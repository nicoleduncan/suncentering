<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:55:56 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>cgcbar2kml.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="cgcbar2kml.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">; docformat = 'rst'</span>
<span class="comments">;</span>
<span class="comments">; NAME:</span>
<span class="comments">;   cgCBar2KML</span>
<span class="comments">;</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">; This program creates a KML file that can be opened in Google Earth to display a</span>
<span class="comments">; color bar as a ScreenOverlay. Screen overlays are images that are displayed in </span>
<span class="comments">; a fixed location on the Google Earth display. A corresponding color bar image file is </span>
<span class="comments">; produced. The KML and color bar image file must be in the same directory to use them with</span>
<span class="comments">; Google Earth.</span>
<span class="comments">;</span>
<span class="comments">;******************************************************************************************;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  Copyright (c) 2012, by Fanning Software Consulting, Inc. All rights reserved.           ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  Redistribution and use in source and binary forms, with or without                      ;</span>
<span class="comments">;  modification, are permitted provided that the following conditions are met:             ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;      * Redistributions of source code must retain the above copyright                    ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer.                     ;</span>
<span class="comments">;      * Redistributions in binary form must reproduce the above copyright                 ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer in the               ;</span>
<span class="comments">;        documentation and/or other materials provided with the distribution.              ;</span>
<span class="comments">;      * Neither the name of Fanning Software Consulting, Inc. nor the names of its        ;</span>
<span class="comments">;        contributors may be used to endorse or promote products derived from this         ;</span>
<span class="comments">;        software without specific prior written permission.                               ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  THIS SOFTWARE IS PROVIDED BY FANNING SOFTWARE CONSULTING, INC. ''AS IS'' AND ANY        ;</span>
<span class="comments">;  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES    ;</span>
<span class="comments">;  OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT     ;</span>
<span class="comments">;  SHALL FANNING SOFTWARE CONSULTING, INC. BE LIABLE FOR ANY DIRECT, INDIRECT,             ;</span>
<span class="comments">;  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED    ;</span>
<span class="comments">;  TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;         ;</span>
<span class="comments">;  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND             ;</span>
<span class="comments">;  ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT              ;</span>
<span class="comments">;  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS           ;</span>
<span class="comments">;  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.                            ;</span>
<span class="comments">;******************************************************************************************;</span>
<span class="comments">;</span>
<span class="comments">;+</span>
<span class="comments">; This program creates a KML file that can be opened in Google Earth to display a</span>
<span class="comments">; color bar as a ScreenOverlay. Screen overlays are images that are displayed in </span>
<span class="comments">; a fixed location on the Google Earth display. A corresponding color bar image file is </span>
<span class="comments">; produced. The KML and color bar image file must be in the same directory to use them with</span>
<span class="comments">; Google Earth. In general, any keyword used for horizontal color bars in cgColorbar can</span>
<span class="comments">; be used with this program. The colorbar image is made from a PostScript intermediate file, which </span>
<span class="comments">; means ImageMagick must be installed on your computer and available to IDL to run this program </span>
<span class="comments">; successfully. Please see `IDL Output for Web Display &lt;http://www.idlcoyote.com/graphics_tips/weboutput.php>`</span>
<span class="comments">; for details.</span>
<span class="comments">; </span>
<span class="comments">; .. image:: cgcbar2kml.png</span>
<span class="comments">; </span>
<span class="comments">; :Categories:</span>
<span class="comments">;    Graphics, FileIO, Maps</span>
<span class="comments">;    </span>
<span class="comments">; :Keywords:</span>
<span class="comments">;    addtofile: in, optional, type=object</span>
<span class="comments">;       If this keyword contains a cgKML_File object, the image is added to the file</span>
<span class="comments">;       as a &lt;ScreenOverlay> element and a separate KML file is not created. In other</span>
<span class="comments">;       words, the `Filename` keyword is ignored and the image file created takes its</span>
<span class="comments">;       name from the cgKML_File object.</span>
<span class="comments">;    background: in, optional, type=string, default='gray'</span>
<span class="comments">;       The background color for the color bar.</span>
<span class="comments">;    bottom: in, optional, type=integer, default=0</span>
<span class="comments">;       The lowest color index of the colors to be loaded in the color bar.</span>
<span class="comments">;    brewer: in, optional, type=boolean, default=0</span>
<span class="comments">;         This keyword is used only if the `CTIndex` keyword is used to select a color table number.</span>
<span class="comments">;         Setting this keyword allows Brewer color tables to be used.</span>
<span class="comments">;    charpercent: in, optional, type=float, default=0.85                 </span>
<span class="comments">;       A value from 0.0 go 1.0 that is multiplied by the CHARSIZE to produce</span>
<span class="comments">;       the character size for the color bar. This value is only used if CHARSIZE is </span>
<span class="comments">;       undefined. This keyword is primarily useful for using color bars in resizeable </span>
<span class="comments">;       graphics windows (cgWindow).</span>
<span class="comments">;    charsize: in, optional, type=float</span>
<span class="comments">;       The character size of the color bar annotations. Default is cgDefCharsize()*charPercent.</span>
<span class="comments">;    clamp: in, optional, type=float</span>
<span class="comments">;        A two-element array in data units. The color bar is clamped to these</span>
<span class="comments">;        two values. This is mostly of interest if you are "window-leveling"</span>
<span class="comments">;        an image. The clamp is set to the "window" of the color bar.</span>
<span class="comments">;        Normally, when you are doing this, you would like the colors outside</span>
<span class="comments">;        the "window" to be set to a neutral color. Use the NEUTRALINDEX keyword</span>
<span class="comments">;        to set the netural color index in the color bar. (See the Examples section</span>
<span class="comments">;        for more information.)</span>
<span class="comments">;    color: in, optional, type=string</span>
<span class="comments">;        The name of the color to use for color bar annotations. Ignored unless passed </span>
<span class="comments">;        the name of a cgColor color. The default value is to use the ANNOTATECOLOR.</span>
<span class="comments">;    ctindex: in, optional, type=integer</span>
<span class="comments">;         The index number of a color table. The `Brewer` and `Reverse` keywords will be checked</span>
<span class="comments">;         to see how to load the color table into the `Palette` keyword. This keyword will take</span>
<span class="comments">;         precidence over any colors that are loaded with the `Palette` keyword. </span>
<span class="comments">;    description: in, optional, type=string</span>
<span class="comments">;       A string that is used to describe the image in the Google Earth interface.</span>
<span class="comments">;    discrete: in, optional, type=boolean, default=0</span>
<span class="comments">;         Set this keyword to configure certain properties of the color bar to make</span>
<span class="comments">;         discrete color blocks for the color bar. This works best if you are using</span>
<span class="comments">;         a handful of colors in the color bar (e.g, 8-16).</span>
<span class="comments">;    divisions: in, optional, type=integer</span>
<span class="comments">;         The number of divisions to divide the bar into. There will</span>
<span class="comments">;         be (divisions + 1) annotations. The default is 0 if using the</span>
<span class="comments">;         default color bar formatting, which allows the plot command to </span>
<span class="comments">;         determine how many divisions to make. Otherwise, if you are specifying</span>
<span class="comments">;         some other format for the tick labels, the default number of divisions</span>
<span class="comments">;         is six.</span>
<span class="comments">;    draworder: in, optional, type=integer, default=0</span>
<span class="comments">;        The drawing order of image overlay. The first order is 0. Images with a higher</span>
<span class="comments">;        order are drawn on top of images with a lower order.</span>
<span class="comments">;    filename: in, optional, type=string, default='kml_cbimage.kml'</span>
<span class="comments">;        The name of the KML file that will be created. The image file will have the same name,</span>
<span class="comments">;        but with a *.png file extension. The KML file and the image file will be created in the</span>
<span class="comments">;        same directory.</span>
<span class="comments">;    format: in, optional, type=string, default=""</span>
<span class="comments">;       The format of the color bar annotations. Default is "". Note that the</span>
<span class="comments">;       formatting behaviour can change, depending up values for the keywords</span>
<span class="comments">;       `RANGE` and `DIVISIONS`. If you prefer to let the IDL Plot command determine</span>
<span class="comments">;       how the color bar labels are formatted, set the format to a null string and</span>
<span class="comments">;       set the `DIVISIONS` keyword to 0. Note the difference in these two commands::</span>
<span class="comments">;       </span>
<span class="comments">;           cgColorbar, Range=[18,125], Position=[0.1, 0.8, 0.9, 0.85]</span>
<span class="comments">;           cgColorbar, Range=[18,125], Position=[0.1, 0.7, 0.9, 0.75], Divisions=0</span>
<span class="comments">;    kmz: in, optional, type=boolean, default=0</span>
<span class="comments">;        Set this keyword to move the KML file and support files to a KMZ compressed file.</span>
<span class="comments">;        Note that this capability is ONLY available in versions of IDL starting with version 8.0.</span>
<span class="comments">;    location: in, optional, type=intarr</span>
<span class="comments">;       A two-element array giving the location of the top-left corner of the</span>
<span class="comments">;       color bar in normalized coordinates from the upper-left of the Google Earth</span>
<span class="comments">;       display screen. Default is [0.025, 0.975].</span>
<span class="comments">;    maxrange: in, optional</span>
<span class="comments">;       The maximum data value for the color bar annotation. Default is NCOLORS.</span>
<span class="comments">;    minrange: in, optional, type=float, default=0.0</span>
<span class="comments">;       The minimum data value for the bar annotation. </span>
<span class="comments">;    minor: in, optional, type=integer, default=2</span>
<span class="comments">;       The number of minor tick divisions. </span>
<span class="comments">;    ncolors: in, optional, type=integer, default=256</span>
<span class="comments">;       This is the number of colors in the color bar.</span>
<span class="comments">;    neutralindex: in, optional, type=integer   </span>
<span class="comments">;       This is the color index to use for color bar values outside the</span>
<span class="comments">;       clamping range when clamping the color bar with the CLAMP keyword.</span>
<span class="comments">;       If this keyword is absent, the highest color table value is used</span>
<span class="comments">;       for low range values and the lowest color table value is used</span>
<span class="comments">;       for high range values, in order to provide contrast with the</span>
<span class="comments">;       clamped region. (See the Examples section for more information.)</span>
<span class="comments">;    oob_factor: in, optional, type=float, default=0.2</span>
<span class="comments">;       The default is to make the length of the out-of-bounds triangle the</span>
<span class="comments">;       same distance as the height (or width, in the case of a vertical</span>
<span class="comments">;       color bar) of the color bar. If you would prefer a shorted triangle length, </span>
<span class="comments">;       set this keyword to a value less than zero (e.g., 0.5). If you prefer a </span>
<span class="comments">;       longer length, set this keyword to a value greater than zero. The "standard"</span>
<span class="comments">;       length will be multiplied by this value.</span>
<span class="comments">;    oob_high: in, optional, type=string</span>
<span class="comments">;       The name of an out-of-bounds high color. This color will be represented</span>
<span class="comments">;       by a triangle on the right or top of the color bar. If the color is</span>
<span class="comments">;       a string byte value (e.g., "215"), then this color in the current color</span>
<span class="comments">;       table is used. The color can also be a three-element color triple </span>
<span class="comments">;       (e.g., [240, 200, 65]).</span>
<span class="comments">;    oob_low: in, optional, type=string</span>
<span class="comments">;       The name of an out-of-bounds low color. This color will be represented</span>
<span class="comments">;       by a triangle on the left or bottom of the color bar. If the color is</span>
<span class="comments">;       a string byte value (e.g., "215"), then this color in the current color</span>
<span class="comments">;       table is used. The color can also be a three-element color triple </span>
<span class="comments">;       (e.g., [240, 200, 65]).</span>
<span class="comments">;    palette: in, optional, type=byte</span>
<span class="comments">;       A color palette containing the RGB color vectors to use for the color</span>
<span class="comments">;       bar. The program will sample NCOLORS from the color palette. </span>
<span class="comments">;    placename: in, optional, type=string, default='Color Bar'</span>
<span class="comments">;        This is the &lt;name> element in a Feature object. It is user-defined text that is used as</span>
<span class="comments">;        the label for an object in Google Earth.</span>
<span class="comments">;    range: in, optional, type=float</span>
<span class="comments">;       A two-element vector of the form [min, max]. Provides an alternative </span>
<span class="comments">;       and faster way way of setting the MINRANGE and MAXRANGE keywords.</span>
<span class="comments">;    reverse: in, optional, type=boolean, default=0</span>
<span class="comments">;       An alternative keyword name (one I can actually remember!) for the INVERTCOLORS keyword.</span>
<span class="comments">;       It reverses the colors in the color bar.</span>
<span class="comments">;    tickinterval: in, optional, type=float</span>
<span class="comments">;       Set this keyword to the interval spacing of major tick marks. Use this keyword in</span>
<span class="comments">;       place of XTickInterval or YTickInterval keywords.</span>
<span class="comments">;    ticklen: in, optional, type=float, default=0.25</span>
<span class="comments">;       Set this keyword to the major tick length desired. Default is 0.25. Setting this </span>
<span class="comments">;       keyword to a value greater than or equal to 0.5 will result in major tick marks </span>
<span class="comments">;       extending the width of the color bar. Note that setting this keyword to 0.3 or</span>
<span class="comments">;       greater will result in minor tick mark lengths being set to 0.01, which is almost </span>
<span class="comments">;       too small to be seen. All direct graphics tick marks act in this (strange!) way.</span>
<span class="comments">;    ticknames: in, optional, type=string                 </span>
<span class="comments">;       A string array of names or values for the color bar tick marks.</span>
<span class="comments">;    title: in, optional, type=string, default=""</span>
<span class="comments">;       This is title for the color bar. The default is to have no title.</span>
<span class="comments">;    tcharsize: in, optional, type=float</span>
<span class="comments">;       The title size. By default, the same as `Charsize`. Note that this keyword is</span>
<span class="comments">;       ignored for vertical color bars unless the title location (`TLocation`) is on</span>
<span class="comments">;       the opposite side of the color bar from the color bar labels. This is a consequence</span>
<span class="comments">;       of being upable to determine the length of color bar labels programmatically in this</span>
<span class="comments">;       orientation.</span>
<span class="comments">;    width: in, optional, type=integer, default=300</span>
<span class="comments">;       The width, in pixels, of the colorbar image that is created.</span>
<span class="comments">;    xlog: in, optional, type=boolean, default=0</span>
<span class="comments">;       Set this keyword to use logarithmic scaling for the colorbar data range.</span>
<span class="comments">;    xtickinterval: in, optional, type=float</span>
<span class="comments">;       This keyword is trapped, but unused. Please use the`TickInterval` keyword instead.</span>
<span class="comments">;    xtitle: in, optional, type=string</span>
<span class="comments">;        This keyword is ignored. Use the `Title` keyword to set a title for the color bar.</span>
<span class="comments">;    _ref_extra: in, optional</span>
<span class="comments">;         Any keyword appropriate KML screen overlay objects is allowed.</span>
<span class="comments">;</span>
<span class="comments">; :Examples:</span>
<span class="comments">;    Here is how you can put an AVHRR NDVI image of Africa on a Google Earth display</span>
<span class="comments">;    with a color bar:: </span>
<span class="comments">;    </span>
<span class="comments">;       ;; Download the image file from the Coyote web page.</span>
<span class="comments">;       netObject = Obj_New('IDLnetURL')</span>
<span class="comments">;       url = 'http://www.idlcoyote.com/data/AF03sep15b.n16-VIg.tif'</span>
<span class="comments">;       returnName = netObject -> Get(URL=url, FILENAME='AF03sep15b.n16-VIg.tif')</span>
<span class="comments">;       Obj_Destroy, netObject</span>
<span class="comments">;       </span>
<span class="comments">;       ;; Create the image overlay KML file.</span>
<span class="comments">;       kmlFile = Obj_New('cgKML_File', 'avhrr_ndvi_cb.kml')</span>
<span class="comments">;       cgLoadCT, 11, /Brewer, /Reverse, RGB_Table=palette</span>
<span class="comments">;       map = cgGeoMap('AF03sep15b.n16-VIg.tif', Image=image)</span>
<span class="comments">;       scaledImage = BytScl(image > 0)</span>
<span class="comments">;       cgImage2KML, scaledImage, map, $</span>
<span class="comments">;          Palette=palette, Missing_Value=0, $</span>
<span class="comments">;          Description='AVHRR NDVI Data from Africa', $</span>
<span class="comments">;          PlaceName='AVHRR Africa', $</span>
<span class="comments">;          AddToFile=kmlFile</span>
<span class="comments">;       cgCBar2KML, Palette=palette, Range=[0,9400], $</span>
<span class="comments">;          Title='NDVI Index', $</span>
<span class="comments">;          Description='AVHRR NDVI Color Bar', $</span>
<span class="comments">;          PlaceName='NDVI Color Bar', $</span>
<span class="comments">;          AddToFile=kmlFile</span>
<span class="comments">;       kmlFile -> Save</span>
<span class="comments">;       kmlFile -> Destroy</span>
<span class="comments">;          </span>
<span class="comments">;       ;; Start Google Earth and open the KML file you just created.</span>
<span class="comments">;       </span>
<span class="comments">;    The output should look like the figure above.</span>
<span class="comments">;    </span>
<span class="comments">;    If you just wish to create a KML file with a color bar, you can do this::</span>
<span class="comments">;    </span>
<span class="comments">;       cgCBar2KML, Filename='colorbar.kml', CTIndex=5, Title='Test Color Bar'</span>
<span class="comments">;       </span>
<span class="comments">; :Author:</span>
<span class="comments">;    FANNING SOFTWARE CONSULTING::</span>
<span class="comments">;       David W. Fanning </span>
<span class="comments">;       1645 Sheely Drive</span>
<span class="comments">;       Fort Collins, CO 80526 USA</span>
<span class="comments">;       Phone: 970-221-0438</span>
<span class="comments">;       E-mail: david@idlcoyote.com</span>
<span class="comments">;       Coyote's Guide to IDL Programming: http://www.idlcoyote.com</span>
<span class="comments">;</span>
<span class="comments">; :History:</span>
<span class="comments">;     Change History::</span>
<span class="comments">;        Written, 30 October 2012 by David W. Fanning.</span>
<span class="comments">;        Added DRAWORDER keyword and fixed a typo concerning MISSING_VALUE. 31 Oct 2012. DWF.</span>
<span class="comments">;        Have been writing the absolute path to the image file into the KML file, when I should</span>
<span class="comments">;            have been using a relative path. 22 Feb 2013. DWF.</span>
<span class="comments">;</span>
<span class="comments">; :Copyright:</span>
<span class="comments">;     Copyright (c) 2012-2013, Fanning Software Consulting, Inc.</span>
<span class="comments">;-</span>
PRO cgCBar2KML, $
    ADDTOFILE=addtofile, $
    BACKGROUND=background, $
    BOTTOM=bottom, $
    BREWER=brewer, $
    CHARPERCENT=charpercent, $
    CHARSIZE=charsize, $
    CLAMP=clamp, $
    COLOR=color, $
    CTINDEX=ctindex, $
    DESCRIPTION=description, $
    DISCRETE=discrete, $
    DIVISIONS=divisions, $
    DRAWORDER=draworder, $
    FILENAME=filename, $
    FORMAT=format, $
    KMZ=kmz, $
    LOCATION=location, $
    MAXRANGE=maxrange, $
    MINOR=minor, $
    MINRANGE=minrange, $
    NCOLORS=ncolors, $
    NEUTRALINDEX=neutralIndex, $
    OOB_FACTOR=oob_factor, $
    OOB_HIGH=oob_high, $
    OOB_LOW=oob_low, $
    PALETTE=palette, $
    PLACENAME=placename, $
    RANGE=range, $
    REVERSE=reverse, $
    TCHARSIZE=tcharsize, $
    TICKINTERVAL=tickinterval, $
    TICKLEN=ticklen, $
    TICKNAMES=ticknames, $
    TITLE=title, $
    XLOG=xlog, $
    XTICKINTERVAL=xtickinterval, $ <span class="comments">; Ignored.</span>
    XTITLE=xtitle, $ <span class="comments">; Ignored.</span>
    WIDTH=width, $
    _REF_EXTRA=extra
    
    Compile_Opt idl2
    
    Catch, theError
    IF theError NE 0 THEN BEGIN
       Catch, /CANCEL
       void = Error_Message()
       RETURN
    ENDIF 
    
    <span class="comments">; Default values.</span>
    IF N_Elements(background) EQ 0 THEN background = 'gray'
    IF N_Elements(location) EQ 0 THEN location = [0.025, 0.975]
    IF N_Elements(placename) EQ 0 THEN placename = 'Color Bar'
    IF N_Elements(oob_factor) EQ 0 THEN oob_factor = 0.2
    IF N_Elements(charsize) EQ 0 THEN charsize=1.75
    IF N_Elements(tcharsize) EQ 0 THEN tcharsize = 2.0
    IF N_Elements(title) EQ 0 THEN BEGIN
        position = [0.1, 0.425, 0.9, 0.775]
    ENDIF ELSE BEGIN
        position = [0.1, 0.525, 0.9, 0.875]
    ENDELSE
    
    <span class="comments">; If the KMZ keyword is set, make sure this version of IDL supports it.</span>
    IF Keyword_Set(kmz) THEN BEGIN
        IF Float(!Version.Release) LT 8.0 THEN BEGIN
            Message, 'The KMZ keyword is not supported in this version of IDL.', /Informational
            kmz = 0
        ENDIF
    ENDIF
    
    <span class="comments">; Need a filename?</span>
    IF N_Elements(filename) EQ 0 THEN BEGIN
       CD, CURRENT=thisDir
       filename = Filepath(ROOT_DIR=thisDir, 'kml_cbimage.kml')
    ENDIF
   
    <span class="comments">; Construct the image filename</span>
    rootName = cgRootName(filename, DIRECTORY=thisDir, EXTENSION=ext)
    IF StrUpCase(ext) NE 'KML' THEN Message, 'The output filename must have a KML file extension.'
    imageFilename = Filepath(ROOT_DIR=thisDir, rootname + '.png')
    
   IF cgObj_Isa(addtofile, 'cgKML_File') THEN BEGIN
   
      addToFile -> GetProperty, FILENAME=filename, COUNT=count
      rootname = cgRootName(filename, DIRECTORY=thisDir, EXTENSION=ext)
      imageFilename = FilePath(ROOT_DIR=thisDir, rootname + StrTrim(count+1,2) + '.png')
      
     <span class="comments">; Write the image file.</span>
     rootname = cgRootName(imageFilename, DIRECTORY=thisDir)
     psFileName = Filepath(ROOT_DIR=thisDir, rootname + '.ps')
     PS_Start, psFilename, /Quiet
     cgDisplay, 1000, 200
     cgColorFill, [0,1,1,0,0], [0,0,1,1,0], /Normal, Color=background
     cgColorbar, $
        BOTTOM=bottom, $
        BREWER=brewer, $
        CHARPERCENT=charpercent, $
        CHARSIZE=charsize, $
        CLAMP=clamp, $
        COLOR=color, $
        CTINDEX=ctindex, $
        DISCRETE=discrete, $
        DIVISIONS=divisions, $
        FORMAT=format, $
        MAXRANGE=maxrange, $
        MINOR=minor, $
        MINRANGE=minrange, $
        NCOLORS=ncolors, $
        NEUTRALINDEX=neutralIndex, $
        OOB_FACTOR=oob_factor, $
        OOB_HIGH=oob_high, $
        OOB_LOW=oob_low, $
        PALETTE=palette, $
        POSITION=position, $
        RANGE=range, $
        REVERSE=reverse, $
        TCHARSIZE=tcharsize, $
        TICKINTERVAL=tickinterval, $
        TICKLEN=ticklen, $
        TICKNAMES=ticknames, $
        TITLE=title, $
        XLOG=xlog
     PS_End, /PNG, /DELETE_PS, WIDTH=width, /NoMessage
     
     <span class="comments">; Create the screen overlay object if a raster file was created.</span>
     IF File_Test(imageFilename) THEN BEGIN
       overlay = Obj_New('cgKML_ScreenOverlay', $
            HREF=File_Basename(imageFilename), $
            DESCRIPTION=description, $
            DRAWORDER=draworder, $
            SCREEN_XY=location, $
            PLACENAME=placename)
        addToFile -> Add, overlay
      ENDIF
   
   ENDIF ELSE BEGIN
   
     <span class="comments">; Write the image file.</span>
     rootname = cgRootName(imageFilename, DIRECTORY=thisDir)
     psFileName = Filepath(ROOT_DIR=thisDir, rootname + '.ps')
     PS_Start, psFilename, /Quiet
     cgDisplay, 1000, 200
     cgColorFill, [0,1,1,0,0], [0,0,1,1,0], /Normal, Color=background
     cgColorbar, $
        BOTTOM=bottom, $
        BREWER=brewer, $
        CHARPERCENT=charpercent, $
        CHARSIZE=charsize, $
        CLAMP=clamp, $
        COLOR=color, $
        CTINDEX=ctindex, $
        DISCRETE=discrete, $
        DIVISIONS=divisions, $
        FORMAT=format, $
        MAXRANGE=maxrange, $
        MINOR=minor, $
        MINRANGE=minrange, $
        NCOLORS=ncolors, $
        NEUTRALINDEX=neutralIndex, $
        OOB_FACTOR=oob_factor, $
        OOB_HIGH=oob_high, $
        OOB_LOW=oob_low, $
        PALETTE=palette, $
        POSITION=position, $
        RANGE=range, $
        REVERSE=reverse, $
        TCHARSIZE=tcharsize, $
        TICKINTERVAL=tickinterval, $
        TICKLEN=ticklen, $
        TICKNAMES=ticknames, $
        TITLE=title, $
        XLOG=xlog
     PS_End, /PNG, /DELETE_PS, WIDTH=width, /NoMessage
   
     <span class="comments">; Write the KML file.</span>
     kmlFile = Obj_New('cgKML_File', filename)
     
     <span class="comments">; Create the screen overlay object if a raster file was created.</span>
     IF File_Test(imageFilename) THEN BEGIN
       overlay = Obj_New('cgKML_ScreenOverlay', $
            HREF=File_Basename(imageFilename), $
            DESCRIPTION=description, $
            DRAWORDER=draworder, $
            SCREEN_XY=location, $
            PLACENAME=placename)
        kmlFile -> Add, overlay
      ENDIF
     kmlFile -> Save, KMZ=Keyword_Set(kmz)
     kmlFile -> Destroy
     
   ENDELSE

END    
</code>
    </div>
  </body>
</html>