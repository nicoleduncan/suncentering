<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:56:08 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>cggooglemapwidget__define.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="cggooglemapwidget__define.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">; docformat = 'rst'</span>
<span class="comments">;</span>
<span class="comments">; NAME:</span>
<span class="comments">;   cgGoogleMapWidget__Define</span>
<span class="comments">;</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;   This is a compound widget object that obtains a Google static map from Google Maps </span>
<span class="comments">;   and displays it in the program's draw widget window. It can be used either as a </span>
<span class="comments">;   stand-alone program or to create a map image in draw widget in a larger widget program.</span>
<span class="comments">;</span>
<span class="comments">;******************************************************************************************;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  Copyright (c) 2012, by Fanning Software Consulting, Inc. All rights reserved.           ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  Redistribution and use in source and binary forms, with or without                      ;</span>
<span class="comments">;  modification, are permitted provided that the following conditions are met:             ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;      * Redistributions of source code must retain the above copyright                    ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer.                     ;</span>
<span class="comments">;      * Redistributions in binary form must reproduce the above copyright                 ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer in the               ;</span>
<span class="comments">;        documentation and/or other materials provided with the distribution.              ;</span>
<span class="comments">;      * Neither the name of Fanning Software Consulting, Inc. nor the names of its        ;</span>
<span class="comments">;        contributors may be used to endorse or promote products derived from this         ;</span>
<span class="comments">;        software without specific prior written permission.                               ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  THIS SOFTWARE IS PROVIDED BY FANNING SOFTWARE CONSULTING, INC. ''AS IS'' AND ANY        ;</span>
<span class="comments">;  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES    ;</span>
<span class="comments">;  OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT     ;</span>
<span class="comments">;  SHALL FANNING SOFTWARE CONSULTING, INC. BE LIABLE FOR ANY DIRECT, INDIRECT,             ;</span>
<span class="comments">;  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED    ;</span>
<span class="comments">;  TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;         ;</span>
<span class="comments">;  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND             ;</span>
<span class="comments">;  ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT              ;</span>
<span class="comments">;  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS           ;</span>
<span class="comments">;  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.                            ;</span>
<span class="comments">;******************************************************************************************;</span>
<span class="comments">;</span>
<span class="comments">;+</span>
<span class="comments">; This is a compound widget object that obtains a Google static map from Google Maps </span>
<span class="comments">; and displays it in the program's draw widget window. It can be used either as a </span>
<span class="comments">; stand-alone program or to create a map image in draw widget in a larger widget program.</span>
<span class="comments">; </span>
<span class="comments">; This program implements a subset of the Google Static Map API, which can be found in</span>
<span class="comments">; more detail here: https://developers.google.com/maps/documentation/staticmaps/. The </span>
<span class="comments">; program works by building a URL for a map image. A connection to the Internet is </span>
<span class="comments">; required to then request a map image (in JPEG or PNG format) to be returned from</span>
<span class="comments">; Goggle Maps. The returned image is then read and loaded into a draw widget window</span>
<span class="comments">; of the right size for the returned map image. The default is to delete the image file</span>
<span class="comments">; that is created, but user can also set keywords to retain the image that is downloaded</span>
<span class="comments">; from Google Maps. Users are able to control button and motion events in the resulting</span>
<span class="comments">; draw widget with their own event handler module. A cgMap coordinate object is created</span>
<span class="comments">; to establish a map reference coordinate system on top of the returned map image, allowing</span>
<span class="comments">; other map information to be drawn on top of the returned map image.</span>
<span class="comments">;</span>
<span class="comments">; .. image:: cggooglemapwidget.png</span>
<span class="comments">; </span>
<span class="comments">; :Categories:</span>
<span class="comments">;    Graphics</span>
<span class="comments">;    </span>
<span class="comments">;    </span>
<span class="comments">; :Examples:</span>
<span class="comments">;    Used to put two markers on a map of Fort Collins, Colorado, in a stand-alone window::</span>
<span class="comments">;        PRO cgGoogleMapWidget_Test</span>
<span class="comments">;            marker1 = {cgGOOGLEMAPMARKER, 'normal', 'dodger blue', 'A', Ptr_New(40.600), Ptr_New(-105.100)}</span>
<span class="comments">;            marker2 = {cgGOOGLEMAPMARKER, 'normal', 'purple',      'B', Ptr_New(40.605), Ptr_New(-105.105)}</span>
<span class="comments">;            googleObject = Obj_New('cgGoogleMapWidget', MARKERS=[marker1, marker2], MAPTYPE='Terrain')</span>
<span class="comments">;        END</span>
<span class="comments">;       </span>
<span class="comments">; :Author:</span>
<span class="comments">;    FANNING SOFTWARE CONSULTING::</span>
<span class="comments">;       David W. Fanning </span>
<span class="comments">;       1645 Sheely Drive</span>
<span class="comments">;       Fort Collins, CO 80526 USA</span>
<span class="comments">;       Phone: 970-221-0438</span>
<span class="comments">;       E-mail: david@idlcoyote.com</span>
<span class="comments">;       Coyote's Guide to IDL Programming: http://www.idlcoyote.com</span>
<span class="comments">;</span>
<span class="comments">; :History:</span>
<span class="comments">;     Change History::</span>
<span class="comments">;        Written, 25 June 2012. DWF.</span>
<span class="comments">;        Set the RETAIN keyword on the draw widget for UNIX machines. 28 June 2012. DWF.</span>
<span class="comments">;        Beefed up and changed error handling when failing to obtain a map from Google Maps. 28 June 2012. DWF.</span>
<span class="comments">;        Added NoForwardFix keyword to call to cgMap to allow better drawing of markers. 29 June 2012. DWF.</span>
<span class="comments">;        Added the ability to turn markers on or off with VisibleMarkers keyword and property. 29 June 2012. DWF.</span>
<span class="comments">;        Added a WID keyword to the GetProperty method to all the user to obtain the Goggle Map </span>
<span class="comments">;            window index number. 29 Aug 2012. DWF.</span>
<span class="comments">;            </span>
<span class="comments">; :Copyright:</span>
<span class="comments">;     Copyright (c) 2012, Fanning Software Consulting, Inc.</span>
<span class="comments">;-</span>

<span class="comments">;</span>
<span class="comments">;</span>
<span class="comments">;+</span>
<span class="comments">; This is the initialization method of the cgGoogleMapWidget object. </span>
<span class="comments">; </span>
<span class="comments">; :Params:</span>
<span class="comments">;    parent: in, optional, type=long</span>
<span class="comments">;         The identifier of the parent widget of the draw widget that is going to be </span>
<span class="comments">;         created by the program. If not provided, the program will create its own </span>
<span class="comments">;         top-level base widget as the parent.</span>
<span class="comments">;       </span>
<span class="comments">; :Keywords:</span>
<span class="comments">;     box_axes: in, optional, type=boolean, default=0</span>
<span class="comments">;         Set this keyword to draw box axes around the Google Map.</span>
<span class="comments">;     button_events: in, optional, type=boolean, default=0</span>
<span class="comments">;         Set this keyword to turn button events on for the draw widget in the program.</span>
<span class="comments">;     center_latitude: in, optional, type=float, default=40.60</span>
<span class="comments">;         The center latitude of the requested Google map. If not provided, the latitude of</span>
<span class="comments">;         Fort Collins, Colorado, home of Coyote. Latitudes are only recognized to four</span>
<span class="comments">;         decimals values of precision.</span>
<span class="comments">;     center_longitude: in, optional, type=float, default=-105.10</span>
<span class="comments">;         The center longitude of the requested Google map. If not provided, the longitude of</span>
<span class="comments">;         Fort Collins, Colorado, home of Coyote. Longitude are only recognized to four</span>
<span class="comments">;         decimals values of precision.</span>
<span class="comments">;     event_method: in, optional, type='string'</span>
<span class="comments">;         The name of the event handler method (a procedure) for the draw widget. If you use this keyword,</span>
<span class="comments">;         you will also need to write this event handler module. It gets sent one positional</span>
<span class="comments">;         parameter, the event structure created by the draw widget.</span>
<span class="comments">;     event_pro: in, optional, type='string'</span>
<span class="comments">;         The name of an external event handler procedure for the draw widget. The event handler</span>
<span class="comments">;         procedure gets sent one positional parameter, the event structure created by the draw widget.</span>
<span class="comments">;     imagetype: in, optional, type=string, default='png32'</span>
<span class="comments">;         The type of image format the Google map should be returned in. The default is</span>
<span class="comments">;         a 32-bit full color PNG file. The image types are given in the Google Static Map</span>
<span class="comments">;         API documentation and are as follows: png or png8, png32, gif, jpg, and jpg-baseline.</span>
<span class="comments">;     keep_image: in, optional, type=boolean, default=0</span>
<span class="comments">;         Set this keyword if you wish to save the Google map as an image when the object</span>
<span class="comments">;         is destroyed.</span>
<span class="comments">;     maptype: in, optional, type=string, default='terrain'</span>
<span class="comments">;         Set this keyword to the type of map you wish to retrieve from Google Maps. The</span>
<span class="comments">;         choices are listed in the Google Static Map API documentation and are: "roadmap",</span>
<span class="comments">;         "terrain", "satellite", and "hybrid".</span>
<span class="comments">;     markers: in, optional, type=structure</span>
<span class="comments">;         A scalar or array of cgGoogleMapMarker structures. If present, the markers will</span>
<span class="comments">;         be requested with the map from Google. The cgGoogleMapMarker structure is defined</span>
<span class="comments">;         like this::</span>
<span class="comments">;            struct = { cgGOOGLEMAPMARKER, $</span>
<span class="comments">;               size: "", $         ; The marker size ("tiny", "small", "mid" or "normal")</span>
<span class="comments">;               color: "", $        ; A color name as provided by cgColor.</span>
<span class="comments">;               label: "", $        ; A single uppercase character label from the set {A-Z,0-9}.</span>
<span class="comments">;               lats: Ptr_New(), $  ; A pointer to one or more latitude values.</span>
<span class="comments">;               lons: Ptr_New() }   ; A pointer to one or more longitude values.</span>
<span class="comments">;         Note that the user will be responsible for freeing the pointers in the MARKERS</span>
<span class="comments">;         structure. This program will not do that.</span>
<span class="comments">;     motion_events: in, optional, type=boolean, default=0</span>
<span class="comments">;         Set this keyword to turn motion events on for the draw widget in the program.</span>
<span class="comments">;     tempDir: in, optional, type=string</span>
<span class="comments">;         The directory where the image containing the Google map is written. By default,</span>
<span class="comments">;         it is obtained from the environment like this: tempdir = GetEnv('IDL_TMPDIR').</span>
<span class="comments">;     visiblemarkers: in, optional, type=boolean, default=1</span>
<span class="comments">;         Set this keyword to 0 to temporarily turn off the display of the markers. Normally,</span>
<span class="comments">;         markers are drawn (if present), unless this flag is set to 0.</span>
<span class="comments">;     xsize: in, optional, type=int, default=600</span>
<span class="comments">;         The X size of the program's draw widget. A maximum of 690 if box axes are requested</span>
<span class="comments">;         and a maximum of 640 if no box axes are requested. Box axes require a 25 pixel border</span>
<span class="comments">;         and the maximum size of a Google Map is 640 pixels.</span>
<span class="comments">;     ysize: in, optional, type=int, default=600</span>
<span class="comments">;         The Y size of the program's draw widget. A maximum of 690 if box axes are requested</span>
<span class="comments">;         and a maximum of 640 if no box axes are requested. Box axes require a 25 pixel border</span>
<span class="comments">;         and the maximum size of a Google Map is 640 pixels.</span>
<span class="comments">;     zoomlevel: in, optional, type=integer, default=12</span>
<span class="comments">;         The zoom level of the requested Google map. Should be an integer between 0 and 21.</span>
<span class="comments">;-</span>
FUNCTION cgGoogleMapWidget::INIT, parent, $
    BOX_AXES=box_axes, $
    BUTTON_EVENTS=button_events, $
    CENTER_LATITUDE=centerLat, $
    CENTER_LONGITUDE=centerLon, $
    EVENT_METHOD=event_method, $
    EVENT_PRO=event_pro, $
    IMAGETYPE=imageType, $
    KEEP_IMAGE=keep_image, $
    MAPTYPE=maptype, $
    MARKERS=markers, $
    MOTION_EVENTS=motion_events, $
    TEMPDIR=tempdir, $
    VISIBLEMARKERS=visiblemarkers, $
    XSIZE=xsize, $
    YSIZE=ysize, $
    ZOOMLEVEL=zoomlevel
    
    Compile_Opt idl2
    
    Catch, theError
    IF theError NE 0 THEN BEGIN
       Catch, /CANCEL
       void = Error_Message()
       RETURN, 0
    ENDIF
    
    <span class="comments">; Check keyword parameters.</span>
    box_axes = Keyword_Set(box_axes)
    maxWindowSize = box_axes ? 690 : 640
    button_events = Keyword_Set(button_events)
    IF N_Elements(centerLat) EQ 0 THEN centerLat = 40.600
    IF N_Elements(centerLon) EQ 0 THEN centerLon = -105.1
    IF N_Elements(event_method) EQ 0 THEN event_method = ""
    IF N_Elements(event_pro) EQ 0 THEN event_pro = ""
    IF N_Elements(imageType) EQ 0 THEN imageType = 'png32' ELSE imageType = StrLowCase(imageType)
    keep_image = Keyword_Set(keep_image)
    IF N_Elements(mapType) EQ 0 THEN mapType = 'terrain' ELSE mapType = StrLowCase(mapType)
    motion_events = Keyword_Set(motion_events)
    IF N_Elements(tempdir) EQ 0 THEN tempdir = GetEnv('IDL_TMPDIR')
    IF N_Elements(visibleMarkers) EQ 0 THEN visibleMarkers = 1
    IF N_Elements(xsize) EQ 0 THEN xsize = 600 ELSE xsize = xsize &lt<span class="comments">; maxWindowSize</span>
    IF N_Elements(ysize) EQ 0 THEN ysize = 600 ELSE ysize = ysize &lt<span class="comments">; maxWindowSize</span>
    IF N_Elements(zoomlevel) EQ 0 THEN zoomlevel = 12 ELSE zoomlevel = 0 > zoomLevel &lt<span class="comments">; 21</span>
    map_xsize = box_axes ? (xsize-50) : xsize
    map_ysize = box_axes ? (ysize-50) : ysize
    
    <span class="comments">; Make sure the temporary directory exists.</span>
    IF ~File_Test(tempDir, /DIRECTORY) THEN File_MkDir, tempDir    

    <span class="comments">; Add a random number generator.</span>
    self.random = Obj_New('RandomNumberGenerator')
    
    <span class="comments">; Use the random number generator to produce a filename for the program.</span>
    filerootName = 'google_map_' + self.random->GetRandomDigits(4)
    CASE imageType OF
       'png': filename = filerootName + '.png'
       'png8': filename = filerootName + '.png'
       'png32': filename = filerootName + '.png'
       'jpg': filename = filerootName + '.jpg'
       'jpg-baseline': filename = filerootName + '.jpg'
       'gif': filename = filerootName + '.jpg'
       ELSE: Message, 'Unknown image type for Google Map: ' + imageType
    ENDCASE
    filename = Filepath(Root_Dir=tempDir, filename)
    
    <span class="comments">; If there is no parent, then create a top-level base widget to display your self in.</span>
    IF N_Elements(parent) EQ 0 THEN BEGIN
       createparent = 1
       parent = Widget_Base(Title='Google Map Widget', COLUMN=1, /BASE_ALIGN_CENTER)
    ENDIF ELSE createparent = 0
    retain = (StrUpCase(!Version.OS_Family) EQ 'UNIX') ? 2 : 1
    drawID = Widget_Draw(parent, XSIZE=xsize, YSIZE=ysize, $
        NOTIFY_REALIZE='cgGoogleMapWidget_Notify_Realize', $
        UVALUE={object:self, method:'Notify_Realize'}, $
        BUTTON_EVENTS=button_events, MOTION_EVENTS=motion_events, $
        EVENT_PRO='cgGoogleMapWidget_Events', RETAIN=retain)
    IF createparent THEN BEGIN
        buttonBase = Widget_Base(parent, ROW=1)
        void = Widget_Button(buttonBase, Value='Zoom In', UVALUE={object:self, method:'ZOOM_IN'})
        void = Widget_Button(buttonBase, Value='Zoom Out', UVALUE={object:self, method:'ZOOM_OUT'})
        menuID = Widget_Button(buttonBase, Value='Map Type...', /MENU)
        void = Widget_Button(menuID, Value='Terrain', UNAME='TERRAIN', $
            UVALUE={object:self, method:'MAP_TYPE'})
        void = Widget_Button(menuID, Value='Satellite', UNAME='SATELLITE', $
            UVALUE={object:self, method:'MAP_TYPE'})
        void = Widget_Button(menuID, Value='Roadmap', UNAME='ROADMAP', $
            UVALUE={object:self, method:'MAP_TYPE'})
        void = Widget_Button(menuID, Value='Hybrid', UNAME='HYBRID', $
            UVALUE={object:self, method:'MAP_TYPE'})
     ENDIF
    
    <span class="comments">; Load the object.</span>
    self.box_axes = box_axes
    self.centerLat = centerLat
    self.centerLon = centerLon
    self.tlb = parent
    self.drawID = drawID
    self.event_method = event_method
    self.event_pro = event_pro
    self.filename = filename
    self.keep_image = keep_image
    self.imageType = imageType
    self.map_xsize = map_xsize
    self.map_ysize = map_ysize
    self.mapType = mapType
    IF box_axes THEN BEGIN
       self.map_position = [25./xsize, 25./ysize, (xsize-25.)/xsize, (ysize-25.)/ysize]
    ENDIF ELSE BEGIN
       self.map_position = [0., 0., 1., 1.]
    ENDELSE
    self.visiblemarkers = Keyword_Set(visibleMarkers)
    self.xsize = xsize
    self.ysize = ysize
    self.tempDir = tempDir
    IF N_Elements(markers) EQ 0 $
        THEN self.markers = Ptr_New(/ALLOCATE_HEAP) $
        ELSE self.markers = Ptr_New(markers)
    self.zoomlevel = zoomlevel
    
    <span class="comments">; Create a map coordinate object for navigating the Google Map.</span>
    self.mapCoord = self -> GetMapCoord()
    
    <span class="comments">; Realize the widget if you created the parent.</span>
    IF createparent THEN Widget_Control, parent, /REALIZE, SET_UVALUE=self
    
    <span class="comments">; Start the program if you created the parent.</span>
    IF createparent THEN BEGIN
       XManager, 'cgGoogleMapWidget', parent, /No_Block, $
          Cleanup='cgGoogleMapWidget_Cleanup', Event_Handler='cgGoogleMapWidget_Events'
    ENDIF
    
    RETURN, 1
END


<span class="comments">;+</span>
<span class="comments">; The clean-up method for the object. When the object is destroyed, </span>
<span class="comments">; this method will free the object's pointers and objects. If you</span>
<span class="comments">; wanted to save the map image file, this is where you do it.</span>
<span class="comments">;-</span>
PRO cgGoogleMapWidget::CLEANUP
    Obj_Destroy, self.mapCoord
    Obj_Destroy, self.random
    Ptr_Free, self.markers
    Ptr_Free, self.mapImage
    IF self.keep_image THEN BEGIN
        filename = cgPickFile(/Write, File=File_BaseName(self.filename), $
           Title='Save Google Map Image As...')
        IF filename NE "" THEN BEGIN
           File_Move, self.filename, filename 
        ENDIF ELSE BEGIN
           File_Delete, self.filename
        ENDELSE
    ENDIF
    IF Obj_Valid(self.tlb) THEN Widget_Control, self.tlb, /Destroy
END


<span class="comments">;+</span>
<span class="comments">; This method creates a cgMap map coordinate object for georeferencing the</span>
<span class="comments">; map image returned by Google maps. Use this object to establish a geocoordinate</span>
<span class="comments">; reference rectangle for drawing on top of the map image.</span>
<span class="comments">;-</span>
PRO cgGoogleMapWidget::CreateMapCoordObject

    Compile_Opt idl2
    
    Catch, theError
    IF theError NE 0 THEN BEGIN
       Catch, /CANCEL
       void = Error_Message()
       Obj_Destroy, mapCoord
       RETURN
    ENDIF
    
    <span class="comments">; Create a map object for navigating the map. Mercator projection, WGS-84 datum.</span>
    mapCoord = Obj_New('cgMap', 105, Datum=8)
  
    <span class="comments">; The metersPerPixel value is determined by using 6371000. meters for the</span>
    <span class="comments">; radius of the Earth, calculating the number of meters per deg lon, then</span>
    <span class="comments">; the number of pixels per deg lon (256/360 for zoom level 0), then figuring</span>
    <span class="comments">; in the zoom level.</span>
    metersPerPixel = cgGoogle_MetersPerPixel(self.zoomlevel)
    xy = mapCoord -> Forward(self.centerLon, self.centerLat)
    xrange = [xy[0] - ((self.map_xsize/2.0)*metersPerPixel), xy[0] + ((self.map_xsize/2.0)*metersPerPixel)]
    yrange = [xy[1] - ((self.map_ysize/2.0)*metersPerPixel), xy[1] + ((self.map_ysize/2.0)*metersPerPixel)]
    mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange, POSITION=self.map_position
    
    <span class="comments">; If there is current a map coordinate object, destroy it first.</span>
    IF Obj_Valid(self.mapCoord) THEN Obj_Destroy, self.mapCoord
    self.mapCoord = mapCoord
 
END



<span class="comments">;+</span>
<span class="comments">; The purpose of this method is obtain the map from Google as an image and display</span>
<span class="comments">; it in the draw widget window.</span>
<span class="comments">; </span>
<span class="comments">; :Keywords:</span>
<span class="comments">;     success: out, optional, type=boolean</span>
<span class="comments">;        On return, if set to 1 a map image was successfully obtained from Google. Otherwise, 0.</span>
<span class="comments">;-</span>
PRO cgGoogleMapWidget::Draw, SUCCESS=success

    Compile_Opt idl2
    
    Catch, theError
    IF theError NE 0 THEN BEGIN
       Catch, /CANCEL
       void = Dialog_Message('There was a problem in obtaining a map from Google Maps. See Command Log for details')
       Print, !Error_State.Msg
       IF Obj_Valid(netObject) THEN Obj_Destroy, netObject
       IF (!D.Flags AND 256) NE 0 THEN WSet, self.wid
       cgErase
       cgText, 0.05, 0.05, /Normal, 'Google Map Image is Unavailable', FONT=0
       success = 0
       RETURN
    ENDIF
    
    <span class="comments">; Assume success</span>
    success = 1
    
    <span class="comments">; Going to take some time!</span>
    Widget_Control, /Hourglass
    
    <span class="comments">; Basic string for obtaining a Google Static Map.</span>
    googleString = 'http://maps.googleapis.com/maps/api/staticmap?center='

    <span class="comments">; Add the center latitude and longitude</span>
    googleString = googleString + String(self.centerLat,format='(F0.4)') + ',' + $
       String(self.centerLon,format='(F0.4)')
       
    <span class="comments">; Add the zoom level.</span>
    googleString = googleString + '&zoom=' + StrTrim(self.zoomLevel,2)
    
    <span class="comments">; Add the size of the image.</span>
    googleString = googleString + '&size=' + StrTrim(self.map_xsize,2) + 'x' + StrTrim(self.map_ysize,2)
    
    <span class="comments">; Add the map type.</span>
    googleString = googleString + '&maptype=' + StrTrim(StrLowCase(self.mapType),2) 
    
    <span class="comments">; Add sensor information.</span>
    googleString = googleString + '&sensor=false
    
    <span class="comments">; Add image format information.</span>
    googleString = googleString + '&format=' + StrTrim(StrLowCase(self.imageType),2)
    
    <span class="comments">; Are there markers that have to be dealt with?</span>
    numMarkers = N_Elements(*self.markers)   
    IF (numMarkers GT 0) && self.visibleMarkers THEN BEGIN
       markerStr = ""
       FOR j=0,numMarkers-1 DO BEGIN
       
           <span class="comments">; This marker.</span>
           thisMarker = (*self.markers)[j]
           
           <span class="comments">; Default values.</span>
           IF thisMarker.size EQ "" THEN markerSize = 'normal' ELSE markerSize = thisMarker.size
           IF thisMarker.color EQ "" THEN markerColor = 'red' ELSE markerColor = thisMarker.color
           
           <span class="comments">; Colors have to be done in a different way.</span>
           triple = cgColor(markerColor, /Triple)
           color = String(triple[0], Format='(Z2.2)') +  String(triple[1], Format='(Z2.2)') +  String(triple[2], Format='(Z2.2)')
               markerStr = markerStr + "&markers=size:" + StrLowCase(markerSize) + "%7C"
           markerStr = markerStr + "color:0x" + color
           
           <span class="comments">; Need a label?</span>
           IF thisMarker.label NE "" THEN markerStr = markerStr + "%7C" + 'label:' + StrUpCase(thisMarker.label)
           
           <span class="comments">; Make a list of lats and lons.</span>
           lats = *thisMarker.lats
           lons = *thisMarker.lons
           FOR k=0,N_Elements(lats)-1 DO BEGIN
               markerStr = markerStr + "%7C" + Strtrim(lats[k],2) + ',' + StrTrim(lons[k],2)
           ENDFOR
       ENDFOR
       
       <span class="comments">; Add the marker string to the Google string.</span>
       googleString = googleString + markerStr
       
    ENDIF
    
    <span class="comments">; Create an IDL object to connect to the Internet with a URL.</span>
    netObject = Obj_New('IDLnetURL')
    returnName = netObject -> Get(URL=googleString, FILENAME=self.filename)
    Obj_Destroy, netObject
    
    <span class="comments">; Read the image and display it in the draw widget window.</span>
    IF N_Elements(returnName) NE 0 THEN BEGIN
        mapImage = Read_Image(self.filename, r, g, b)
        IF ~self.keep_image THEN File_Delete, self.filename
        IF N_Elements(r) NE 0 THEN TVLCT, r, g, b
        IF (!D.Flags AND 256) NE 0 THEN WSet, self.wid
        cgImage, mapImage, Position=self.map_position, KEEP_ASPECT=1, /Erase, Background='white'
        
        <span class="comments">; Do you need box axes?</span>
        IF self.box_axes THEN BEGIN
            mapCoord = self -> GetMapCoord(/UPDATE)
            cgMap_Grid, /Box_Axes, MAP=mapCoord
        ENDIF
        
       
        <span class="comments">; Store the image</span>
        IF ~Ptr_Valid(self.mapImage) THEN BEGIN
          self.mapImage = Ptr_New(mapImage, /No_Copy) 
        ENDIF ELSE *self.mapImage = mapImage
    ENDIF ELSE BEGIN
        IF (!D.Flags AND 256) NE 0 THEN WSet, self.wid
        success = 0
        cgErase
        cgText, 0.05, 0.05, /Normal, 'Google Map Image is Unavailable', FONT=0
    ENDELSE
       
    Widget_Control, Hourglass=0
END


<span class="comments">;+</span>
<span class="comments">; The purpose of this method is handle draw widget events. </span>
<span class="comments">; </span>
<span class="comments">;-</span>
PRO cgGoogleMapWidget::DrawWidgetEvents, event

    Compile_Opt idl2
    
    Catch, theError
    IF theError NE 0 THEN BEGIN
       Catch, /CANCEL
       void = Error_Message()
       RETURN
    ENDIF
        
    <span class="comments">; Need to call a method or procedure?</span>
    IF self.event_method NE "" THEN Call_Method, self.event_method, self, event
    IF self.event_pro NE "" THEN Call_Procedure, self.event_pro, event
    
END

<span class="comments">;+</span>
<span class="comments">; This method returns the map coordinate object that sets up the georeferencing</span>
<span class="comments">; coordinate system (in projected meter space) for drawing on top of the map image.</span>
<span class="comments">; </span>
<span class="comments">; :Keywords:</span>
<span class="comments">;     update: in, optional, type=boolean, default=0</span>
<span class="comments">;         Set this keyword to make sure a new map coordinate object is created.</span>
<span class="comments">;-</span>
FUNCTION cgGoogleMapWidget::GetMapCoord, UPDATE=update

    Compile_Opt idl2
    
    Catch, theError
    IF theError NE 0 THEN BEGIN
       Catch, /CANCEL
       void = Error_Message()
       RETURN, Obj_New()
    ENDIF
    
    <span class="comments">; If updating, we will need a new map coordinate object.</span>
    IF Keyword_Set(update) THEN Obj_Destroy, self.mapCoord
    
    <span class="comments">; If the map coordinate is not valid, then create one.</span>
    IF ~Obj_Valid(self.mapCoord) THEN self -> CreateMapCoordObject
    
    <span class="comments">; Return the current map coordinate object.</span>
    RETURN, self.mapCoord
    
END

<span class="comments">;+</span>
<span class="comments">; The properties of the object are retrieved with this method.</span>
<span class="comments">;</span>
<span class="comments">; :Keywords:</span>
<span class="comments">;     center_latitude: out, optional, type=float</span>
<span class="comments">;         The center latitude of the requested Google map. </span>
<span class="comments">;     center_longitude: out, optional, type=float</span>
<span class="comments">;         The center longitude of the requested Google map. </span>
<span class="comments">;     event_method: out, optional, type='string'</span>
<span class="comments">;         The name of the event handler method for the draw widget. </span>
<span class="comments">;     filename: out, optional, type='string'</span>
<span class="comments">;         The name of the file where the map image is stored.</span>
<span class="comments">;     imagetype: out, optional, type=string</span>
<span class="comments">;         The type of image format the Google map should be returned in. </span>
<span class="comments">;     mapcoord: out, optional, type=object</span>
<span class="comments">;         The map coordinate object. Another way to obtain the map coordinate object is</span>
<span class="comments">;         to use the GetMapCoord method.</span>
<span class="comments">;     mapimage: out, optional, type=bytarr</span>
<span class="comments">;         The image variable containing the Goggle map. The size and dimensions</span>
<span class="comments">;         of the image depend upon what was retrieved from Google.</span>
<span class="comments">;     mapposition: out, optional, type=fltarr</span>
<span class="comments">;         The position of the map in the display window.</span>
<span class="comments">;     maptype: out, optional, type=boolean</span>
<span class="comments">;         The type of Google map requested by the program.</span>
<span class="comments">;     xsize: out, optional, type=int</span>
<span class="comments">;         The X size of the program's draw widget.</span>
<span class="comments">;     ysize: out, optional, type=int</span>
<span class="comments">;         The Y size of the program's draw widget.</span>
<span class="comments">;     zoomlevel: out, optional, type=integer</span>
<span class="comments">;         The zoom level of the requested Google map. </span>
<span class="comments">;-</span>
PRO cgGoogleMapWidget::GetProperty, $
    CENTER_LATITUDE=centerLat, $
    CENTER_LONGITUDE=centerLon, $
    EVENT_METHOD=event_method, $
    FILENAME=filename, $
    MAPIMAGE=mapimage, $
    IMAGETYPE=imageType, $
    MAPPOSITION=map_position, $
    MAPCOORD=mapCoord, $
    MAPTYPE=maptype, $
    MARKERS=markers, $
    WID=wid, $
    XSIZE=xsize, $
    YSIZE=ysize, $
    ZOOMLEVEL=zoomlevel

    Compile_Opt idl2
    
    Catch, theError
    IF theError NE 0 THEN BEGIN
       Catch, /CANCEL
       void = Error_Message()
       RETURN
    ENDIF
    
    IF Arg_Present(centerLat) THEN centerLat = self.centerLat
    IF Arg_Present(centerLon) THEN centerLon = self.centerLon
    IF Arg_Present(filename) THEN filename = self.filename
    IF Arg_Present(imageType) THEN imageType = self.imageType
    IF Arg_Present(event_method) THEN event_method = self.event_method
    IF Arg_Present(mapCoord) THEN mapCoord = self.mapCoord
    IF Arg_Present(mapImage) THEN mapImage = *self.mapImage
    IF Arg_Present(map_position) THEN map_position = self.map_position
    IF Arg_Present(maptype) THEN maptype = self.maptype
    IF Arg_Present(markers) THEN IF Ptr_Valid(self.markers) THEN markers = *self.markers
    IF Arg_Present(wid) THEN wid = self.wid
    IF Arg_Present(xsize) THEN xsize = self.xsize
    IF Arg_Present(ysize) THEN ysize = self.ysize
    IF Arg_Present(zoomlevel) THEN zoomlevel = self.zoomlevel
    
END



<span class="comments">;+</span>
<span class="comments">; The purpose of this method is to display a map with a particular map type.</span>
<span class="comments">; </span>
<span class="comments">; :Params:</span>
<span class="comments">;    event: in, required, type=varies</span>
<span class="comments">;       The event structure passed to this event handler method from which the map</span>
<span class="comments">;       type can be obtained. Or, the map type itself, passed as a string.</span>
<span class="comments">;-</span>
PRO cgGoogleMapWidget::Map_Type, event

    Compile_Opt idl2
    
    Catch, theError
    IF theError NE 0 THEN BEGIN
       Catch, /CANCEL
       void = Error_Message()
       RETURN
    ENDIF

    IF Size(event, /TNAME) EQ 'STRING' THEN BEGIN
       mapType = event
    ENDIF ELSE BEGIN
       mapType = Widget_Info(event.id, /UNAME)
    ENDELSE
    mapType = StrLowCase(mapType)
    
    validTypes = ['roadmap', 'terrain', 'satellite', 'hybrid']
    index = Where(validTypes EQ mapType, count)
    IF count EQ 0 THEN Message, 'Invalid map type: ' + StrUpCase(mapType)
    
    <span class="comments">; Store it.</span>
    self.mapType = mapType
    
    <span class="comments">; Draw the new map.</span>
    self -> Draw
       
END


<span class="comments">;+</span>
<span class="comments">; The purpose of this method is to draw the initial map plot in the draw widget.</span>
<span class="comments">; </span>
<span class="comments">;-</span>
PRO cgGoogleMapWidget::Notify_Realize

   Compile_Opt idl2
   
   <span class="comments">; Standard error handling.</span>
   Catch, theError
   IF theError NE 0 THEN BEGIN
      Catch, /Cancel
      void = Error_Message()
      RETURN
   ENDIF

    <span class="comments">; Get the window index number of this draw widget.</span>
    Widget_Control, self.drawID, Get_Value=wid
    self.wid = wid
    
    <span class="comments">; Set the draw widget up to handle events.</span>
   Widget_Control, self.drawID, Set_UValue={object:self, method:'DrawWidgetEvents'}
    
     <span class="comments">; Draw the initial map image.</span>
    self -> Draw
    
END


<span class="comments">;+</span>
<span class="comments">; The purpose of this method is to set some of the object's properties. If</span>
<span class="comments">; you wish to retrive a new map after updating the object properties, be sure</span>
<span class="comments">; to set the DRAW keyword.</span>
<span class="comments">;</span>
<span class="comments">; :Keywords:</span>
<span class="comments">;     center_latitude: in, optional, type=float, default=40.60</span>
<span class="comments">;         The center latitude of the requested Google map. If not provided, the latitude of</span>
<span class="comments">;         Fort Collins, Colorado, home of Coyote. Latitudes are only recognized to four</span>
<span class="comments">;         decimals values of precision.</span>
<span class="comments">;     center_longitude: in, optional, type=float, default=-105.10</span>
<span class="comments">;         The center longitude of the requested Google map. If not provided, the longitude of</span>
<span class="comments">;         Fort Collins, Colorado, home of Coyote. Longitude are only recognized to four</span>
<span class="comments">;         decimals values of precision.</span>
<span class="comments">;     draw: in, optional, type=boolean, default=0</span>
<span class="comments">;         Set this keyword if you want to immediate retrieve and display a new map with the</span>
<span class="comments">;         updated properties.</span>
<span class="comments">;     event_method: in, optional, type='string'</span>
<span class="comments">;         The name of the event handler method for the draw widget. If you use this keyword,</span>
<span class="comments">;         you will also need to write this event handler module. It gets sent one positional</span>
<span class="comments">;         parameter, the event structure created by the draw widget.</span>
<span class="comments">;     event_pro: in, optional, type='string'</span>
<span class="comments">;         The name of an external event handler procedure for the draw widget. The event handler</span>
<span class="comments">;         procedure gets sent one positional parameter, the event structure created by the draw widget.</span>
<span class="comments">;     imagetype: in, optional, type=string, default='png32'</span>
<span class="comments">;         The type of image format the Google map should be returned in. The default is</span>
<span class="comments">;         a 32-bit full color PNG file. The image types are given in the Google Static Map</span>
<span class="comments">;         API documentation and are as follows: png or png8, png32, gif, jpg, and jpg-baseline.</span>
<span class="comments">;     maptype: in, optional, type=string, default='terrain'</span>
<span class="comments">;         Set this keyword to the type of map you wish to retrieve from Google Maps. The</span>
<span class="comments">;         choices are listed in the Google Static Map API documentation and are: "roadmap",</span>
<span class="comments">;         "terrain", "satellite", and "hybrid".</span>
<span class="comments">;     markers: in, optional, type=structure</span>
<span class="comments">;         A scalar or array of cgGoogleMapMarker structures. If present, the markers will</span>
<span class="comments">;         be requested with the map from Google. The GoogleMapMarker structure is defined</span>
<span class="comments">;         like this::</span>
<span class="comments">;            struct = { cgGOOGLEMAPMARKER, $</span>
<span class="comments">;               size: "", $         ; The marker size ("tiny", "small", "mid" or "normal")</span>
<span class="comments">;               color: "", $        ; A color name as provided by cgColor.</span>
<span class="comments">;               label: "", $        ; A single uppercase character label from the set {A-Z,0-9}.</span>
<span class="comments">;               lats: Ptr_New(), $  ; A pointer to one or more latitude values.</span>
<span class="comments">;               lons: Ptr_New() }   ; A pointer to one or more longitude values.</span>
<span class="comments">;         Note that the user will be responsible for freeing the pointers in the MARKERS</span>
<span class="comments">;         structure. This program will not do that.</span>
<span class="comments">;     visiblemarkers: in, optional, type=boolean, default=1</span>
<span class="comments">;         Set this keyword to 0 to temporarily turn off the display of the markers. Normally,</span>
<span class="comments">;         markers are drawn (if present), unless this flag is set to 0.</span>
<span class="comments">;     zoomlevel: in, optional, type=integer, default=12</span>
<span class="comments">;         The zoom level of the requested Google map. Should be an integer between 0 and 21.</span>

PRO cgGoogleMapWidget::SetProperty, $
    CENTER_LATITUDE=centerLat, $
    CENTER_LONGITUDE=centerLon, $
    DRAW=draw, $
    EVENT_METHOD=event_method, $
    EVENT_PRO=event_pro, $
    IMAGETYPE=imageType, $
    MAPTYPE=maptype, $
    MARKERS=markers, $
    VISIBLEMARKERS=visiblemarkers, $
    ZOOMLEVEL=zoomlevel

    Compile_Opt idl2
    
    Catch, theError
    IF theError NE 0 THEN BEGIN
       Catch, /CANCEL
       void = Error_Message()
       RETURN
    ENDIF
    
    IF N_Elements(centerLat) NE 0 THEN self.centerLat = centerLat
    IF N_Elements(centerLon) NE 0 THEN self.centerLon = centerLon
    IF N_Elements(imageType) NE 0 THEN self.imageType = imageType
    IF N_Elements(event_method) NE 0 THEN self.event_method = event_method
    IF N_Elements(event_pro) NE 0 THEN self.event_pro = event_pro
    IF N_Elements(maptype) NE 0 THEN self.maptype = maptype
    IF N_Elements(markers) NE 0 THEN BEGIN
       IF Ptr_Valid(self.markers) THEN *self.markers = markers ELSE self.markers = Ptr_New(markers)
    ENDIF
    IF N_Elements(visiblemarkers) NE 0 THEN self.visiblemarkers = Keyword_Set(visiblemarkers)
    IF N_Elements(zoomlevel) NE 0 THEN self.zoomlevel = zoomlevel
        
    <span class="comments">; Things have changed. Update the map coordinate object.</span>
    self -> CreateMapCoordObject
    
    <span class="comments">; Need to update the image?</span>
    IF Keyword_Set(draw) THEN self -> Draw
    
END

<span class="comments">;+</span>
<span class="comments">; The purpose of this method is to make the draw widget window the current window.</span>
<span class="comments">;-</span>
PRO cgGoogleMapWidget::SetWindow

    WSet, self.wid
    
END

<span class="comments">;+</span>
<span class="comments">; The purpose of this method is to zoom into the map by</span>
<span class="comments">; increasing the zoom factor.</span>
<span class="comments">; </span>
<span class="comments">; :Params:</span>
<span class="comments">;    event: in, optional, type=structure</span>
<span class="comments">;       The event structure passed to this event handler method. Not used currently.</span>
<span class="comments">;-</span>
PRO cgGoogleMapWidget::Zoom_In, event

    Compile_Opt idl2
    
    Catch, theError
    IF theError NE 0 THEN BEGIN
       Catch, /CANCEL
       void = Error_Message()
       RETURN
    ENDIF

    self.zoomlevel = (self.zoomlevel + 1) &lt<span class="comments">; 21</span>
    self -> Draw
    self -> CreateMapCoordObject
       
END


<span class="comments">;+</span>
<span class="comments">; The purpose of this method is to zoom out of the map by</span>
<span class="comments">; decreasing the zoom factor.</span>
<span class="comments">; </span>
<span class="comments">; :Params:</span>
<span class="comments">;    event: in, optional, type=structure</span>
<span class="comments">;       The event structure passed to this event handler method. Not used currently.</span>
<span class="comments">;-</span>
PRO cgGoogleMapWidget::Zoom_Out, event

    Compile_Opt idl2
    
    Catch, theError
    IF theError NE 0 THEN BEGIN
       Catch, /CANCEL
       void = Error_Message()
       RETURN
    ENDIF

    self.zoomlevel = (self.zoomlevel - 1) > 0
    self -> Draw
    self -> CreateMapCoordObject
       
END


<span class="comments">;+</span>
<span class="comments">; This is the realize notify routine for the widget. Its function call the</span>
<span class="comments">; Realize_Notify method to draw the initial plot in the display window.</span>
<span class="comments">; </span>
<span class="comments">; :Params:</span>
<span class="comments">;    id: in, required, type=int</span>
<span class="comments">;        The widget identifier of the widget that has been realized.</span>
<span class="comments">;-</span>
PRO cgGoogleMapWidget_Notify_Realize, id

   Widget_Control, id, Get_UValue=struct
   Call_Method, 'Notify_Realize', struct.object
   
END


<span class="comments">;+</span>
<span class="comments">; This is the cleanup routine for the widget. Its function is to destroy</span>
<span class="comments">; the underlying program object.</span>
<span class="comments">; </span>
<span class="comments">; :Params:</span>
<span class="comments">;    tlb: in, required, type=int</span>
<span class="comments">;        The widget identifier of the parent base widget that just died.</span>
<span class="comments">;-</span>
PRO cgGoogleMapWidget_Cleanup, tlb

   Widget_Control, tlb, Get_UValue=self
   Obj_Destroy, self
   
END


<span class="comments">;+</span>
<span class="comments">; This is the main event handler for the program. All events come here</span>
<span class="comments">; to be distributed to the appropriate event handler method according</span>
<span class="comments">; to instructions packed into the UVALUE of any widget generating an</span>
<span class="comments">; event.</span>
<span class="comments">; </span>
<span class="comments">; :Params:</span>
<span class="comments">;    event: in, required, type=structure</span>
<span class="comments">;        The event structure passed by the window manager.</span>
<span class="comments">;-</span>
PRO cgGoogleMapWidget_Events, event

   Compile_Opt idl2
   
   <span class="comments">; Standard error handling.</span>
   Catch, theError
   IF theError NE 0 THEN BEGIN
      Catch, /Cancel
      void = Error_Message()
      RETURN
   ENDIF
   
    Widget_Control, event.id, Get_UValue=instructions
    Call_Method, instructions.method, instructions.object, event

END


<span class="comments">;+</span>
<span class="comments">; The object class definition for the cgGoogleMapWidget class.</span>
<span class="comments">; </span>
<span class="comments">; :Params:</span>
<span class="comments">;     class: out, optional, type=structure</span>
<span class="comments">;        The object class definition as a structure. Occasionally, comes in handy.</span>
<span class="comments">;-</span>
PRO cgGoogleMapWidget__Define, class

    class = { cgGoogleMapWidget, $
              box_axes: 0B, $          <span class="comments">; A flag that indicates box axes should be drawn on the image.</span>
              centerLat: 0.0D, $       <span class="comments">; The center latitude of the Google map.</span>
              centerLon: 0.0D, $       <span class="comments">; The center longitude of the Google map.</span>
              drawID: 0L, $            <span class="comments">; The draw widget identifier.</span>
              event_method: "", $      <span class="comments">; The event method of the draw widget.</span>
              event_pro: "", $         <span class="comments">; An external event handler procedure for the draw widget.</span>
              filename: "", $          <span class="comments">; The name of the image file containing the map after download.</span>
              keep_image: 0B, $        <span class="comments">; Set this flag to save the Google map as an image.</span>
              imageType: "", $         <span class="comments">; The type of image to download (png, jpeg, etc.).</span>
              mapImage: Ptr_New(), $   <span class="comments">; The Goggle map as an image variable.</span>
              map_position: FltArr(4), $ <span class="comments">; The position of the map in the draw widget.</span>
              map_xsize: 0L, $         <span class="comments">; The X size of the map.</span>
              map_ysize: 0L, $         <span class="comments">; The Y size of the map.</span>
              mapType: "", $           <span class="comments">; The type of Google map (terrain, roadmap, satellite, etc.).</span>
              mapCoord: Obj_New(), $   <span class="comments">; A map coordinate object for drawing on top of the map.</span>
              markers: Ptr_New(), $    <span class="comments">; Markers that Google puts on the map.</span>
              random: Obj_New(), $     <span class="comments">; A random number generator object.</span>
              tlb: 0L, $               <span class="comments">; The parent of this widget-object.</span>
              tempDir: "", $           <span class="comments">; The directory where the map is downloaded as an image.</span>
              visibleMarkers: 0B, $    <span class="comments">; A flag that indicates if the markers are shown or not.</span>
              wid: 0L, $               <span class="comments">; The window index number of the draw widget.</span>
              xsize: 0L, $             <span class="comments">; The X size of the draw widget. No larger than 640 pixels.</span>
              ysize: 0L, $             <span class="comments">; The Y size of the draw widget. No larger than 640 pixels.</span>
              zoomlevel: 0 $           <span class="comments">; The zoom level of the Google Map (0 to 21).</span>
            }
             
END


</code>
    </div>
  </body>
</html>