<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:56:06 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>cggeomap.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="cggeomap.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">; docformat = 'rst'</span>
<span class="comments">;</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;   The purpose of this function is to translate a GEOTIFF structure</span>
<span class="comments">;   (as returned by QUERY_TIFF or READ_TIFF) into a map coordinate</span>
<span class="comments">;   object (cgMap) that can be used to georeference images with a </span>
<span class="comments">;   map data coordinate system. The Coyote Library is required.</span>
<span class="comments">;</span>
<span class="comments">;******************************************************************************************;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  Copyright (c) 2011, by Fanning Software Consulting, Inc. All rights reserved.           ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  Redistribution and use in source and binary forms, with or without                      ;</span>
<span class="comments">;  modification, are permitted provided that the following conditions are met:             ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;      * Redistributions of source code must retain the above copyright                    ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer.                     ;</span>
<span class="comments">;      * Redistributions in binary form must reproduce the above copyright                 ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer in the               ;</span>
<span class="comments">;        documentation and/or other materials provided with the distribution.              ;</span>
<span class="comments">;      * Neither the name of Fanning Software Consulting, Inc. nor the names of its        ;</span>
<span class="comments">;        contributors may be used to endorse or promote products derived from this         ;</span>
<span class="comments">;        software without specific prior written permission.                               ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  THIS SOFTWARE IS PROVIDED BY FANNING SOFTWARE CONSULTING, INC. ''AS IS'' AND ANY        ;</span>
<span class="comments">;  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES    ;</span>
<span class="comments">;  OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT     ;</span>
<span class="comments">;  SHALL FANNING SOFTWARE CONSULTING, INC. BE LIABLE FOR ANY DIRECT, INDIRECT,             ;</span>
<span class="comments">;  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED    ;</span>
<span class="comments">;  TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;         ;</span>
<span class="comments">;  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND             ;</span>
<span class="comments">;  ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT              ;</span>
<span class="comments">;  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS           ;</span>
<span class="comments">;  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.                            ;</span>
<span class="comments">;******************************************************************************************;</span>
<span class="comments">;</span>
<span class="comments">;+</span>
<span class="comments">;   The purpose of this function is to translate a GEOTIFF structure</span>
<span class="comments">;   (as returned by QUERY_TIFF or READ_TIFF) into a map coordinate</span>
<span class="comments">;   object (cgMap) that can be used to georeference images with a </span>
<span class="comments">;   map data coordinate system. The Coyote Library is required.</span>
<span class="comments">;</span>
<span class="comments">;   It is not possible to have a one-to-one mapping between every GeoTIFF file and a map projection</span>
<span class="comments">;   in IDL, since IDL has a limited number of map projections and datums available. And, even at that,</span>
<span class="comments">;   I have not implemented all of IDL's map projections or datums, only those that I thought were most</span>
<span class="comments">;   likely to be encountered in my own work. If you run into a GeoTIFF file that does not work in this</span>
<span class="comments">;   code (either because of an error in the code or because it is not supported), please contact me.</span>
<span class="comments">;   I am interested in supporting as many GeoTIFF files as possible and I will take pains to do so if</span>
<span class="comments">;   I know they are needed.</span>
<span class="comments">;   </span>
<span class="comments">; :Categories:</span>
<span class="comments">;    Graphics, Map Projections</span>
<span class="comments">;    </span>
<span class="comments">; :Returns:</span>
<span class="comments">;     A cgMap coordinate object is returned containing the map projection information</span>
<span class="comments">;     for the image.</span>
<span class="comments">;       </span>
<span class="comments">; :Params:</span>
<span class="comments">;    image:  in, optional, type=various</span>
<span class="comments">;        A GeoTIFF image. This can optionally be the name of a GeoTiff file.</span>
<span class="comments">;        If a filename is used, do not pass the geoTiff parameter, as this</span>
<span class="comments">;        parameter will be obtained from the GeoTiff file.</span>
<span class="comments">;               </span>
<span class="comments">; :Keywords:</span>
<span class="comments">;     boundary: out, optional, type=array</span>
<span class="comments">;        A four-element array giving the boundaries of the map projection in the form</span>
<span class="comments">;        [x0,y0,x1,y1]. This is a more convenient way of expressing the range</span>
<span class="comments">;        of the map space.</span>
<span class="comments">;     ccolor: in, optional, type=string, default='Charcoal'</span>
<span class="comments">;        The name of a color the map continents should be displayed with. The default</span>
<span class="comments">;        is "charcoal". Color names are those supported by cgColor.</span>
<span class="comments">;     clip: in, optional, type=boolean, default=0</span>
<span class="comments">;         Set this keyword to display the image (assumes the `Display` keyword is set)</span>
<span class="comments">;         with a two-precent histogram clipping.</span>
<span class="comments">;     continents: in, optional, type=boolean, default=0</span>
<span class="comments">;         If a cgMap object is made successfully, then setting this keyword</span>
<span class="comments">;         will add a cgMapContinents object to the cgMap object.   </span>
<span class="comments">;     display: in, optional, type=boolean, default=0</span>
<span class="comments">;         Set this keyword to display the image with the map annotations in a </span>
<span class="comments">;         resizeable cgWindow.          </span>
<span class="comments">;     ellipsoid: out, optional, type=string</span>
<span class="comments">;         The name of the ellipsoid used in the GeoTiff file.          </span>
<span class="comments">;     gcolor: in, optional, type=string, default='Gray'</span>
<span class="comments">;         The name of a color the map grid should be displayed with. The default</span>
<span class="comments">;         is "gray". Color names are those supported by cgColor.</span>
<span class="comments">;     geotiff: in, optional, type=structure</span>
<span class="comments">;        A GeoTIFF structure of geoTags. Normally obtained by calling</span>
<span class="comments">;        QUERY_TIFF or READ_TIFF, but will be read from the file if a</span>
<span class="comments">;        filename is passed as the first positional parameter. If the geotag</span>
<span class="comments">;        is read from the file, it can be passed back to the user by setting</span>
<span class="comments">;        this keyword to a named variable.         </span>
<span class="comments">;     grid: in, optional, type=boolean, default=0</span>
<span class="comments">;         If a cgMap object is made successfully, then setting this keyword</span>
<span class="comments">;         will add a cgMapGrid object to the cgMap object.  </span>
<span class="comments">;     image: out, optional, type=varies</span>
<span class="comments">;         Set this keyword to a named variable that on exit will contain the image data.                     </span>
<span class="comments">;     latlonbox: out, optional, type=array</span>
<span class="comments">;        A four-element array giving the boundaries of the map projection in the</span>
<span class="comments">;        Google Map form of [north, south, east, west]. This is useful when you</span>
<span class="comments">;        are creating image overlays to be added to Google Earth.</span>
<span class="comments">;     map_projection: out, optional, type=string</span>
<span class="comments">;         The name of the map projection found in the GeoTiff file.</span>
<span class="comments">;     mcolor: in, optional, type=string, default='Black'</span>
<span class="comments">;         The name of a color the map should be displayed in. (Normally the map</span>
<span class="comments">;         border and map title are displayed in this color.)</span>
<span class="comments">;     onimage: in, optional, type=boolean, default=0</span>
<span class="comments">;         Set this keword if the map object is to get its position from the last</span>
<span class="comments">;         cgImage command issued.</span>
<span class="comments">;     palette: out, optional, type=bytarr</span>
<span class="comments">;         If the GeoTiff file contains RGB color vectors, and keywords to cgGeoTiff cause the</span>
<span class="comments">;         file to be read (e.g, IMAGE or DISPLAY), then this output keyword will contain those</span>
<span class="comments">;         vectors in a 3-by-256 byte array.</span>
<span class="comments">;     silent: in, optional, type=boolean, default=0</span>
<span class="comments">;         IDL cannot map every GeoTiff image to a supported map projection or datum.</span>
<span class="comments">;         Normally, if the GeoTIFF image is unsupported, an error message is issued.</span>
<span class="comments">;         Setting this keyword will suppress such error messages. If you do this, you</span>
<span class="comments">;         MUST check the SUCCESS keyword to see if the program ran successfully. (Of</span>
<span class="comments">;         course, it is a good idea to check it in any case!)</span>
<span class="comments">;     sub_rect: in, optional, type=integer</span>
<span class="comments">;         Set this keyword to a four-element array, [x, y, width, height], that </span>
<span class="comments">;         specifies a rectangular region within the file to extract. Only the </span>
<span class="comments">;         rectangular portion of the image selected by this keyword is read and </span>
<span class="comments">;         returned. The rectangle is measured in pixels from the lower left </span>
<span class="comments">;         corner (right hand coordinate system). If this keyword is not use, the</span>
<span class="comments">;         entire image is read.</span>
<span class="comments">;     success: out, optional, type=boolean, default=0</span>
<span class="comments">;         An output variable that will contain a 1 if the map coordinate object was</span>
<span class="comments">;         created successfully. Or to a 0 if it was not created successfully.</span>
<span class="comments">;     title: in, optional, type=string, default=""                      </span>
<span class="comments">;         The title of the map projection.</span>
<span class="comments">;     _extra: in, optional</span>
<span class="comments">;         Any keyword appropriate for cgImage can be collected and passed along if</span>
<span class="comments">;         the DISPLAY keyword is also set.</span>
<span class="comments">;          </span>
<span class="comments">; :Examples:</span>
<span class="comments">;    To display a GeoTiff image in cgWindow with map annotations::</span>
<span class="comments">;       file = 'C:\IDL\data\tiff\AF03sep15b.n16-VIg.tif'</span>
<span class="comments">;       mapCoord = cgGeoMap(file, /Continents, /Grid, /Display)</span>
<span class="comments">;       </span>
<span class="comments">; :Author:</span>
<span class="comments">;    FANNING SOFTWARE CONSULTING::</span>
<span class="comments">;        David W. Fanning </span>
<span class="comments">;        1645 Sheely Drive</span>
<span class="comments">;        Fort Collins, CO 80526 USA</span>
<span class="comments">;        Phone: 970-221-0438</span>
<span class="comments">;        E-mail: david@idlcoyote.com</span>
<span class="comments">;        Coyote's Guide to IDL Programming: http://www.idlcoyote.com/</span>
<span class="comments">;</span>
<span class="comments">; :History:</span>
<span class="comments">;     Modification History::</span>
<span class="comments">;        Converted from old GeoTIff program in Catalyst Library to run with Coyote Graphics routines.</span>
<span class="comments">;           9 November 2011. David W. Fanning.</span>
<span class="comments">;         Assuming meters as unit length if can't find linear measure in file. 1 Dec 2011. DWF.</span>
<span class="comments">;         Added UTM Zone 18S (projection 29178) for LandSAT MSS images over Amazon. 1 Dec 2011. DWF.</span>
<span class="comments">;         Added the ability to pass cgImage keywords via the keyword inheritance mechanism. 1 Dec 2011. DWF.</span>
<span class="comments">;         Added SUB_RECT keyword. 5 Dec 2011. DWF.</span>
<span class="comments">;         Added ability to read GOES EAST and GOES WEST GeoTiff files  from this NOAA web site:</span>
<span class="comments">;            http://http://www.osdpd.noaa.gov/ml/gis/index.html. 26 Dec 2011. DWF.</span>
<span class="comments">;         Modified code to read GeoTiff files created by HEG v2.11 from HDF-EOS2 grid files. 30 Dec 2011. DWF.</span>
<span class="comments">;         Modified to read multi-dimensional GeoTiff images and reverse the images correct. 12 Jan 2012. DWF.</span>
<span class="comments">;         Write base filename as title for window if the DISPLAY keyword is set. 22 Feb 2012. DWF.</span>
<span class="comments">;         Had inexplicably left out CENTER_LATITUDE parameter in Equirectangular projection. 30 July 2012. DWF.</span>
<span class="comments">;         Added PALETTE keyword to return the RGB color palette present in the file, if any. 16 August 2012. DWF.</span>
<span class="comments">;         Moved the geotiff argument to a GEOTIFF keyword, as I always expect it to be this way. 6 Sept 2012. DWF.</span>
<span class="comments">;         Removed UTM/WGS84 warning message in IDL 8.2, as this problem has been fixed in IDL 8.2. 2 Oct 2012. DWF.</span>
<span class="comments">;         Added BOUNDARY, ELLIPSOID, LATLONBOX, and MAP_PROJECTION output keywords to facilitate </span>
<span class="comments">;            creating Google Earth overlays. 30 Oct 2012. DWF.</span>
<span class="comments">;         </span>
<span class="comments">; :Copyright:</span>
<span class="comments">;     Copyright (c) 2011-2012, Fanning Software Consulting, Inc.</span>
<span class="comments">;-</span>
Function cgGeoMap, image, $
    BOUNDARY=boundary, $
    CLIP=clip, $
    DISPLAY=display, $
    ELLIPSOID=ellipsoid, $
    GCOLOR=gcolor, $
    GEOTIFF=geotiff, $
    GRID=grid, $
    CCOLOR=ccolor, $
    CONTINENTS=continents, $
    IMAGE=outImage, $
    LATLONBOX=latlonbox, $
    MAP_PROJECTION=map_projection, $
    MCOLOR=mcolor, $
    ONIMAGE=onimage, $
    PALETTE=palette, $
    SILENT=silent, $
    SUB_RECT=sub_rect, $
    SUCCESS=success, $
    TITLE=title, $
    _EXTRA=extra

    <span class="comments">; Compiler options.</span>
    Compile_Opt DEFINT32
    Compile_Opt STRICTARR
    Compile_Opt STRICTARRSUBS
    Compile_Opt LOGICAL_PREDICATE
       
    Catch, theError
    IF theError NE 0 THEN BEGIN
        Catch, /CANCEL
        IF ~Keyword_Set(silent) THEN void = Error_Message()
        success = 0
        RETURN, Obj_New()
    ENDIF
   
    <span class="comments">; Set default values of keywords.</span>
    SetDefaultValue, mcolor, 'black'
    SetDefaultValue, gcolor, 'charcoal'
    SetDefaultValue, ccolor, 'charcoal'
    SetDefaultValue, title, ""
    onimage = Keyword_Set(onimage)
    
   <span class="comments">; If no parameters, ask about reading a GeoTiff file.</span>
   IF N_Elements(image) EQ 0 THEN BEGIN
        geofile = cgPickfile(Title='Select GeoTiff File...', FILTER=['*.tif', '*.tiff'])
        IF geofile EQ "" THEN RETURN, Obj_New()
        
        <span class="comments">; Read the image query file. Make sure it is a GeoTiff file.</span>
        ok = Query_Tiff(geofile, info, GEOTIFF=geotiff)
        IF ~ok THEN Message, 'Selected file does not appear to be a TIFF file.'
        IF Size(geotiff, /TNAME) NE 'STRUCT' THEN Message, 'Selected file does not appear to be a GeoTiff file.'
        channels = info.channels
        dims = info.dimensions
        CASE channels OF
            1: BEGIN
               xsize = dims[0]
               ysize = dims[1]
               END
               
            3: BEGIN
               indices = Where(dims NE 3, count)
               IF count NE 2 THEN Message, 'Cannot determine the image dimensions.'
               xsize = dims[indices[0]]
               ysize = dims[indices[1]]
               END
               
            ELSE: Message, 'Do not know how to handle an image with ' + StrTrim(channels,2) + ' channels'
        ENDCASE
        
        <span class="comments">; For further processing we need image to be equal to geofile.</span>
        image = geofile
   ENDIF
   
   
   <span class="comments">; Is the first parameter the name of a file or an image?</span>
   IF (N_Elements(image) NE 0) || (N_Elements(geofile) NE 0) THEN BEGIN
            
       <span class="comments">; Is the parameter a string?</span>
       IF Size(image, /TNAME) NE 'STRING' THEN BEGIN
       
           <span class="comments">; Then we are going to assume this is an image and that you have passed</span>
           <span class="comments">; a geotiff structure to us.</span>
           IF N_Elements(geotiff) EQ 0 THEN Message, 'A GeoTiff structure must be passed with the image'
           
           <span class="comments">; Get the image sizes</span>
           dims = Image_Dimensions(image, XSIZE=xsize, YSIZE=ysize)
       
       ENDIF ELSE BEGIN
       
           <span class="comments">; Is it a filename? Can we find the file?</span>
           ok = File_Test(image)
           IF ~ok THEN Message, 'Cannot locate the specified file: ' +  image
           
            <span class="comments">; Read the image query file. Make sure it is a GeoTiff file.</span>
            ok = Query_Tiff(image, info, GEOTIFF=geotiff)
            IF ~ok THEN Message, 'Specified file does not appear to be a TIFF file.'
            IF Size(geotiff, /TNAME) NE 'STRUCT' THEN Message, 'Specified file does not appear to be a GeoTiff file.'
            channels = info.channels
            dims = info.dimensions
            CASE channels OF
                1: BEGIN
                   xsize = dims[0]
                   ysize = dims[1]
                   END
                   
                3: BEGIN
                   indices = Where(dims NE 3, count)
                   IF count NE 2 THEN Message, 'Cannot determine the image dimensions.'
                   xsize = dims[indices[0]]
                   ysize = dims[indices[1]]
                   END
                   
                4: BEGIN
                   indices = Where(dims NE 4, count)
                   IF count NE 2 THEN Message, 'Cannot determine the image dimensions.'
                   xsize = dims[indices[0]]
                   ysize = dims[indices[1]]
                   END

                ELSE: Message, 'Do not know how to handle an image with ' + StrTrim(channels,2) + ' channels'
            ENDCASE
      ENDELSE
   ENDIF

   <span class="comments">; Get the fields of the geotiff structure.</span>
   fields = Tag_Names(geotiff)
   
   <span class="comments">; We can only handle raster images with projected coordinate systems, unless this is </span>
   <span class="comments">; a GeoTiff file with Geographic model, such as GOES images. If it is one of these images,</span>
   <span class="comments">; then I am going to assign a project code to this image and handle it in the special projection</span>
   <span class="comments">; section below.</span>
   geoModel = 0
   gtModelIndex = Where(fields EQ 'GTMODELTYPEGEOKEY', gtModelType)
   
   IF gtModelType GT 0 THEN BEGIN
   
       IF (geotiff.gtModelTypeGeoKey EQ 2) THEN BEGIN
       
           <span class="comments">; We need a map projection code if we have one in the file</span>
           index = Where(fields EQ 'PROJECTEDCSTYPEGEOKEY', projCount)
           IF projCount GT 0 THEN projCode = geotiff.PROJECTEDCSTYPEGEOKEY
           index = Where(fields EQ 'PROJECTIONGEOKEY', projCount)
           IF projCount GT 0 THEN projCode = geotiff.PROJECTIONGEOKEY
           IF N_Elements(projCode) EQ 0 THEN projCode = 99901 <span class="comments">; GOES East/West Satellites</span>
           geoModel = 1   
       ENDIF
   
   ENDIF 
   
   <span class="comments">; We want all measurements to be in meters. First, check to see of there is a ProjLineearUnitsGeokey.</span>
   <span class="comments">; If not, check the GeogLinearUnitsGeokey.</span>
   index = Where(fields EQ 'PROJLINEARUNITSGEOKEY', unitsCount)
   IF unitsCount EQ 0 THEN BEGIN
      index = Where(fields EQ 'GEOGLINEARUNITSGEOKEY', unitsCount)
      IF unitsCount NE 0 THEN unitValue = geotiff.GEOGLINEARUNITSGEOKEY
   ENDIF ELSE unitValue = geotiff.PROJLINEARUNITSGEOKEY
   
   <span class="comments">; Can't find a linear unit. Will assume meters. No trouble with this so far. (Fingers crossed.)</span>
   IF N_Elements(unitValue) EQ 0 THEN BEGIN
        unitValue = 9001L
<span class="comments">;        IF ~Keyword_Set(silent) THEN $</span>
<span class="comments">;            Message, 'Cannot find a linear unit key in the GeoTiff structure. Assuming meter.', /Informational</span>
   ENDIF
   CASE unitValue OF
   
        '9001':       <span class="comments">; Linear meter </span>
        '9002': BEGIN <span class="comments">; Linear foot</span>
            xscale = xscale * (1.0D/3.28D)
            yscale = yscale * (1.0D/3.28D)
            END            
        ELSE: Message, 'Linear unit ' + StrTrim(unitValue,2) + ' is not supported in this program.'
        
   ENDCASE
   
   <span class="comments">; We need a map projection code if we have one in the file</span>
   index = Where(fields EQ 'PROJECTEDCSTYPEGEOKEY', projCount)
   IF projCount EQ 0 THEN BEGIN
      index = Where(fields EQ 'PROJECTIONGEOKEY', projCount)
      IF projCount GT 0 THEN projCode = geotiff.PROJECTIONGEOKEY
   ENDIF ELSE projCode = geotiff.PROJECTEDCSTYPEGEOKEY
   IF N_Elements(projCode) EQ 0 THEN Message, 'Cannot find a map projection Geokey in the GeoTiff Structure.'
   
   <span class="comments">; Assume successful completion.</span>
   success = 1
   
   <span class="comments">; Get the pixel scale values.</span>
   xscale = (geotiff.ModelPixelScaleTag)[0]
   yscale = (geotiff.ModelPixelScaleTag)[1]
   
   <span class="comments">; Get the tie points and calculate the map projection range.</span>
   x0 = (geotiff.ModelTiePointTag)[3]
   y1 = (geotiff.ModelTiePointTag)[4]
   x1 = x0 + (xscale * xsize)
   y0 = y1 - (yscale * ysize)
   xrange = [x0, x1]
   yrange = [y0, y1]
<span class="comments">;   Print, 'X Range: ', xrange</span>
<span class="comments">;   Print, 'Y Range: ', yrange</span>
   
   <span class="comments">; Is this a user-defined projection code?</span>
   IF projCode EQ 32767L THEN BEGIN
   
        <span class="comments">; What kind of datum is being used?</span>
        IF Where(fields EQ 'GEOGRAPHICTYPEGEOKEY') NE -1 THEN BEGIN
            CASE geotiff.GEOGRAPHICTYPEGEOKEY OF
                   0: thisDatum = 19 <span class="comments">; Undefined, assgined to sphere.</span>
                4001: thisDatum = 9  <span class="comments">; Airy</span>
                4002: thisDatum = 11 <span class="comments">; Modified Airy</span>
                4003: thisDatum = 14 <span class="comments">; Astralian National</span>
                4008: thisDatum = 0  <span class="comments">; Clarke 1866</span>
                4017: thisDatum = 6  <span class="comments">; Everest</span>
                4018: thisDatum = 10 <span class="comments">; Modified Everest</span>
                4023: thisDatum = 3  <span class="comments">; International 1967</span>
                4024: thisDatum = 15 <span class="comments">; Krassovsky</span>
                4030: thisDatum = 8  <span class="comments">; WGS 84</span>
                4034: thisDatum = 1  <span class="comments">; Clarke 1880</span>
                4035: thisDatum = 19 <span class="comments">; Sphere</span>
                4267: thisDatum = 0  <span class="comments">; NAD27, same as Clark 1866</span>
                4322: thisDatum = 5  <span class="comments">; WGS 72</span>
                4326: thisDatum = 8  <span class="comments">; WGS 84</span>
                ELSE:
            ENDCASE
        ENDIF
        
        <span class="comments">; What kind of datum ellipsoid is being used?</span>
        IF Where(fields EQ 'GEOGELLIPSOIDGEOKEY') NE -1 THEN BEGIN
            CASE geotiff.GEOGELLIPSOIDGEOKEY OF
                   0: thisDatum = 19 <span class="comments">; Undefined, assgined to sphere.</span>
                6322: thisDatum = 5  <span class="comments">; WGS 72</span>
                6326: thisDatum = 8  <span class="comments">; WGS 84</span>
                6001: thisDatum = 9  <span class="comments">; Airy</span>
                6002: thisDatum = 11 <span class="comments">; Modified Airy</span>
                6003: thisDatum = 14 <span class="comments">; Astralian National</span>
                6008: thisDatum = 0  <span class="comments">; Clarke 1866</span>
                6017: thisDatum = 6  <span class="comments">; Everest</span>
                6018: thisDatum = 10 <span class="comments">; Modified Everest</span>
                6023: thisDatum = 3  <span class="comments">; International 1967</span>
                6024: thisDatum = 15 <span class="comments">; Krassovsky</span>
                6030: thisDatum = 8  <span class="comments">; WGS 84</span>
                6034: thisDatum = 1  <span class="comments">; Clarke 1880</span>
                6035: thisDatum = 19 <span class="comments">; Sphere</span>
                ELSE:
            ENDCASE
        ENDIF
        
        <span class="comments">; Default datum if you don't have one defined by here.</span>
        IF N_Elements(thisDatum) THEN thisDatum = 19 <span class="comments">; Defaults to Sphere.</span>

        <span class="comments">; What kind of projection is this?</span>
        IF Where(fields EQ 'PROJCOORDTRANSGEOKEY') NE -1 THEN BEGIN
            CASE geotiff.PROJCOORDTRANSGEOKEY OF
                 1: thisProjection = 109 <span class="comments">; Transverse Mercator</span>
                 7: thisProjection = 105 <span class="comments">; Mercator</span>
                 8: thisProjection = 104 <span class="comments">; Lambert Conformal Conic</span>
                10: thisProjection = 111 <span class="comments">; Lambert Azimuthal Equal Area</span>
                11: thisProjection = 103 <span class="comments">; Albers Equal Area</span>
                14: thisProjection = 110 <span class="comments">; Stereographic</span>
                15: thisProjection = 106 <span class="comments">; Polar Stereographic</span>
                17: thisProjection = 117 <span class="comments">; Equirectangular</span>
                20: thisProjection = 118 <span class="comments">; Miller Cylindrical</span>
                21: thisProjection = 114 <span class="comments">; Orthographic</span>
                22: thisProjection = 107 <span class="comments">; Polyconic</span>
                23: thisProjection = 121 <span class="comments">; Robinson</span>
                24: thisProjection = 116 <span class="comments">; Sinusoidal</span>
                ELSE: Message, 'Unsupported map projection for this GeoTIFF image.'      
            ENDCASE
        ENDIF

        IF Where(fields EQ 'PROJCOORDTRANSGEOKEY') NE -1 THEN BEGIN
            CASE geotiff.PROJCOORDTRANSGEOKEY OF
                 1: thisProjection = 109 <span class="comments">; Transverse Mercator</span>
                 7: thisProjection = 105 <span class="comments">; Mercator</span>
                 8: thisProjection = 104 <span class="comments">; Lambert Conformal Conic</span>
                10: thisProjection = 111 <span class="comments">; Lambert Azimuthal Equal Area</span>
                11: thisProjection = 103 <span class="comments">; Albers Equal Area</span>
                14: thisProjection = 110 <span class="comments">; Stereographic</span>
                15: thisProjection = 106 <span class="comments">; Polar Stereographic</span>
                17: thisProjection = 117 <span class="comments">; Equirectangular</span>
                20: thisProjection = 118 <span class="comments">; Miller Cylindrical</span>
                21: thisProjection = 114 <span class="comments">; Orthographic</span>
                22: thisProjection = 107 <span class="comments">; Polyconic</span>
                23: thisProjection = 121 <span class="comments">; Robinson</span>
                24: thisProjection = 116 <span class="comments">; Sinusoidal</span>
                ELSE: Message, 'Unsupported map projection for this GeoTIFF image.'      
            ENDCASE
        ENDIF ELSE BEGIN
           IF geoModel THEN thisProjection = 117
        ENDELSE
        IF N_Elements(thisProjection) EQ 0 THEN Message, 'Unknown map projection for this GeoTIFF image.' 
        
        <span class="comments">; Make the map coordinate object, based on the map projection.</span>
        CASE thisProjection OF
        
            103: BEGIN <span class="comments">; Albers Equal Area</span>
            
                 CASE 1 OF <span class="comments">; Longitude</span>
                    (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
                    (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
                    ELSE:
                 ENDCASE
            
                 CASE 1 OF <span class="comments">; Latitude</span>
                    (Where(fields EQ 'PROJNATORIGINLATGEOKEY'))[0] NE -1 : lat = geotiff.PROJNATORIGINLATGEOKEY
                    (Where(fields EQ 'PROJORIGINLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJORIGINLATGEOKEY
                    (Where(fields EQ 'PROJCENTERLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJCENTERLATGEOKEY
                    ELSE:
                 ENDCASE

                 index = Where(fields EQ 'PROJFALSEEASTINGGEOKEY', count)
                 IF count GT 0 THEN falseEast = geotiff.PROJFALSEEASTINGGEOKEY ELSE falseEast = 0
                 
                 index = Where(fields EQ 'PROJFALSENORTHINGGEOKEY', count)
                 IF count GT 0 THEN falseNorth = geotiff.PROJFALSENORTHINGGEOKEY ELSE falseNorth = 0

                 std_parallel_1 = geotiff.PROJSTDPARALLEL1GEOKEY
                 std_parallel_2 = geotiff.PROJSTDPARALLEL2GEOKEY

                 mapCoord = Obj_New('cgMap', thisProjection, DATUM=thisDatum, $
                      CENTER_LATITUDE=lat, CENTER_LONGITUDE=lon, $
                      STANDARD_PAR1=std_parallel_1, STANDARD_PAR2=std_parallel_2, $
                      FALSE_EASTING=falseEast, FALSE_NORTHING=falseNorth, NAME='FROM_GEOCOORD', $
                      COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
                 mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange
                 
                 END

            104: BEGIN <span class="comments">; Lambert Conformal Conic</span>
                 CASE 1 OF <span class="comments">; Longitude</span>
                    (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
                    (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
                    ELSE:
                 ENDCASE
            
                 CASE 1 OF <span class="comments">; Latitude</span>
                    (Where(fields EQ 'PROJNATORIGINLATGEOKEY'))[0] NE -1 : lat = geotiff.PROJNATORIGINLATGEOKEY
                    (Where(fields EQ 'PROJORIGINLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJORIGINLATGEOKEY
                    (Where(fields EQ 'PROJCENTERLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJCENTERLATGEOKEY
                    ELSE:
                 ENDCASE

                 index = Where(fields EQ 'PROJFALSEEASTINGGEOKEY', count)
                 IF count GT 0 THEN falseEast = geotiff.PROJFALSEEASTINGGEOKEY ELSE falseEast = 0
                 
                 index = Where(fields EQ 'PROJFALSENORTHINGGEOKEY', count)
                 IF count GT 0 THEN falseNorth = geotiff.PROJFALSENORTHINGGEOKEY ELSE falseNorth = 0

                 std_parallel_1 = geotiff.PROJSTDPARALLEL1GEOKEY
                 std_parallel_2 = geotiff.PROJSTDPARALLEL2GEOKEY

                 mapCoord = Obj_New('cgMap', thisProjection, DATUM=thisDatum, $
                      CENTER_LATITUDE=lat, CENTER_LONGITUDE=lon, $
                      STANDARD_PAR1=std_parallel_1, STANDARD_PAR2=std_parallel_2, $
                      FALSE_EASTING=falseEast, FALSE_NORTHING=falseNorth, $
                      COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
                 mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange
                 
                 END
                 
            105: BEGIN <span class="comments">; Mercator</span>
            
                 CASE 1 OF <span class="comments">; Longitude</span>
                    (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
                    (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
                    ELSE:
                 ENDCASE
            
                 index = Where(fields EQ 'PROJFALSEEASTINGGEOKEY', count)
                 IF count GT 0 THEN falseEast = geotiff.PROJFALSEEASTINGGEOKEY ELSE falseEast = 0
                 
                 index = Where(fields EQ 'PROJFALSENORTHINGGEOKEY', count)
                 IF count GT 0 THEN falseNorth = geotiff.PROJFALSENORTHINGGEOKEY ELSE falseNorth = 0

                 index = Where(fields EQ 'PROJSTDPARALLEL1GEOKEY', count)
                 IF count EQ 0 THEN BEGIN
                    index = Where(fields EQ 'PROJSTDPARALLELGEOKEY', count)
                    IF count NE 0 THEN true_scale_lat = geotiff.PROJSTDPARALLELGEOKEY
                 ENDIF ELSE true_scale_lat = geotiff. PROJSTDPARALLEL1GEOKEY
                 
                 mapCoord = Obj_New('cgMap', thisProjection, DATUM=thisDatum, $
                      TRUE_SCALE_LATITUDE=true_scale_lat, CENTER_LONGITUDE=lon, $
                      FALSE_EASTING=falseEast, FALSE_NORTHING=falseNorth, $
                      COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
                 mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange
                 
                 END

            106: BEGIN <span class="comments">; Polar Stereographic</span>
            
                 CASE 1 OF <span class="comments">; Longitude</span>
                    (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
                    (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
                    ELSE:
                 ENDCASE
            
                 CASE 1 OF <span class="comments">; Latitude</span>
                    (Where(fields EQ 'PROJNATORIGINLATGEOKEY'))[0] NE -1 : lat = geotiff.PROJNATORIGINLATGEOKEY
                    (Where(fields EQ 'PROJORIGINLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJORIGINLATGEOKEY
                    (Where(fields EQ 'PROJCENTERLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJCENTERLATGEOKEY
                    ELSE:
                 ENDCASE

                 index = Where(fields EQ 'PROJFALSEEASTINGGEOKEY', count)
                 IF count GT 0 THEN falseEast = geotiff.PROJFALSEEASTINGGEOKEY ELSE falseEast = 0
                 
                 index = Where(fields EQ 'PROJFALSENORTHINGGEOKEY', count)
                 IF count GT 0 THEN falseNorth = geotiff.PROJFALSENORTHINGGEOKEY ELSE falseNorth = 0

                 mapCoord = Obj_New('cgMap', thisProjection, DATUM=thisDatum, $
                      CENTER_LATITUDE=lat, CENTER_LONGITUDE=lon, $
                      FALSE_EASTING=falseEast, FALSE_NORTHING=falseNorth, $
                      COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
                 mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange
                 
                 END
                 
            107: BEGIN <span class="comments">; Polyconic</span>
            
                 CASE 1 OF <span class="comments">; Longitude</span>
                    (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
                    (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
                    ELSE:
                 ENDCASE
            
                 CASE 1 OF <span class="comments">; Latitude</span>
                    (Where(fields EQ 'PROJNATORIGINLATGEOKEY'))[0] NE -1 : lat = geotiff.PROJNATORIGINLATGEOKEY
                    (Where(fields EQ 'PROJORIGINLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJORIGINLATGEOKEY
                    (Where(fields EQ 'PROJCENTERLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJCENTERLATGEOKEY
                    ELSE:
                 ENDCASE

                 index = Where(fields EQ 'PROJFALSEEASTINGGEOKEY', count)
                 IF count GT 0 THEN falseEast = geotiff.PROJFALSEEASTINGGEOKEY ELSE falseEast = 0
                 
                 index = Where(fields EQ 'PROJFALSENORTHINGGEOKEY', count)
                 IF count GT 0 THEN falseNorth = geotiff.PROJFALSENORTHINGGEOKEY ELSE falseNorth = 0

                 mapCoord = Obj_New('cgMap', thisProjection, DATUM=thisDatum, $
                      CENTER_LATITUDE=lat, CENTER_LONGITUDE=lon, $
                      FALSE_EASTING=falseEast, FALSE_NORTHING=falseNorth, $
                      COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
                 mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange
                 
                 END

            109: BEGIN <span class="comments">; Transverse Mercator</span>
            
                 CASE 1 OF <span class="comments">; Longitude</span>
                    (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
                    (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
                    ELSE:
                 ENDCASE
            
                 CASE 1 OF <span class="comments">; Latitude</span>
                    (Where(fields EQ 'PROJNATORIGINLATGEOKEY'))[0] NE -1 : lat = geotiff.PROJNATORIGINLATGEOKEY
                    (Where(fields EQ 'PROJORIGINLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJORIGINLATGEOKEY
                    (Where(fields EQ 'PROJCENTERLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJCENTERLATGEOKEY
                    ELSE:
                 ENDCASE

                 index = Where(fields EQ 'PROJFALSEEASTINGGEOKEY', count)
                 IF count GT 0 THEN falseEast = geotiff.PROJFALSEEASTINGGEOKEY ELSE falseEast = 0
                 
                 index = Where(fields EQ 'PROJFALSENORTHINGGEOKEY', count)
                 IF count GT 0 THEN falseNorth = geotiff.PROJFALSENORTHINGGEOKEY ELSE falseNorth = 0

                 index = Where(fields EQ 'PROJSCALEATNATORIGINGEOKEY', count)
                 IF count GT 0 THEN mercator_scale = geotiff.PROJSCALEATNATORIGINGEOKEY ELSE mercator_scale = 0.9996

                 mapCoord = Obj_New('cgMap', thisProjection, DATUM=thisDatum, $
                      CENTER_LATITUDE=lat, CENTER_LONGITUDE=lon, $
                      MERCATOR_SCALE=mercator_scale, $
                      FALSE_EASTING=falseEast, FALSE_NORTHING=falseNorth, $
                      COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
                 mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange
                 
                 END
                 
            110: BEGIN <span class="comments">; Stereographic</span>

                 CASE 1 OF <span class="comments">; Longitude</span>
                    (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
                    (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
                    ELSE:
                 ENDCASE
            
                 CASE 1 OF <span class="comments">; Latitude</span>
                    (Where(fields EQ 'PROJNATORIGINLATGEOKEY'))[0] NE -1 : lat = geotiff.PROJNATORIGINLATGEOKEY
                    (Where(fields EQ 'PROJORIGINLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJORIGINLATGEOKEY
                    (Where(fields EQ 'PROJCENTERLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJCENTERLATGEOKEY
                    ELSE:
                 ENDCASE

                 index = Where(fields EQ 'PROJFALSEEASTINGGEOKEY', count)
                 IF count GT 0 THEN falseEast = geotiff.PROJFALSEEASTINGGEOKEY ELSE falseEast = 0
                 
                 index = Where(fields EQ 'PROJFALSENORTHINGGEOKEY', count)
                 IF count GT 0 THEN falseNorth = geotiff.PROJFALSENORTHINGGEOKEY ELSE falseNorth = 0

                 mapCoord = Obj_New('cgMap', thisProjection, DATUM=19, $
                      CENTER_LATITUDE=lat, CENTER_LONGITUDE=lon, $
                      FALSE_EASTING=falseEast, FALSE_NORTHING=falseNorth, $
                      COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
                 mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange
                 
                 END

            111: BEGIN <span class="comments">; Lambert Azimuthal</span>
            
                 CASE 1 OF <span class="comments">; Longitude</span>
                    (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
                    (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
                    ELSE:
                 ENDCASE
            
                 CASE 1 OF <span class="comments">; Latitude</span>
                    (Where(fields EQ 'PROJNATORIGINLATGEOKEY'))[0] NE -1 : lat = geotiff.PROJNATORIGINLATGEOKEY
                    (Where(fields EQ 'PROJORIGINLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJORIGINLATGEOKEY
                    (Where(fields EQ 'PROJCENTERLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJCENTERLATGEOKEY
                    ELSE:
                 ENDCASE

                 index = Where(fields EQ 'PROJFALSEEASTINGGEOKEY', count)
                 IF count GT 0 THEN falseEast = geotiff.PROJFALSEEASTINGGEOKEY ELSE falseEast = 0
                 
                 index = Where(fields EQ 'PROJFALSENORTHINGGEOKEY', count)
                 IF count GT 0 THEN falseNorth = geotiff.PROJFALSENORTHINGGEOKEY ELSE falseNorth = 0
                 
                 mapCoord = Obj_New('cgMap', thisProjection, DATUM=19, $
                      CENTER_LATITUDE=lat, CENTER_LONGITUDE=lon, $
                      FALSE_EASTING=falseEast, FALSE_NORTHING=falseNorth, $
                      COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
                 mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange
                 
                 END

            114: BEGIN <span class="comments">; Orthographic</span>

                 CASE 1 OF <span class="comments">; Longitude</span>
                    (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
                    (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
                    ELSE:
                 ENDCASE
            
                 CASE 1 OF <span class="comments">; Latitude</span>
                    (Where(fields EQ 'PROJNATORIGINLATGEOKEY'))[0] NE -1 : lat = geotiff.PROJNATORIGINLATGEOKEY
                    (Where(fields EQ 'PROJORIGINLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJORIGINLATGEOKEY
                    (Where(fields EQ 'PROJCENTERLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJCENTERLATGEOKEY
                    ELSE:
                 ENDCASE

                 index = Where(fields EQ 'PROJFALSEEASTINGGEOKEY', count)
                 IF count GT 0 THEN falseEast = geotiff.PROJFALSEEASTINGGEOKEY ELSE falseEast = 0
                 
                 index = Where(fields EQ 'PROJFALSENORTHINGGEOKEY', count)
                 IF count GT 0 THEN falseNorth = geotiff.PROJFALSENORTHINGGEOKEY ELSE falseNorth = 0

                 mapCoord = Obj_New('cgMap', thisProjection, DATUM=19, $
                      CENTER_LATITUDE=lat, CENTER_LONGITUDE=lon, $
                      FALSE_EASTING=falseEast, FALSE_NORTHING=falseNorth, $
                      COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
                 mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange
                 
                 END

            116: BEGIN <span class="comments">; Sinusoidal</span>
            
                 CASE 1 OF <span class="comments">; Longitude</span>
                    (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
                    (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
                    ELSE:
                 ENDCASE
            
                 index = Where(fields EQ 'PROJFALSEEASTINGGEOKEY', count)
                 IF count GT 0 THEN falseEast = geotiff.PROJFALSEEASTINGGEOKEY ELSE falseEast = 0
                 
                 index = Where(fields EQ 'PROJFALSENORTHINGGEOKEY', count)
                 IF count GT 0 THEN falseNorth = geotiff.PROJFALSENORTHINGGEOKEY ELSE falseNorth = 0

                 mapCoord = Obj_New('cgMap', thisProjection, DATUM=19, $
                      CENTER_LONGITUDE=lon, $
                      FALSE_EASTING=falseEast, FALSE_NORTHING=falseNorth, $
                      COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
                 mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange
                 
                 END

            117: BEGIN <span class="comments">; Equirectangular</span>
                 CASE 1 OF <span class="comments">; Longitude</span>
                    (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
                    (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
                    ELSE:
                 ENDCASE
            
                 index = Where(fields EQ 'PROJFALSEEASTINGGEOKEY', count)
                 IF count GT 0 THEN falseEast = geotiff.PROJFALSEEASTINGGEOKEY ELSE falseEast = 0
                 
                 index = Where(fields EQ 'PROJFALSENORTHINGGEOKEY', count)
                 IF count GT 0 THEN falseNorth = geotiff.PROJFALSENORTHINGGEOKEY ELSE falseNorth = 0

                 
                 index = Where(fields EQ 'PROJSTDPARALLEL1GEOKEY', count)
                 IF count EQ 0 THEN BEGIN
                    index = Where(fields EQ 'PROJSTDPARALLELGEOKEY', count)
                    IF count NE 0 THEN true_scale_lat = geotiff.PROJSTDPARALLELGEOKEY
                 ENDIF ELSE true_scale_lat = geotiff. PROJSTDPARALLEL1GEOKEY
                 
                 mapCoord = Obj_New('cgMap', thisProjection, DATUM=19, $
                      TRUE_SCALE_LATITUDE=true_scale_lat, CENTER_LONGITUDE=lon, $
                      FALSE_EASTING=falseEast, FALSE_NORTHING=falseNorth, $
                      COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
                 mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange
                 
                 END
                 
            118: BEGIN <span class="comments">; Miller Cylindrical</span>
            
                 CASE 1 OF <span class="comments">; Longitude</span>
                    (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
                    (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
                    ELSE:
                 ENDCASE
            
                 CASE 1 OF <span class="comments">; Latitude</span>
                    (Where(fields EQ 'PROJNATORIGINLATGEOKEY'))[0] NE -1 : lat = geotiff.PROJNATORIGINLATGEOKEY
                    (Where(fields EQ 'PROJORIGINLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJORIGINLATGEOKEY
                    (Where(fields EQ 'PROJCENTERLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJCENTERLATGEOKEY
                    ELSE:
                 ENDCASE

                 index = Where(fields EQ 'PROJFALSEEASTINGGEOKEY', count)
                 IF count GT 0 THEN falseEast = geotiff.PROJFALSEEASTINGGEOKEY ELSE falseEast = 0
                 
                 index = Where(fields EQ 'PROJFALSENORTHINGGEOKEY', count)
                 IF count GT 0 THEN falseNorth = geotiff.PROJFALSENORTHINGGEOKEY ELSE falseNorth = 0
                 
                 mapCoord = Obj_New('cgMap', thisProjection, DATUM=19, $
                      CENTER_LONGITUDE=lon, $
                      FALSE_EASTING=falseEast, FALSE_NORTHING=falseNorth, $
                      COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
                 mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange
                 
                 END

            121: BEGIN <span class="comments">; Robinson</span>
            
                 CASE 1 OF <span class="comments">; Longitude</span>
                    (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
                    (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
                    (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
                    ELSE:
                 ENDCASE
            
                 index = Where(fields EQ 'PROJFALSEEASTINGGEOKEY', count)
                 IF count GT 0 THEN falseEast = geotiff.PROJFALSEEASTINGGEOKEY ELSE falseEast = 0
                 
                 index = Where(fields EQ 'PROJFALSENORTHINGGEOKEY', count)
                 IF count GT 0 THEN falseNorth = geotiff.PROJFALSENORTHINGGEOKEY ELSE falseNorth = 0
                 
                 mapCoord = Obj_New('cgMap', thisProjection, DATUM=19, $
                      CENTER_LONGITUDE=lon, $
                      FALSE_EASTING=falseEast, FALSE_NORTHING=falseNorth, $
                      COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
                 mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange
                 
                 END
                 
        ENDCASE
        
<span class="comments">;        RETURN, mapCoord</span>
        
   ENDIF
   
   <span class="comments">; UTM projections.</span>
   IF (projCode GT 32200) AND (projCode LE 32260) THEN BEGIN
   
        thisProjection = 101 <span class="comments">; UTM</span>
        thisDatum = 5        <span class="comments">; WGS 72</span>
        zone = projCode - 32200
        
        CASE 1 OF <span class="comments">; Longitude</span>
              (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
              (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
              (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
              (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
               ELSE:
        ENDCASE
            
        CASE 1 OF <span class="comments">; Latitude</span>
               (Where(fields EQ 'PROJNATORIGINLATGEOKEY'))[0] NE -1 : lat = geotiff.PROJNATORIGINLATGEOKEY
               (Where(fields EQ 'PROJORIGINLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJORIGINLATGEOKEY
               (Where(fields EQ 'PROJCENTERLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJCENTERLATGEOKEY
               ELSE:
        ENDCASE

        mapCoord = Obj_New('cgMap', thisProjection, DATUM=thisDatum, $
            CENTER_LATITUDE=lat, CENTER_LONGITUDE=lon, ZONE=zone, $
            COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
        mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange
        
<span class="comments">;        RETURN, mapCoord</span>
        
   ENDIF
   
   IF (projCode GT 32300) AND (projCode LE 32360) THEN BEGIN
   
        thisProjection = 101 <span class="comments">; UTM</span>
        thisDatum = 5        <span class="comments">; WGS 72</span>
        zone = -(projCode - 32300)
        
        CASE 1 OF <span class="comments">; Longitude</span>
              (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
              (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
              (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
              (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
               ELSE:
        ENDCASE
            
        CASE 1 OF <span class="comments">; Latitude</span>
               (Where(fields EQ 'PROJNATORIGINLATGEOKEY'))[0] NE -1 : lat = geotiff.PROJNATORIGINLATGEOKEY
               (Where(fields EQ 'PROJORIGINLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJORIGINLATGEOKEY
               (Where(fields EQ 'PROJCENTERLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJCENTERLATGEOKEY
               ELSE:
        ENDCASE

        mapCoord = Obj_New('cgMap', thisProjection, DATUM=thisDatum, $
            CENTER_LATITUDE=lat, CENTER_LONGITUDE=lon, ZONE=zone, $
            COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
        mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange
<span class="comments">;        RETURN, mapCoord</span>
                
   ENDIF

   IF (projCode GT 32400) AND (projCode LE 32460) THEN BEGIN
   
         Message, 'The WGS72BE datum is not currently supported.
<span class="comments">;        thisProjection = 101 ; UTM</span>
<span class="comments">;        thisDatum = 5        ; WGS 72</span>
<span class="comments">;        zone = -(projCode - 32400)</span>
<span class="comments">;        index = Where(fields EQ 'PROJNATORIGINLONGGEOKEY', count)</span>
<span class="comments">;        IF count EQ 0 THEN BEGIN</span>
<span class="comments">;             index = Where(fields EQ 'PROJORIGINLONGGEOKEY', count)</span>
<span class="comments">;             IF count NE 0 THEN lon = geotiff.PROJORIGINLONGGEOKEY</span>
<span class="comments">;        ENDIF ELSE lon = geotiff.PROJNATORIGINLONGGEOKEY</span>
<span class="comments">;             index = Where(fields EQ 'PROJNATORIGINLATGEOKEY', count)</span>
<span class="comments">;        IF count EQ 0 THEN BEGIN</span>
<span class="comments">;              index = Where(fields EQ 'PROJORIGINLATGEOKEY', count)</span>
<span class="comments">;              IF count NE 0 THEN lat = geotiff.PROJORIGINLATGEOKEY</span>
<span class="comments">;        ENDIF ELSE lat = geotiff. PROJNATORIGINLATGEOKEY</span>
<span class="comments">;        mapCoord = Obj_New('cgMap', thisProjection, DATUM=thisDatum, $</span>
<span class="comments">;            CENTER_LATITUDE=lat, CENTER_LONGITUDE=lon, ZONE=zone)</span>
<span class="comments">;        mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange</span>
<span class="comments">;        RETURN, mapCoord</span>
                
   ENDIF
   
   IF (projCode GT 32500) AND (projCode LE 32560) THEN BEGIN
   
         Message, 'The WGS72BE datum is not currently supported.
<span class="comments">;        thisProjection = 101 ; UTM</span>
<span class="comments">;        thisDatum = 5        ; WGS 72</span>
<span class="comments">;        zone = -(projCode - 32500)</span>
<span class="comments">;        index = Where(fields EQ 'PROJNATORIGINLONGGEOKEY', count)</span>
<span class="comments">;        IF count EQ 0 THEN BEGIN</span>
<span class="comments">;             index = Where(fields EQ 'PROJORIGINLONGGEOKEY', count)</span>
<span class="comments">;             IF count NE 0 THEN lon = geotiff.PROJORIGINLONGGEOKEY</span>
<span class="comments">;        ENDIF ELSE lon = geotiff.PROJNATORIGINLONGGEOKEY</span>
<span class="comments">;             index = Where(fields EQ 'PROJNATORIGINLATGEOKEY', count)</span>
<span class="comments">;        IF count EQ 0 THEN BEGIN</span>
<span class="comments">;              index = Where(fields EQ 'PROJORIGINLATGEOKEY', count)</span>
<span class="comments">;              IF count NE 0 THEN lat = geotiff.PROJORIGINLATGEOKEY</span>
<span class="comments">;        ENDIF ELSE lat = geotiff. PROJNATORIGINLATGEOKEY</span>
<span class="comments">;        mapCoord = Obj_New('cgMap', thisProjection, DATUM=thisDatum, $</span>
<span class="comments">;            CENTER_LATITUDE=lat, CENTER_LONGITUDE=lon, ZONE=zone)</span>
<span class="comments">;        mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange</span>
<span class="comments">;        RETURN, mapCoord</span>
                
   ENDIF   

   IF (projCode GT 32600) AND (projCode LE 32660) THEN BEGIN
   
        thisProjection = 101 <span class="comments">; UTM</span>
        thisDatum = 8        <span class="comments">; WGS 84</span>
        zone = projCode - 32600
        
        <span class="comments">; There is a bug in all versions of IDL up to IDL 8.1 apparently that</span>
        <span class="comments">; produces the wrong result when a UTM projection is used in conjunction</span>
        <span class="comments">; with a WGS84 datum (the most common datum used in this projection). Here</span>
        <span class="comments">; we substitute the WALBECK datum, which is nearly identical to WGS84 are</span>
        <span class="comments">; results in position errors of less than a meter typically.</span>
        IF (Float(!version.release) LT 8.2) THEN BEGIN
              IF ~Keyword_Set(silent) THEN Print, 'Switching UTM datum from WGS84 to WALBECK to avoid UTM projection bug.'
              thisDatum = 12
        ENDIF   
        
        CASE 1 OF <span class="comments">; Longitude</span>
              (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
              (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
              (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
              (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
               ELSE:
        ENDCASE
            
        CASE 1 OF <span class="comments">; Latitude</span>
               (Where(fields EQ 'PROJNATORIGINLATGEOKEY'))[0] NE -1 : lat = geotiff.PROJNATORIGINLATGEOKEY
               (Where(fields EQ 'PROJORIGINLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJORIGINLATGEOKEY
               (Where(fields EQ 'PROJCENTERLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJCENTERLATGEOKEY
               ELSE:
        ENDCASE

        mapCoord = Obj_New('cgMap', thisProjection, DATUM=thisDatum, $
            CENTER_LATITUDE=lat, CENTER_LONGITUDE=lon, ZONE=zone, $
                      COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
        mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange
<span class="comments">;        RETURN, mapCoord</span>
 
   ENDIF

   IF (projCode GT 32700) AND (projCode LE 32760) THEN BEGIN
   
        thisProjection = 101 <span class="comments">; UTM</span>
        thisDatum = 8        <span class="comments">; WGS 84</span>
        zone = -(projCode - 32700)
        
        <span class="comments">; There is a bug in all versions of IDL up to IDL 8.1 apparently that</span>
        <span class="comments">; produces the wrong result when a UTM projection is used in conjunction</span>
        <span class="comments">; with a WGS84 datum (the most common datum used in this projection). Here</span>
        <span class="comments">; we substitute the WALBECK datum, which is nearly identical to WGS84 are</span>
        <span class="comments">; results in position errors of less than a meter typically.</span>
        IF (Float(!version.release) LT 8.2) THEN BEGIN
              IF ~Keyword_Set(silent) THEN Print, 'Switching UTM datum from WGS84 to WALBECK to avoid UTM projection bug.'
              thisDatum = 12
        ENDIF   
        
        CASE 1 OF <span class="comments">; Longitude</span>
              (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
              (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
              (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
              (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
               ELSE:
        ENDCASE
            
        CASE 1 OF <span class="comments">; Latitude</span>
               (Where(fields EQ 'PROJNATORIGINLATGEOKEY'))[0] NE -1 : lat = geotiff.PROJNATORIGINLATGEOKEY
               (Where(fields EQ 'PROJORIGINLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJORIGINLATGEOKEY
               (Where(fields EQ 'PROJCENTERLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJCENTERLATGEOKEY
               ELSE:
        ENDCASE

        mapCoord = Obj_New('cgMap', thisProjection, DATUM=thisDatum, $
            CENTER_LATITUDE=lat, CENTER_LONGITUDE=lon, ZONE=zone, $
            COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
         mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange
<span class="comments">;        RETURN, mapCoord</span>
        
   ENDIF

   <span class="comments">; State Zone Projections</span>
   IF (projCode GT 26700) AND (projCode LE 26899) THEN BEGIN
        thisProjection = 101 <span class="comments">; UTM</span>
        thisDatum = 0        <span class="comments">; CLARK 1866 or NAD27</span>
        zone = projCode - 26700
        
        CASE 1 OF <span class="comments">; Longitude</span>
              (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
              (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
              (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
              (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
               ELSE:
        ENDCASE
            
        CASE 1 OF <span class="comments">; Latitude</span>
               (Where(fields EQ 'PROJNATORIGINLATGEOKEY'))[0] NE -1 : lat = geotiff.PROJNATORIGINLATGEOKEY
               (Where(fields EQ 'PROJORIGINLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJORIGINLATGEOKEY
               (Where(fields EQ 'PROJCENTERLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJCENTERLATGEOKEY
               ELSE:
        ENDCASE

        mapCoord = Obj_New('cgMap', thisProjection, DATUM=thisDatum, $
            CENTER_LATITUDE=lat, CENTER_LONGITUDE=lon, ZONE=zone, $
            COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
        mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange
<span class="comments">;        RETURN, mapCoord</span>
        
   ENDIF
 
   IF (projCode GT 26900) AND (projCode LE 27999) THEN BEGIN
   
        thisProjection = 101 <span class="comments">; UTM</span>
        thisDatum = 8        <span class="comments">; WGS84 or NAD83</span>
        zone = projCode - 26900
        
        <span class="comments">; There is a bug in all versions of IDL up to IDL 8.1 apparently that</span>
        <span class="comments">; produces the wrong result when a UTM projection is used in conjunction</span>
        <span class="comments">; with a WGS84 datum (the most common datum used in this projection). Here</span>
        <span class="comments">; we substitute the WALBECK datum, which is nearly identical to WGS84 are</span>
        <span class="comments">; results in position errors of less than a meter typically.</span>
        IF (Float(!version.release) LT 8.2) THEN BEGIN
              IF ~Keyword_Set(silent) THEN Print, 'Switching UTM datum from WGS84 to WALBECK to avoid UTM projection bug.'
              thisDatum = 12
        ENDIF   
        
        CASE 1 OF <span class="comments">; Longitude</span>
              (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
              (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
              (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
              (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
               ELSE:
        ENDCASE
            
        CASE 1 OF <span class="comments">; Latitude</span>
               (Where(fields EQ 'PROJNATORIGINLATGEOKEY'))[0] NE -1 : lat = geotiff.PROJNATORIGINLATGEOKEY
               (Where(fields EQ 'PROJORIGINLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJORIGINLATGEOKEY
               (Where(fields EQ 'PROJCENTERLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJCENTERLATGEOKEY
               ELSE:
        ENDCASE

        mapCoord = Obj_New('cgMap', thisProjection, DATUM=thisDatum, $
            CENTER_LATITUDE=lat, CENTER_LONGITUDE=lon, ZONE=zone, $
            COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
        mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange
<span class="comments">;        RETURN, mapCoord</span>
        
   ENDIF
  
   <span class="comments">; State Zone Projections</span>
   IF (projCode GT 32000) AND (projCode LE 32099) THEN BEGIN
   
        thisProjection = 101 <span class="comments">; UTM</span>
        thisDatum = 0        <span class="comments">; CLARK 1866 or NAD27</span>
        zone = projCode - 32000
        
        CASE 1 OF <span class="comments">; Longitude</span>
              (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
              (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
              (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
              (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
               ELSE:
        ENDCASE
            
        CASE 1 OF <span class="comments">; Latitude</span>
               (Where(fields EQ 'PROJNATORIGINLATGEOKEY'))[0] NE -1 : lat = geotiff.PROJNATORIGINLATGEOKEY
               (Where(fields EQ 'PROJORIGINLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJORIGINLATGEOKEY
               (Where(fields EQ 'PROJCENTERLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJCENTERLATGEOKEY
               ELSE:
        ENDCASE

        mapCoord = Obj_New('cgMap', thisProjection, DATUM=thisDatum, $
            CENTER_LATITUDE=lat, CENTER_LONGITUDE=lon, ZONE=zone, $
            COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
        mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange
        
   ENDIF
 
   IF (projCode GT 32100) AND (projCode LE 32299) THEN BEGIN
   
        thisProjection = 101 <span class="comments">; UTM</span>
        thisDatum = 8        <span class="comments">; WGS84 or NAD83</span>
        zone = projCode - 32100
        
        <span class="comments">; There is a bug in all versions of IDL up to IDL 8.1 apparently that</span>
        <span class="comments">; produces the wrong result when a UTM projection is used in conjunction</span>
        <span class="comments">; with a WGS84 datum (the most common datum used in this projection). Here</span>
        <span class="comments">; we substitute the WALBECK datum, which is nearly identical to WGS84 are</span>
        <span class="comments">; results in position errors of less than a meter typically.</span>
        IF (Float(!version.release) LT 8.2) THEN BEGIN
              IF ~Keyword_Set(silent) THEN Print, 'Switching UTM datum from WGS84 to WALBECK to avoid UTM projection bug.'
              thisDatum = 12
        ENDIF   
        
        CASE 1 OF <span class="comments">; Longitude</span>
              (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
              (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
              (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
              (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
               ELSE:
        ENDCASE
            
        CASE 1 OF <span class="comments">; Latitude</span>
               (Where(fields EQ 'PROJNATORIGINLATGEOKEY'))[0] NE -1 : lat = geotiff.PROJNATORIGINLATGEOKEY
               (Where(fields EQ 'PROJORIGINLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJORIGINLATGEOKEY
               (Where(fields EQ 'PROJCENTERLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJCENTERLATGEOKEY
               ELSE:
        ENDCASE

        mapCoord = Obj_New('cgMap', thisProjection, DATUM=thisDatum, $
            CENTER_LATITUDE=lat, CENTER_LONGITUDE=lon, ZONE=zone, $
            COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
        mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange

   ENDIF
   
   <span class="comments">; Projections that have been added to support work I am doing for clients.</span>
   <span class="comments">; LandSAT MSS Amazon Basin</span>
   IF (projCode EQ 29178) THEN BEGIN <span class="comments">; UTM Zone 18S</span>
   
        thisProjection = 101 <span class="comments">; UTM</span>
        IF (Float(!Version.Release) GE 8) $
            THEN thisDatum = 23 $ <span class="comments">; South American 1969</span>
            ELSE thisDatum = 14   <span class="comments">; Australian National (same as SAD-69)</span>
        zone = -18           <span class="comments">; Zone 18S</span>
                
        CASE 1 OF <span class="comments">; Longitude</span>
              (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
              (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
              (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
              (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
               ELSE:
        ENDCASE
            
        CASE 1 OF <span class="comments">; Latitude</span>
               (Where(fields EQ 'PROJNATORIGINLATGEOKEY'))[0] NE -1 : lat = geotiff.PROJNATORIGINLATGEOKEY
               (Where(fields EQ 'PROJORIGINLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJORIGINLATGEOKEY
               (Where(fields EQ 'PROJCENTERLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJCENTERLATGEOKEY
               ELSE:
        ENDCASE

        mapCoord = Obj_New('cgMap', thisProjection, DATUM=thisDatum, $
            CENTER_LATITUDE=lat, CENTER_LONGITUDE=lon, ZONE=zone, $
            COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
        mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange

   ENDIF
   
   IF (projCode EQ 29181) THEN BEGIN <span class="comments">; UTM Zone 21S</span>
   
        thisProjection = 101 <span class="comments">; UTM</span>
        IF (Float(!Version.Release) GE 8) $
            THEN thisDatum = 23 $ <span class="comments">; South American 1969</span>
            ELSE thisDatum = 14   <span class="comments">; Australian National (same as SAD-69)</span>
        zone = -21                <span class="comments">; Zone 21S</span>
                
        CASE 1 OF <span class="comments">; Longitude</span>
              (Where(fields EQ 'PROJNATORIGINLONGGEOKEY'))[0] NE -1 :        lon = geotiff.PROJNATORIGINLONGGEOKEY
              (Where(fields EQ 'PROJORIGINLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJORIGINLONGGEOKEY
              (Where(fields EQ 'PROJCENTERLONGGEOKEY'))[0] NE -1 :           lon = geotiff.PROJCENTERLONGGEOKEY
              (Where(fields EQ 'PROJSTRAIGHTVERTPOLELONGGEOKEY'))[0] NE -1 : lon = geotiff.PROJSTRAIGHTVERTPOLELONGGEOKEY
               ELSE:
        ENDCASE
            
        CASE 1 OF <span class="comments">; Latitude</span>
               (Where(fields EQ 'PROJNATORIGINLATGEOKEY'))[0] NE -1 : lat = geotiff.PROJNATORIGINLATGEOKEY
               (Where(fields EQ 'PROJORIGINLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJORIGINLATGEOKEY
               (Where(fields EQ 'PROJCENTERLATGEOKEY'))[0] NE -1 :    lat = geotiff.PROJCENTERLATGEOKEY
               ELSE:
        ENDCASE

        mapCoord = Obj_New('cgMap', thisProjection, DATUM=thisDatum, $
            CENTER_LATITUDE=lat, CENTER_LONGITUDE=lon, ZONE=zone, $
            COLOR=mcolor, TITLE=title, ONIMAGE=onimage)
        mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange

   ENDIF

   IF (projCode EQ 99901) THEN BEGIN <span class="comments">; GOES EAST image</span>
   
        thisProjection = 117 <span class="comments">; Equirectangular</span>
        
        <span class="comments">; What kind of datum is being used?</span>
        IF Where(fields EQ 'GEOGRAPHICTYPEGEOKEY') NE -1 THEN BEGIN
            CASE geotiff.GEOGRAPHICTYPEGEOKEY OF
                   0: thisDatum = 19 <span class="comments">; Undefined, assgined to sphere.</span>
                4001: thisDatum = 9  <span class="comments">; Airy</span>
                4002: thisDatum = 11 <span class="comments">; Modified Airy</span>
                4003: thisDatum = 14 <span class="comments">; Astralian National</span>
                4008: thisDatum = 0  <span class="comments">; Clarke 1866</span>
                4017: thisDatum = 6  <span class="comments">; Everest</span>
                4018: thisDatum = 10 <span class="comments">; Modified Everest</span>
                4023: thisDatum = 3  <span class="comments">; International 1967</span>
                4024: thisDatum = 15 <span class="comments">; Krassovsky</span>
                4030: thisDatum = 8  <span class="comments">; WGS 84</span>
                4034: thisDatum = 1  <span class="comments">; Clarke 1880</span>
                4035: thisDatum = 19 <span class="comments">; Sphere</span>
                4267: thisDatum = 0  <span class="comments">; NAD27, same as Clark 1866</span>
                4322: thisDatum = 5  <span class="comments">; WGS 72</span>
                4326: thisDatum = 8  <span class="comments">; WGS 84</span>
                ELSE:
            ENDCASE
        ENDIF
        
        <span class="comments">; Get the pixel scale values, which are in lat/lon degrees in this case.</span>
        xscale = (geotiff.ModelPixelScaleTag)[0]
        yscale = (geotiff.ModelPixelScaleTag)[1]
       
        <span class="comments">; Get the tie points (in lat/lon space) and calculate the map projection range.</span>
        x0 = (geotiff.ModelTiePointTag)[3]
        y0 = (geotiff.ModelTiePointTag)[4]
        x1 = x0 + (xscale * xsize)
        y1 = y0 - (yscale * ysize)
        xrange = [x0, x1]
        yrange = [y0, y1]
        
        mapCoord = Obj_New('cgMap', thisProjection, DATUM=thisDatum, $
            CENTER_LONGITUDE=(xrange[1]-xrange[0])/2.0 + xrange[0], $
            CENTER_LATITUDE=(yrange[1]-yrange[0])/2.0 + yrange[0], $
            COLOR=mcolor, TITLE=title, ONIMAGE=onimage, XRANGE=xrange, YRANGE=yrange)
 
   ENDIF
   
   <span class="comments">; If this is a Geographic Model, then the ranges are in lon/lat space.</span>
   <span class="comments">; They need to be converted to XY projected space.</span>
   IF geoModel THEN BEGIN
   
       mapCoord -> GetProperty, XRANGE=xrange, YRANGE=yrange
       
       <span class="comments">; Many of these geographic models go between 0 and 360 degrees</span>
       <span class="comments">; of longitude, which cause me a great deal of headache. If the</span>
       <span class="comments">; range is 360 degrees, more or less, then I'm just going to</span>
       <span class="comments">; assign the range.</span>
       IF Floats_Equal(xrange[1] - xrange[0], 360.0, ULP=5) THEN xrange = [-180, 180]
       
       <span class="comments">; Otherwise, I will project them into XY meters.</span>
       xy = mapCoord -> Forward(xrange, yrange)
       mapCoord -> SetProperty, XRANGE=Reform(xy[0,*]), YRANGE=Reform(xy[1,*])
       
   ENDIF
   
   <span class="comments">; If we get here, we don't know what to do. </span>
   IF (N_Elements(mapCoord) EQ 0) THEN BEGIN
      Message, 'Map projection code ' + StrTrim(projCode,2) + ' is not supported.
   ENDIF
   
   <span class="comments">; Need a map outline in this cgMapCoord object?</span>
   IF Keyword_Set(continents) THEN BEGIN
       contObj = Obj_New('cgMapContinents', mapCoord, /HIRES, $
                        COLOR=ccolor, FILL=Keyword_Set(fill), NAME='MAPCONTINENTS')
       IF ~Obj_Valid(contObj) THEN $
          Message, 'Cannot successfully create a cgMapContinents object.'
       mapCoord -> SetProperty, CONTINENTS=contObj
   ENDIF
      
   <span class="comments">; Need a map grid in this cgMapCoord object?</span>
   IF Keyword_Set(grid) THEN BEGIN
       gridObj = Obj_New('cgMapGrid', mapCoord, COLOR=gcolor, /AUTODRAWGRID, NAME='MAPGRID')
       IF ~Obj_Valid(gridObj) THEN $
          Message, 'Cannot successfully create a cgMapGrid object.'
       mapCoord -> SetProperty, GRID=gridObj
   ENDIF
   
   <span class="comments">; Would you like to display the image?</span>
   IF Keyword_Set(display) THEN BEGIN
       IF N_Elements(geofile) EQ 0 THEN geofile = image
       thisImage = Read_Tiff(geofile, r, g, b, SUB_RECT=sub_rect)
       dims = Image_Dimensions(thisImage, YINDEX=yindex)
       thisImage = Reverse(Temporary(thisImage), yindex+1)
       IF N_Elements(r) NE 0 THEN palette=[[r],[g],[b]]
       mapCoord -> SetProperty, ONIMAGE=1
       cgWindow, WASPECT=Float(ysize)/xsize, WTitle=cgRootName(geofile)
       IF Keyword_Set(clip) THEN BEGIN
            cgImage, thisImage, /Keep_Aspect, /AddCmd, Margin=0.05, $
                STRETCH=2, PALETTE=palette, _EXTRA=extra       
       ENDIF ELSE BEGIN
            cgImage, thisImage, /Keep_Aspect, /AddCmd, Margin=0.05, PALETTE=palette, _EXTRA=extra
       ENDELSE
       cgWindow, 'Draw', mapCoord, /Method, /AddCmd
   ENDIF
   
   IF Arg_Present(outimage) THEN BEGIN 
       IF N_Elements(thisImage) NE 0 THEN BEGIN
            IF N_Elements(r) NE 0 THEN palette=[[r],[g],[b]]
            outimage = Temporary(thisImage)
       ENDIF ELSE BEGIN
             IF N_Elements(geofile) EQ 0 THEN BEGIN
                geofile = image
                outimage = Read_Tiff(geofile, r, g, b, SUB_RECT=sub_rect)
                IF N_Elements(r) NE 0 THEN palette=[[r],[g],[b]]
                dims = Image_Dimensions(outimage, YINDEX=yindex)
                outimage = Reverse(Temporary(outimage), yindex+1)
              ENDIF ELSE outimage = image
       ENDELSE
   ENDIF
   
   <span class="comments">; Get return values.</span>
   mapCoord -> GetProperty, $
      BOUNDARY=boundary, $
      ELLIPSOID=ellipsoid, $
      LATLONBOX=latlonbox, $
      MAP_PROJECTION=map_projection
   
   
   RETURN, mapCoord
END
</code>
    </div>
  </body>
</html>