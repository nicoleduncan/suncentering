<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:56:57 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>image_blend.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="image_blend.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;+</span>
<span class="comments">; NAME:</span>
<span class="comments">;       IMAGE_BLEND</span>
<span class="comments">;</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;       The purpose of this program is to demonstrate how to</span>
<span class="comments">;       use the alpha channel to blend one image into another.</span>
<span class="comments">;       The specific purpose is to see a color image on top of</span>
<span class="comments">;       a gray-scale image, with the gray-scale image showing</span>
<span class="comments">;       through behind the color image.</span>
<span class="comments">;</span>
<span class="comments">; AUTHOR:</span>
<span class="comments">;       FANNING SOFTWARE CONSULTING</span>
<span class="comments">;       David Fanning, Ph.D.</span>
<span class="comments">;       1645 Sheely Drive</span>
<span class="comments">;       Fort Collins, CO 80526 USA</span>
<span class="comments">;       Phone: 970-221-0438</span>
<span class="comments">;       E-mail: david@idlcoyote.com</span>
<span class="comments">;       Coyote's Guide to IDL Programming: http://www.idlcoyote.com</span>
<span class="comments">;</span>
<span class="comments">; CATEGORY:</span>
<span class="comments">;</span>
<span class="comments">;       Widgets, Object Graphics.</span>
<span class="comments">;</span>
<span class="comments">; CALLING SEQUENCE:</span>
<span class="comments">;</span>
<span class="comments">;       Image_Blend</span>
<span class="comments">;</span>
<span class="comments">; REQUIRED INPUTS:</span>
<span class="comments">;</span>
<span class="comments">;       None. The images "worldelv.dat" and "ctscan.dat" from the</span>
<span class="comments">;       examples/data directory are used.</span>
<span class="comments">;</span>
<span class="comments">; OPTIONAL INPUTS:</span>
<span class="comments">;</span>
<span class="comments">;       backgroundImage::  A 2D image variable that will be used for the background image.</span>
<span class="comments">;       foregroundImage:   A 2D image variable that will be used for the foreground image.</span>
<span class="comments">;</span>
<span class="comments">; OPTIONAL KEYWORD PARAMETERS:</span>
<span class="comments">;</span>
<span class="comments">;       COLORTABLE: The number of a color table to use for the foreground image.</span>
<span class="comments">;       Color table 3 (red temperature) is used as a default.</span>
<span class="comments">;</span>
<span class="comments">; COMMON BLOCKS:</span>
<span class="comments">;</span>
<span class="comments">;       None.</span>
<span class="comments">;</span>
<span class="comments">; SIDE EFFECTS:</span>
<span class="comments">;</span>
<span class="comments">;       None.</span>
<span class="comments">;</span>
<span class="comments">; RESTRICTIONS:</span>
<span class="comments">;</span>
<span class="comments">;       None. The program XCOLORS is required from the Coyote library.</span>
<span class="comments">;</span>
<span class="comments">; EXAMPLE:</span>
<span class="comments">;</span>
<span class="comments">;       Image_Blend, Colortable=5</span>
<span class="comments">;</span>
<span class="comments">; MODIFICATION HISTORY:</span>
<span class="comments">;</span>
<span class="comments">;       Written by David Fanning, 30 March 99.</span>
<span class="comments">;       Fixed bug where I redefined the image parameter. Duh... 1 April 99. DWF.</span>
<span class="comments">;       Moved the program into the 21st century. :-) 21 March 2003. DWF.</span>
<span class="comments">;       Added TIFF, GIF (if version supports it), and PS output. 27 December 2006. DWF.</span>
<span class="comments">;-</span>
<span class="comments">;******************************************************************************************;</span>
<span class="comments">;  Copyright (c) 2008, by Fanning Software Consulting, Inc.                                ;</span>
<span class="comments">;  All rights reserved.                                                                    ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  Redistribution and use in source and binary forms, with or without                      ;</span>
<span class="comments">;  modification, are permitted provided that the following conditions are met:             ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;      * Redistributions of source code must retain the above copyright                    ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer.                     ;</span>
<span class="comments">;      * Redistributions in binary form must reproduce the above copyright                 ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer in the               ;</span>
<span class="comments">;        documentation and/or other materials provided with the distribution.              ;</span>
<span class="comments">;      * Neither the name of Fanning Software Consulting, Inc. nor the names of its        ;</span>
<span class="comments">;        contributors may be used to endorse or promote products derived from this         ;</span>
<span class="comments">;        software without specific prior written permission.                               ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  THIS SOFTWARE IS PROVIDED BY FANNING SOFTWARE CONSULTING, INC. ''AS IS'' AND ANY        ;</span>
<span class="comments">;  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES    ;</span>
<span class="comments">;  OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT     ;</span>
<span class="comments">;  SHALL FANNING SOFTWARE CONSULTING, INC. BE LIABLE FOR ANY DIRECT, INDIRECT,             ;</span>
<span class="comments">;  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED    ;</span>
<span class="comments">;  TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;         ;</span>
<span class="comments">;  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND             ;</span>
<span class="comments">;  ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT              ;</span>
<span class="comments">;  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS           ;</span>
<span class="comments">;  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.                            ;</span>
<span class="comments">;******************************************************************************************;</span>


PRO Image_Blend_Output, event

   <span class="comments">; This event handler creates PNG and JPEG files.</span>

Widget_Control, event.top, Get_UValue=info, /No_Copy

   <span class="comments">; Get a snapshop of window contents. (TVRD equivalent.)</span>

Wait, 0.5 <span class="comments">; Give the pull-down menu time to snap back.</span>
info.thisWindow->GetProperty, Image_Data=snapshot

   <span class="comments">; JPEG or PNG file wanted?</span>

Widget_Control, event.id, Get_UValue=whichFileType
CASE whichFileType OF

   'GIF': BEGIN

      filename = Dialog_Pickfile(/Write, File='idl.gif')
      image2D = Color_Quan(snapshot, 1, r, g, b, COLORS=256)
      IF filename NE '' THEN Write_GIF, filename, image2d, r, g, b
      END

   'PNG': BEGIN

      filename = Dialog_Pickfile(/Write, File='idl.png')
      IF filename NE '' THEN Write_PNG, filename, snapshot
      END

   'PS': BEGIN

      filename = Dialog_Pickfile(/Write, File='idl.eps')
      IF filename EQ '' THEN  RETURN
      dims = info.thisWindow -> GetDimensions()
      aspect = Float(dims[1]) / dims[0]
      IF aspect GT 1.0 THEN BEGIN
         width = 6.0
         height = 7.0/aspect
      ENDIF ELSE BEGIN
         height = 6
         width = 6.0 * aspect
      ENDELSE
      dimensions = [width, height] * 2.54
      clipboard = Obj_New("IDLgrClipboard", Dimensions=dimensions, Units=2)
      clipboard -> Draw, info.thisView, Filename=filename, /PostScript
      Obj_Destroy, clipboard
      END

   'JPEG': BEGIN

      filename = Dialog_Pickfile(/Write, File='idl.jpg')
      IF filename NE '' THEN Write_JPEG, filename, snapshot, True=1
      END

   'TIFF': BEGIN
      filename = Dialog_Pickfile(/Write, File='idl.tif')
      IF filename NE '' THEN Write_TIFF, filename, Reverse(snapshot,3)
      END

ENDCASE

    <span class="comments">;Put the info structure back.</span>

Widget_Control, event.top, Set_UValue=info, /No_Copy
END
<span class="comments">;-------------------------------------------------------------------</span>



PRO Image_Blend_Exit, event

   <span class="comments">; Exit the program via the EXIT button.</span>
   <span class="comments">; The Image_Blend_CLEANUP procedure will be called automatically.</span>

Widget_Control, event.top, /Destroy
END
<span class="comments">;-------------------------------------------------------------------</span>



PRO Image_Blend_Foreground_Colors, event

    <span class="comments">; This event handler changes foreground image colors.</span>

Widget_Control, event.top, Get_UValue=info, /No_Copy

    <span class="comments">; Is this an XCOLORS event?</span>

thisEvent = Tag_Names(event, /Structure_Name)
IF thisEvent EQ 'XCOLORS_LOAD' THEN BEGIN

   <span class="comments">; Set the color palette with the new colors.</span>

   s = Size(*info.foregroundImage, /Dimensions)
   alpha_image = BytArr(4, s[0], s[1])
   alpha_image[0,*, *] = event.r[*info.foregroundImage]
   alpha_image[1,*, *] = event.g[*info.foregroundImage]
   alpha_image[2,*, *] = event.b[*info.foregroundImage]
   Widget_Control, info.sliderID, Get_Value=currentBlend
   alpha_image[3, *, *] = info.blendMask * currentBlend
   info.alphaImage->SetProperty, Data=alpha_image
   info.thisWindow->Draw, info.thisView

ENDIF ELSE XColors, NotifyID=[event.id, event.top], $
   Group_Leader=event.top, Title='Foreground Image Colors', $
   XOffset=100, YOffset=100
Widget_Control, event.top, Set_UValue=info, /No_Copy
END
<span class="comments">;---------------------------------------------------------------------</span>



PRO Image_Blend_Background_Colors, event

    <span class="comments">; This event handler changes background image colors.</span>

Widget_Control, event.top, Get_UValue=info, /No_Copy

    <span class="comments">; Is this an XCOLORS event?</span>

thisEvent = Tag_Names(event, /Structure_Name)
IF thisEvent EQ 'XCOLORS_LOAD' THEN BEGIN

   <span class="comments">; Set the color palette with the new colors.</span>

   info.grayPalette->SetProperty, Red=event.r, Green=event.g, Blue=event.b
   info.thisWindow->Draw, info.thisView

ENDIF ELSE XColors, NotifyID=[event.id, event.top], $
   Group_Leader=event.top, Title='Background Image Colors', $
   XOffset=100, YOffset=200
Widget_Control, event.top, Set_UValue=info, /No_Copy
END
<span class="comments">;---------------------------------------------------------------------</span>



PRO Image_Blend_CleanUp, id

    <span class="comments">; Come here when the widget dies. Free all the program</span>
    <span class="comments">; objects, pointers, pixmaps, etc. and release memory.</span>

Widget_Control, id, Get_UValue=info
IF N_Elements(info) NE 0 THEN BEGIN
   Obj_Destroy, info.thisContainer
   Ptr_Free, info.foregroundImage
ENDIF
END
<span class="comments">;---------------------------------------------------------------------</span>



PRO Image_Blend_Slider, event

    <span class="comments">; This event handler sets the blending values.</span>

Widget_Control, event.top, Get_UValue=info, /No_Copy

    <span class="comments">; Set the blend value.</span>

info.alphaImage->GetProperty, Data=thisData
s = Size(*info.foregroundImage, /Dimensions)
thisData[3, *, *] = info.blendMask * event.value
info.alphaImage->SetProperty, Data=thisData
info.thisWindow->Draw, info.thisView

    <span class="comments">;Put the info structure back.</span>

Widget_Control, event.top, Set_UValue=info, /No_Copy
END
<span class="comments">;---------------------------------------------------------------------</span>



PRO Image_Blend_Expose, event

    <span class="comments">; This event handler responds to draw widget expose events..</span>

Widget_Control, event.top, Get_UValue=info, /No_Copy

   <span class="comments">; Redisplay the graphic.</span>

info.thisWindow->Draw, info.thisView

    <span class="comments">;Put the info structure back.</span>

Widget_Control, event.top, Set_UValue=info, /No_Copy
END
<span class="comments">;---------------------------------------------------------------------</span>



PRO Image_Blend_Event, event

    <span class="comments">; This is main event handler for the TLB. It currently</span>
    <span class="comments">; handles resize events.</span>

Widget_Control, event.top, Get_UValue=info, /No_Copy

    <span class="comments">; Resize the draw widget.</span>

info.thisWindow->SetProperty, Dimension=[event.x, event.y*info.drawScale+15]

   <span class="comments">; Redisplay the graphic.</span>

info.thisWindow->Draw, info.thisView

    <span class="comments">;Put the info structure back.</span>

Widget_Control, event.top, Set_UValue=info, /No_Copy
END
<span class="comments">;---------------------------------------------------------------------</span>



PRO Image_Blend, backgroundImage, foregroundImage, Colortable=colortable

    <span class="comments">; Get images to display</span>

IF N_Elements(backgroundImage) EQ 0 THEN BEGIN
   filename = Filepath(SubDir=['examples', 'data'], 'worldelv.dat')
   OpenR, lun, filename, /Get_LUN
   backgroundImage = BytArr(360,360)
   ReadU, lun, backgroundImage
   Free_Lun, lun
ENDIF

IF N_Elements(foregroundImage) EQ 0 THEN BEGIN
   filename = Filepath(SubDir=['examples', 'data'], 'ctscan.dat')
   OpenR, lun, filename, /Get_LUN
   foregroundImage = BytArr(256,256)
   ReadU, lun, foregroundImage
   Free_Lun, lun
ENDIF

IF N_Elements(colortable) EQ 0 THEN colortable = 3

    <span class="comments">; Create the gray color palette.</span>

grayPalette = Obj_New('IDLgrPalette')
grayPalette->LoadCT, 0

   <span class="comments">; The foreground image must be 24-bit for alpha blending to work.</span>

s = Size(foregroundImage, /Dimensions)
alpha_image = BytArr(4, s[0], s[1])
LoadCT, colortable
TVLCT, r, g, b, /Get
alpha_image[0, *, *] = r[foregroundImage]
alpha_image[1, *, *] = g[foregroundImage]
alpha_image[2, *, *] = b[foregroundImage]

   <span class="comments">; Pixels with value 0 with be totally transparent.</span>
   <span class="comments">; Other pixels will start out half transparent.</span>

blendMask = BytArr(s[0], s[1])
blendMask[Where(foregroundImage GT 0)] = 1B
alpha_image[3, *, *] = blendMask * 128B

backgroundImgObj = Obj_New('IDLgrImage', backgroundImage, $
   Dimensions=[400,400], Palette=grayPalette)

alphaImage = Obj_New('IDLgrImage', alpha_image, $
   Dimensions=[400,400], Interleave=0, $
   Blend_Func=[3,4])

   <span class="comments">; Create a model for the images. Add images to model.</span>

thisModel = Obj_New('IDLgrModel')
thisModel->Add, backgroundImgObj
thisModel->Add, alphaImage

    <span class="comments">; Create a view.</span>

viewRect = [0, 0, 400, 400]
thisView = Obj_New('IDLgrView', Viewplane_Rect=viewRect)
thisView->Add, thisModel

    <span class="comments">; Create the widgets for this program.</span>

tlb = Widget_Base(Title='Image Overlay Example', $
   MBar=menubase, TLB_Size_Events=1, Column=1)

drawID = Widget_Draw(tlb, XSize=400, YSize=400, $
   Graphics_Level=2, Expose_Events=1, Retain=0, $
   Event_Pro='Image_Blend_Expose')

   <span class="comments">; Create a slider widget to control the amount of</span>
   <span class="comments">; transparency in the foreground image.</span>

sliderID = Widget_Slider(tlb, Scr_XSize=406, Min=0, Max=255, $
   Value=128, Title='Opacity Control', Event_Pro='Image_Blend_Slider')

    <span class="comments">; Create FILE menu buttons for output and exiting.</span>

filer = Widget_Button(menubase, Value='File', /Menu)

   <span class="comments">; Create OUTPUT menu buttons for formatted output files.</span>

output = Widget_Button(filer, Value='Output', /Menu)
IF Float(!Version.Release) GE 6.2 THEN BEGIN
   b = Widget_Button(output, Value='GIF File', $
      UValue='GIF', Event_Pro='Image_Blend_Output')
ENDIF
b = Widget_Button(output, Value='PNG File', $
   UValue='PNG', Event_Pro='Image_Blend_Output')
b = Widget_Button(output, Value='JPEG File', $
   UValue='JPEG', Event_Pro='Image_Blend_Output')
b = Widget_Button(output, Value='TIFF File', $
   UValue='TIFF', Event_Pro='Image_Blend_Output')
b = Widget_Button(output, Value='Encapsulated PS File', $
   UValue='PS', Event_Pro='Image_Blend_Output')
b = Widget_Button(filer, Value='Quit', /Separator, $
   Event_Pro='Image_Blend_Exit')

   <span class="comments">; Create a colors menu.</span>

colors = Widget_Button(menubase, Value='Colors', /Menu)
b = Widget_Button(colors, Value='Foreground Image Colors', $
   Event_Pro='Image_Blend_Foreground_Colors')
b = Widget_Button(colors, Value='Background Image Colors', $
   Event_Pro='Image_Blend_Background_Colors')

   <span class="comments">; Get geometry information for resizing.</span>

tlbGeo = Widget_Info(tlb, /Geometry)
drawGeo = Widget_Info(drawID, /Geometry)
drawScale = Float(drawGeo.Scr_YSize) / tlbGeo.YSize

    <span class="comments">; Realize the widgets and get the window object.</span>

Widget_Control, tlb, /Realize
Widget_Control, drawID, Get_Value=thisWindow

thisWindow->Draw, thisView

   <span class="comments">; Create a container object to hold all the other</span>
   <span class="comments">; objects. This will make it easy to free all the</span>
   <span class="comments">; objects when we are finished with the program.</span>

thisContainer = Obj_New('IDL_Container')
thisContainer->Add, backgroundImgObj
thisContainer->Add, thisWindow
thisContainer->Add, thisModel
thisContainer->Add, grayPalette
thisContainer->Add, thisView

    <span class="comments">; Create an info structure to hold program information.</span>

info = { thisContainer:thisContainer, $              <span class="comments">; The container object.</span>
         thisWindow:thisWindow, $                    <span class="comments">; The window object.</span>
         alphaImage:alphaImage, $                    <span class="comments">; The foreground image object.</span>
         foregroundImage:Ptr_New(foregroundImage), $ <span class="comments">; The original foreground image.</span>
         blendMask:blendMask, $                      <span class="comments">; A mask for screening blending values.</span>
         grayPalette:grayPalette, $                  <span class="comments">; The background image palette.</span>
         drawScale:drawScale, $                      <span class="comments">; The draw widget scaling factor.</span>
         drawID:drawID, $                            <span class="comments">; The draw widget identifier.</span>
         sliderID:sliderID, $                        <span class="comments">; The slider widget identifier.</span>
         thisView:thisView}                          <span class="comments">; The object view.</span>

Widget_Control, tlb, Set_UValue=info, /No_Copy

XManager, 'Image_Blend', tlb, Cleanup='Image_Blend_Cleanup', $
   Group_Leader=group, /No_Block
END
</code>
    </div>
  </body>
</html>