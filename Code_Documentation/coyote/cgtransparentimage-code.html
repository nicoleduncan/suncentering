<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:56:35 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>cgtransparentimage.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="cgtransparentimage.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">; docformat = 'rst'</span>
<span class="comments">;</span>
<span class="comments">; NAME:</span>
<span class="comments">;   cgTransparentImage</span>
<span class="comments">;</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">; Creates a semi-transparent image for display. Optionally, a  "missing" </span>
<span class="comments">; color or color index (for 2D images) can be set to a completely transparent value.</span>
<span class="comments">; The transparent image can be saved as a transparent PNG file.</span>
<span class="comments">;</span>
<span class="comments">;******************************************************************************************;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  Copyright (c) 2012, by Fanning Software Consulting, Inc. All rights reserved.           ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  Redistribution and use in source and binary forms, with or without                      ;</span>
<span class="comments">;  modification, are permitted provided that the following conditions are met:             ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;      * Redistributions of source code must retain the above copyright                    ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer.                     ;</span>
<span class="comments">;      * Redistributions in binary form must reproduce the above copyright                 ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer in the               ;</span>
<span class="comments">;        documentation and/or other materials provided with the distribution.              ;</span>
<span class="comments">;      * Neither the name of Fanning Software Consulting, Inc. nor the names of its        ;</span>
<span class="comments">;        contributors may be used to endorse or promote products derived from this         ;</span>
<span class="comments">;        software without specific prior written permission.                               ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  THIS SOFTWARE IS PROVIDED BY FANNING SOFTWARE CONSULTING, INC. ''AS IS'' AND ANY        ;</span>
<span class="comments">;  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES    ;</span>
<span class="comments">;  OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT     ;</span>
<span class="comments">;  SHALL FANNING SOFTWARE CONSULTING, INC. BE LIABLE FOR ANY DIRECT, INDIRECT,             ;</span>
<span class="comments">;  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED    ;</span>
<span class="comments">;  TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;         ;</span>
<span class="comments">;  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND             ;</span>
<span class="comments">;  ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT              ;</span>
<span class="comments">;  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS           ;</span>
<span class="comments">;  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.                            ;</span>
<span class="comments">;******************************************************************************************;</span>
<span class="comments">;</span>
<span class="comments">;+</span>
<span class="comments">; Creates a semi-transparent image for display. Optionally, a  "missing" </span>
<span class="comments">; color or color index (for 2D images) can be set to a completely transparent value.</span>
<span class="comments">; The transparent image can be saved as a transparent PNG file.</span>
<span class="comments">;</span>
<span class="comments">; :Categories:</span>
<span class="comments">;    Graphics</span>
<span class="comments">;    </span>
<span class="comments">; :Params:</span>
<span class="comments">;    image: in, optional, type=byte</span>
<span class="comments">;       A 2D image or a 24-bit image with or without an alpha channel. If an alpha</span>
<span class="comments">;       channel is present, it will be modified by the program.</span>
<span class="comments">;       </span>
<span class="comments">; :Keywords:</span>
<span class="comments">;     brewer: in, optional, type=boolean, default=0</span>
<span class="comments">;         This keyword is used only if the `CTIndex` keyword is used to select a color table number.</span>
<span class="comments">;         Setting this keyword allows Brewer color tables to be used.</span>
<span class="comments">;         </span>
<span class="comments">;     ctindex: in, optional, type=integer</span>
<span class="comments">;         The index number of a color table. The `Brewer` and `Reverse` keywords will be checked</span>
<span class="comments">;         to see how to load the color table into the `Palette` keyword. This keyword will take</span>
<span class="comments">;         precidence over any colors that are loaded with the `Palette` keyword. </span>
<span class="comments">;         </span>
<span class="comments">;     missing_value: in, optional, type=various</span>
<span class="comments">;        The "color" of a pixel that will be treated as a "missing" color or value.</span>
<span class="comments">;        Any pixels in the image with this color value will be set completely</span>
<span class="comments">;        transparent. If `Color` is a string, use cgColor to obtain a color triple. </span>
<span class="comments">;        If `Color` is a non-strint scalar, this value is taken to be the missing color index</span>
<span class="comments">;        in a 2D image. Otherwise, this is assumed to be a color triple that indicates</span>
<span class="comments">;        the "missing" color or value in the output image. The alpha channel in the output image</span>
<span class="comments">;        is set to 0 for the "missing" color, which makes this value completely transparent.</span>
<span class="comments">;        </span>
<span class="comments">;     filename: in, optional, type=string</span>
<span class="comments">;         The name of an image file that can be read with READ_IMAGE. Used to</span>
<span class="comments">;         select the input image if the `image` parameter is not used.</span>
<span class="comments">;        </span>
<span class="comments">;     nogui: in, optional, type=boolean, default=0</span>
<span class="comments">;         Set this keyword if you do not wish to have the user confirm the name of</span>
<span class="comments">;         the output PNG file selected with the `PNGFile` keyword.</span>
<span class="comments">;         </span>
<span class="comments">;     palette: in, optional, type=byte</span>
<span class="comments">;         Set this keyword to a 3x256 or 256x3 byte array containing the RGB color </span>
<span class="comments">;         vectors to be loaded before the transparent image is created. Such vectors can be </span>
<span class="comments">;         obtained, for example, from cgLoadCT with the RGB_TABLE keyword::</span>
<span class="comments">;               </span>
<span class="comments">;                IDL> cgLoadCT, 4, /BREWER, /REVERSE, RGB_TABLE=palette</span>
<span class="comments">;                IDL> tImage = cgTransparentImage( cgDemoData(7), PALETTE=palette)</span>
<span class="comments">;                </span>
<span class="comments">;         The default is to use whatever colors are loaded in the current hardware color table.</span>
<span class="comments">;         A palette applies only to 2D input images.</span>
<span class="comments">;         </span>
<span class="comments">;     pngfile: in, optional</span>
<span class="comments">;         If this keyword is set, the output image is written as a transparent</span>
<span class="comments">;         PNG file in 4xMxN format. Optionally, this keyword can be set to the</span>
<span class="comments">;         name of the output PNG file. The user will have the option of confirming</span>
<span class="comments">;         the name of the output file, unless the `NoGUI` keyword is set.</span>
<span class="comments">;         </span>
<span class="comments">;     reverse: in, optional, type=boolean, default=0</span>
<span class="comments">;         Set this keyword to reverse the color table vectors selected with the `CTIndex` keyword.</span>

<span class="comments">;     transparent: in, optional, type=integer, default=50</span>
<span class="comments">;         The percentage of transparency desired in the output image. A number </span>
<span class="comments">;         between 0 and 100.</span>
<span class="comments">;        </span>
<span class="comments">;     wset: in, optional, type=long</span>
<span class="comments">;        If image parameter is not present, make the window indicated with</span>
<span class="comments">;        this keyword the current graphics window for obtaining an image parameter.</span>
<span class="comments">;        If not passed, and no image is present, then the current graphics window is </span>
<span class="comments">;        used to create the image.</span>
<span class="comments">;</span>
<span class="comments">; :Examples:</span>
<span class="comments">;    To create and display a transparent image::</span>
<span class="comments">;       cgDisplay, WID=0</span>
<span class="comments">;       cgImage, cgDemoData(5), CTIndex=0, /Interp</span>
<span class="comments">;       timage = cgTransparentImage(MISSING_VALUE='black', TRANSPARENT=50)</span>
<span class="comments">;       cgDisplay, WID=1</span>
<span class="comments">;       cgImage, cgDemoData(7), CTIndex=22</span>
<span class="comments">;       cgImage, timage</span>
<span class="comments">;</span>
<span class="comments">; :Author:</span>
<span class="comments">;    FANNING SOFTWARE CONSULTING::</span>
<span class="comments">;       David W. Fanning </span>
<span class="comments">;       1645 Sheely Drive</span>
<span class="comments">;       Fort Collins, CO 80526 USA</span>
<span class="comments">;       Phone: 970-221-0438</span>
<span class="comments">;       E-mail: david@idlcoyote.com</span>
<span class="comments">;       Coyote's Guide to IDL Programming: http://www.idlcoyote.com</span>
<span class="comments">;</span>
<span class="comments">; :History:</span>
<span class="comments">;     Change History::</span>
<span class="comments">;        Written, 23 October 2012 to replace Make_Transparent_Image, which was retired. DWF.</span>
<span class="comments">;</span>
<span class="comments">; :Copyright:</span>
<span class="comments">;     Copyright (c) 2012, Fanning Software Consulting, Inc.</span>
<span class="comments">;-</span>
FUNCTION cgTransparentImage, image, $
  BREWER=brewer, $
  CTINDEX=ctindex, $
  MISSING_VALUE=missing_value, $
  FILENAME=filename, $
  NOGUI=nogui, $
  PALETTE=palette, $
  PNGFILE=pngfile, $
  REVERSE=reverse, $
  TRANSPARENT=transparent, $
  WSET=wset
  
    Compile_Opt idl2

    Catch, theError
    IF theError NE 0 THEN BEGIN 
        Catch, /CANCEL
        void = Error_Message()
        RETURN, image
    ENDIF
    
    <span class="comments">; Check for keyword values.</span>
    IF N_Elements(transparent) EQ 0 THEN transparent = 50
    nogui = Keyword_Set(nogui)

    <span class="comments">; Make sure the transparent value is between 0 and 100 initially, and between 0 and 1 finally.</span>
    transparent = (0 > transparent &lt<span class="comments">; 100) / 100.0</span>
        
    <span class="comments">; Did the user pass an image? If not, read an image from the display.</span>
    IF N_Elements(image) EQ 0 THEN BEGIN
    
        <span class="comments">; Did the user specify a filename?</span>
        IF N_Elements(filename) NE 0 THEN BEGIN
            image = Read_Image(filename, r, g, b)
            IF N_Elements(r) NE 0 THEN palette = [[r],[g],[b]]
        ENDIF 
        IF N_Elements(image) EQ 0 THEN BEGIN
            IF (!D.Flags AND 256) EQ 0 THEN Message, 'Current device does not support windows.'
            IF N_Elements(wset) NE 0 THEN BEGIN
                thisWindow = !D.Window
                WSet, wset
            ENDIF
            image = cgSnapshot(TRUE=3)
            IF N_Elements(thisWindow) NE 0 THEN WSet, thisWindow
        ENDIF
    ENDIF
    
    <span class="comments">; What kind of image are we dealing with here?</span>
    ndims = Size(image, /N_DIMENSIONS)
    CASE ndims OF
        2: BEGIN

           <span class="comments">; Use a color table to create a color palette?</span>
           IF N_Elements(ctindex) NE 0 THEN BEGIN
              cgLoadCT, ctindex, Reverse=reverse, Brewer=brewer, RGB_TABLE=palette
           ENDIF
 
           IF N_Elements(palette) NE 0 THEN BEGIN
              IF (Size(palette, /DIMENSIONS))[0] EQ 3 THEN BEGIN
                 r = Reform(palette[0,*])
                 g = Reform(palette[1,*])
                 b = Reform(palette[2,*])
              ENDIF ELSE BEGIN
                 r = palette[*,0]
                 g = palette[*,1]
                 b = palette[*,2]
              ENDELSE
           ENDIF ELSE BEGIN
              TVLCT, r, g, b, /Get
           ENDELSE
           red = r[image]
           grn = g[image]
           blu = b[image]
           alpha = Byte(image) * 0 + (255 * (1.0 - transparent))
           
           <span class="comments">; Handle missing color index here.</span>
           IF (N_Elements(missing_value) EQ 1) && (Size(missing_value, /TNAME) NE 'STRING') THEN BEGIN
              missingIndices = Where(image EQ missing_value, missingCnt)
              IF missingCnt GT 0 THEN alpha[missingIndices] = 0B
           ENDIF
           END
           
        3: BEGIN
           s = Size(image, /DIMENSIONS)
           index = Where(s EQ 3, count)
           IF count GT 0 THEN BEGIN
                CASE index OF
                   0: aImage = Transpose(image, [1,2,0])
                   1: aImage = Transpose(image, [0,2,1])
                   ELSE: aImage = image
                ENDCASE
                red = aImage[*,*,0]
                grn = aImage[*,*,1]
                blu = aImage[*,*,2]
                s = Size(aImage, /DIMENSIONS)
                alpha = BytArr(s[0], s[1]) + (255 * (1.0 - transparent))
           ENDIF
           index = Where(s EQ 4, count)
           IF count GT 0 THEN BEGIN
                CASE index OF
                   0: aImage = Transpose(image, [1,2,0])
                   1: aImage = Transpose(image, [0,2,1])
                   ELSE: aImage = image
                ENDCASE
                red = aImage[*,*,0]
                grn = aImage[*,*,1]
                blu = aImage[*,*,2]
                s = Size(aImage, /DIMENSIONS)
                alpha = BytArr(s[0], s[1]) + (255 * (1.0 - transparent))    
           ENDIF
           END
                      
        ELSE: Message, 'Input variable does not appear to be an image.'
    ENDCASE
    
    <span class="comments">; Did the user pass a color? </span>
    CASE N_Elements(missing_value) OF
        0: 
        1: BEGIN
           IF Size(missing_value, /TNAME) EQ 'STRING' THEN BEGIN
               missingColor = cgColor(missing_value, /TRIPLE)
           ENDIF
           END
        2: Message, 'The COLOR keyword contains unexpected values.'
        3: missingColor = missing_value
        ELSE: Message, 'The COLOR keyword must be a color triple.'
    ENDCASE
    
    <span class="comments">; Find the missing color in the image, if it is defined and this is not a 2D image.</span>
    IF (N_Elements(missingColor) NE 0) && (Size(image, /N_DIMENSIONS) NE 2) THEN BEGIN
      indices = Where((red EQ missingColor[0]) AND (grn EQ missingColor[1]) $
                  AND (blu EQ missingColor[2]), count)
      IF count GT 0 THEN alpha[indices] = 0
    ENDIF
    
    <span class="comments">; Create the transparent image.</span>
    transparentImage = [ [[red]], [[grn]], [[blu]], [[alpha]] ]
    transparentImage = Transpose(transparentImage, [2,0,1])
    
    <span class="comments">; Write this image to a file?</span>
    IF Keyword_Set(pngfile) THEN BEGIN
        
        IF Size(pngfile, /TNAME) EQ 'STRING' THEN outfilename = pngfile ELSE outfilename = 'transparent.png'
        IF noGUI THEN BEGIN
            Write_PNG, outfilename, transparentImage
        ENDIF ELSE BEGIN
            outfilename = Dialog_Pickfile(Title='Select PNG File For Output...', $
                FILE=outfilename, FILTER='*.png')
            IF outfilename NE "" THEN BEGIN
               Write_PNG, outfilename, transparentImage
            ENDIF
        ENDELSE
        
    ENDIF
    
    <span class="comments">; Return the transparent image.</span>
    RETURN, transparentImage
    
END
</code>
    </div>
  </body>
</html>