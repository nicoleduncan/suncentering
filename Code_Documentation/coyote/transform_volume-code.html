<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:57:13 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>transform_volume.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="transform_volume.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;+</span>
<span class="comments">; NAME:</span>
<span class="comments">;       TRANSFORM_VOLUME</span>
<span class="comments">;</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;</span>
<span class="comments">;       The purpose of this program is to transform (e.g., rotate,</span>
<span class="comments">;       scale, and translate) a 3D array or volume.</span>
<span class="comments">;</span>
<span class="comments">; AUTHOR:</span>
<span class="comments">;</span>
<span class="comments">;       Martin Downing,</span>
<span class="comments">;       Clinical Research Physicist,</span>
<span class="comments">;       Grampian Orthopaedic RSA Research Centre,</span>
<span class="comments">;       Woodend Hospital, Aberdeen, AB15 6LS.</span>
<span class="comments">;       Pnone: 01224 556055 / 07903901612</span>
<span class="comments">;       Fa: 01224 556662</span>
<span class="comments">;       E-mail: m.downing@abdn.ac.uk</span>
<span class="comments">;</span>
<span class="comments">; CATEGORY:</span>
<span class="comments">;</span>
<span class="comments">;      Mathematics, graphics.</span>
<span class="comments">;</span>
<span class="comments">; CALLING SEQUENCE:</span>
<span class="comments">;</span>
<span class="comments">;      result = TRANSFORM_VOLUME( volume )</span>
<span class="comments">;</span>
<span class="comments">; INPUTS:</span>
<span class="comments">;</span>
<span class="comments">;       volume:    The 3D array or volume to be transformed.</span>
<span class="comments">;</span>
<span class="comments">; OPTIONAL KEYWORDS:</span>
<span class="comments">;</span>
<span class="comments">;      BUFFER_SIZE: To reduce memory overhead the routine processes the job in chunks, the number</span>
<span class="comments">;         of elements of which can be set using the BUFFER_SIZE keyword, set this keyword to</span>
<span class="comments">;         0 to force the whole array to be processed at one time. The default value is 128.</span>
<span class="comments">;</span>
<span class="comments">;      MISSING: The value to return for transformed values outside the bounds of</span>
<span class="comments">;         the volume. (Passed to the INTERPOLATE function.) Default is 0.</span>
<span class="comments">;</span>
<span class="comments">;      T3DMAT: The homogeneous transforamtion matrix. If this keyword is not present,</span>
<span class="comments">;         the following keywords can be used to create a homogeneous transformation matrix:</span>
<span class="comments">;</span>
<span class="comments">;         ROTATION - The rotation vector [rx,ry,rz]. The order of rotation is ZYX.</span>
<span class="comments">;         TRANSLATE - The translation vector [tx,ty,tz].</span>
<span class="comments">;         SCALE - The scale vector [sx,sy,sz].</span>
<span class="comments">;         CENTRE_ROTATION - The centre of rotation [cx,cy,cz].</span>
<span class="comments">;</span>
<span class="comments">; OUTPUTS:</span>
<span class="comments">;</span>
<span class="comments">;       result:    The transformed array or volume.</span>
<span class="comments">;</span>
<span class="comments">; COMMON BLOCKS:</span>
<span class="comments">;</span>
<span class="comments">;       None.</span>
<span class="comments">;</span>
<span class="comments">; DEPENDENCIES:</span>
<span class="comments">;</span>
<span class="comments">;       The program uses the library INTERPLOLATE routine, which currently (IDL 5.4)</span>
<span class="comments">;       uses linear interpolation. Note that the operation is performed in chunks,</span>
<span class="comments">;       each of which is independant of the result of the others, so the operation</span>
<span class="comments">;       could easiliy be parallelised.</span>
<span class="comments">;</span>
<span class="comments">; MODIFICATION HISTORY:</span>
<span class="comments">;</span>
<span class="comments">;       Written by: Martin Downing, 16 September 2001.</span>
<span class="comments">;       Added MISSING keyword. Removed INPLACE keyword. 25 Nov 2001. MD</span>
<span class="comments">;-</span>
<span class="comments">;******************************************************************************************;</span>
<span class="comments">;  Copyright (c) 2008, by Fanning Software Consulting, Inc.                                ;</span>
<span class="comments">;  All rights reserved.                                                                    ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  Redistribution and use in source and binary forms, with or without                      ;</span>
<span class="comments">;  modification, are permitted provided that the following conditions are met:             ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;      * Redistributions of source code must retain the above copyright                    ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer.                     ;</span>
<span class="comments">;      * Redistributions in binary form must reproduce the above copyright                 ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer in the               ;</span>
<span class="comments">;        documentation and/or other materials provided with the distribution.              ;</span>
<span class="comments">;      * Neither the name of Fanning Software Consulting, Inc. nor the names of its        ;</span>
<span class="comments">;        contributors may be used to endorse or promote products derived from this         ;</span>
<span class="comments">;        software without specific prior written permission.                               ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  THIS SOFTWARE IS PROVIDED BY FANNING SOFTWARE CONSULTING, INC. ''AS IS'' AND ANY        ;</span>
<span class="comments">;  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES    ;</span>
<span class="comments">;  OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT     ;</span>
<span class="comments">;  SHALL FANNING SOFTWARE CONSULTING, INC. BE LIABLE FOR ANY DIRECT, INDIRECT,             ;</span>
<span class="comments">;  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED    ;</span>
<span class="comments">;  TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;         ;</span>
<span class="comments">;  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND             ;</span>
<span class="comments">;  ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT              ;</span>
<span class="comments">;  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS           ;</span>
<span class="comments">;  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.                            ;</span>
<span class="comments">;******************************************************************************************;</span>
FUNCTION Transform_Volume, volume, Rotation=rotation, $
    Scale=scale, Translate=translate, Centre_Rotation=centre_rotation, $
    T3Dmat=t3dmat, Buffer_Size=buffer_size, Missing=missing

   <span class="comments">; Error handling.</span>

Catch, theError
IF theError NE 0 THEN BEGIN
   Catch, /Cancel
   ok = Dialog_Message(!Error.State.Msg)
   RETURN, -1
ENDIF

   <span class="comments">; Find the dimensions of the volume.</span>

 s = Size(volume)
 sx=s[1] & sy=s[2] & sz=s[3]
 st = sx*sy*sz

vol_t = volume
IF N_Elements(missing) THEN missing = 0

   <span class="comments">; Create a transform matrix, if one is not provided.</span>

IF N_Elements(t3dmat) EQ 0 THEN begin

   IF N_Elements(rotation) EQ 0 THEN rotation =[0,0,0]
   IF N_Elements(centre_rotation) EQ 0  THEN centre_rotation=[(sx-1)/2.0,(sy-1)/2.0,(sz-1)/2.0]
   IF N_Elements(translate) EQ 0 THEN translate =[0,0,0]
   IF N_Elements(scale) EQ 0 THEN scale =[1,1,1]

   T3D, /Reset, Translate = -centre_rotation
   T3D, Rotate=rotation
   T3D, Translate= centre_rotation + translate, Scale=scale
   t3dmat = !P.T

ENDIF

   <span class="comments">; Check buffer size. The size 128 is optimim on my system, You may</span>
   <span class="comments">; want to try other values.</span>

 IF N_Elements(buffer_size) EQ 0 THEN buffer_size = 128
 IF buffer_size LE 0 THEN buffer_size = st

   <span class="comments">; Perform the transformations.</span>

 FOR j=0L,(st-1),buffer_size DO BEGIN

      <span class="comments">; Account for possible odd last chunk.</span>

   bufsize = buffer_size &lt<span class="comments">; (st-j)</span>

      <span class="comments">; Generate volume coordinates by interpolating temporary array of volume indices.</span>

   i = j + Lindgen(bufsize)
   coords = [ [(i MOD sx)],[((i / sx) MOD (sy))], [(i / (sx * sy))], [Replicate(1b, bufsize)]]
   coords = Temporary(coords) # t3dmat
   vol_t[j:j+bufsize-1] = Interpolate(volume, coords[*,0], coords[*,1], coords[*,2], Missing=missing)
ENDFOR

   <span class="comments">; Return the transformed volume.</span>

RETURN, vol_t
END
</code>
    </div>
  </body>
</html>