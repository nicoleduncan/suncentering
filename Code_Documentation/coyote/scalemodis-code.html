<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:57:11 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>scalemodis.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="scalemodis.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;+</span>
<span class="comments">; NAME:</span>
<span class="comments">;  SCALEMODIS</span>
<span class="comments">;</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;</span>
<span class="comments">;  MODIS corrected reflectance images often appear drab when initially processed</span>
<span class="comments">;  and displayed on a computer using BYTSCL. In fact, the resulting true-color </span>
<span class="comments">;  images look nothing like the images you can find on the MODIS Rapid Response</span>
<span class="comments">;  web page (http://rapidfire.sci.gsfc.nasa.gov/gallery/). After poking around on</span>
<span class="comments">;  the Internet for awhile, I discovered that the Rapid Response Team doesn't use</span>
<span class="comments">;  BYTSCL to prepare the images. Rather, they selectively scale portions of the</span>
<span class="comments">;  reflectance image, using a piecewise scaling with different slopes. This program</span>
<span class="comments">;  implements this Rapid Response Team algorithm.</span>
<span class="comments">;</span>
<span class="comments">; AUTHOR:</span>
<span class="comments">;</span>
<span class="comments">;   FANNING SOFTWARE CONSULTING</span>
<span class="comments">;   David Fanning, Ph.D.</span>
<span class="comments">;   1645 Sheely Drive</span>
<span class="comments">;   Fort Collins, CO 80526 USA</span>
<span class="comments">;   Phone: 970-221-0438</span>
<span class="comments">;   E-mail: david@idlcoyote.com</span>
<span class="comments">;   Coyote's Guide to IDL Programming: http://www.idlcoyote.com/</span>
<span class="comments">;</span>
<span class="comments">; CATEGORY:</span>
<span class="comments">;</span>
<span class="comments">;  Graphics</span>
<span class="comments">;</span>
<span class="comments">; CALLING SEQUENCE:</span>
<span class="comments">;</span>
<span class="comments">;  scaledBand = ScaleModis(red, green, blue)</span>
<span class="comments">;</span>
<span class="comments">; ARGUMENTS:</span>
<span class="comments">;</span>
<span class="comments">;  red:           A two-dimensional array representing the corrected reflectance</span>
<span class="comments">;                 values of a MODIS image. This is a required parameter. If the</span>
<span class="comments">;                 green and blue parameters are also used, this parameter will </span>
<span class="comments">;                 represent the red band of a RGB 24-bit scaled image that is returned.</span>
<span class="comments">;                 </span>
<span class="comments">;  green:         If the three parameters--red, green, and blue--are present, the returned</span>
<span class="comments">;                 array is a 24-bit true-color image, scaled appropriately. This parameter</span>
<span class="comments">;                 is used as the green band in such an image. The parameter is a two-dimensional</span>
<span class="comments">;                 array of corrected reflectance values.</span>
<span class="comments">;             </span>
<span class="comments">;  blue:          If the three parameters--red, green, and blue--are present, the returned</span>
<span class="comments">;                 array is a 24-bit true-color image, scaled appropriately. This parameter</span>
<span class="comments">;                 is used as the blue band in such an image. The parameter is a two-dimensional</span>
<span class="comments">;                 array of corrected reflectance values.</span>
<span class="comments">;                 </span>
<span class="comments">; KEYWORD PARAMETERS:</span>
<span class="comments">;</span>
<span class="comments">;  RANGE:         A two-dimensional array that the input bands are first scaled into, prior to</span>
<span class="comments">;                 the differential scaling using the MODIS Rapid Response algorithm. The default</span>
<span class="comments">;                 input range is [-0.01, 1.10]. These values will be used to set the MIN and MAX</span>
<span class="comments">;                 keywords for the BYTSCL command in the initial scaling of the input bands.</span>
<span class="comments">;</span>
<span class="comments">;  CLOUD:         The MODIS Rapid Response team uses a slightly different scaling algorithm when</span>
<span class="comments">;                 the idea is to emphasize clouds in a MODIS scene. Set this keyword to use the</span>
<span class="comments">;                 alternate cloud scaling algorithm.</span>
<span class="comments">;</span>
<span class="comments">; OUTPUTS:</span>
<span class="comments">; </span>
<span class="comments">;  scaledBand:    If a single 2D array is passed as the argument, then scaledBand is the scaled</span>
<span class="comments">;                 2D output array. If all three arguments are passed to the program, then scaledBand</span>
<span class="comments">;                 is a scaled 24-bit image that represents a true-color or false color representation</span>
<span class="comments">;                 of the three input bands.</span>
<span class="comments">;                 </span>
<span class="comments">; MODIFICATION HISTORY:</span>
<span class="comments">;</span>
<span class="comments">;  Written by: David W. Fanning, July 2009, using the IDL programs MODIS_FALSE_COLOR and</span>
<span class="comments">;     and SCALE_IMAGE for inspiration. I found these programs on the Internet when poking  </span>
<span class="comments">;     around MODIS web pages. I suspect, but I am not sure, these programs were originally  </span>
<span class="comments">;     written by Liam Gumley.</span>
<span class="comments">;  Minor changes to the ScaleIt function to be sure partitioning is done correctly. 5 Aug 2009. DWF.</span>
<span class="comments">;-</span>
<span class="comments">;</span>
<span class="comments">;******************************************************************************************;</span>
<span class="comments">;  Copyright (c) 2009, by Fanning Software Consulting, Inc.                                ;</span>
<span class="comments">;  All rights reserved.                                                                    ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  Redistribution and use in source and binary forms, with or without                      ;</span>
<span class="comments">;  modification, are permitted provided that the following conditions are met:             ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;      * Redistributions of source code must retain the above copyright                    ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer.                     ;</span>
<span class="comments">;      * Redistributions in binary form must reproduce the above copyright                 ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer in the               ;</span>
<span class="comments">;        documentation and/or other materials provided with the distribution.              ;</span>
<span class="comments">;      * Neither the name of Fanning Software Consulting, Inc. nor the names of its        ;</span>
<span class="comments">;        contributors may be used to endorse or promote products derived from this         ;</span>
<span class="comments">;        software without specific prior written permission.                               ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  THIS SOFTWARE IS PROVIDED BY FANNING SOFTWARE CONSULTING, INC. ''AS IS'' AND ANY        ;</span>
<span class="comments">;  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES    ;</span>
<span class="comments">;  OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT     ;</span>
<span class="comments">;  SHALL FANNING SOFTWARE CONSULTING, INC. BE LIABLE FOR ANY DIRECT, INDIRECT,             ;</span>
<span class="comments">;  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED    ;</span>
<span class="comments">;  TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;         ;</span>
<span class="comments">;  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND             ;</span>
<span class="comments">;  ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT              ;</span>
<span class="comments">;  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS           ;</span>
<span class="comments">;  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.                            ;</span>
<span class="comments">;******************************************************************************************;</span>
FUNCTION ScaleModis_ScaleIt, image, input, output

    <span class="comments">; This function performs the actual piecewise scaling and returns</span>
    <span class="comments">; the differentially scaled image.</span>
    
    ON_Error, 2 <span class="comments">; Return to caller.</span>
    
    <span class="comments">; Create the output array.</span>
    scaled = image * 0B
    
    <span class="comments">; Check the input vector lengths to be sure they are the same.</span>
    inum = N_Elements(input)
    onum = N_Elements(output)
    IF inum NE onum THEN Message, 'Scaling vectors must be the same length.'
    
    <span class="comments">; Partition the image into input values.</span>
    h = Histogram(Value_Locate(input[1:inum-2], image) + 2, $
       MIN=0, MAX=255, REVERSE_INDICES=ri)
    
    <span class="comments">; Differentially scale the image.</span>
    FOR index=0,N_Elements(input)-2 DO BEGIN
        x1 = input[index]
        x2 = input[index+1]
        y1 = output[index]
        y2 = output[index+1]
        
        <span class="comments">; Find slope and intercept for scaling.</span>
        m = (y2 - y1) / Float((x2 - x1))
        b = y2 - (m * x2)
 
        <span class="comments">; Get the indices you need to scale.</span>
        IF ri[index] NE ri[index+1] THEN BEGIN
            indices = ri[ri[index]:ri[index+1]-1]
        
            <span class="comments">; Scale the image.</span>
            scaled[indices] = Byte(m * image[indices] + b)
        ENDIF
    ENDFOR
    
    RETURN, scaled
END <span class="comments">; ---------------------------------------------------------------------------------------</span>


FUNCTION ScaleModis, red, grn, blu, RANGE=range, CLOUD=cloud

    <span class="comments">; Error handling. Return to caller with error condition.</span>
    On_Error, 2
    
    <span class="comments">; Check keywords.</span>
    IF N_Elements(range) EQ 0 THEN range = [-0.01, 1.10]
    IF N_Elements(range) EQ 1 THEN Message, 'RANGE must be a two-element array.'
    cloud = Keyword_Set(cloud)
    
    <span class="comments">; Set up input and output vectors for Rapid Response scaling. Image pixels</span>
    <span class="comments">; between adjacent values in the input vector are linearly scaled to the corresponding</span>
    <span class="comments">; values in the output vector. In other words, pixels with values between 0 and 30 in</span>
    <span class="comments">; the byte scaled input image are scaled into the range 0 to 110 in the output image, and </span>
    <span class="comments">; so on. Each portion of the input image is scaled differently.</span>
    IF cloud THEN BEGIN
        input  = [0, 25,  55, 100, 255]
        output = [0, 90, 140, 175, 255]
    ENDIF ELSE BEGIN
        input  = [0,  30,  60, 120, 190, 255]
        output = [0, 110, 160, 210, 240, 255]
    ENDELSE
    
    <span class="comments">; Proceed differently, depending upon the the number of positional parameters.</span>
    CASE N_Params() OF
    
        0: Message, 'Must pass a MODIS corrected reflectance 2D image as an argument.'
        1: BEGIN
              ndims = Size(red, /N_DIMENSIONS)
              IF ndims NE 2 THEN Message, 'Input image must be a 2D array.'
              scaled = ScaleModis_ScaleIt(BytScl(red, MIN=range[0], MAX=range[1]), input, output)
           END
        2: Message, 'Either 1 or 3 positional arguments are required in this function.'
        3: BEGIN
              ndims = Size(red, /N_DIMENSIONS)
              IF ndims NE 2 THEN Message, 'Input image must be a 2D array.'
              dims = Size(red, /DIMENSIONS)
              IF Total(dims EQ Size(grn, /DIMENSIONS)) NE 2 THEN Message, 'Input images must have the same dimensions'
              IF Total(dims EQ Size(blu, /DIMENSIONS)) NE 2 THEN Message, 'Input images must have the same dimensions'
              scaled = BytArr(dims[0], dims[1], 3)
              scaled[0,0,0] = ScaleModis_ScaleIt(BytScl(red, MIN=range[0], MAX=range[1]), input, output)
              scaled[0,0,1] = ScaleModis_ScaleIt(BytScl(grn, MIN=range[0], MAX=range[1]), input, output)
              scaled[0,0,2] = ScaleModis_ScaleIt(BytScl(blu, MIN=range[0], MAX=range[1]), input, output)
           END
    
    ENDCASE

    RETURN, scaled
END <span class="comments">; ---------------------------------------------------------------------------------------</span>

</code>
    </div>
  </body>
</html>