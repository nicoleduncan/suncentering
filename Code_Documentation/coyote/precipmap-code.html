<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:57:09 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>precipmap.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="precipmap.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;+</span>
<span class="comments">; NAME:</span>
<span class="comments">;       PrecipMap</span>
<span class="comments">;</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;</span>
<span class="comments">;       This is a program that demonstrates how to place an IDL map projection</span>
<span class="comments">;       onto an image that is already in a map projection space. It uses a NOAA</span>
<span class="comments">;       precipitation image that is in a polar stereographic map projection, and</span>
<span class="comments">;       for which the latitudes and longitudes of its four corners are known.</span>
<span class="comments">;</span>
<span class="comments">;       For additional details, see http://www.idlcoyote.com/map_tips/precipmap.html.</span>
<span class="comments">;</span>
<span class="comments">; AUTHOR:</span>
<span class="comments">;</span>
<span class="comments">;       FANNING SOFTWARE CONSULTING</span>
<span class="comments">;       David Fanning, Ph.D.</span>
<span class="comments">;       1645 Sheely Drive</span>
<span class="comments">;       Fort Collins, CO 80526 USA</span>
<span class="comments">;       Phone: 970-221-0438</span>
<span class="comments">;       E-mail: david@idlcoyote.com</span>
<span class="comments">;       Coyote's Guide to IDL Programming: http://www.idlcoyote.com/</span>
<span class="comments">;</span>
<span class="comments">; CATEGORY:</span>
<span class="comments">;</span>
<span class="comments">;       Map Projection</span>
<span class="comments">;</span>
<span class="comments">; CALLING SEQUENCE:</span>
<span class="comments">;</span>
<span class="comments">;       IDL> PrecipMap, filename</span>
<span class="comments">;</span>
<span class="comments">; INPUTS:</span>
<span class="comments">;</span>
<span class="comments">;      filename:   The name of the precipitation file. For demo, download</span>
<span class="comments">;                  ST4.2005010112.24h.bin from http://www.idlcoyote.com/data/ST4.2005010112.24h.bin.</span>
<span class="comments">;                  </span>
<span class="comments">; KEYWORDS:</span>
<span class="comments">; </span>
<span class="comments">;      DATA:   Set this keyword to a named variable that on output will contain the scaled data.</span>
<span class="comments">;      </span>
<span class="comments">;      PALETTE:    Set this keyword to a named variable that on output will contain the color </span>
<span class="comments">;                  palette used to display the data.</span>
<span class="comments">;                   </span>
<span class="comments">;</span>
<span class="comments">; RESTRICTIONS:</span>
<span class="comments">;</span>
<span class="comments">;     Requires files from the Coyote Library:</span>
<span class="comments">;</span>
<span class="comments">;     http://www.idlcoyote.com/documents/programs.html</span>
<span class="comments">;</span>
<span class="comments">; MODIFICATION HISTORY:</span>
<span class="comments">;</span>
<span class="comments">;  Written by David W. Fanning, 28 April 2006 from code and discussion supplied</span>
<span class="comments">;       by James Kuyper in the IDL newsgroup.</span>
<span class="comments">;  Renamed Colorbar procedure to cgColorbar to avoid conflict with IDL 8 Colorbar function.</span>
<span class="comments">;        26 September 2010. DWF.</span>
<span class="comments">;  Got the polar stereo map projection correct. 5 September 2011. DWF.</span>
<span class="comments">;  Added DATA, MAP, and PALETTE output keywords and updated to use more modern Coyote</span>
<span class="comments">;        Library mapping routines. 2 November 2012. DWF.</span>
<span class="comments">;-</span>
<span class="comments">;</span>
<span class="comments">;******************************************************************************************;</span>
<span class="comments">;  Copyright (c) 2008, by Fanning Software Consulting, Inc.                                ;</span>
<span class="comments">;  All rights reserved.                                                                    ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  Redistribution and use in source and binary forms, with or without                      ;</span>
<span class="comments">;  modification, are permitted provided that the following conditions are met:             ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;      * Redistributions of source code must retain the above copyright                    ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer.                     ;</span>
<span class="comments">;      * Redistributions in binary form must reproduce the above copyright                 ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer in the               ;</span>
<span class="comments">;        documentation and/or other materials provided with the distribution.              ;</span>
<span class="comments">;      * Neither the name of Fanning Software Consulting, Inc. nor the names of its        ;</span>
<span class="comments">;        contributors may be used to endorse or promote products derived from this         ;</span>
<span class="comments">;        software without specific prior written permission.                               ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  THIS SOFTWARE IS PROVIDED BY FANNING SOFTWARE CONSULTING, INC. ''AS IS'' AND ANY        ;</span>
<span class="comments">;  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES    ;</span>
<span class="comments">;  OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT     ;</span>
<span class="comments">;  SHALL FANNING SOFTWARE CONSULTING, INC. BE LIABLE FOR ANY DIRECT, INDIRECT,             ;</span>
<span class="comments">;  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED    ;</span>
<span class="comments">;  TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;         ;</span>
<span class="comments">;  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND             ;</span>
<span class="comments">;  ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT              ;</span>
<span class="comments">;  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS           ;</span>
<span class="comments">;  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.                            ;</span>
<span class="comments">;******************************************************************************************;</span>

FUNCTION PrecipMap_Annotate, axis, index, value

   <span class="comments">; This is a function for annotating the colorbar.</span>

   plevels = Indgen(15)
   levels = [0, 2, 5, 10, 15, 20, 25, 50, 75, 100, 125, 150, 200, 250]
   labels = StrTrim(levels, 2)
   text = [labels[0:12], labels[13] + '+', '']
   selection = Where(plevels EQ value)
   RETURN, (text[selection])[0]

END <span class="comments">;----------------------------------------------------------------------</span>



PRO PrecipMap, filename, DATA=data, MAP=map, Palette=palette

   <span class="comments">; Error handling.</span>
   Catch, theError
   IF theError NE 0 THEN BEGIN
      Catch, /Cancel
      void = Error_Message()
      RETURN
   ENDIF

   <span class="comments">; Need a filename?</span>
   IF N_Elements(filename) EQ 0 THEN BEGIN
      filename = Dialog_Pickfile(Filter='*.bin') <span class="comments">; Demo file.</span>
      IF filename EQ "" THEN RETURN
   ENDIF
   OPENR, lun, filename, /Get_Lun
   image = FltArr(1121, 881)
   ReadU, lun, image
   Free_Lun, lun

   <span class="comments">; Set up 15 colors, roughly equvilent to NOAA precipitation colors.</span>
   <span class="comments">; Use black for missing values.</span>
   colors = ['dark green', 'lime green', 'light sea green', 'yellow', 'khaki', $
             'dark goldenrod', 'light salmon', 'orange', 'red', 'sienna', 'purple', $
             'orchid', 'thistle', 'sky blue', 'black']
   TVLCT, cgColor(colors, /Triple), 1

   <span class="comments">; Process image data. Missing values = 9.999e20.</span>
   s = Size(image, /Dimensions)
   scaledImage = BytArr(s[0],s[1])
   levels = [0, 2, 5, 10, 15, 20, 25, 50, 75, 100, 125, 150, 200, 250]
   FOR j=1,13 DO BEGIN
      index = Where(image GE levels[j-1] AND image LT levels[j], count)
      IF count GT 0 THEN scaledImage[index] = Byte(j)
   ENDFOR
   index = Where(image GT 250 AND image LT 9.999e20, count)
   IF count GT 0 THEN scaledImage[index] = 14B
   missing = Where(image EQ 9.999e20, missing_count)
   IF missing_count GT 0 THEN scaledImage[missing] = 15B <span class="comments">; Will be black.</span>

   <span class="comments">; Set up the map structure. This image is a stereographic image.</span>
   mapCoord = Obj_New('cgMap', "Polar Stereographic", CENTER_LONGITUDE=-105, CENTER_LATITUDE=70)

   <span class="comments">; Set up latitutes and longitudes at the corners of the image. (ll, ul, ur, lr)</span>
   longitude = [-119.023D, -134.039, -59.959, -80.7500]
   latitude =  [  23.117D,   53.509,  45.619,  19.8057]

   <span class="comments">; Project those lat/lon points into UV space.</span>
   uv = mapCoord -> Forward(longitude, latitude)
   
   <span class="comments">; To set up map projection space, we need values at left, top, right, and bottom</span>
   <span class="comments">; of image. We calculate these in UV space. Note that these values are in the</span>
   <span class="comments">; center of the pixel. We have to move them to the edge of the pixel below.</span>
   <span class="comments">; The U direction corresponds to longitude, and the V direction to latitude.</span>
   topv =   (uv[1,1] + uv[1,2]) * 0.5
   botv =   (uv[1,0] + uv[1,3]) * 0.5
   leftu =  (uv[0,0] + uv[0,1]) * 0.5
   rightu = (uv[0,2] + uv[0,3]) * 0.5

   <span class="comments">; Calculate the scales in UV directions. The variable s contains the image dimensions.</span>
   xscale = (rightu-leftu) / (s[0]-1)
   yscale = (topv-botv) / (s[1]-1)

   <span class="comments">; Get the range of the UV box that envelopes the image.</span>
   xrange = [uv[0,1] - (0.5 * xscale), uv[0,2] + (0.5 * xscale)]
   yrange = [uv[1,0] - (0.5 * yscale), uv[1,1] + (0.5 * yscale)]

   <span class="comments">; Decide on a position of the image in the window.</span>
   pos = [0.05, 0.25, 0.95, 0.95]
   
   <span class="comments">; Update the map coordinate object.</span>
   mapCoord -> SetProperty, XRANGE=xrange, YRANGE=yrange, POSITION=pos

   <span class="comments">; Display the image. The variable POS will change (probably) to keep the aspect.</span>
   cgDisplay, 500, 500
   cgImage, scaledImage, POSITION=pos, /KEEP_ASPECT, /ERASE

   <span class="comments">; Set up a map coordinate space on top of the image in UV coordinates.</span>
   mapCoord -> Draw
<span class="comments">;</span>
<span class="comments">;   ; Add continent and state outlines, along with grid labels.</span>
   cgMap_Continents, /HIRES, Color='medium gray', /USA, MAP=mapCoord
   cgMap_Grid, LATS=Indgen(8)*5+Round(MIN(latitude)), /LABEL, $
             LONS = Indgen(8)*10+Round(Min(longitude)), $
             COLOR='gray', MAP=mapCoord

   <span class="comments">; Add a colorbar. Non-linear scaling requires use of tick formatting function.</span>
   cgColorbar, NColors=13, Bottom=1, Position=[pos[0], 0.1, pos[2], 0.15], $
      Divisions=14, Title='24 Hour Precipitation (mm)', AnnotateColor='black', $
      /Discrete, OOB_High=14, XTickFormat='PrecipMap_Annotate'
  
   <span class="comments">; Need output keywords?</span>
   IF Arg_Present(data) THEN data = scaledImage
   IF Arg_Present(palette) THEN BEGIN
      TVLCT, r, g, b, /Get
      palette = [[r],[g],[b]]
   ENDIF
   IF Arg_Present(map) THEN map = mapCoord
        
END <span class="comments">;----------------------------------------------------------------------</span>
</code>
    </div>
  </body>
</html>