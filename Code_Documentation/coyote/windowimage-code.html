<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:57:14 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>windowimage.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="windowimage.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">; docformat = 'rst'</span>
<span class="comments">;</span>
<span class="comments">; NAME:</span>
<span class="comments">;   WindowImage</span>
<span class="comments">;</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;   Allows the user to interactively adjust image contrast by means of "windowing and</span>
<span class="comments">;   leveling" the image. Move the cursor vertically in the window to adjust the image</span>
<span class="comments">;   stretch "window". Move the cursor horizontally in the window to adjust the image</span>
<span class="comments">;   "level".</span>
<span class="comments">;</span>
<span class="comments">;******************************************************************************************;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  Copyright (c) 2010, by Fanning Software Consulting, Inc. All rights reserved.           ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  Redistribution and use in source and binary forms, with or without                      ;</span>
<span class="comments">;  modification, are permitted provided that the following conditions are met:             ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;      * Redistributions of source code must retain the above copyright                    ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer.                     ;</span>
<span class="comments">;      * Redistributions in binary form must reproduce the above copyright                 ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer in the               ;</span>
<span class="comments">;        documentation and/or other materials provided with the distribution.              ;</span>
<span class="comments">;      * Neither the name of Fanning Software Consulting, Inc. nor the names of its        ;</span>
<span class="comments">;        contributors may be used to endorse or promote products derived from this         ;</span>
<span class="comments">;        software without specific prior written permission.                               ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  THIS SOFTWARE IS PROVIDED BY FANNING SOFTWARE CONSULTING, INC. ''AS IS'' AND ANY        ;</span>
<span class="comments">;  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES    ;</span>
<span class="comments">;  OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT     ;</span>
<span class="comments">;  SHALL FANNING SOFTWARE CONSULTING, INC. BE LIABLE FOR ANY DIRECT, INDIRECT,             ;</span>
<span class="comments">;  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED    ;</span>
<span class="comments">;  TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;         ;</span>
<span class="comments">;  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND             ;</span>
<span class="comments">;  ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT              ;</span>
<span class="comments">;  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS           ;</span>
<span class="comments">;  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.                            ;</span>
<span class="comments">;******************************************************************************************;</span>
<span class="comments">;</span>
PRO WindowImage_OriginalSettings, event
    
    <span class="comments">; This event handler resotres the original window settings.</span>
    
    <span class="comments">; Error handling.</span>
    Catch, theError
    IF theError NE 0 THEN BEGIN
        Catch, /CANCEL
        void = Error_Message()
        IF N_Elements(info) NE 0 THEN $
            Widget_Control, event.top, SET_UVALUE=info, /NO_COPY
        RETURN
    ENDIF
    
    <span class="comments">; Get the program information.</span>
    Widget_Control, event.top, GET_UVALUE=info, /NO_COPY
    
    <span class="comments">; Restore original contrast and brightness values.</span>
    contrast = 50
    brightness = 50
    level = (1-brightness/100.)*(info.maxImage - info.minImage) + info.minImage
    width = (1-contrast/100.)*(info.maxImage - info.minImage)
            
    <span class="comments">; Calculate the window size.</span>
    displayMax = (level + (width / 2))
    displayMin = (level - (width / 2))
    IF displayMax GT info.maxImage THEN BEGIN
         difference = Abs(displayMax - info.maxImage)
         displayMax = displayMax - difference
         displayMin = displayMin - difference
    ENDIF
    IF displayMin LT info.minImage THEN BEGIN
         difference = Abs(info.minImage - displayMin)
         displayMin = displayMin + difference
         displayMax = displayMax + difference
    ENDIF
            
    <span class="comments">; Store everything.</span>
    info.iWindow = [displayMin, displayMax]
    info.iLevel = level
    info.contrast = contrast
    info.brightness = brightness
    info.x = -1
    info.y = -1
            
    <span class="comments">; Display it in the window.</span>
    WindowImage_Display, info
    
    Widget_Control, event.top, Set_UValue=info, /No_Copy

END <span class="comments">;---------------------------------------------------------------------------</span>



PRO WindowImage_Quit, event
    Widget_Control, event.top, /Destroy
END <span class="comments">;---------------------------------------------------------------------------------------</span>


PRO WindowImage_Resize, event

    <span class="comments">; Error handling.</span>
    Catch, theError
    IF theError NE 0 THEN BEGIN
        Catch, /CANCEL
        void = Error_Message()
        IF N_Elements(info) NE 0 THEN $
            Widget_Control, event.top, SET_UVALUE=info, /NO_COPY
        RETURN
    ENDIF
    
    <span class="comments">; Get the program information.</span>
    Widget_Control, event.top, GET_UVALUE=info, /NO_COPY
    
    <span class="comments">; Calculate a new draw widget size.</span>
    newx =info.labelxsize > event.x 
    newy = event.y - info.labelysize - 86
    
    <span class="comments">; Calculate a window size for the image. Maximum of 800 pixels. Minimum of 400.</span>
    maximageSize = Max([newx, newy])
    wsize = MaxWindowSize()
    IF info.imageAspect GE 1 THEN BEGIN
         maxSize = wsize[1] &lt<span class="comments">; (maxImageSize > 200)</span>
         ywinsize = maxsize
         xwinsize = (maxsize / info.imageAspect) &lt<span class="comments">; wsize[0]</span>
    ENDIF ELSE BEGIN
         maxSize = wsize[0] &lt<span class="comments">; (maxImageSize > 200)</span>
         xwinsize = maxsize
         ywinsize = (maxsize * info.imageAspect) &lt<span class="comments">; (wsize[1] - info.labelysize - 86)</span>
    ENDELSE
    
    <span class="comments">; Resize the draw widgets.</span>
    Widget_Control, info.imgDrawID, DRAW_XSIZE=xwinSize, DRAW_YSIZE=ywinsize
    Widget_Control, info.cbDrawID, DRAW_XSIZE=xwinSize
    
    <span class="comments">; Redisplay the image.</span>
    WindowImage_Display, info
    
    <span class="comments">; Put the program information back in storage.</span>
    Widget_Control, event.top, SET_UVALUE=info, /NO_COPY
    
END <span class="comments">;---------------------------------------------------------------------------------------</span>


PRO WindowImage_DrawEvents, event

    <span class="comments">; Error handling.</span>
    Catch, theError
    IF theError NE 0 THEN BEGIN
        Catch, /CANCEL
        void = Error_Message()
        IF N_Elements(info) NE 0 THEN $
            Widget_Control, event.top, SET_UVALUE=info, /NO_COPY
        RETURN
    ENDIF
    
    <span class="comments">; What kind of event is this?</span>
    possibleEvents = ['DOWN', 'UP', 'MOTION', 'VIEWPORT', 'EXPOSE']
    thisEvent = possibleEvents[event.type]
    
    CASE thisEvent OF
        
        'DOWN': BEGIN
            
            <span class="comments">; Get the program information.</span>
            Widget_Control, event.top, GET_UVALUE=info, /NO_COPY
            
            <span class="comments">; Set the initial point.</span>
            info.x = event.x
            info.y = event.y
            
            <span class="comments">; Clear events for this widget.</span>
            Widget_Control, event.id, /CLEAR_EVENTS
            
            <span class="comments">; Turn motion events on.</span>
            Widget_Control, event.ID, DRAW_MOTION_EVENTS=1
            
            <span class="comments">; Put the program information back in storage and return.</span>
            Widget_Control, event.top, SET_UVALUE=info, /NO_COPY
            RETURN
            
            END
            
        'UP': BEGIN
        
            <span class="comments">; Get the program information.</span>
            Widget_Control, event.top, GET_UVALUE=info, /NO_COPY

            <span class="comments">; Turn motion events off and clear any queued up events.</span>
            Widget_Control, event.ID, DRAW_MOTION_EVENTS=0
            Widget_Control, event.id, /CLEAR_EVENTS
            
            <span class="comments">; Calculate new contrast/brightness values.</span>
            contrast = 0 > ((info.y - event.y) * info.cstep + info.contrast) &lt<span class="comments">; 99</span>
            brightness = 0 > ((info.x - event.x) * info.bstep + info.brightness) &lt<span class="comments">; 100</span>
            level = (1-brightness/100.)*(info.maxImage - info.minImage) + info.minImage
            width = (1-contrast/100.)*(info.maxImage - info.minImage)
            
            <span class="comments">; Calculate new display min/max.</span>
            displayMax = (level + (width / 2))
            displayMin = (level - (width / 2))
            IF displayMax GT info.maxImage THEN BEGIN
               difference = Abs(displayMax - info.maxImage)
               displayMax = displayMax - difference
               displayMin = displayMin - difference
            ENDIF
            IF displayMin LT info.minImage THEN BEGIN
               difference = Abs(info.minImage - displayMin)
               displayMin = displayMin + difference
               displayMax = displayMax + difference
            ENDIF
            
            <span class="comments">; Store everything.</span>
            info.iWindow = [displayMin, displayMax]
            info.iLevel = level
            info.contrast = contrast
            info.brightness = brightness
            info.x = event.x
            info.y = event.y
            
            <span class="comments">; Display the undated image.</span>
            WindowImage_Display, info
            
            <span class="comments">; Put the program information back in storage and return.</span>
            Widget_Control, event.top, SET_UVALUE=info, /NO_COPY
            
            END
            
        'MOTION': BEGIN

            <span class="comments">; Get the program information.</span>
            Widget_Control, event.top, GET_UVALUE=info, /NO_COPY
             
            <span class="comments">; Calculate new contrast/brightness values.</span>
            contrast = 0 > ((info.y - event.y) * info.cstep + info.contrast) &lt<span class="comments">; 99</span>
            brightness = 0 > ((info.x - event.x) * info.bstep + info.brightness) &lt<span class="comments">; 100</span>
            level = (1-brightness/100.)*(info.maxImage - info.minImage) + info.minImage
            width = (1-contrast/100.)*(info.maxImage - info.minImage)
            
            <span class="comments">; Calculate new display min/max.</span>
            displayMax = (level + (width / 2))
            displayMin = (level - (width / 2))
            IF displayMax GT info.maxImage THEN BEGIN
               difference = Abs(displayMax - info.maxImage)
               displayMax = displayMax - difference
               displayMin = displayMin - difference
            ENDIF
            IF displayMin LT info.minImage THEN BEGIN
               difference = Abs(info.minImage - displayMin)
               displayMin = displayMin + difference
               displayMax = displayMax + difference
            ENDIF
 
            <span class="comments">; Store the information.           </span>
            info.iWindow = [displayMin, displayMax]
            info.iLevel = level
            
            <span class="comments">; Update the image.            </span>
            WindowImage_Display, info
            
            <span class="comments">; Put the program information back in storage and return.</span>
            Widget_Control, event.top, SET_UVALUE=info, /NO_COPY
            
            END
    
    ENDCASE
    
    
END <span class="comments">;---------------------------------------------------------------------------------------</span>


PRO WindowImage_Display, info

    SetDecomposedState, 1, CURRENTSTATE=currentState

    <span class="comments">; Load the color table.</span>
    cgLoadCT, info.colortable, REVERSE=info.reverse, BREWER=info.brewer, NCOLORS=253
    TVLCT, cgColor(info.neutralColor, /TRIPLE), 254
    
    <span class="comments">; Draw the image.</span>
    WSet, info.imgWinID
    cgImage, info.image, SCALE=info.scale, NCOLORS=253, /Keep, $
        MINVALUE=info.iwindow[0], MAXVALUE=info.iwindow[1], NOERASE=1

    <span class="comments">; Draw the color bar.</span>
    WSet, info.cbWinID
    cgErase
    cgColorbar, NCOLORS=253, CLAMP=info.iwindow, NEUTRALINDEX=254, $
        POSITION=[0.05, 0.35, 0.95, 0.65], FONT=0, ANNOTATECOLOR='black', $
        RANGE=[info.minImage, info.maxImage], DIVISIONS=5, FORMAT='(F0.2)'
    
    <span class="comments">; Write a label on the color bar.</span>
    format = '(F0.3)'
    txt = 'Window: [' + String(info.iwindow[0], FORMAT=format) + ', ' + $
                        String(info.iwindow[1], FORMAT=format) + ']  Level: ' + $
                        String(info.ilevel, FORMAT=format)
    cgText, 0.5, 0.75, /Normal, Alignment=0.5, Font=0, txt, Color='black'
  
    SetDecomposedState, currentState

END <span class="comments">;---------------------------------------------------------------------------------------</span>


<span class="comments">;+</span>
<span class="comments">; :Description:</span>
<span class="comments">;   Allows the user to interactively adjust image contrast by means of "windowing and</span>
<span class="comments">;   leveling" the image. Move the cursor vertically in the window to adjust the image</span>
<span class="comments">;   stretch "window". Move the cursor horizontally in the window to adjust the image</span>
<span class="comments">;   "level".</span>
<span class="comments">;</span>
<span class="comments">; :Categories:</span>
<span class="comments">;    Graphics</span>
<span class="comments">;    </span>
<span class="comments">; :Params:</span>
<span class="comments">;    image: in, required, type=any</span>
<span class="comments">;         Any 2D array that you wish to adjust the contrast of.</span>
<span class="comments">;       </span>
<span class="comments">; :Keywords:</span>
<span class="comments">;     brewer: in, optional, type=boolean, default=0</span>
<span class="comments">;         Set this keyword to indicate a Brewer color table is desired.</span>
<span class="comments">;     colortable: in, optional, type=integer, default=0</span>
<span class="comments">;          The index number of a color table to load with cgLoadCT.</span>
<span class="comments">;     neutralcolor: in, optional, type=string</span>
<span class="comments">;         The name of the color to use for values outside the image "window" in</span>
<span class="comments">;         the color table. If a default grayscale color table is loaded, the default</span>
<span class="comments">;         color is "rose", otherwise the default is "black".</span>
<span class="comments">;     reverse: in, optional, type=boolean, default=0</span>
<span class="comments">;         Set this keyword if you wish to reverse the color table.</span>
<span class="comments">;         </span>
<span class="comments">; :Examples:</span>
<span class="comments">;    To see a demonstation::</span>
<span class="comments">;       IDL> WindowImage</span>
<span class="comments">;       </span>
<span class="comments">; :Author:</span>
<span class="comments">;       FANNING SOFTWARE CONSULTING::</span>
<span class="comments">;           David W. Fanning </span>
<span class="comments">;           1645 Sheely Drive</span>
<span class="comments">;           Fort Collins, CO 80526 USA</span>
<span class="comments">;           Phone: 970-221-0438</span>
<span class="comments">;           E-mail: david@idlcoyote.com</span>
<span class="comments">;           Coyote's Guide to IDL Programming: http://www.idlcoyote.com</span>
<span class="comments">;</span>
<span class="comments">; :History:</span>
<span class="comments">;     Change History::</span>
<span class="comments">;        Written, 29 November 2010. DWF. </span>
<span class="comments">;        Added color protection to the program. 30 Nov 2010. DWF.</span>
<span class="comments">;        Modification of cgImage command to prevent flashing. 27 Feb 2011. DWF.</span>
<span class="comments">;</span>
<span class="comments">; :Copyright:</span>
<span class="comments">;     Copyright (c) 2010, Fanning Software Consulting, Inc.</span>
<span class="comments">;-</span>
PRO WindowImage, image, $
    BREWER=brewer, $
    COLORTABLE=colortable, $
    NEUTRALCOLOR=neutralColor, $
    REVERSE=reverse
    
    Compile_Opt idl2
    
    <span class="comments">; Error handling.</span>
    Catch, theError
    IF theError NE 0 THEN BEGIN
        Catch, /CANCEL
        void = Error_Message()
        RETURN
    ENDIF

    <span class="comments">; Check parameters.</span>
    IF N_Elements(image) EQ 0 THEN BEGIN
         filename = Filepath(Subdir=['examples','data'], 'muscle.jpg')
         Read_JPEG, filename, image
    ENDIF
    minImage = Min(image, MAX=maxImage, /NAN)
    IF (minImage LT 0) OR (maxImage GT 253) THEN scale = 1 ELSE scale = 0
    brewer = Keyword_Set(brewer)
    reverse = Keyword_Set(brewer)
    IF N_Elements(colortable) EQ 0 THEN BEGIN
        IF N_Elements(neutralColor) EQ 0 THEN neutralColor = 'rose'
        IF brewer THEN BEGIN
            cgLoadCT, 17, REVERSE=reverse, BREWER=1, NCOLORS=253
            colortable = 17
        ENDIF ELSE BEGIN
            cgLoadCT,  0, REVERSE=reverse, BREWER=0, NCOLORS=253
            colortable = 0
        ENDELSE
    ENDIF ELSE BEGIN
        IF N_Elements(neutralColor) EQ 0 THEN neutralColor = 'gray'
        cgLoadCT, colortable, REVERSE=reverse, BREWER=brewer, NCOLORS=253
    ENDELSE
    TVLCT, cgColor(neutralColor, /TRIPLE), 254
        
    IF N_Elements(ilevel) EQ 0 THEN ilevel = (maxImage - minImage) / 2.0
    IF N_Elements(iwindow) EQ 0 THEN BEGIN
       w20 = (maxImage - minImage) * 0.20
       iwindow = minImage > [ilevel - w20, ilevel + w20] &lt<span class="comments">; maxImage</span>
    ENDIF
    IF (iLevel LT iwindow[0]) OR (iLevel GT iwindow[1]) THEN BEGIN
        ilevel = (iwindow[1] - iwindow[0]) / 2.0
    ENDIF
    
    <span class="comments">; Check image, get dimensions.</span>
    IF Size(image, N_DIMENSIONS=1) NE 2 THEN Message, 'The image argument must be 2D.'
    s = Size(image, /DIMENSIONS)
    xsize = s[0]
    ysize = s[1]
    imageAspect = Float(s[1])/s[0]
    
    <span class="comments">; Calculate a window size for the image. Maximum of 800 pixels. Minimum of 400.</span>
    maximageSize = Max([xsize, ysize])
    maxSize = 800 &lt<span class="comments">; (maxImageSize > 400)</span>
    IF imageAspect GE 1 THEN BEGIN
         ywinsize = maxsize
         xwinsize = maxsize / imageAspect
    ENDIF ELSE BEGIN
         xwinsize = maxsize
         ywinsize = maxsize * imageAspect
    ENDELSE
    
    <span class="comments">; Create widgets.</span>
    tlb = Widget_Base(Title='Image Window/Leveling', Column=1, MBar=menuID, $
        Base_Align_Center=1, TLB_Size_Events=1, YPAD=0)
    fileID = Widget_Button(menuID, Value='File')
    button = Widget_Button(fileID, Value='Restore Original Settings', $
        Event_Pro='WindowImage_OriginalSettings')
    quitID = Widget_Button(fileID, Value='Quit', Event_Pro="WindowImage_Quit", /Separator)
    cbDrawID = Widget_Draw(tlb, XSize=xwinsize, YSize=80)
    imgDrawID = Widget_Draw(tlb, XSize=xwinsize, YSize=ywinsize, Button_Events=1, $
       Event_Pro='WindowImage_DrawEvents')
    labelID = Widget_Label(tlb, Value='Drag cursor horizontally for BRIGHTNESS, ' + $
        'vertically for CONTRAST.', /Dynamic_Resize)
    Widget_Control, tlb, /REALIZE
    
    <span class="comments">; Get window index numbers.</span>
    Widget_Control, cbDrawID, Get_Value=cbWinID
    Widget_Control, imgDrawID, Get_Value=imgWinID
    
    <span class="comments">; Find the Y screen sizes of the label widget.</span>
    g = Widget_Info(labelID, /Geometry)
    labelysize = g.scr_ysize
    labelxsize = g.scr_xsize
    
    <span class="comments">; Create an info structure to hold program information.</span>
    info = { image: image, $
             xsize: xsize, $
             ysize: ysize, $
             labelxsize: labelxsize, $
             labelysize: labelysize, $
             iWindow: iWindow, $
             iLevel: iLevel, $
             cbWinID: cbWinID, $
             imgWinID: imgWinID, $
             scale: scale, $
             colortable: colortable, $
             neutralcolor: neutralcolor, $
             brewer: brewer, $
             reverse: reverse, $
             x: -1, $
             y: -1, $
             imageAspect: imageAspect, $
             imgDrawID: imgDrawID, $
             cbDrawID: cbDrawID, $
             contrast: 50, $
             brightness: 50, $
             cstep: ysize / 512., $
             bstep: xsize / 2048., $
             minImage: minImage, $
             maxImage: maxImage }
             
    <span class="comments">; Display the initial window contents.</span>
    WindowImage_Display, info
             
    Widget_Control, tlb, SET_UVALUE=info, /NO_COPY
     
    XManager, 'windowimage', tlb, /NO_BLOCK, EVENT_HANDLER='WindowImage_Resize'

END <span class="comments">;---------------------------------------------------------------------------------------</span>
</code>
    </div>
  </body>
</html>