<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:56:12 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>cgimage2kml.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="cgimage2kml.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">; docformat = 'rst'</span>
<span class="comments">;</span>
<span class="comments">; NAME:</span>
<span class="comments">;   cgImage2KML</span>
<span class="comments">;</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">; This program creates a KML file that can be opened in Google Earth to display the </span>
<span class="comments">; image drapped over the Google Earth terrain. A corresponding image file is also</span>
<span class="comments">; produced. The KML and image file must be in the same directory to use them with</span>
<span class="comments">; Google Earth.</span>
<span class="comments">;</span>
<span class="comments">;******************************************************************************************;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  Copyright (c) 2012, by Fanning Software Consulting, Inc. All rights reserved.           ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  Redistribution and use in source and binary forms, with or without                      ;</span>
<span class="comments">;  modification, are permitted provided that the following conditions are met:             ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;      * Redistributions of source code must retain the above copyright                    ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer.                     ;</span>
<span class="comments">;      * Redistributions in binary form must reproduce the above copyright                 ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer in the               ;</span>
<span class="comments">;        documentation and/or other materials provided with the distribution.              ;</span>
<span class="comments">;      * Neither the name of Fanning Software Consulting, Inc. nor the names of its        ;</span>
<span class="comments">;        contributors may be used to endorse or promote products derived from this         ;</span>
<span class="comments">;        software without specific prior written permission.                               ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  THIS SOFTWARE IS PROVIDED BY FANNING SOFTWARE CONSULTING, INC. ''AS IS'' AND ANY        ;</span>
<span class="comments">;  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES    ;</span>
<span class="comments">;  OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT     ;</span>
<span class="comments">;  SHALL FANNING SOFTWARE CONSULTING, INC. BE LIABLE FOR ANY DIRECT, INDIRECT,             ;</span>
<span class="comments">;  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED    ;</span>
<span class="comments">;  TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;         ;</span>
<span class="comments">;  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND             ;</span>
<span class="comments">;  ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT              ;</span>
<span class="comments">;  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS           ;</span>
<span class="comments">;  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.                            ;</span>
<span class="comments">;******************************************************************************************;</span>
<span class="comments">;</span>
<span class="comments">;+</span>
<span class="comments">; This program creates a KML file that can be opened in Google Earth to display the </span>
<span class="comments">; image drapped over the Google Earth terrain. A corresponding image file is also</span>
<span class="comments">; produced. The KML and image file must be in the same directory to use them with</span>
<span class="comments">; Google Earth.</span>
<span class="comments">; </span>
<span class="comments">; .. image:: cgimage2kml.png</span>
<span class="comments">;  </span>
<span class="comments">; :Categories:</span>
<span class="comments">;    Graphics, FileIO, Maps</span>
<span class="comments">;    </span>
<span class="comments">; :Params:</span>
<span class="comments">; </span>
<span class="comments">;    image: in, optional</span>
<span class="comments">;       A 2D image or a 24-bit image with or without an alpha channel. If an alpha</span>
<span class="comments">;       channel is present, it will be modified by the program if the `Transparent`</span>
<span class="comments">;       keyword is used. An image is required unless the `GeoTiff` keyword is used</span>
<span class="comments">;       to obtain an image.</span>
<span class="comments">;       </span>
<span class="comments">;    mapcoord: in, optional, type=object</span>
<span class="comments">;       A map coordinate object (cgMap) from which map projection information and map</span>
<span class="comments">;       boundaries for the image overlay can be obtained. This parameter is required</span>
<span class="comments">;       unless the `GeoTiff` keyword is used to obtain a map coordinate object.</span>
<span class="comments">;       </span>
<span class="comments">; :Keywords:</span>
<span class="comments">; </span>
<span class="comments">;    addtofile: in, optional, type=object</span>
<span class="comments">;       If this keyword contains a cgKML_File object, the image is added to the file</span>
<span class="comments">;       as a &lt;GroundOverlay) element and a separate KML file is not created. In other</span>
<span class="comments">;       words, the `Filename` keyword is ignored and the image file created takes its</span>
<span class="comments">;       name from the cgKML_File object.</span>
<span class="comments">; </span>
<span class="comments">;    brewer: in, optional, type=boolean, default=0</span>
<span class="comments">;       This keyword is used only if the `CTIndex` keyword is used to select a color table number.</span>
<span class="comments">;       Setting this keyword allows Brewer color tables to be used.</span>
<span class="comments">;         </span>
<span class="comments">;    ctindex: in, optional, type=integer</span>
<span class="comments">;       The index number of a color table. The `Brewer` and `Reverse` keywords will be checked</span>
<span class="comments">;       to see how to load the color table into the `Palette` keyword. This keyword will take</span>
<span class="comments">;       precidence over any colors that are loaded with the `Palette` keyword. This keyword</span>
<span class="comments">;       applies only to 2D images.</span>
<span class="comments">;         </span>
<span class="comments">;    description: in, optional, type=string</span>
<span class="comments">;       A string that is used to describe the image in the Google Earth interface.</span>
<span class="comments">;        </span>
<span class="comments">;    draworder: in, optional, type=integer, default=0</span>
<span class="comments">;        The drawing order of image overlay. The first order is 0. Images with a higher</span>
<span class="comments">;        order are drawn on top of images with a lower order.</span>
<span class="comments">;</span>
<span class="comments">;    geotiff: in, optional, type=string</span>
<span class="comments">;       The name of a GeoTiff file from which the `image`, `mapcoord`, `palette` (possibly), </span>
<span class="comments">;       and `latlonbox` values can be obtained. </span>
<span class="comments">;        </span>
<span class="comments">;    filename: in, optional, type=string, default='kml_image.kml'</span>
<span class="comments">;        The name of the KML file that will be created. The image file will have the same name,</span>
<span class="comments">;        but with a *.png file extension. The KML file and the image file will be created in the</span>
<span class="comments">;        same directory.</span>
<span class="comments">;        </span>
<span class="comments">;    flyto: in, optional, type=fltarr(3)</span>
<span class="comments">;        A three-element array that gives the coordinates [longitude, latitude, elevation] where</span>
<span class="comments">;        the "eye" should be located with respect to the Earth. This implements a LookAt element</span>
<span class="comments">;        in KML file, so that when the KML file is open, it "flies to" the location represented</span>
<span class="comments">;        here. Longitude must be in the range -180 to 180. Latitude must be in the range -90 to 90.</span>
<span class="comments">;        And elevation is a number in kilometers. If a two-element array [longitude, latitude] is</span>
<span class="comments">;        passed in, the default value for elevation is 11000 km above the surface of the Earth.</span>
<span class="comments">;         </span>
<span class="comments">;    kmz: in, optional, type=boolean, default=0</span>
<span class="comments">;        Set this keyword to move the KML file and support files to a KMZ compressed file.</span>
<span class="comments">;        Note that this capability is ONLY available in versions of IDL starting with version 8.0.</span>
<span class="comments">;</span>
<span class="comments">;    latlonbox: out, optional, type=array</span>
<span class="comments">;        A four-element array giving the boundaries of the map projection in the</span>
<span class="comments">;        Google Map form of [north, south, east, west]. Normally, this information</span>
<span class="comments">;        is obtained from the mapCoord object and need not be passed in. The values</span>
<span class="comments">;        are in latitude and longitude coordinates that go from -90 to 90 and -180 to</span>
<span class="comments">;        180 degrees, respectively.</span>
<span class="comments">;        </span>
<span class="comments">;    max_value: in, optional</span>
<span class="comments">;        The value to use for the MAX value when the image is scaled with BYTSCL.</span>
<span class="comments">;</span>
<span class="comments">;    min_value: in, optional</span>
<span class="comments">;        The value to use for the MIN value when the image is scaled with BYTSCL.</span>
<span class="comments">;</span>
<span class="comments">;    missing_value: in, optional, type=various</span>
<span class="comments">;        The "color" of a pixel that will be treated as a "missing" color or value.</span>
<span class="comments">;        Any pixels in the image with this color value will be set completely</span>
<span class="comments">;        transparent. If `Color` is a string, use cgColor to obtain a color triple. </span>
<span class="comments">;        If `Color` is a non-strint scalar, this value is taken to be the missing color index</span>
<span class="comments">;        in a 2D image. Otherwise, this is assumed to be a color triple that indicates</span>
<span class="comments">;        the "missing" color or value in the output image. The alpha channel in the output image</span>
<span class="comments">;        is set to 0 for the "missing" color, which makes this value completely transparent.</span>
<span class="comments">;        If the `Transparent` keyword is not used, it is set to 0 by using the `Missing_Value`</span>
<span class="comments">;        keyword.</span>
<span class="comments">;        </span>
<span class="comments">;    palette: in, optional, type=byte</span>
<span class="comments">;        Set this keyword to a 3x256 or 256x3 byte array containing the RGB color </span>
<span class="comments">;        vectors to be loaded before the transparent image is created. Such vectors can be </span>
<span class="comments">;        obtained, for example, from cgLoadCT with the RGB_TABLE keyword::</span>
<span class="comments">;               </span>
<span class="comments">;                IDL> cgLoadCT, 4, /BREWER, /REVERSE, RGB_TABLE=palette</span>
<span class="comments">;                IDL> tImage = cgTransparentImage( cgDemoData(7), PALETTE=palette)</span>
<span class="comments">;                </span>
<span class="comments">;        The default is to use whatever colors are loaded in the current hardware color table.</span>
<span class="comments">;        A palette applies only to 2D input images.</span>
<span class="comments">;         </span>
<span class="comments">;    placename: in, optional, type=string</span>
<span class="comments">;        This is the &lt;name> element in a Feature object. It is user-defined text that is used as</span>
<span class="comments">;        the label for an object in Google Earth.</span>
<span class="comments">;</span>
<span class="comments">;    resize_factor: in, optional, type=float</span>
<span class="comments">;        Setting this keyword to a value allows the user to resize the image prior to making the</span>
<span class="comments">;        PNG image file that will be output with the KML file. This is especially helpful with</span>
<span class="comments">;        very large images. Setting the factor to 0.5 will reduce the image to half it's normal</span>
<span class="comments">;        size before processing. Setting the factor to 2.0 will increase the size by a factor</span>
<span class="comments">;        of 2 before processing. The image is resized with nearest neighbor sampling.</span>
<span class="comments">;</span>
<span class="comments">;    reverse: in, optional, type=boolean, default=0</span>
<span class="comments">;        Set this keyword to reverse the color table vectors selected with the `CTIndex` keyword.</span>
<span class="comments">;</span>
<span class="comments">;    transparent: in, optional, type=integer, default=50</span>
<span class="comments">;        The percentage of transparency desired in the output image. A number </span>
<span class="comments">;        between 0 and 100.</span>
<span class="comments">;        </span>
<span class="comments">; :Examples:</span>
<span class="comments">;    Here is how you can put an AVHRR NDVI image of Africa on a Google Earth display:: </span>
<span class="comments">;    </span>
<span class="comments">;       ;; Download the image file from the Coyote web page.</span>
<span class="comments">;       netObject = Obj_New('IDLnetURL')</span>
<span class="comments">;       url = 'http://www.idlcoyote.com/data/AF03sep15b.n16-VIg.tif'</span>
<span class="comments">;       returnName = netObject -> Get(URL=url, FILENAME='AF03sep15b.n16-VIg.tif')</span>
<span class="comments">;       Obj_Destroy, netObject</span>
<span class="comments">;       </span>
<span class="comments">;       ;; Create the image overlay KML file.</span>
<span class="comments">;       cgImage2KML, GeoTiff='AF03sep15b.n16-VIg.tif', Min_Value=0, CTIndex=11, $</span>
<span class="comments">;          /Brewer, /Reverse, Transparent=50, Filename='avhrr_ndvi.kml', $</span>
<span class="comments">;          Description='AVHRR NDVI Data from Africa'</span>
<span class="comments">;          </span>
<span class="comments">;       ;; Start Google Earth and open the KML file you just created.</span>
<span class="comments">;       </span>
<span class="comments">;    The output should look like the figure above.</span>
<span class="comments">;       </span>
<span class="comments">; :Author:</span>
<span class="comments">;    FANNING SOFTWARE CONSULTING::</span>
<span class="comments">;       David W. Fanning </span>
<span class="comments">;       1645 Sheely Drive</span>
<span class="comments">;       Fort Collins, CO 80526 USA</span>
<span class="comments">;       Phone: 970-221-0438</span>
<span class="comments">;       E-mail: david@idlcoyote.com</span>
<span class="comments">;       Coyote's Guide to IDL Programming: http://www.idlcoyote.com</span>
<span class="comments">;</span>
<span class="comments">; :History:</span>
<span class="comments">;     Change History::</span>
<span class="comments">;        Written, 30 October 2012 by David W. Fanning.</span>
<span class="comments">;        Added DRAWORDER keyword and fixed a typo concerning MISSING_VALUE. 31 Oct 2012. DWF.</span>
<span class="comments">;        Fixed a problem that was causing floating underflow warnings to be thrown. 5 Nov 2012. DWF.</span>
<span class="comments">;        Images with values between 0 and 255 were not getting scaled properly. Fixed. 30 Nov 2012. DWF.</span>
<span class="comments">;        Added a FlyTo keyword to allow the user to fly to a particular location on the Earth. 31 Dec 2012. DWF.</span>
<span class="comments">;        Was not handling 24- or 32-bit images correctly, nor was the MISSING_COLOR keyword being</span>
<span class="comments">;            interpreted correctly when expressed as a color string. 20 Feb 2013. DWF.</span>
<span class="comments">;        Have been writing the absolute path to the image file into the KML file, when I should</span>
<span class="comments">;            have been using a relative path. 22 Feb 2013. DWF.</span>
<span class="comments">;            </span>
<span class="comments">; :Copyright:</span>
<span class="comments">;     Copyright (c) 2012, Fanning Software Consulting, Inc.</span>
<span class="comments">;-</span>
PRO cgImage2KML, image, mapCoord, $
   ADDTOFILE=addtofile, $
   BREWER=brewer, $
   CTINDEX=ctindex, $
   DESCRIPTION=description, $
   DRAWORDER=draworder, $
   GEOTIFF=geotiff, $
   FILENAME=filename, $
   FLYTO=flyto, $
   KMZ=kmz, $
   LATLONBOX=latlonbox, $
   MAX_VALUE=max_value, $
   MIN_VALUE=min_value, $
   MISSING_VALUE=missing_value, $
   PALETTE=palette, $
   PLACENAME=placename, $
   RESIZE_FACTOR=resize_factor, $
   REVERSE=reverse, $
   TRANSPARENT=transparent

   Compile_Opt idl2
   
   <span class="comments">; Error handling.</span>
   Catch, theError
   IF theError NE 0 THEN BEGIN
       Catch, /CANCEL
       void = Error_Message()
       RETURN
   ENDIF
   
   <span class="comments">; If the KMZ keyword is set, make sure this version of IDL supports it.</span>
   IF Keyword_Set(kmz) THEN BEGIN
     IF Float(!Version.Release) LT 8.0 THEN BEGIN
        Message, 'The KMZ keyword is not supported in this version of IDL.', /Informational
        kmz = 0
     ENDIF
   ENDIF
   
   <span class="comments">; If the user sets either the MIN_VALUE or MAX_VALUE keyword, then you should scale the image.</span>
   IF (N_Elements(min_value) GT 0) || (N_Elements(max_value)  GT 0) THEN scaleit = 1 ELSE scaleit = 0
   
   <span class="comments">; Has the GEOTIFF keyword been used to obtain program variables?</span>
   IF N_Elements(geotiff) NE 0 THEN BEGIN
      mapCoord = cgGeoMap(geotiff, $
          BOUNDARY=boundary, $
          ELLIPSOID=ellipsoid, $
          IMAGE=image, $
          LATLONBOX=latlonbox, $
          MAP_PROJECTION=map_projection, $
          PALETTE=palette)
   ENDIF
   
   <span class="comments">; Check required parameters.</span>
   IF N_Elements(image) EQ 0 THEN Message, 'An image parameter is required to proceed.'
   IF N_Elements(mapCoord) EQ 0 THEN BEGIN
      IF N_Elements(latlonBox) EQ 0 THEN Message, 'A map coordinate object is required to proceed.'
   ENDIF ELSE BEGIN
      mapCoord -> GetProperty, $
          BOUNDARY=boundary, $
          ELLIPSOID=ellipsoid, $
          LATLONBOX=latlonbox, $
          MAP_PROJECTION=map_projection
   ENDELSE
   IF N_Elements(latlonBox) EQ 0 THEN Message, 'Map boundaries for the image cannot be obtained.'
   IF N_Elements(order) EQ 0 THEN order = 0
   IF (N_Elements(missing_value) NE 0) && (N_Elements(transparent) EQ 0) THEN BEGIN
      transparent = 0
   ENDIF
   
   <span class="comments">; Handle the flyTo values.</span>
   IF N_Elements(flyTo) NE 0 THEN BEGIN
       IF N_Elements(flyTo) LT 2 THEN Message, 'FlyTo keyword should be 2- or 3-element array.'
       IF N_Elements(flyTo) EQ 2 THEN flyTo = [flyTo, 11000]
       IF N_Elements(flyTo) GT 3 THEN Message, 'FlyTo keyword should be 2- or 3-element array.'
       lookAtObj = Obj_New('cgKML_LookAt', LONGITUDE=flyTo[0], LATITUDE=flyTo[1], HEIGHT=flyTo[2])
   ENDIF
   
   <span class="comments">; Need a filename?</span>
   IF N_Elements(filename) EQ 0 THEN BEGIN
      CD, CURRENT=thisDir
      filename = Filepath(ROOT_DIR=thisDir, 'kml_image.kml')
   ENDIF
   
   <span class="comments">; Construct the image filename</span>
   rootName = cgRootName(filename, DIRECTORY=thisDir, EXTENSION=ext)
   IF StrUpCase(ext) NE 'KML' THEN Message, 'The output filename must have a KML file extension.'
   imageFilename = Filepath(ROOT_DIR=thisDir, rootname + '.png')
   
   <span class="comments">; If you got this far, and you don't have a map coordinate object, you will have</span>
   <span class="comments">; to create one.</span>
   IF N_Elements(mapCoord) EQ 0 THEN BEGIN
       mapCoord = Obj_New('cgMap', 'Equirectangular', Ellipsoid='WGS 84', $
          XRange=[latlonbox[2], latlonbox[3]], YRange=[latlonBox[1], latlonbox[0]], /LATLON_RANGES)
       mapCoord -> GetProperty, $
          BOUNDARY=boundary, $
          ELLIPSOID=ellipsoid, $
          MAP_PROJECTION=map_projection
   ENDIF
   
   <span class="comments">; Are you loading a color table?</span>
   IF N_Elements(ctindex) NE 0 THEN BEGIN
      cgLoadCT, ctindex, BREWER=brewer, REVERSE=reverse, RGB_TABLE=palette
   ENDIF
   
   <span class="comments">; Otherwise, let's use gray-scale colors for the image.</span>
   IF N_Elements(palette) EQ 0 THEN cgLoadCT, 0, RGB_TABLE=palette
   
   <span class="comments">; How many dimensions does this image have?</span>
   ndims = Size(image, /N_Dimensions)
   
   <span class="comments">; Should the image be reduced in size before displaying it?</span>
   IF N_Elements(resize_factor) NE 0 THEN BEGIN
        dims = Image_Dimensions(image, XSIZE=xsize, YSIZE=ysize)
        warped = cgResizeImage(image, Long(xsize*resize_factor), Long(ysize*resize_factor))
   ENDIF ELSE warped = image
   
   <span class="comments">; If the map projection is not "EQUIRECTANGULAR" or the ellipsoid is not "WGS84", then the</span>
   <span class="comments">; image has to be warped into the correct map projection.</span>
   IF (StrUpCase(map_projection) NE 'EQUIRECTANGULAR') || (StrUpCase(StrCompress(ellipsoid, /REMOVE_ALL)) NE 'WGS84') THEN BEGIN
      googleMapCoord = Obj_New('cgMap', 'Equirectangular', Ellipsoid='WGS 84')
      ndims = Size(warped, /N_Dimensions)
      IF ndims EQ 2 THEN thisMissingValue = 0 ELSE thisMissingValue=missing_value
      warped = cgChangeMapProjection(warped, mapCoord, MAPOUT=googleMapCoord, $
          LATLONBOX=latlonbox, MISSING=thisMissingValue)
   ENDIF 
   
   <span class="comments">; Byte scale the image.</span>
   IF (N_Elements(missing_value) NE 0) THEN BEGIN
      IF ndims EQ 2 THEN BEGIN
          imgType = Size(warped, /TNAME)
          IF (imgType NE 'FLOAT') && (imgType NE 'DOUBLE') THEN warped = Float(warped)
          missing = Where(warped EQ missing_value, count)
          IF count GT 0 THEN warped[missing] = !Values.F_NAN
          IF (Min(warped, /NAN) LT 0) || (Max(warped, /NAN) GT 255) || scaleIt THEN BEGIN
             warped = BytScl(warped, MIN=min_value, MAX=max_value, /NAN, TOP=254) + 1B
          ENDIF
          IF count GT 0 THEN warped[missing] = 0B
      ENDIF
   ENDIF ELSE BEGIN
      IF (Min(warped) LT 0) || (Max(warped) GT 255) || scaleIt THEN BEGIN
         warped = BytScl(warped, MIN=min_value, MAX=max_value, /NAN)
      ENDIF
   ENDELSE
   
   <span class="comments">; If this is a 2D image, create a 24-bit image from the palette.</span>
   r = Reform(palette[*,0])
   g = Reform(palette[*,1])
   b = Reform(palette[*,2])
   IF (ndims EQ 2) THEN warped = [ [[r[warped]]], [[g[warped]]], [[b[warped]]]]
   
   <span class="comments">; Do we need transparency?</span>
   IF N_Elements(transparent) NE 0 THEN BEGIN
       IF (ndims EQ 2) THEN BEGIN
          warped = cgTransparentImage(warped, TRANSPARENT=transparent, MISSING_VALUE=[r[0],g[0],b[0]])
       ENDIF ELSE BEGIN
          warped = cgTransparentImage(warped, TRANSPARENT=transparent, MISSING_VALUE=missing_value)
       ENDELSE
   ENDIF
   
   <span class="comments">; Save the image as a PNG file.</span>
   dims = Image_Dimensions(warped, XINDEX=xindex, YINDEX=yindex, TRUEINDEX=trueindex)
   IF trueindex GT 0 THEN warped = Transpose(warped, [trueindex, xindex, yindex])
   
   IF cgObj_Isa(addtofile, 'cgKML_File') THEN BEGIN
   
      addToFile -> GetProperty, FILENAME=filename, COUNT=count
      rootname = cgRootName(filename, DIRECTORY=thisDir, EXTENSION=ext)
      imageFilename = FilePath(ROOT_DIR=thisDir, rootname + StrTrim(count+1,2) + '.png')
      
     <span class="comments">; Write the image file.</span>
     Write_PNG, imageFilename, warped
      overlay = Obj_New('cgKML_GroundOverlay', $
          HREF=File_BaseName(imageFilename), $
          DESCRIPTION=description, $
          LATLONBOX=latlonBox, $
          PLACENAME=placename, $
          DRAWORDER=draworder)
       addToFile -> Add, overlay
       
       <span class="comments">; Do you have a lookAt object?</span>
       IF Obj_Valid(lookAtObj) THEN addToFile -> Add, lookAtObj
   
   ENDIF ELSE BEGIN
   
     <span class="comments">; Write the image file.</span>
     Write_PNG, imageFilename, warped
   
     <span class="comments">; Write the KML file.</span>
     kmlFile = Obj_New('cgKML_File', filename)
     overlay = Obj_New('cgKML_GroundOverlay', $
       HREF=File_BaseName(imageFilename), $
       DESCRIPTION=description, $
       LATLONBOX=latlonBox, $
       PLACENAME=placename, $
       DRAWORDER=draworder)
     kmlFile -> Add, overlay

     <span class="comments">; Do you have a lookAt object?</span>
     IF Obj_Valid(lookAtObj) THEN kmlFile -> Add, lookAtObj
     
     kmlFile -> Save, KMZ=Keyword_Set(kmz)
     kmlFile -> Destroy
     
     
   ENDELSE
   
END
</code>
    </div>
  </body>
</html>