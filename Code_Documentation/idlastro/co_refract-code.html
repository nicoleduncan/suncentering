<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:57:21 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>co_refract.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="co_refract.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;+</span>
<span class="comments">; NAME:</span>
<span class="comments">;   CO_REFRACT()      </span>
<span class="comments">;</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;   Calculate correction to altitude due to atmospheric refraction.</span>
<span class="comments">;</span>
<span class="comments">; DESCRIPTION:</span>
<span class="comments">;   CO_REFRACT can calculate both apparent altitude from observed altitude and </span>
<span class="comments">;   vice-versa.</span>
<span class="comments">;</span>
<span class="comments">; CALLING SEQUENCE:</span>
<span class="comments">;   new_alt  = CO_REFRACT(old_alt, [ ALTITUDE= , PRESSURE= , $</span>
<span class="comments">;                                  TEMPERATURE= , /TO_OBSERVED , EPSILON= ])</span>
<span class="comments">;</span>
<span class="comments">; INPUT:</span>
<span class="comments">;   old_alt - Observed (apparent) altitude, in DEGREES.  (apparent if keyword </span>
<span class="comments">;             /TO_OBSERVED set).    May be scalar or vector.</span>
<span class="comments">;</span>
<span class="comments">; OUTPUT: </span>
<span class="comments">;     Function returns apparent (observed) altitude, in DEGREES. (observed if </span>
<span class="comments">;         keyword /TO_OBSERVED set).    Will be of same type as input </span>
<span class="comments">;         altitude(s).</span>
<span class="comments">;</span>
<span class="comments">; OPTIONAL KEYWORD INPUTS:</span>
<span class="comments">;      ALTITUDE :  The height of the observing location, in meters.  This is </span>
<span class="comments">;             only used to determine an approximate temperature and pressure, </span>
<span class="comments">;             if these are not specified separately. [default=0, i.e. sea level]</span>
<span class="comments">;      PRESSURE :  The pressure at the observing location, in millibars.</span>
<span class="comments">;      TEMPERATURE:    The temperature at the observing location, in Kelvin.</span>
<span class="comments">;      EPSILON:  When keyword /TO_OBSERVED has been set, this is the accuracy </span>
<span class="comments">;               to  obtain via the iteration, in arcseconds [default = 0.25 </span>
<span class="comments">;                arcseconds].</span>
<span class="comments">;      /TO_OBSERVED:  Set this keyword to go from Apparent->Observed altitude, </span>
<span class="comments">;                 using the iterative technique.</span>
<span class="comments">;</span>
<span class="comments">;       Note, if altitude is set, but temperature or pressure are not, the </span>
<span class="comments">;       program will make an intelligent guess for the temperature and pressure.</span>
<span class="comments">;</span>
<span class="comments">; DESCRIPTION:</span>
<span class="comments">;</span>
<span class="comments">;   Because the index of refraction of air is not precisely 1.0, the atmosphere</span>
<span class="comments">;   bends all incoming light, making a star or other celestial object appear at</span>
<span class="comments">;   a slightly different altitude (or elevation) than it really is.  It is </span>
<span class="comments">;   important to understand the following definitions:</span>
<span class="comments">;</span>
<span class="comments">;   Observed Altitude:  The altitude that a star is SEEN to BE, with a telescope.</span>
<span class="comments">;                       This is where it appears in the sky.  This is always </span>
<span class="comments">;                       GREATER than the apparent altitude.</span>
<span class="comments">;</span>
<span class="comments">;   Apparent Altitude:  The altitude that a star would be at, if *there were no</span>
<span class="comments">;                     atmosphere* (sometimes called "true" altitude). This is </span>
<span class="comments">;                     usually calculated from an object's celestial coordinates.</span>
<span class="comments">;                     Apparent altitude is always LOWER than the observed </span>
<span class="comments">;                     altitude.</span>
<span class="comments">;</span>
<span class="comments">;   Thus, for example, the Sun's apparent altitude when you see it right on the</span>
<span class="comments">;   horizon is actually -34 arcminutes.</span>
<span class="comments">;</span>
<span class="comments">;   This program uses couple simple formulae to estimate the effect for most </span>
<span class="comments">;   optical and radio wavelengths.  Typically, you know your observed altitude </span>
<span class="comments">;   (from an observation), and want the apparent altitude.  To go the other way,</span>
<span class="comments">;   this program uses an iterative approach.</span>
<span class="comments">;</span>
<span class="comments">; EXAMPLE:</span>
<span class="comments">;    The lower limb of the Sun is observed to have altitude of 0d 30'.   </span>
<span class="comments">;    Calculate the the true (=apparent) altitude of the Sun's lower limb using </span>
<span class="comments">;    mean  conditions of air pressure and temperature</span>
<span class="comments">;</span>
<span class="comments">;    IDL> print, co_refract(0.5)     ===>  0.025degrees (1.55')</span>
<span class="comments">; WAVELENGTH DEPENDENCE:</span>
<span class="comments">;    This correction is 0 at zenith, about 1 arcminute at 45 degrees, and 34 </span>
<span class="comments">;    arcminutes at the horizon FOR OPTICAL WAVELENGTHS.  The correction is </span>
<span class="comments">;    NON-NEGLIGIBLE at all wavelengths, but is not very easily calculable.  </span>
<span class="comments">;    These formulae assume a wavelength of 550 nm, and will be accurate to </span>
<span class="comments">;    about 4 arcseconds for all visible wavelengths, for elevations of 10 </span>
<span class="comments">;    degrees and higher.    Amazingly, they are also ACCURATE FOR RADIO </span>
<span class="comments">;    FREQUENCIES LESS THAN ~ 100 GHz.</span>
<span class="comments">;</span>
<span class="comments">;    It is important to understand that these formulae really can't do better </span>
<span class="comments">;    than about 30 arcseconds of accuracy very close to the horizon, as </span>
<span class="comments">;    variable atmospheric effects become very important.</span>
<span class="comments">;</span>
<span class="comments">; REFERENCES:</span>
<span class="comments">;    1.  Meeus, Astronomical Algorithms, Chapter 15.</span>
<span class="comments">;    2.  Explanatory Supplement to the Astronomical Almanac, 1992.</span>
<span class="comments">;    3.  Methods of Experimental Physics, Vol 12 Part B, Astrophysics, </span>
<span class="comments">;        Radio Telescopes, Chapter 2.5, "Refraction Effects in the Neutral </span>
<span class="comments">;        Atmosphere", by R.K. Crane.</span>
<span class="comments">;</span>
<span class="comments">;</span>
<span class="comments">; DEPENDENCIES:</span>
<span class="comments">;    CO_REFRACT_FORWARD (contained in this file and automatically compiled).</span>
<span class="comments">;</span>
<span class="comments">; AUTHOR:</span>
<span class="comments">;   Chris O'Dell</span>
<span class="comments">;       Univ. of Wisconsin-Madison</span>
<span class="comments">;   Observational Cosmology Laboratory</span>
<span class="comments">;   Email: odell@cmb.physics.wisc.edu</span>
<span class="comments">;</span>
<span class="comments">; REVISION HISTORY:</span>
<span class="comments">;    version 1 (May 31, 2002)</span>
<span class="comments">;    Update iteration formula,   W. Landsman    June 2002</span>
<span class="comments">;    Corrected slight bug associated with scalar vs. vector temperature and </span>
<span class="comments">;               pressure inputs. 6/10/2002</span>
<span class="comments">;    Fixed problem with vector input when /TO_OBSERVED set W. Landsman Dec 2005</span>
<span class="comments">;    Allow arrays with more than 32767 elements W.Landsman/C.Dickinson Feb 2010</span>
<span class="comments">;-</span>
<a id="co_refract_forward:source"></a>function co_refract_forward, a, P=P, T=T

<span class="comments">; INPUTS</span>
<span class="comments">;    a = The observed (apparent) altitude, in DEGREES.</span>
<span class="comments">;        May be scalar or vector.</span>
<span class="comments">;</span>
<span class="comments">; INPUT KEYWORDS</span>
<span class="comments">;    P:  Pressure [in millibars]. Default is 1010 millibars. [scalar or vector]</span>
<span class="comments">;    T:  Ground Temp [in Celsius].  Default is 0 Celsius. [scalar or vector]</span>

compile_opt idl2
d2r = !dpi/180.
if n_elements(P) eq 0 then P = 1010.
if n_elements(T) eq 0 then T = 283.

<span class="comments">; you have observed the altitude a, and would like to know what the "apparent" </span>
<span class="comments">; altitude is (the one behind the atmosphere).</span>
w = where(a LT 15.)
R = 0.0166667/tan((a + 7.31/(a+4.4))*d2r)

<span class="comments">;R = 1.02/tan((a + 10.3/(a+5.11))*d2r)/60. </span>
<span class="comments">; this formula goes the other direction!</span>

if w[0] ne -1 then R[w] = 3.569*(0.1594 + .0196*a[w] + $
      .00002*a[w]^2)/(1.+.505*a[w]+.0845*a[w]^2)
tpcor = P/1010. * 283/T
R = tpcor * R

return, R

END

<a id="co_refract:source"></a>function co_refract, a, altitude=altitude, pressure=pressure,  $
            temperature=temperature, To_observed=To_observed, epsilon=epsilon

<span class="comments">; This is the main window.  Calls co_refract_forward either iteratively or a </span>
<span class="comments">; single time depending on the direction we are going for refraction.</span>

compile_opt idl2
o = keyword_set(To_observed)
alpha = 0.0065 <span class="comments">; temp lapse rate [deg C per meter]</span>

if n_elements(altitude) eq 0 then altitude = 0.
if n_elements(temperature) eq 0 then begin
        if altitude GT 11000 then temperature = 211.5 $
                             else temperature = 283.0 - alpha*altitude
endif
<span class="comments">; estimate Pressure based on altitude, using U.S. Standard Atmosphere formula.</span>
if n_elements(pressure) eq 0 then $ 
              pressure = 1010.*(1-6.5/288000*altitude)^5.255
if n_elements(epsilon) eq 0 then  $
     epsilon = 0.25 <span class="comments">; accuracy of iteration for observed=1 case, in arcseconds</span>

if not o then begin
        aout = a - co_refract_forward(a,P=pressure,T=temperature)
endif else begin
        aout = a*0.
        na = n_elements(a)
<span class="comments">; if there are multiple elevations but only one temp and pressure entered, </span>
<span class="comments">; expand those to be arrays of the same size.</span>
	P = pressure + a*0. & T = temperature + a*0.
        for i=0L,na-1 do begin
                <span class="comments">;calculate initial refraction guess</span>
                dr = co_refract_forward(a[i],P=P[i],T=T[i])
            cur = a[i] + dr <span class="comments">; guess of observed location</span>

                repeat begin
                  last = cur
                  dr = co_refract_forward(cur,P=P[i],T=T[i])
                  cur= a[i] + dr
                endrep until abs(last-cur)*3600. LT epsilon
                aout[i] = cur
        endfor
endelse

if N_elements(aout) GT 1 then return, reform(aout) else return, aout

END
</code>
    </div>
  </body>
</html>