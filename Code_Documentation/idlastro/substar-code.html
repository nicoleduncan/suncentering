<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:58:03 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>substar.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="substar.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><a id="substar:source"></a>pro substar,image,x,y,mag,id,psfname,VERBOSE = verbose	<span class="comments">;Subtract scaled PSF stars</span>
<span class="comments">;+</span>
<span class="comments">; NAME:</span>
<span class="comments">;	SUBSTAR</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;	Subtract a scaled point spread function at specified star position(s).</span>
<span class="comments">; EXPLANATION:</span>
<span class="comments">;	Part of the IDL-DAOPHOT photometry sequence</span>
<span class="comments">;</span>
<span class="comments">; CALLING SEQUENCE:</span>
<span class="comments">;	SUBSTAR, image, x, y, mag, [ id, psfname, /VERBOSE] </span>
<span class="comments">;</span>
<span class="comments">; INPUT-OUTPUT:</span>
<span class="comments">;	IMAGE -  On input, IMAGE is the original image array.  A scaled</span>
<span class="comments">;		PSF will be subtracted from IMAGE at specified star positions.</span>
<span class="comments">;		Make a copy of IMAGE before calling SUBSTAR, if you want to</span>
<span class="comments">;		keep a copy of the unsubtracted image array</span>
<span class="comments">;</span>
<span class="comments">; INPUTS:</span>
<span class="comments">;	X -   REAL Vector of X positions found by NSTAR (or FIND)</span>
<span class="comments">;	Y -   REAL Vector of Y positions found by NSTAR (or FIND)        </span>
<span class="comments">;	MAG - REAL Vector of stellar magnitudes found by NSTAR (or APER)</span>
<span class="comments">;		Used to scale the PSF to match intensity at star position.</span>
<span class="comments">;		Stars with magnitude values of 0.0 are assumed missing and </span>
<span class="comments">;		ignored in the subtraction.</span>
<span class="comments">;</span>
<span class="comments">; OPTIONAL INPUTS:</span>
<span class="comments">;	ID -  Index vector indicating which stars are to be subtracted.  If</span>
<span class="comments">;		omitted, (or set equal to -1), then stars will be subtracted </span>
<span class="comments">;		at all positions specified by the X and Y vectors.</span>
<span class="comments">;</span>
<span class="comments">;	PSFNAME - Name of the FITS file containing the PSF residuals, as</span>
<span class="comments">;		generated by GETPSF.  SUBSTAR will prompt for this parameter</span>
<span class="comments">;		if not supplied.      </span>
<span class="comments">;</span>
<span class="comments">; OPTIONAL INPUT KEYWORD:</span>
<span class="comments">;	VERBOSE - If this keyword is set and nonzero, then SUBSTAR will </span>
<span class="comments">;		display the star that it is currently processing      </span>
<span class="comments">;</span>
<span class="comments">; COMMON BLOCKS:</span>
<span class="comments">;	The RINTER common block is used (see RINTER.PRO) to save time in the</span>
<span class="comments">;	PSF calculations</span>
<span class="comments">;</span>
<span class="comments">; PROCEDURES CALLED:</span>
<span class="comments">;	DAO_VALUE(), READFITS(), REMOVE, SXOPEN, SXPAR(), SXREAD()</span>
<span class="comments">; REVISION HISTORY:</span>
<span class="comments">;	Written, W. Landsman                      August, 1988</span>
<span class="comments">;	Added VERBOSE keyword                     January, 1992</span>
<span class="comments">;	Fix star subtraction near edges, W. Landsman    May, 1996</span>
<span class="comments">;	Assume the PSF file is in FITS format  W. Landsman   July, 1997</span>
<span class="comments">;	Converted to IDL V5.0   W. Landsman   September 1997</span>
<span class="comments">;-</span>
 common rinter,c1,c2,c3,init                  <span class="comments">;Save time in RINTER</span>
 if N_params() LT 4 then begin
    print,'Syntax - SUBSTAR, image, x, y, mag,[ id, psfname, /VERBOSE]'
    return
 endif 

 s = size(image)
 if s[0] NE 2 then $
    message, 'ERROR - Input array (first parameter) must be 2 dimensions'
 npts = N_elements(image)

 if N_elements(psfname) NE 1 then begin
     psfname = ''
     read, 'Enter name of the FITS file containing PSF residuals: ', psfname
 endif

 if N_params() LT 5 then id = indgen( N_elements(x) ) else begin
    if min(id) LT 0 then id = indgen( N_elements(x) )    <span class="comments">;Subtract all stars?</span>
 endelse

 psf = readfits(psfname, hpsf)
 nstar = N_elements(id)            <span class="comments">;Number of stars to subtract</span>
 gauss = sxpar( hpsf, 'GAUSS*' )
 psfmag = sxpar( hpsf, 'PSFMAG' )
 psfrad = sxpar( hpsf, 'PSFRAD' )
 fitrad = sxpar( hpsf, 'FITRAD' ) 
 npsf = sxpar( hpsf, 'NAXIS1' )

 nbox = ( 2*fix( psfrad + 0.5 ) + 1) > ((npsf-7)/2)
 nhalf = (nbox-1)/2
 psfrsq = psfrad^2
 lx = fix( x[id] + 0.5 ) - nhalf
 ly = fix( y[id] + 0.5 ) - nhalf
 smag = mag[id]
 scale = 10^(-0.4*(smag- psfmag))
 xx = x[id] - lx
 yy = y[id] - ly 
 bad = where( (smag EQ 0.0), Nbad)        <span class="comments">;Any stars with missing magnitudes?</span>
 if Nbad GT 0 then begin
	nstar = nstar - Nbad
	remove,bad,lx,ly,xx,yy,scale
 endif
 rsq = fltarr( nbox, nbox)
 boxgen = indgen(nbox)

<span class="comments">;     Compute RINTER common block arrays</span>

 p_1 = shift(psf,1,0) & p1 = shift(psf,-1,0) & p2 = shift(psf,-2,0)
 c1 = 0.5*(p1-p_1)
 c2 = 2.*p1 + p_1 - 0.5*(5.*psf + p2)
 c3 = 0.5 *(3.*(psf-p1) + p2 - p_1)
 init = 1

 verbose = keyword_set(VERBOSE)
 cr = string("15b)
 for i = 0L,nstar-1 do begin                                 
   dx = boxgen - xx[i]
   dy = boxgen - yy[i]
   dx2 = dx^2 & dy2 = dy^2
   for j = 0,nbox-1 do rsq[0,j] = dx2 + dy2[j]
   good = where( rsq LT psfrsq)
   xgood = good mod nbox      &  ygood = good/nbox
   dx = dx[xgood]             &  dy = dy[ygood]
   goodbig = ( xgood + lx[i] ) + ( ygood + ly[i] )*s[1]
   bad = where( (goodbig LT 0) or (goodbig GE npts), Nbad)
   if nbad GT 0 then remove,bad,goodbig,dx,dy
   image[goodbig] = image[goodbig] - scale[i] * dao_value( dx,dy,gauss,psf )
   if VERBOSE then  $
             print,f="($,'SUBSTAR: Processing Star',I5,A)",id[i],cr
endfor                                                 
return
end
</code>
    </div>
  </body>
</html>