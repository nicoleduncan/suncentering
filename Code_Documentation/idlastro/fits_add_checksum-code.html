<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:57:30 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>fits_add_checksum.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="fits_add_checksum.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><a id="fits_add_checksum:source"></a>pro fits_add_checksum, hdr, im, no_timestamp = no_timestamp, $
              FROM_IEEE=from_IEEE
<span class="comments">;+</span>
<span class="comments">; NAME:</span>
<span class="comments">;    FITS_ADD_CHECKSUM</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;    Add or update the CHECKSUM and DATASUM keywords in a FITS header</span>
<span class="comments">; EXPLANATION: </span>
<span class="comments">;     Follows the 23 May 2002 version of the FITS checksum proposal at </span>
<span class="comments">;     http://heasarc.gsfc.nasa.gov/docs/heasarc/fits/checksum.html  </span>
<span class="comments">; CALLING SEQUENCE:</span>
<span class="comments">;     FITS_ADD_CHECKSUM, Hdr, [ Data, /No_TIMESTAMP, /FROM_IEEE ]</span>
<span class="comments">; INPUT-OUTPUT:</span>
<span class="comments">;     Hdr - FITS header (string array), it will be updated with new </span>
<span class="comments">;           (or modfied) CHECKSUM and DATASUM keywords </span>
<span class="comments">; OPTIONAL INPUT:</span>
<span class="comments">;     Data - data array associated with the FITS header.   If not supplied, or</span>
<span class="comments">;           set to a scalar, then the program checks whether there is a </span>
<span class="comments">;           DATASUM keyword already in the FITS header containing the 32bit</span>
<span class="comments">;           checksum for the data.   if there is no such keyword then there </span>
<span class="comments">;           assumed to be no data array associated with the FITS header.</span>
<span class="comments">; OPTIONAL INPUT KEYWORDS:</span>
<span class="comments">;    /FROM_IEEE - If this keyword is set, then the input is assumed to be in </span>
<span class="comments">;             big endian format (e.g. an untranslated FITS array).    This </span>
<span class="comments">;             keyword only has an effect on little endian machines (e.g. </span>
<span class="comments">;             a Linux box).</span>
<span class="comments">;    /No_TIMESTAMP - If set, then a time stamp is not included in the comment</span>
<span class="comments">;             field of the CHECKSUM and DATASUM keywords.   Unless the </span>
<span class="comments">;             /No_TIMESTAMP keyword is set, repeated calls to FITS_ADD_CHECKSUM</span>
<span class="comments">;             with the same header and data will yield different values of </span>
<span class="comments">;             CHECKSUM (as the date stamp always changes).   However, use of the</span>
<span class="comments">;             date stamp is recommended in the checksum proposal. </span>
<span class="comments">; PROCEDURES USED:</span>
<span class="comments">;     CHECKSUM32, FITS_ASCII_ENCODE(), GET_DATE, SXADDPAR, SXPAR()</span>
<span class="comments">; REVISION HISTORY:</span>
<span class="comments">;     W. Landsman    SSAI    December 2002</span>
<span class="comments">;     Fix problem with images with a multiple of 2880 bytes.  W.L. May 2008</span>
<span class="comments">;     Avoid conversion error when DATASUM is an empty string  W.L.  June 2008</span>
<span class="comments">;     Don't update DATASUM if not already present and no data array supplied </span>
<span class="comments">;                       W.L. July 2008 </span>
<span class="comments">;     Make sure input header array has 80 chars/line  W.L. Aug 2009</span>
<span class="comments">;-</span>
 On_error,2
 compile_opt idl2
 
 if N_params() EQ 0 then begin 
     print,'Syntax - FITS_ADD_CHECKSUM, Hdr, Data, /No_TIMESTAMP, /FROM_IEEE'
     return
 endif

 datasum = sxpar(hdr,'DATASUM', Count = N_DATASUM)
 Nim = N_elements(im)
 datasum_update = 1b
 if Nim GT 1 then begin
     checksum32,im, dsum,FROM_IEEE = from_IEEE
     remain = Nim mod 2880
     if remain GT 0 then begin
         exten = sxpar( hdr, 'XTENSION', Count = N_exten)
         if N_exten GT 0 then if exten EQ 'TABLE   ' then $
                 checksum32,[dsum,replicate(32b,2880-remain)],dsum
    endif
    sdsum = strtrim(dsum,2)
    dsum_exist= 1b
 endif else begin 
        if N_datasum EQ 0 then begin      <span class="comments">;Don't update DATASUM keyword </span>
	      datasum_update = 0b     
 	      sdsum = '         0' 
	 endif else begin
	   if strtrim(datasum,2) EQ '' then dsum=0 else dsum = ulong(datasum)
           sdsum = strtrim(dsum,2)
       endelse   
 endelse 
 
 if keyword_set(no_timestamp) then tm = '' else Get_date,tm,/timetag

<span class="comments">; Do the Checksum keywords already exist?</span>

  if N_DATASUM GT 0 then verb = 'updated ' else verb = 'created '
  if datasum_update then sxaddpar,hdr,'DATASUM', sdsum,  $
    ' data unit checksum ' + verb + tm

 test = sxpar(hdr,'CHECKSUM', Count = N_CHECKSUM)
 if N_CHECKSUM GT 0 then verb = 'updated ' else verb = 'created '
 sxaddpar,hdr,'CHECKSUM','0000000000000000', $
       ' HDU checksum ' + verb + tm   <span class="comments">;Initialize CHECKSUM keyword</span>
<span class="comments">;Make sure each line in header is 80 characters</span>
 if ~array_equal(strlen(hdr),80) then begin
     n = N_elements(hdr)
     bhdr = replicate(32b,80,n )
     for i=0, n-1 do bhdr[0,i] = byte(hdr[i])
 endif else bhdr = byte(hdr)

 remain = N_elements(bhdr) mod 2880 
 if remain  NE 0 then $
       bhdr = [reform(bhdr,N_elements(bhdr)), replicate(32b, 2880 - remain) ]
 checksum32,bhdr, hsum, /NoSAVE
 if N_elements(dsum) GT 0 then checksum32, [dsum,hsum], hdusum $
                        else hdusum = hsum
 
 ch = FITS_ASCII_ENCODE(not hdusum) <span class="comments">;ASCII encode the complement of the checksum </span>
 sxaddpar,hdr,'CHECKSUM',ch

 return
 end
</code>
    </div>
  </body>
</html>