<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:58:13 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>xy2ad.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="xy2ad.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><a id="xy2ad:source"></a>pro xy2ad, x, y, astr, a, d
<span class="comments">;+</span>
<span class="comments">; NAME:</span>
<span class="comments">;     XY2AD</span>
<span class="comments">;</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;     Compute R.A. and Dec from X and Y and a FITS astrometry structure</span>
<span class="comments">; EXPLANATION:</span>
<span class="comments">;     The astrometry structure must first be extracted by EXTAST from a FITS</span>
<span class="comments">;     header.   The offset from the reference pixel is computed and the CD </span>
<span class="comments">;     matrix is applied.     If distortion is present then this is corrected.</span>
<span class="comments">;     If a WCS projection (Calabretta & Greisen 2002, A&A, 395, 1077) is </span>
<span class="comments">;     present, then the procedure WCSXY2SPH is used to compute astronomical</span>
<span class="comments">;     coordinates.    Angles are returned in  degrees.</span>
<span class="comments">;   </span>
<span class="comments">;     XY2AD is meant to be used internal to other procedures.  </span>
<span class="comments">;     For interactive purposes use XYAD.</span>
<span class="comments">;</span>
<span class="comments">; CALLING SEQUENCE:</span>
<span class="comments">;     XY2AD, x, y, astr, a, d   </span>
<span class="comments">;</span>
<span class="comments">; INPUTS:</span>
<span class="comments">;     X     - row position in pixels, scalar or vector</span>
<span class="comments">;     Y     - column position in pixels, scalar or vector</span>
<span class="comments">;           X and Y should be in the standard IDL convention (first pixel is</span>
<span class="comments">;           0), and not the FITS convention (first pixel is 1). </span>
<span class="comments">;     ASTR - astrometry structure, output from EXTAST procedure containing:</span>
<span class="comments">;        .CD   -  2 x 2 array containing the astrometry parameters CD1_1 CD1_2</span>
<span class="comments">;               in DEGREES/PIXEL                                   CD2_1 CD2_2</span>
<span class="comments">;        .CDELT - 2 element vector giving physical increment at reference pixel</span>
<span class="comments">;        .CRPIX - 2 element vector giving X and Y coordinates of reference pixel</span>
<span class="comments">;               (def = NAXIS/2)</span>
<span class="comments">;        .CRVAL - 2 element vector giving R.A. and DEC of reference pixel </span>
<span class="comments">;               in DEGREES</span>
<span class="comments">;        .CTYPE - 2 element vector giving projection types </span>
<span class="comments">;        .LONGPOLE - scalar longitude of north pole</span>
<span class="comments">;        .LATPOLE - scalar giving native latitude of the celestial pole</span>
<span class="comments">;        .PV2 - Vector of projection parameter associated with latitude axis</span>
<span class="comments">;             PV2 will have up to 21 elements for the ZPN projection, up to 3</span>
<span class="comments">;             for the SIN projection and no more than 2 for any other</span>
<span class="comments">;             projection</span>
<span class="comments">;        .DISTORT - Optional substructure specifying distortion parameters</span>
<span class="comments">;                  </span>
<span class="comments">;</span>
<span class="comments">; OUTPUT:</span>
<span class="comments">;     A - R.A. in DEGREES, same number of elements as X and Y</span>
<span class="comments">;     D - Dec. in DEGREES, same number of elements as X and Y</span>
<span class="comments">;</span>
<span class="comments">; RESTRICTIONS:</span>
<span class="comments">;       Note that all angles are in degrees, including CD and CRVAL</span>
<span class="comments">;       Also note that the CRPIX keyword assumes an FORTRAN type</span>
<span class="comments">;       array beginning at (1,1), while X and Y give the IDL position</span>
<span class="comments">;       beginning at (0,0).   No parameter checking is performed.</span>
<span class="comments">;</span>
<span class="comments">; NOTES:</span>
<span class="comments">;      AD2XY tests for presence of WCS coordinates by the presence of a dash </span>
<span class="comments">;      in the 5th character position in the value of CTYPE (e.g 'DEC--SIN').       </span>
<span class="comments">; PROCEDURES USED:</span>
<span class="comments">;       TAG_EXIST(), WCSXY2SPH</span>
<span class="comments">; REVISION HISTORY:</span>
<span class="comments">;       Written by R. Cornett, SASC Tech., 4/7/86</span>
<span class="comments">;       Converted to IDL by B. Boothman, SASC Tech., 4/21/86</span>
<span class="comments">;       Perform CD  multiplication in degrees  W. Landsman   Dec 1994</span>
<span class="comments">;       Understand reversed X,Y (X-Dec, Y-RA) axes,   W. Landsman  October 1998</span>
<span class="comments">;       Consistent conversion between CROTA and CD matrix W. Landsman Oct. 2000</span>
<span class="comments">;       No special case for tangent projection W. Landsman June 2003</span>
<span class="comments">;       Work for non-WCS coordinate transformations W. Landsman Oct 2004</span>
<span class="comments">;       Use CRVAL reference point for non-WCS transformation  W.L. March 2007</span>
<span class="comments">;       Use post V6.0 notation   W.L. July 2009</span>
<span class="comments">;       </span>
<span class="comments">;- </span>
 compile_opt idl2
 if N_params() LT 4 then begin
        print,'Syntax -- XY2AD, x, y, astr, a, d'
        return
 endif
 radeg = 180.0d/!DPI                  <span class="comments">;Double precision !RADEG</span>

 cd = astr.cd
 crpix = astr.crpix
 cdelt = astr.cdelt
 if cdelt[0] NE 1.0 then begin 
         cd[0,0] *= cdelt[0] & cd[0,1] *= cdelt[0]
         cd[1,1] *= cdelt[1] & cd[1,0] *= cdelt[1]
  endif


 xdif = x - (crpix[0]-1)            
 ydif = y - (crpix[1]-1)
 
 if tag_exist(astr,'DISTORT') then begin
      if astr.distort.name EQ 'SIP' then begin
           distort  = astr.distort
           a = distort.a
           b = distort.b
           na = ((size(a,/dimen))[0])
           xdif1 = xdif
           ydif1 = ydif
           
           for i=0,na-1 do begin
               for j=0,na-1 do begin
                  if a[i,j] NE 0.0 then xdif1 +=  xdif^i*ydif^j*a[i,j]            
                  if b[i,j] NE 0.0 then ydif1 +=  xdif^i*ydif^j*b[i,j]
           endfor
           endfor

           xdif = xdif1
           ydif = ydif1
           
      endif
 endif

 xsi = cd[0,0]*xdif + cd[0,1]*ydif   <span class="comments">;Can't use matrix notation, in</span>
 eta = cd[1,0]*xdif + cd[1,1]*ydif   <span class="comments">;case X and Y are vectors</span>

 ctype = astr.ctype
 crval = astr.crval
 coord = strmid(ctype,0,4)
 reverse = ((coord[0] EQ 'DEC-') && (coord[1] EQ 'RA--')) || $
           ((coord[0] EQ 'GLAT') && (coord[1] EQ 'GLON')) || $
           ((coord[0] EQ 'ELAT') && (coord[1] EQ 'ELON'))

 if reverse then begin
     crval = rotate(crval,2)
     temp = xsi & xsi = eta & eta = temp
 endif

 if strmid(ctype[0],4,1) EQ '-' then begin
 WCSXY2SPH, xsi, eta, a, d, CTYPE = ctype[0:1], PV2 = astr.pv2, $
        LONGPOLE = astr.longpole, CRVAL = crval, LATPOLE = astr.latpole
 endif else begin
         a = crval[0] +xsi & d = crval[1] + eta	
 endelse
 return
 end
</code>
    </div>
  </body>
</html>