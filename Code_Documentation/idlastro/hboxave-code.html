<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:57:40 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>hboxave.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="hboxave.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><a id="hboxave:source"></a>pro hboxave, oldim, oldhd, newim, newhd, box, ERRMSG = errmsg   <span class="comments">;Boxaverage and update header</span>
<span class="comments">;+</span>
<span class="comments">; NAME:</span>
<span class="comments">;       HBOXAVE</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;       Box average an image array and update the FITS header array</span>
<span class="comments">; EXPLANATION:</span>
<span class="comments">;       The function BOXAVE() is used.  This procedure is recommended for </span>
<span class="comments">;       integer images when photometric precision is desired, because it </span>
<span class="comments">;       performs intermediate steps using REAL*4 arithmetic.   Otherwise, the </span>
<span class="comments">;       procedure HREBIN is much faster.</span>
<span class="comments">;</span>
<span class="comments">; CALLING SEQUENCE:</span>
<span class="comments">;       HBOXAVE, Oldim, Oldhd, Newim, Hewhd, box</span>
<span class="comments">;               or</span>
<span class="comments">;       HBOXAVE, Oldim, Oldhd, box</span>
<span class="comments">;</span>
<span class="comments">; INPUTS:</span>
<span class="comments">;       Oldim - the original image array</span>
<span class="comments">;       Oldhd - the original image FITS header, string array</span>
<span class="comments">;</span>
<span class="comments">; OPTIONAL INPUTS:</span>
<span class="comments">;       box - the box size to be used, integer scalar.  If omitted, then</span>
<span class="comments">;               HBOXAVE will prompt for this parameter.</span>
<span class="comments">;</span>
<span class="comments">; OPTIONAL OUTPUTS:</span>
<span class="comments">;       Newim - the image after boxaveraging</span>
<span class="comments">;       Newhd - header for newim containing updated astrometry info</span>
<span class="comments">;               If output parameters are not supplied, the program</span>
<span class="comments">;               will modify the input parameters OLDIM and OLDHD</span>
<span class="comments">;               to contain the new array and updated header.</span>
<span class="comments">; OPTIONAL KEYWORD OUTPUT:</span>
<span class="comments">;       ERRMSG - If this keyword is supplied, then any error mesasges will be</span>
<span class="comments">;               returned to the user in this parameter rather than depending on</span>
<span class="comments">;               on the MESSAGE routine in IDL.   If no errors are encountered</span>
<span class="comments">;               then a null string is returned.               </span>
<span class="comments">;</span>
<span class="comments">; PROCEDURE:</span>
<span class="comments">;       The parameters BSCALE, NAXIS1, NAXIS2, CRPIX1, and CRPIX2 and</span>
<span class="comments">;       the CD (or CDELT) parameters are updated for the new FITS header.</span>
<span class="comments">;</span>
<span class="comments">; EXAMPLE:</span>
<span class="comments">;       Compress the image in a FITS file 'image.fits' by a factor of 4 and </span>
<span class="comments">;       update the astrometry in the FITS header</span>
<span class="comments">;</span>
<span class="comments">;       IDL> im = readfits('image.fits',hdr)    ;Read FITS file into IDL arrays</span>
<span class="comments">;       IDL> hboxave, im, hdr, 4                ;Boxaverage by 4</span>
<span class="comments">;       IDL> writefits,'image.fits',im,hdr      ;Write a new FITS file</span>
<span class="comments">;</span>
<span class="comments">; CALLED PROCEDURES:</span>
<span class="comments">;       CHECK_FITS - Check that the FITS header is appropriate to the image</span>
<span class="comments">;       BOXAVE() - Performs box averaging of an image</span>
<span class="comments">;       SXPAR(), SXADDPAR - Read and write FITS keyword values</span>
<span class="comments">;</span>
<span class="comments">; MODIFICATION HISTORY:</span>
<span class="comments">;       Written, Aug. 1986 W. Landsman, STI Corp.</span>
<span class="comments">;       IDLV2 changes, sxaddpar format keyword added, J. Isensee, July,1990</span>
<span class="comments">;       Fix 0.5 pixel offset in new CRPIX computation W. Landsman, Dec, 1991</span>
<span class="comments">;       Update BSCALE even if no astrometry present   W. Landsman, May 1997</span>
<span class="comments">;       Converted to IDL V5.0   W. Landsman   September 1997</span>
<span class="comments">;       Added ERRMSG keyword, Use double formatting   W. Landsman   April 2000</span>
<span class="comments">;       Recognize PC matrix astrometry format    W. Landsman   December 2001</span>
<span class="comments">;- </span>
 On_error,2                               <span class="comments">;Return to caller on error</span>

 npar = N_params()

 if ( npar LT 2 ) then begin            <span class="comments">;Check # of parameters</span>
     print,'Syntax: HBOXAVE, oldim, oldhd, [ newim, newhd, box, ERRMSG = ]'
     print,'    or  HBOXAVE, oldim, oldhd, [ box, ERRMSG =  ]'
     return
 endif

 save_err = arg_present(errmsg)      <span class="comments">;Does user want to return error messages?</span>
<span class="comments">;                                    Check for valid 2-D image & header</span>
  check_FITS, oldim, oldhd, dimen, /NOTYPE, ERRMSG = errmsg
  if errmsg NE '' then begin
        if not save_err then message,'ERROR - ' + errmsg,/CON
        return
  endif

  if N_elements(dimen) NE 2 then begin 
           errmsg = 'Input image array must be 2-dimensional'
           if not save_err then message,'ERROR - ' + errmsg,/CON
           return
  endif
 
 xsize = dimen[0]  &  ysize = dimen[1]
 if npar EQ 3 then begin

    box = newim

 endif else if (npar NE 5) then begin    <span class="comments">;prompt for box size</span>

   print,'Boxaverage an image and update header'
   print,'Original array size is '+ strn(xsize) + ' by ' + strn(ysize)
   read, 'Enter width of box to be used in box average: ',box

 endif

 box = fix(box)                      <span class="comments">;Check for integer type </span>
 if N_elements(box) NE 1 then begin
    box = 0
    read, 'Enter width of box to be used in box average: ',box
 endif

 newx = xsize/float(box)
 newy = ysize/float(box)

 if (newx*box NE xsize) or (newy*box NE ysize) then $
    message,'ERROR - Box size does not evenly divide image size'

 if npar GT 3 then newim = boxave( oldim, box) else $
                   oldim = boxave( oldim, box)

 newhd = oldhd
 sxaddpar, newhd, 'NAXIS1', fix(newx)
 sxaddpar, newhd, 'NAXIS2', fix(newy)
 label = 'HBOXAVE:' + strmid( systime(), 4, 20)
 sxaddpar, newhd, 'HISTORY', label + ' Original Image Size Was ' + $
    strn(xsize) + ' by ' +  strn(ysize) 
 sxaddpar, newhd, 'HISTORY',label+' Box Width: '+ strn(box)+' Pixels'

<span class="comments">; Update astrometry info if it exists</span>

 extast, oldhd, astr, noparams
 if noparams GE 0 then begin

 pix_ratio = box*box     <span class="comments">;Ratio of old to new pixel areas</span>

 crpix = (astr.crpix - 0.5)/box + 0.5
 sxaddpar, newhd, 'CRPIX1', crpix[0]
 sxaddpar, newhd, 'CRPIX2', crpix[1]

 if (noparams NE 2) then begin 

    cdelt = astr.cdelt
    sxaddpar, newhd, 'CDELT1', CDELT[0]*box
    sxaddpar, newhd, 'CDELT2', CDELT[1]*box

 endif else begin       <span class="comments">;CDn_m Matrix</span>

    cd = astr.cd
    sxaddpar, newhd, 'CD1_1', cd[0,0]*box
    sxaddpar, newhd, 'CD1_2', cd[0,1]*box
    sxaddpar, newhd, 'CD2_1', cd[1,0]*box
    sxaddpar, newhd, 'CD2_2', cd[1,1]*box

 endelse 
 endif
 
 bscale = sxpar( oldhd, 'BSCALE')
 if ( bscale NE 0 )  and ( bscale NE 1) then $
      sxaddpar, newhd, 'BSCALE', bscale*pix_ratio, ' CALIBRATION FACTOR'

 bzero = sxpar( oldhd, 'BZERO')
 if ( bzero NE 0) then sxaddpar, newhd, 'BZERO', bzero*pix_ratio, $
        ' ADDITIVE CONST FOR CALIB'

 if npar LT 4 then oldhd = newhd
 return
 end
</code>
    </div>
  </body>
</html>