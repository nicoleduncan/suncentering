<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:57:47 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>max_likelihood.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="max_likelihood.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;+</span>
<span class="comments">; NAME:</span>
<span class="comments">;	MAX_LIKELIHOOD</span>
<span class="comments">;</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;	Maximum likelihood deconvolution of an image or a spectrum.</span>
<span class="comments">; EXPLANATION:</span>
<span class="comments">; 	Deconvolution of an observed image (or spectrum) given the </span>
<span class="comments">;	instrument point spread response function (spatially invariant psf).</span>
<span class="comments">;	Performs iteration based on the Maximum Likelihood solution for</span>
<span class="comments">;	the restoration of a blurred image (or spectrum) with additive noise.</span>
<span class="comments">;	Maximum Likelihood formulation can assume Poisson noise statistics</span>
<span class="comments">;	or Gaussian additive noise, yielding two types of iteration.</span>
<span class="comments">;</span>
<span class="comments">; CALLING SEQUENCE:</span>
<span class="comments">;	for i=1,Niter do Max_Likelihood, data, psf, deconv, FT_PSF=psf_ft</span>
<span class="comments">;</span>
<span class="comments">; INPUTS PARAMETERS:</span>
<span class="comments">;	data = observed image or spectrum, should be mostly positive,</span>
<span class="comments">;				with mean sky (background) near zero.</span>
<span class="comments">;	psf = Point Spread Function of the observing instrument,</span>
<span class="comments">;				(response to a point source, must sum to unity).</span>
<span class="comments">; INPUT/OUTPUT PARAMETERS:</span>
<span class="comments">;	deconv = as input: the result of previous call to Max_Likelihood,</span>
<span class="comments">;		(initial guess on first call, default = average of data),</span>
<span class="comments">;		as output: result of one more iteration by Max_Likelihood.</span>
<span class="comments">;	Re_conv = (optional) the current deconv image reconvolved with PSF</span>
<span class="comments">;		for use in next iteration and to check convergence.</span>
<span class="comments">;</span>
<span class="comments">; OPTIONAL INPUT KEYWORDS:</span>
<span class="comments">;      /GAUSSIAN causes max-likelihood iteration for Gaussian additive noise</span>
<span class="comments">;		to be used,  otherwise the default is Poisson statistics.</span>
<span class="comments">;	FT_PSF = passes (out/in) the Fourier transform of the PSF,</span>
<span class="comments">;		so that it can be reused for the next time procedure is called,</span>
<span class="comments">;      /NO_FT overrides the use of FFT, using the IDL function convol() instead.</span>
<span class="comments">;	POSITIVITY_EPS = value of epsilon passed to function positivity,</span>
<span class="comments">;			default = -1 which means no action (identity).</span>
<span class="comments">;	UNDERFLOW_ZERO = cutoff to consider as zero, if numbers less than this.</span>
<span class="comments">;</span>
<span class="comments">; EXTERNAL CALLS:</span>
<span class="comments">;	function convolve( image, psf ) for convolutions using FFT or otherwise.</span>
<span class="comments">;	function positivity( image, EPS= ) to make image positive.</span>
<span class="comments">;</span>
<span class="comments">; METHOD:</span>
<span class="comments">;	Maximum Likelihood solution is a fixed point of an iterative eq.</span>
<span class="comments">;	(derived by setting partial derivatives of Log(Likelihood) to zero).</span>
<span class="comments">;	Poisson noise case was derived by Richardson(1972) & Lucy(1974).</span>
<span class="comments">;	Gaussian noise case is similar with subtraction instead of division.</span>
<span class="comments">; NOTES:</span>
<span class="comments">;       WARNING: The Poisson case may not conserve flux for an odd image size.  </span>
<span class="comments">;       This behavior is being investigated.</span>
<span class="comments">; HISTORY:</span>
<span class="comments">;	written: Frank Varosi at NASA/GSFC, 1992.</span>
<span class="comments">;	F.V. 1993, added optional arg. Re_conv (to avoid doing it twice).</span>
<span class="comments">;	Converted to IDL V5.0   W. Landsman   September 1997</span>
<span class="comments">;       Use COMPLEMENT keyword to WHERE()   W. Landsman  Jan 2008</span>
<span class="comments">;-</span>

<a id="Max_Likelihood:source"></a>pro Max_Likelihood, data, psf, deconv, Re_conv, FT_PSF=psf_ft, NO_FT=noft, $
						GAUSSIAN=gaussian, $
						POSITIVITY_EPS=epsilon, $
						UNDERFLOW_ZERO=under
        compile_opt idl2
	if N_elements( deconv ) NE N_elements( data ) then begin
		deconv = data
		deconv[*] = total( data )/N_elements( data )
		Re_conv = 0
	   endif

	if N_elements( under ) NE 1 then under = 1.e-22
	if N_elements( epsilon ) NE 1 then epsilon = -1
	if N_elements( Re_conv ) NE N_elements( deconv ) then $
		Re_conv = convolve( positivity( deconv, EPS=epsilon ), psf, $
						  FT_PSF=psf_ft, NO_FT=noft )
	if keyword_set( gaussian ) then begin

		deconv = deconv + convolve( data - Re_conv, psf, /CORREL, $
						   FT_PSF=psf_ft, NO_FT=noft )
	  endif else begin
		wp = where( Re_conv GT under, npos, $
		     ncomplement=nneg,complement=wz)
              
		if (npos GT 0) then Re_conv[wp] = ( data[wp]/Re_conv[wp] ) > 0
		if (nneg GT 0) then Re_conv[wz] = 1.
		deconv = deconv * convolve( Re_conv, psf, FT_PSF=psf_ft, $
							/CORREL, NO_FT=noft )
	   endelse
	   
	if N_params() GE 4 then $
		Re_conv = convolve( positivity( deconv, EPS=epsilon ), psf, $
						FT_PSF = psf_ft, NO_FT = noft )
						
 end
</code>
    </div>
  </body>
</html>