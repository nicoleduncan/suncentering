<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:57:30 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>fitexy.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="fitexy.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;+</span>
<span class="comments">; NAME:</span>
<span class="comments">;       FITEXY</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;       Best straight-line fit to data with errors in both coordinates</span>
<span class="comments">; EXPLANATION:</span>
<span class="comments">;       Linear Least-squares approximation in one-dimension (y = a + b*x),</span>
<span class="comments">;               when both x and y data have errors</span>
<span class="comments">;</span>
<span class="comments">; CALLING EXAMPLE:</span>
<span class="comments">;       FITEXY, x, y, A, B, X_SIG= , Y_SIG= , [sigma_A_B, chi_sq, q, TOL=]</span>
<span class="comments">;</span>
<span class="comments">; INPUTS:</span>
<span class="comments">;       x = array of values for independent variable.</span>
<span class="comments">;       y = array of data values assumed to be linearly dependent on x.</span>
<span class="comments">;</span>
<span class="comments">; REQUIRED INPUT KEYWORDS:</span>
<span class="comments">;       X_SIGMA = scalar or array specifying the standard deviation of x data.</span>
<span class="comments">;       Y_SIGMA = scalar or array specifying the standard deviation of y data.</span>
<span class="comments">;</span>
<span class="comments">; OPTIONAL INPUT KEYWORD:</span>
<span class="comments">;       TOLERANCE = desired accuracy of minimum & zero location, default=1.e-3.</span>
<span class="comments">;</span>
<span class="comments">; OUTPUTS:</span>
<span class="comments">;       A_intercept = constant parameter result of linear fit,</span>
<span class="comments">;       B_slope = slope parameter, so that:</span>
<span class="comments">;                       ( A_intercept + B_slope * x ) approximates the y data.</span>
<span class="comments">; OPTIONAL OUTPUT:</span>
<span class="comments">;       sigma_A_B = two element array giving standard deviation of </span>
<span class="comments">;                A_intercept and B_slope parameters, respectively.</span>
<span class="comments">;                The standard deviations are not meaningful if (i) the</span>
<span class="comments">;                fit is poor (see parameter q), or (ii) b is so large that</span>
<span class="comments">;                the data are consistent with a vertical (infinite b) line.</span>
<span class="comments">;                If the data are consistent with *all* values of b, then</span>
<span class="comments">;                sigma_A_B = [1e33,e33]  </span>
<span class="comments">;       chi_sq = resulting minimum Chi-Square of Linear fit, scalar</span>
<span class="comments">;       q - chi-sq probability, scalar (0-1) giving the probability that</span>
<span class="comments">;              a correct model would give a value equal or larger than the</span>
<span class="comments">;              observed chi squared.   A small value of q indicates a poor</span>
<span class="comments">;              fit, perhaps because the errors are underestimated.   As </span>
<span class="comments">;              discussed by Tremaine et al. (2002, ApJ, 574, 740) an </span>
<span class="comments">;              underestimate of the errors (e.g. due to an intrinsic dispersion)</span>
<span class="comments">;              can lead to a bias in the derived slope, and it may be worth</span>
<span class="comments">;              enlarging the error bars to get a reduced chi_sq ~ 1</span>
<span class="comments">;</span>
<span class="comments">; COMMON:</span>
<span class="comments">;       common fitexy, communicates the data for computation of chi-square.</span>
<span class="comments">;</span>
<span class="comments">; PROCEDURE CALLS:</span>
<span class="comments">;       CHISQ_FITEXY()            ;Included in this file</span>
<span class="comments">;       MINF_BRACKET, MINF_PARABOLIC, ZBRENT    ;In IDL Astronomy Library </span>
<span class="comments">;       MOMENT(), CHISQR_PDF()     ;In standard IDL distribution</span>
<span class="comments">;</span>
<span class="comments">; PROCEDURE:</span>
<span class="comments">;       From "Numerical Recipes" column by Press and Teukolsky: </span>
<span class="comments">;       in "Computer in Physics",  May, 1992 Vol.6 No.3</span>
<span class="comments">;       Also see the 2nd edition of the book "Numerical Recipes" by Press et al.</span>
<span class="comments">;</span>
<span class="comments">;       In order to avoid  problems with data sets where X and Y are of very </span>
<span class="comments">;       different order of magnitude the data are normalized before the fitting</span>
<span class="comments">;       process is started.     The following normalization is used:</span>
<span class="comments">;       xx = (x - xm) / xs    and    sigx = x_sigma / xs    </span>
<span class="comments">;                             where xm = MEAN(x) and xs = STDDEV(x)</span>
<span class="comments">;       yy = (y - ym) / ys    and    sigy = y_sigma / ys    </span>
<span class="comments">;                             where ym = MEAN(y) and ys = STDDEV(y)</span>
<span class="comments">;</span>
<span class="comments">;</span>
<span class="comments">; MODIFICATION HISTORY:</span>
<span class="comments">;       Written, Frank Varosi NASA/GSFC  September 1992.</span>
<span class="comments">;       Now returns q rather than 1-q   W. Landsman  December 1992</span>
<span class="comments">;       Use CHISQR_PDF, MOMENT instead of STDEV,CHI_SQR1 W. Landsman April 1998</span>
<span class="comments">;       Fixed typo for initial guess of slope, this error was nearly</span>
<span class="comments">;             always insignificant          W. Landsman   March 2000</span>
<span class="comments">;       Normalize X,Y before calculation (from F. Holland) W. Landsman Nov 2006</span>
<span class="comments">;-</span>
<a id="chisq_fitexy:source"></a>function chisq_fitexy, B_angle
<span class="comments">;</span>
<span class="comments">; NAME:</span>
<span class="comments">;       chisq_fitexy</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;       Function minimized by fitexy  (computes chi-square of linear fit).</span>
<span class="comments">;       It is called by minimization procedures during execution of fitexy.</span>
<span class="comments">; CALLING SEQUENCE:</span>
<span class="comments">;               chisq = chisq_fitexy( B_angle )</span>
<span class="comments">; INPUTS:</span>
<span class="comments">;       B_angle = arc-tangent of B_slope of linear fit.</span>
<span class="comments">; OUTPUTS:</span>
<span class="comments">;       Result of function = chi_square - offs  (offs is in COMMON).</span>
<span class="comments">; COMMON:</span>
<span class="comments">;       common fitexy, communicates the data from pro fitexy.</span>
<span class="comments">; PROCEDURE:</span>
<span class="comments">;       From "Numerical Recipes" column: Computer in Physics Vol.6 No.3</span>
<span class="comments">; MODIFICATION HISTORY:</span>
<span class="comments">;       Written, Frank Varosi NASA/GSFC 1992.</span>

  common fitexy, xx, yy, sigx, sigy, ww, Ai, offs

        B_slope = tan( B_angle )
        ww = 1/( ( (B_slope * sigx)^2 + sigy^2 ) > 1.e-30 )
        if N_elements( ww ) EQ 1 then sumw = ww * N_elements( xx ) $
                                 else sumw = total( ww )
        y_Bx = yy - B_slope * xx
        Ai = total( ww * y_Bx )/sumw

return, total( ww * (y_Bx - Ai)^2 ) - offs
end
<span class="comments">;-------------------------------------------------------------------------------</span>
<a id="fitexy:source"></a>pro fitexy, x, y, A_intercept, B_slope, sigma_A_B, chi_sq, q, TOLERANCE=Tol, $
                                        X_SIGMA=x_sigma, Y_SIGMA=y_sigma
  compile_opt idl2					
  common fitexy, xx, yy, sigx, sigy, ww, Ai, offs

  if N_params() LT 4 then begin
     print,'Syntax -  fitexy, x, y, A, B, X_SIG=sigx, Y_SIG=sigy,' 
     print,'                  [sigma_A_B, chi_sq, q, TOLERANCE = ]'
     return
  endif
  
<span class="comments">; Normalize data before running fitexy</span>

  xm = (MOMENT(x, SDEV = xs, /DOUBLE))[0]
  ym = (MOMENT(y, SDEV = ys, /DOUBLE))[0]
  xx = (x - xm) / xs
  yy = (y - ym) / ys
  sigx = x_sigma / xs
  sigy = y_sigma / ys
 
   
<span class="comments">;Compute first guess for B_slope using standard 1-D Linear Least-squares fit,</span>
<span class="comments">; where the non-linear term involving errors in x are ignored.</span>
<span class="comments">; (note that Tx is a transform to reduce roundoff errors)</span>

        ww = sigx^2 + sigy^2
        if N_elements( ww ) EQ 1 then sumw = ww * N_elements( xx ) $
                                 else sumw = total( ww )
        Sx = total( xx * ww )
        Tx = xx - Sx/sumw
        B = total( ww * yy * Tx ) / total( ww * Tx^2 )

<span class="comments">;Find the minimum chi-sq while including the non-linear term (B * sigx)^2</span>
<span class="comments">; involving variance in x data (computed by function chisq_fitexy):</span>
<span class="comments">; using minf_bracket (=MNBRAK) and minf_parabolic (=BRENT)</span>
        offs = 0
        ang = [ 0, atan( B ), 1.571 ]
        chi = fltarr( 3 )
        for j=0,2 do chi[j] = chisq_fitexy( ang[j] )    <span class="comments">;this is for later...</span>
        if N_elements( Tol ) NE 1 then Tol=1.e-3
        a0 = ang[0]
        a1 = ang[1]
        minf_bracket, a0,a1,a2, c0,c1,c2, FUNC="chisq_fitexy"
        minf_parabolic, a0,a1,a2, Bang, chi_sq, FUNC="chisq_fitexy", TOL=Tol

        if N_params() EQ 7 then q = 1 - chisqr_pdf( chi_sq, N_elements(x) - 2 )
        A_intercept = Ai        <span class="comments">;computed in function chisq_fitexy</span>
        ang = [a0,a1,a2,ang]
        chi = [c0,c1,c2,chi]

<span class="comments">;Now compute the variances of estimated parameters,</span>
<span class="comments">; by finding roots of ( (chi_sq + 1) - chisq_fitexy ).</span>
<span class="comments">;Note: ww, Ai are computed in function chisq_fitexy.</span>

        offs = chi_sq + 1
        wc = where( chi GT offs, nc )

        if (nc GT 0) then begin

                angw = [ang[wc]]
                d1 = abs( angw - Bang ) MOD !PI
                d2 = !PI - d1
                wa = where( angw LT Bang, na )

                if (na GT 0) then begin
                        d = d1[wa]
                        d1[wa] = d2[wa]
                        d2[wa] = d
                   endif

                Bmax = zbrent( Bang,Bang+max(d1),F="chisq_fitexy",T=Tol ) -Bang
                Amax = Ai - A_intercept
                Bmin = zbrent( Bang,Bang-min(d2),F="chisq_fitexy",T=Tol ) -Bang
                Amin = Ai - A_intercept

                if N_elements( ww ) EQ 1 then r2 = 2/( ww * N_elements( x ) ) $
                                         else r2 = 2/total( ww )

                sigma_A_B = [ Amin^2 + Amax^2 + r2 , Bmin^2 + Bmax^2 ]
                sig_A_B = sqrt( sigma_A_B/2 ) / ([1,cos(Bang)^2])

          endif 

<span class="comments">;Finally, transform parameters back to orignal units.</span>


        B_slope = tan( Bang ) *ys /xs
        A_intercept = A_intercept*ys - tan(Bang) * ys / xs *xm + ym
        if Nc GT 0 then sigma_A_B = [SQRT( (sig_A_B[0] * ys)^2 +  $
                    (sig_A_B[1] * ys / xs * xm)^2 ), sig_A_B[1] * ys / xs] $
                else sigma_A_B = [1.e33,1.e33]    

return
end
</code>
    </div>
  </body>
</html>