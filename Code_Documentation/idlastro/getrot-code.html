<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:57:39 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>getrot.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="getrot.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><a id="getrot:source"></a>pro getrot, hdr, rot, cdelt, DEBUG = debug, SILENT = silent, ALT=alt      <span class="comments">;GET ROTation </span>
<span class="comments">;+</span>
<span class="comments">; NAME:</span>
<span class="comments">;    GETROT</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;     Return the rotation and plate scale of an image from its FITS header</span>
<span class="comments">; EXPLANATION:</span>
<span class="comments">;     Derive the counterclockwise rotation angle, and the X and Y scale</span>
<span class="comments">;     factors of an image, from a FITS image header.   The input parameter </span>
<span class="comments">;     may be either a FITS image header or an astrometry structure (as </span>
<span class="comments">;     obtained by extast.pro)</span>
<span class="comments">;</span>
<span class="comments">; CALLING SEQUENCE:</span>
<span class="comments">;     GETROT, Hdr, [ Rot, CDelt, /SILENT, DEBUG =  ]   </span>
<span class="comments">;             or </span>
<span class="comments">;     GETROT, Astr, Rot, CDelt, /SILENT, DEBUG = ]       </span>
<span class="comments">;</span>
<span class="comments">; INPUT PARAMETERS:</span>
<span class="comments">;     HDR - FITS Image header (string array).  Program will extract the </span>
<span class="comments">;             astrometry structure</span>
<span class="comments">;              or</span>
<span class="comments">;     ASTR -  ASTROMETRY structure, of the type returned by EXTAST.</span>
<span class="comments">;             See the documentation for EXTAST.PRO for details.</span>
<span class="comments">;</span>
<span class="comments">; OPTIONAL OUTPUT PARAMETERS:</span>
<span class="comments">;       ROT - Scalar giving the counterclockwise rotation of NORTH in DEGREES </span>
<span class="comments">;               from the +Y axis of the image.</span>
<span class="comments">;       CDELT- 2 element vector giving the scale factors in DEGREES/PIXEL in </span>
<span class="comments">;               the X and Y directions.   CDELT[1] is always positive, whereas</span>
<span class="comments">;               CDELT[0] is negative for a normal left-handed coordinate system,</span>
<span class="comments">;               and positive for a right-handed system. </span>
<span class="comments">;</span>
<span class="comments">;       If no output variables are supplied (or /DEBUG is set), then GETROT </span>
<span class="comments">;       will display the rotation and plate scale at the terminal.</span>
<span class="comments">;</span>
<span class="comments">; OPTIONAL INPUT KEYWORD</span>
<span class="comments">; </span>
<span class="comments">;       ALT - single character 'A' through 'Z' or ' ' specifying an alternate</span>
<span class="comments">;             astrometry system present in the FITS header.   See extast.pro</span>
<span class="comments">;             for more information on the ALT keyword.    Ignored if an</span>
<span class="comments">;             astrometry structure rather than FITS header is supplied.</span>
<span class="comments">;       DEBUG - if DEBUG is set, GETROT will print the rotation for both the </span>
<span class="comments">;           X and Y axis when these values are unequal.  If DEBUG is set to 2, </span>
<span class="comments">;           then the output parameter ROT will contain both X and Y rotations.</span>
<span class="comments">;</span>
<span class="comments">;       /SILENT - if set, then do not provide a warning about a right-handed</span>
<span class="comments">;           coordinate system</span>
<span class="comments">; PROCEDURE:</span>
<span class="comments">;       If the FITS header already contains CDELT (and CD or CROTA) keyword,</span>
<span class="comments">;       (as suggested by the Calabretta & Greisen (2002, A&A, 395, 1077) FITS </span>
<span class="comments">;       standard) then this is used for the scale factor.</span>
<span class="comments">;       </span>
<span class="comments">;       If the header contains CD keywords but no CDELT keywords (as in IRAF</span>
<span class="comments">;       headers) then the scale factor is derived from the CD matrix.</span>
<span class="comments">;</span>
<span class="comments">;       In case of skew (different rotations of the X and Y axes), the rotations</span>
<span class="comments">;       are averaged together if they are less than 2 degrees.   Otherwise,</span>
<span class="comments">;       a warning is given and the X rotation is used.  </span>
<span class="comments">;</span>
<span class="comments">; PROCEDURES USED:</span>
<span class="comments">;       EXTAST, GSSS_EXTAST</span>
<span class="comments">; REVISION HISTORY:</span>
<span class="comments">;       Written W. Landsman STX January 1987 </span>
<span class="comments">;       Option to return both rotations added.  J. D. Offenberg, STX, Aug 1991</span>
<span class="comments">;       Use new astrometry structure   W. Landsman  Mar 1994</span>
<span class="comments">;       Recognize a GSSS header        W. Landsman  June 1994</span>
<span class="comments">;       Correct rotation determination with unequal CDELT values WL October 1998</span>
<span class="comments">;       Consistent conversion between CROTA and CD matrix  WL  October 2000</span>
<span class="comments">;       Correct CDELT computations for rotations near 90 deg WL November 2002</span>
<span class="comments">;       Preserve sign in the CDELT output  WL June 2003</span>
<span class="comments">;       Check if latitude/longitude reversed in CTYPE  WL  February 2004</span>
<span class="comments">;       Fix problem in latitude check  M.Lombardi/W.Landsman Sep 2004</span>
<span class="comments">;       Added ALT keyword W. Landsman May 2005</span>
<span class="comments">;       Account for any rotation of the native system by examining the value</span>
<span class="comments">;        of LONGPOLE       H. Taylor/W. Landsman</span>
<span class="comments">;       Account for case where X,Y rotations differ by 2*!pi WL. Aug 2011</span>
<span class="comments">;-</span>
 Compile_opt IDL2
 On_error,2

 if N_params() EQ 0 then begin
        print,'Syntax: GETROT, Hdr, [ Rot, CDelt, DEBUG= , /SILENT, ALT=]'
        print,'    OR: GETROT, Astr, [ Rot, CDelt, DEBUG= , /SILENT]'
        return
 endif

 tpi = 2*!dpi
 if ~keyword_set(DEBUG) then debug = 0
 radeg = 180.0/!DPI
 sz = size(hdr,/STR)                <span class="comments">;Did user supply a FITS header or a CD matrix?</span>

 if ((sz.N_dimensions eq 1) && $
     (sz.type_name EQ 'STRING')) then begin     <span class="comments">;FITS header?</span>

        extast,hdr,astr,alt=alt             <span class="comments">;Extract astrometry from header,</span>
        if strmid(astr.ctype[0],5,3) EQ 'GSS' then begin
                hdr1 = hdr
                gsss_stdast, hdr1
                extast, hdr1, astr
        endif
        cd = astr.cd/RADEG      <span class="comments">;then extract CD matrix from astrometry.</span>
        if N_elements(cd) NE 4 then $
            message,'ERROR - Header is missing astrometry keywords CD or CDELT'

endif else $
 if ((sz.N_dimensions eq 1) and $
     (sz.type_name EQ 'STRUCT')) then begin     <span class="comments">;Astrometry Structure?</span>
      astr = hdr
      cd = astr.cd/RADEG
 endif else message, $
        'ERROR - First parameter must be an image header or astrometry structure'

 if astr.cdelt[0] NE 1.0 then begin
        cdelt = astr.cdelt
        cd[0,0] *= cdelt[0] & cd[0,1] *= cdelt[0]
        cd[1,1] *= cdelt[1] & cd[1,0] *= cdelt[1]
 endif else  cd = astr.cd/RADEG                                        
 
 ctype = strmid(astr.ctype[0],0,4)
<span class="comments">; Check if first coordinate in CTYPE is latitude</span>
 if (ctype EQ 'DEC-') or (strmid(ctype, 1) EQ 'LAT')  then $
      cd = reverse(cd,1)
 det = cd[0,0]*cd[1,1] - cd[0,1]*cd[1,0]
 if det LT 0 then sgn = -1 else sgn = 1
 if ~keyword_set(SILENT) then if det GT 0 then $
   message,'WARNING - Astrometry is for a right-handed coordinate system',/INF
 cdelt = fltarr(2)
 if (cd[1,0] eq 0) && (cd[0,1] eq 0) then begin <span class="comments">;Unrotated coordinates?</span>
   rot = 0.
   rot2 = 0.
   cdelt[0] = cd[0,0]
   cdelt[1] = cd[1,1]
 endif else begin
   rot  = atan(  sgn*cd[0,1],  sgn*cd[0,0] ) 
   rot2 = atan( -cd[1,0],  cd[1,1] )
  

 if rot NE rot2 then begin          <span class="comments">;Handle unequal rotations</span>
      if keyword_set(debug) then $
        print,'X axis rotation:',rot*!RADEG, ' Y axis rotation:',rot2*!RADEG
      if debug eq 2 then rot = [rot,rot2] else begin
      
      if abs(rot - rot2)*!RADEG LT 2 then rot = (rot + rot2)/2. else $
      if abs(rot - rot2- tpi)*!radeg lt 2  then rot = (rot +rot2 -tpi)/2. else $
      if abs(rot - rot2 +tpi)*!radeg lt 2  then rot = (rot +rot2 +tpi)/2. else $
         message,/INF, $
	 'WARNING: X and Y axis rotations differ by more than 2 degrees'
      endelse
      
 endif

  cdelt[0] =   sgn*sqrt(cd[0,0]^2 + cd[0,1]^2)
  cdelt[1] =   sqrt(cd[1,1]^2 + cd[1,0]^2)
 endelse

 rot = rot*RADEG   
 if astr.longpole NE 180.0d then rot = rot + ( 180.0d - astr.longpole )
 rot = float(rot)
 cdelt = float(cdelt*RADEG)

 if N_params() EQ 1 || keyword_set(DEBUG) then begin
        if debug LT 2 then print,'Rotation (counterclockwise)',rot,' degrees'
        print,'Sampling interval X axis',cdelt[0]*3600.,' arc seconds/pixel'
        print,'                  Y axis',cdelt[1]*3600.,' arc seconds/pixel'
 endif

 return
 end
</code>
    </div>
  </body>
</html>