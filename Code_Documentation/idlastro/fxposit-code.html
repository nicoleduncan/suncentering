<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:57:37 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>fxposit.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="fxposit.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source">        FUNCTION FXPOSIT, XFILE, EXT_NO, readonly=readonly, COMPRESS=COMPRESS, $
                 SILENT = Silent, EXTNUM = extnum, ERRMSG= ERRMSG, $
		 LUNIT = lunit, UNIXPIPE= unixpipe, FPACK= fpack, $
		 NO_FPACK = no_fpack,HEADERONLY=headeronly
<span class="comments">;+</span>
<span class="comments">; NAME:</span>
<span class="comments">;     FXPOSIT</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;     Return the unit number of a FITS file positioned at specified extension</span>
<span class="comments">; EXPLANATION:</span>
<span class="comments">;     The FITS file will be ready to be read at the beginning of the </span>
<span class="comments">;     specified extension.    Either an extension number or extension name</span>
<span class="comments">;     can be specified.   Called by headfits.pro, mrdfits.pro</span>
<span class="comments">;</span>
<span class="comments">;     Modified in March 2009 to set the /SWAP_IF_LITTLE_ENDIAN keyword</span>
<span class="comments">;     when opening a file, and **may not be compatible with earlier versions**</span>
<span class="comments">; CALLING SEQUENCE:</span>
<span class="comments">;     unit=FXPOSIT(FILE, EXT_NO_OR_NAME, /READONLY, COMPRESS=program, </span>
<span class="comments">;                       UNIXPIPE=, ERRMSG= , EXTNUM= , UNIT=, /SILENT</span>
<span class="comments">;                        /FPACK, /NO_FPACK</span>
<span class="comments">;</span>
<span class="comments">; INPUT PARAMETERS:</span>
<span class="comments">;     FILE    = FITS file name, scalar string.    If an empty string is supplied</span>
<span class="comments">;              then the user will be prompted for the file name.   The user</span>
<span class="comments">;              will also be prompted if a wild card is supplied, and more than </span>
<span class="comments">;              one file matches the wildcard.</span>
<span class="comments">;     EXT_NO_OR_NAME  = Either the extension to be moved to (scalar </span>
<span class="comments">;               nonnegative integer) or the name of the extension to read </span>
<span class="comments">;               (scalar string)</span>
<span class="comments">;</span>
<span class="comments">; RETURNS:</span>
<span class="comments">;     Unit number of file or -1 if an error is detected.</span>
<span class="comments">;</span>
<span class="comments">; OPTIONAL INPUT KEYWORD PARAMETER:</span>
<span class="comments">;     COMPRESS - If this keyword is set and non-zero, then then treat</span>
<span class="comments">;                the file as compressed.  If 1 assume a gzipped file.</span>
<span class="comments">;                and use IDLs internal decompression facility.    For Unix </span>
<span class="comments">;                compressed or bzip2 compressed files spawn off a process to </span>
<span class="comments">;                decompress and use its output as the FITS stream.  If the </span>
<span class="comments">;                keyword is not 1, then use its value as a string giving the </span>
<span class="comments">;                command needed for decompression.</span>
<span class="comments">;     /FPACK - Signal that the file is compressed with the FPACK software. </span>
<span class="comments">;               http://heasarc.gsfc.nasa.gov/fitsio/fpack/ ) By default, </span>
<span class="comments">;               (FXPOSIT will assume that if the file name extension ends in </span>
<span class="comments">;              .fz that it is fpack compressed.)     The FPACK software must</span>
<span class="comments">;               be installed on the system </span>
<span class="comments">;     /NO_FPACK - The unit will only be used to read the FITS header.  In</span>
<span class="comments">;                 that case FPACK compressed files need not be uncompressed.</span>
<span class="comments">;      LUNIT -    Integer giving the file unit number.    Use this keyword if</span>
<span class="comments">;                you want to override the default use of GET_LUN to obtain</span>
<span class="comments">;                a unit number.</span>
<span class="comments">;     /READONLY - If this keyword is set and non-zero, then OPENR rather </span>
<span class="comments">;                than OPENU will be used to open the FITS file.    Note that</span>
<span class="comments">;                 compressed files are always set to /READONLY</span>
<span class="comments">;     /SILENT    If set, then suppress any messages about invalid characters</span>
<span class="comments">;                in the FITS file.</span>
<span class="comments">;</span>
<span class="comments">; OPTIONAL OUTPUT KEYWORDS:</span>
<span class="comments">;       EXTNUM - Nonnegative integer give the extension number actually read</span>
<span class="comments">;               Useful only if the extension was specified by name.</span>
<span class="comments">;       ERRMSG  = If this keyword is present, then any error messages will be</span>
<span class="comments">;                 returned to the user in this parameter rather than</span>
<span class="comments">;                 depending on the MESSAGE routine in IDL.  If no errors are</span>
<span class="comments">;                 encountered, then a null string is returned.</span>
<span class="comments">;       UNIXPIPE - If set to 1, then the FITS file was opened with a UNIX pipe</span>
<span class="comments">;                rather than with the OPENR command.    This is only required </span>
<span class="comments">;                 when reading a FPACK, bzip or Unix compressed file.   Note </span>
<span class="comments">;                 that automatic byteswapping cannnot be set for a Unix pipe, </span>
<span class="comments">;                 since the SWAP_IF_LITTLE_ENDIAN keyword is only available for the</span>
<span class="comments">;                 OPEN command, and it is the responsibilty of the calling </span>
<span class="comments">;                 routine to perform the byteswapping.</span>
<span class="comments">; SIDE EFFECTS:</span>
<span class="comments">;      Opens and returns a file unit.</span>
<span class="comments">; PROCEDURE:</span>
<span class="comments">;      Open the appropriate file, or spawn a command and intercept</span>
<span class="comments">;      the output.</span>
<span class="comments">;      Call FXMOVE to get to the appropriate extension.</span>
<span class="comments">; PROCEDURE CALLS:</span>
<span class="comments">;      FXMOVE()</span>
<span class="comments">; MODIFICATION HISTORY:</span>
<span class="comments">;      Derived from William Thompson's FXFINDEND routine.</span>
<span class="comments">;      Modified by T.McGlynn, 5-October-1994.</span>
<span class="comments">;       Modified by T.McGlynn, 25-Feb-1995 to handle compressed</span>
<span class="comments">;          files.  Pipes cannot be accessed using FXHREAD so</span>
<span class="comments">;          MRD_HREAD was written.</span>
<span class="comments">;       W. Landsman 23-Apr-1997    Force the /bin/sh shell when uncompressing </span>
<span class="comments">;       T. McGlynn  03-June-1999   Use /noshell option to get rid of processes left by spawn.</span>
<span class="comments">;                                  Use findfile to retain ability to use wildcards</span>
<span class="comments">;       W. Landsman 03-Aug-1999    Use EXPAND_TILDE under Unix to find file</span>
<span class="comments">;       T. McGlynn  04-Apr-2000    Put reading code into FXMOVE,</span>
<span class="comments">;                                  additional support for compression from D.Palmer.</span>
<span class="comments">;       W. Landsman/D.Zarro 04-Jul-2000    Added test for !VERSION.OS EQ 'Win32' (WinNT)</span>
<span class="comments">;       W. Landsman    12-Dec-2000 Added /SILENT keyword</span>
<span class="comments">;       W. Landsman April 2002     Use FILE_SEARCH for V5.5 or later</span>
<span class="comments">;       W. Landsman Feb 2004       Assume since V5.3 (OPENR,/COMPRESS available)</span>
<span class="comments">;       W. Landsman,W. Thompson, 2-Mar-2004, Add support for BZIP2 </span>
<span class="comments">;       W. Landsman                Don't leave open file if an error occurs</span>
<span class="comments">;       W. Landsman  Sep 2004      Treat FTZ extension as gzip compressed</span>
<span class="comments">;       W. Landsman  Feb 2006      Removed leading spaces (prior to V5.5)</span>
<span class="comments">;       W. Landsman  Nov 2006      Allow specification of extension name</span>
<span class="comments">;                                  Added EXTNUM, ERRMSG keywords</span>
<span class="comments">;       W. Landsman/N.Piskunov Dec 2007  Added LUNIT keyword</span>
<span class="comments">;       W. Landsman     Mar 2009   OPEN with /SWAP_IF_LITTLE_ENDIAN</span>
<span class="comments">;                                  Added UNIXPIPE output keyword</span>
<span class="comments">;       N. Rich        May 2009    Check if filename is an empty string</span>
<span class="comments">;       W. Landsman   May 2009     Support FPACK compressed files</span>
<span class="comments">;                                  Added /FPACK, /HEADERONLY keywords</span>
<span class="comments">;       W.Landsman    July 2009    Deprecated /HEADERONLY add /NO_FPACK</span>
<span class="comments">;       W.Landsman    July 2011    Check for SIMPLE in first 8 chars </span>
<span class="comments">;               Use gunzip to decompress Unix. Z file since compress utility </span>
<span class="comments">;               often not installed anymore)</span>
<span class="comments">;       W. Landsman   October 2012 Add .fz extension if /FPACK set</span>
<span class="comments">;-</span>
<span class="comments">;</span>
        On_Error,2
        compile_opt idl2  
<span class="comments">;</span>
<span class="comments">;  Check the number of parameters.</span>
<span class="comments">;</span>
        IF N_Params() LT 2 THEN BEGIN 
            PRINT,'SYNTAX:  UNIT = FXPOSIT(FILE, EXT_NO, /Readonly,' + $
	                   'ERRMSG= , /SILENT, compress=prog, LUNIT = lunit)'
            RETURN,-1
        ENDIF
        PRINTERR = ~ARG_PRESENT(ERRMSG)
	ERRMSG = ''
	UNIXPIPE=0
<span class="comments">; The /headeronly keyword has been replaced with /no_fpack	</span>
        if ~keyword_set(no_fpack) then no_fpack = keyword_set(headeronly)
	exten = ext_no

   	COUNT=0
	IF XFILE[0] NE '' THEN BEGIN 
             FILE = FILE_SEARCH(XFILE, COUNT=COUNT)  
	     IF COUNT GT 1 THEN $
	          FILE = DIALOG_PICKFILE(FILTER=XFILE, /MUST_EXIST, $
		         TITLE = 'Please select a FITS file')
	ENDIF ELSE BEGIN 
             FILE =DIALOG_PICKFILE(FILTER=['*.fit*;*.fts*;*.img*;*.FIT*'], $
	           TITLE='Please select a FITS file',/MUST_EXIST)
         ENDELSE
             COUNT = N_ELEMENTS(FILE)
	            

        IF COUNT EQ 0 THEN BEGIN
	    ERRMSG = 'Specified FITS File not found ' + XFILE[0]
	    IF PRINTERR THEN MESSAGE,ERRMSG,/CON 
            RETURN, -1   <span class="comments">; Don't print anything out, just report an error</span>
	ENDIF    
        
        FILE = FILE[0]
	IF KEYWORD_SET(FPACK) then $
	    if strlowcase(strmid(FILE,2,3,/reverse)) NE '.fz' then $
	    FILE += '.fz'
	    
<span class="comments">;</span>
<span class="comments">;  Check if logical unit number is specified explicitly.</span>
<span class="comments">;</span>
        IF KEYWORD_SET(LUNIT) THEN BEGIN 
	   UNIT=LUNIT 
	   GLUN = 0
	ENDIF ELSE BEGIN 
	    UNIT = -1
            GLUN = 1
       ENDELSE
<span class="comments">; </span>
<span class="comments">;  Check if this is a compressed file.</span>
<span class="comments">;</span>
        UCMPRS = ' '
	IF KEYWORD_SET(compress) THEN BEGIN
	    IF strcompress(string(compress),/remo) eq '1' THEN BEGIN
	        compress = 'gunzip'
	    ENDIF
	    UCMPRS = compress<span class="comments">;</span>
	ENDIF ELSE IF KEYWORD_SET(FPACK) THEN $
	    UCMPRS = 'funpack'      $
	ELSE BEGIN
        
            LEN = STRLEN(FILE)
            IF LEN GT 3 THEN $
	        tail = STRLOWCASE(STRMID(file, len-3, 3))  $
	    ELSE tail = ' '
	    
            IF STRMID(tail,1,2) EQ '.z'  THEN $
                UCMPRS = 'gunzip'   $
	    ELSE IF (tail EQ '.gz') || (tail EQ 'ftz') THEN $
	        UCMPRS = 'gzip'       $
	    ELSE IF tail EQ 'bz2' THEN $
	        UCMPRS = 'bunzip2'     $
	    ELSE IF ~KEYWORD_SET(NO_FPACK) THEN $
	          IF tail EQ '.fz' THEN UCMPRS = 'funpack'	
	    
	ENDELSE

<span class="comments">;  Handle compressed files which are always opened for Read only.</span>

	IF UCMPRS EQ 'gzip' THEN BEGIN
	        
                OPENR, UNIT, FILE, /COMPRESS, GET_LUN=glun, ERROR = ERROR, $
		           /SWAP_IF_LITTLE       
                IF ERROR NE 0 THEN BEGIN
                        IF PRINTERR THEN PRINT,!ERROR_STATE.MSG ELSE $
			    ERRMSG = !ERROR_STATE.MSG 
                        RETURN,-1
                ENDIF
 
	ENDIF ELSE IF UCMPRS NE ' ' THEN BEGIN
<span class="comments">; Handle FPACK compressed file.        If an extension name is supplied then</span>
<span class="comments">; first recursively call FXPOSIT to get the extension number.    Then open </span>
<span class="comments">; the bidirectional pipe. 	</span>
		        if UCMPRS EQ 'funpack' then begin
			if size(exten,/TNAME) EQ 'STRING' THEN BEGIN
			unit = fxposit( file, ext_no, /no_fpack,extnum=extnum)
			free_lun,unit
			exten = extnum
			endif 
			SPAWN, [UCMPRS,'-S',FILE], UNIT=UNIT, /NOSHELL 
			ENDIF else $
                        SPAWN, [UCMPRS,'-c',FILE], UNIT=UNIT, /NOSHELL
			UNIXPIPE = 1
                  
        ENDIF ELSE BEGIN
<span class="comments">;</span>
<span class="comments">;  Go to the start of the file.</span>
<span class="comments">;</span>
                IF KEYWORD_SET(READONLY) THEN $
                    OPENR, UNIT, FILE, GET_LUN=glun, ERROR = ERROR, $
                           /SWAP_IF_LITTLE ELSE                     $
                    OPENU, UNIT, FILE, GET_LUN=glun, ERROR = ERROR, $
                           /SWAP_IF_LITTLE 

                IF ERROR NE 0 THEN BEGIN
                        IF PRINTERR THEN PRINT,!ERROR_STATE.MSG ELSE $
			    ERRMSG = !ERROR_STATE.MSG 
                        RETURN,-1
                ENDIF
        ENDELSE
	
        IF SIZE(EXT_NO,/TNAME) NE 'STRING' THEN $
	      IF EXT_NO LE 0 THEN RETURN, UNIT

<span class="comments">;For Uncompresed files test that the first 8 characters are 'SIMPLE'</span>

        IF ucmprs EQ ' ' THEN BEGIN
          simple = BytArr(6)
	  READU,unit,simple
          if string(simple) NE 'SIMPLE' then begin 
                IF ~KEYWORD_SET(LUNIT) THEN Free_Lun, unit
	        ERRMSG = "ERROR - FITS File must begin with 'SIMPLE'" 
		if printerr THEN MESSAGE,errmsg,/CON
		return,-1
           endif 	
	point_lun,unit,0    	
	endif
	
	stat = FXMOVE(unit, exten, SILENT = Silent, EXT_NO = extnum, $
	ERRMSG=errmsg)

	IF stat LT 0 THEN BEGIN
            IF ~KEYWORD_SET(LUNIT) THEN Free_Lun, unit
	    IF PrintErr THEN MESSAGE,ErrMsg
	    RETURN, stat
	ENDIF ELSE RETURN, unit
END
</code>
    </div>
  </body>
</html>