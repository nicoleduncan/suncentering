<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:57:24 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>dbbuild.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="dbbuild.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><a id="dbbuild:source"></a>pro dbbuild,v1,v2,v3,v4,v5,v6,v7,v8,v9,v10,v11,v12,v13,v14,v15,v16,v17,v18, $
    v19,v20,v21,v22,v23,v24,v25,v26,v27,v28,v29,v30,v31,v32,v33,v34,v35,v36, $
    v37,v38,v39,v40,v41,v42,v43,v44,v45,v46,v47,v48,v49,v50, $
    NOINDEX = noindex, STATUS=STATUS, SILENT=SILENT
<span class="comments">;+</span>
<span class="comments">; NAME:</span>
<span class="comments">;	DBBUILD</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;	Build a database by appending new values for every item.  </span>
<span class="comments">; EXPLANATION:</span>
<span class="comments">;	The database must be opened for update (with DBOPEN) before calling </span>
<span class="comments">;	DBBUILD.     This version for IDL V6.1 or later.</span>
<span class="comments">;</span>
<span class="comments">; CALLING SEQUENCE:</span>
<span class="comments">;	DBBUILD, [ v1, v2, v3, v4......v50, /NOINDEX, /SILENT, STATUS =  ]</span>
<span class="comments">;</span>
<span class="comments">; INPUTS:</span>
<span class="comments">;	v1,v2....v50 - vectors containing values for all items in the database.</span>
<span class="comments">;         V1 contains values for the first item, V2 for the second, etc.</span>
<span class="comments">;         The number of vectors supplied must equal the number of items</span>
<span class="comments">;         (excluding entry number) in the database.  The number of elements </span>
<span class="comments">;         in each vector should be the same.   A multiple valued item</span>
<span class="comments">;         should be dimensioned NVALUE by NENTRY, where NVALUE is the number</span>
<span class="comments">;         of values, and NENTRY is the number of entries.</span>
<span class="comments">;</span>
<span class="comments">; OPTIONAL INPUT KEYWORDS:</span>
<span class="comments">;	/NOINDEX - If this keyword is supplied and non-zero then DBBUILD will</span>
<span class="comments">;             *not* create an indexed file.    Useful to save time if</span>
<span class="comments">;             DBBUILD is to be called several times and the indexed file need</span>
<span class="comments">;             only be created on the last call</span>
<span class="comments">;</span>
<span class="comments">;	/SILENT  - If the keyword SILENT is set and non-zero, then DBBUILD</span>
<span class="comments">;	      will not print a message when the index files are generated</span>
<span class="comments">;</span>
<span class="comments">; OPTIONAL OUTPUT KEYWORD:</span>
<span class="comments">;	STATUS - Returns a status code denoting whether the operation was</span>
<span class="comments">;	      successful (1) or unsuccessful (0).  Useful when DBBUILD is</span>
<span class="comments">;	      called from within other applications.</span>
<span class="comments">;</span>
<span class="comments">; EXAMPLE:</span>
<span class="comments">;	Suppose a database named STARS contains the four items NAME,RA,DEC, and </span>
<span class="comments">;	FLUX.   Assume that one already has the four vectors containing the</span>
<span class="comments">;	values, and that the database definition (.DBD) file already exists.</span>
<span class="comments">;</span>
<span class="comments">;	IDL> !PRIV=2                  ;Writing to database requires !PRIV=2</span>
<span class="comments">;	IDL> dbcreate,'stars',1,1   ;Create database (.DBF) & index (.DBX) file</span>
<span class="comments">;	IDL> dbopen,'stars',1         ;Open database for update</span>
<span class="comments">;	IDL> dbbuild,name,ra,dec,flux ;Write 4 vectors into the database</span>
<span class="comments">;</span>
<span class="comments">; NOTES:</span>
<span class="comments">;	Do not call DBCREATE before DBBUILD if you want to append entries to</span>
<span class="comments">;	an existing database</span>
<span class="comments">;</span>
<span class="comments">;	DBBUILD checks that each value vector matches the idl type given in the</span>
<span class="comments">;	database definition (..dbd) file, and that character strings are the </span>
<span class="comments">;	proper length. </span>
<span class="comments">; PROCEDURE CALLS:</span>
<span class="comments">;       DBCLOSE, DBINDEX, DBXPUT, DBWRT, IS_IEEE_BIG()</span>
<span class="comments">; REVISION HISTORY:</span>
<span class="comments">;	Written          W. Landsman           March, 1989</span>
<span class="comments">;	Added /NOINDEX keyword           W. Landsman        November, 1992</span>
<span class="comments">;	User no longer need supply all items   W. Landsman  December, 1992 </span>
<span class="comments">;	Added STATUS keyword, William Thompson, GSFC, 1 April 1994</span>
<span class="comments">;	Added /SILENT keyword, William Thompson, GSFC, October 1995</span>
<span class="comments">;	Allow up to 30 items, fix problem if first item was multiple value</span>
<span class="comments">;				  W. Landsman    GSFC, July 1996</span>
<span class="comments">;	Faster build of external databases on big endian machines </span>
<span class="comments">;				  W. Landsman    GSFC, November 1997  </span>
<span class="comments">;       Use SIZE(/TNAME) for error mesage display  W.Landsman   July 2001</span>
<span class="comments">;       Fix message display error introduced July 2001  W. Landsman   Oct. 2001 </span>
<span class="comments">;       Make sure error message appears even if !QUIET is set W.L November 2006</span>
<span class="comments">;       Major rewrite to use SCOPE_VARFETCH, accept 50 input items</span>
<span class="comments">;                   W. Landsman    November 2006</span>
<span class="comments">;      Fix warning if parameters have different # of elements W.L.  May 2010</span>
<span class="comments">;      Fix warning if scalar parameter supplied W.L.  June 2010</span>
<span class="comments">;      Fix for when first parameter is multi-dimensioned W.L. July 2010</span>
<span class="comments">;      Check data type of first parameter W.L. Jan 2012</span>
<span class="comments">;-</span>
  COMPILE_OPT IDL2
  On_error,2                            <span class="comments">;Return to caller</span>
  npar = N_params()
  if npar LT 1 then begin
    print,'Syntax - DBBUILD, v1, [ v2, v3, v4, v5, ... v50,' 
    print,'         /NOINDEX, /SILENT, STATUS =  ]'
    return
  endif

 dtype = ['UNDEFINED','BYTE','INT','LONG','FLOAT','DOUBLE', $
        'COMPLEX','STRING','STRUCT','DCOMPLEX','POINTER','OBJREF', $ 
        'UINT', 'ULONG', 'LONG64','ULONG64']

 
<span class="comments">;  Initialize STATUS as unsuccessful (0).  If the routine is successful, this</span>
<span class="comments">;  will be updated below.</span>

  status = 0

  nitem = db_info( 'ITEMS' )
  if nitem LE npar  then message, 'ERROR - ' + strtrim(npar,2) + $ $
     ' variables supplied but only ' + strtrim(nitem-1,2) + ' items in database' 

   items = indgen(nitem)
   db_item, items, itnum, ivalnum, idltype, sbyte, numvals, nbyte
   nitems = ( npar &lt<span class="comments">; nitem)</span>
   vv = 'v' + strtrim( indgen(nitems+1), 2)

<span class="comments">;Create a pointer array to point at each of the supplied variables   </span>
   tmp = ptrarr(nitems,/allocate_heap)
   for i=0,nitems-1 do *tmp[i] = SCOPE_VARFETCH(vv[i+1], LEVEL=0)

   ndata = N_elements(v1)/ numvals[1]   <span class="comments">;# of elements in last dimension</span>

   for i = 1,npar do begin    <span class="comments">;Get the dimensions and type of each input vector</span>

      sz = size( *tmp[i-1], /STRUCT)
       ndatai = sz.N_elements/numvals[i]
      if ndatai NE ndata then message, $
          'WARNING - Parameter ' + strtrim(i,2) + ' has dimension ' +  $
	  strjoin(strtrim( sz.dimensions[0:sz.n_dimensions-1],2),' ') ,/con
      if sz.type_name NE dtype[idltype[i]] then begin
        message, 'Item ' + strtrim( db_item_info('NAME',i),2) + $
           ' - parameter '+strtrim(i,2) + ' - has an incorrect data type',/CON
        message, 'Required data type is ' + dtype[idltype[i]], /INF
        message, 'Supplied data type is ' + sz.type_name, /INF
	ptr_free,tmp
        return
     endif

  endfor
  external = db_info('external',0)
  noconvert = external ? is_ieee_big() : 1b

  entry = make_array( DIMEN = db_info('LENGTH'),/BYTE ) <span class="comments">;Empty entry array</span>
  nvalues = long( db_item_info( 'NVALUES' ) )       <span class="comments">;# of values per item</span>
  nbyte = nbyte*nvalues                             <span class="comments">;Number of bytes per item</span>
                    
  for i = 0l, Ndata - 1 do begin
       i1 = i*nvalues
       i2 = i1 + nvalues -1

        dbxput,0l,entry,idltype[0],sbyte[0],nbyte[0]
	for j = 1,nitems  do $
	dbxput, (*tmp[j-1])[ i1[j]:i2[j] ], $
	       entry,idltype[j], sbyte[j], nbyte[j] 
	       
      dbwrt,entry,noconvert=noconvert        <span class="comments">;Write the entry into the database</span>

  endfor
  ptr_free,tmp

  if ~keyword_set( NOINDEX ) then begin

      indexed = db_item_info( 'INDEX' )      <span class="comments">;Need to create an indexed file?</span>
      if ~array_equal(indexed,0)  then begin
	   if ~keyword_set(silent) then	$
	           message,'Now creating indexed files',/INF
           dbindex,items
       endif

  endif

  dbclose

<span class="comments">;  Mark successful completion, and return.</span>

  status = 1
  return
  end
</code>
    </div>
  </body>
</html>