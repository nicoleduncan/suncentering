<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:57:31 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>fits_test_checksum.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="fits_test_checksum.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><a id="fits_test_checksum:source"></a> function fits_test_checksum,hdr, data, ERRMSG = errmsg,FROM_IEEE=from_ieee
<span class="comments">;+</span>
<span class="comments">; NAME:</span>
<span class="comments">;    FITS_TEST_CHECKSUM()</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;    Verify the values of the CHECKSUM and DATASUM keywords in a FITS header </span>
<span class="comments">; EXPLANATION: </span>
<span class="comments">;     Follows the 2007 version of the FITS checksum proposal at </span>
<span class="comments">;     http://fits.gsfc.nasa.gov/registry/checksum.html</span>
<span class="comments">; </span>
<span class="comments">; CALLING SEQUENCE:</span>
<span class="comments">;    result = FITS_TEST_CHECKSUM(HDR, [ DATA, ERRMSG=, /FROM_IEEE ])</span>
<span class="comments">; INPUTS:</span>
<span class="comments">;    HDR - FITS header (vector string)</span>
<span class="comments">; OPTIONAL DATA:</span>
<span class="comments">;    DATA - data array associated with the FITS header.   If not supplied, or</span>
<span class="comments">;           set to a scalar, then there is assumed to be no data array </span>
<span class="comments">;           associated with the FITS header.</span>
<span class="comments">; RESULT:</span>
<span class="comments">;     An integer -1, 0 or 1 indicating the following conditions:</span>
<span class="comments">;           1 - CHECKSUM (and DATASUM) keywords are present with correct values</span>
<span class="comments">;           0 - CHECKSUM keyword is not present</span>
<span class="comments">;          -1 - CHECKSUM or DATASUM keyword does not have the correct value</span>
<span class="comments">;               indicating possible data corruption.</span>
<span class="comments">; OPTIONAL INPUT KEYWORD:</span>
<span class="comments">;    /FROM_IEEE - If this keyword is set, then the input is assumed to be in </span>
<span class="comments">;             big endian format (e.g. an untranslated FITS array).    This </span>
<span class="comments">;             keyword only has an effect on little endian machines (e.g. </span>
<span class="comments">;             a Linux box).</span>
<span class="comments">; OPTIONAL OUTPUT KEYWORD:</span>
<span class="comments">;     ERRMSG - will contain a scalar string giving the error condition.   If</span>
<span class="comments">;              RESULT = 1 then ERRMSG will be an empty string.   If this </span>
<span class="comments">;              output keyword is not supplied, then the error message will be</span>
<span class="comments">;              printed at the terminal.</span>
<span class="comments">; NOTES:</span>
<span class="comments">;     The header and data must be *exactly* as originally written in the FITS </span>
<span class="comments">;     file.  By default, some FITS readers may alter keyword values (e.g. </span>
<span class="comments">;     BSCALE) or append information (e.g. HISTORY or an inherited primary </span>
<span class="comments">;     header) and this will alter the checksum value.           </span>
<span class="comments">; PROCEDURES USED:</span>
<span class="comments">;    CHECKSUM32, FITS_ASCII_ENCODE(), SXPAR()</span>
<span class="comments">; EXAMPLE:</span>
<span class="comments">;     Verify the CHECKSUM keywords in the primary header/data unit of a FITS </span>
<span class="comments">;     file 'test.fits'</span>
<span class="comments">;</span>
<span class="comments">;     FITS_READ,'test.fits',data,hdr,/no_PDU,/NoSCALE</span>
<span class="comments">;     print,FITS_TEST_CHECKSUM(hdr,data)</span>
<span class="comments">;</span>
<span class="comments">;     Note the use of the /No_PDU and /NoSCALE keywords to avoid any alteration </span>
<span class="comments">;     of the FITS header</span>
<span class="comments">; REVISION HISTORY:</span>
<span class="comments">;     W. Landsman  SSAI               December 2002</span>
<span class="comments">;     Return quietly if CHECKSUM keywords not found W. Landsman May 2003</span>
<span class="comments">;     Add /NOSAVE to CHECKSUM32 calls when possible W. Landsman Sep 2004</span>
<span class="comments">;-</span>
  On_error,2 
  compile_opt idl2 
  
  if N_Params() LT 1 then begin
      print,'Syntax - result = FITS_TEST_CHECKSUM(Hdr, [Data,' +  $
                               ' ERRMSG=, /FROM_IEEE ])'
      return, 0
  endif
  result = 1
  printerr = ~arg_present(errmsg)
  checksum = sxpar(hdr,'CHECKSUM', Count = N_checksum)
  datasum = sxpar(hdr,'DATASUM', Count = N_datasum)
  if (N_checksum EQ 0) then begin
      errmsg = 'CHECKSUM keyword not present in FITS header'
      if printerr then message,/con, errmsg
      return, 0
  endif 
  if N_datasum EQ 0 then datasum = '0' 
  ch  = shift(byte(checksum),-1)
  checksum32,ch-48b, sum32, /NOSAVE
  bhdr = byte(hdr)
  remain = N_elements(bhdr) mod 2880 
  if remain  NE 0 then $
       bhdr = [reform(bhdr,N_elements(bhdr)), replicate(32b, 2880 - remain) ]
  checksum32,bhdr, hsum, FROM_IEEE = from_ieee, /NOSAVE
  Ndata = N_elements(data)
  if Ndata GT 1 then begin 
           checksum32, data, dsum, FROM_IEEE= from_ieee
           remain = Ndata mod 2880
           if remain GT 0 then begin
              exten = sxpar( hdr, 'XTENSION', Count = N_exten)
              if N_exten GT 0 then if exten EQ 'TABLE   ' then $
                      checksum32,[dsum,replicate(32b,2880-remain)],dsum,/NOSAVE
           endif
           checksum32, [dsum, hsum], hdusum, /NOSAVE
           dsum = strtrim(dsum,2)
           if dsum NE datasum then begin
                  result = 1
                  errmsg = 'Computed Datasum: ' + dsum + $
                           ' FITS header value: ' + datasum
                  if printerr then message,/Con, errmsg 
           endif
  endif else hdusum = hsum

  csum = FITS_ASCII_ENCODE(not hdusum)
  if csum NE '0000000000000000' then begin
                  result = -1
                  errmsg = 'Computed Checksum: ' + csum + $
                           ' FITS header value: ' + checksum
                   if printerr then message,/Con, errmsg 
  endif
  return, result
  end
</code>
    </div>
  </body>
</html>