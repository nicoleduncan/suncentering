<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:58:01 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>sky.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="sky.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><a id="sky:source"></a>pro sky,image,skymode,skysig, SILENT=silent, CIRCLERAD = circlerad, $
      _EXTRA = _EXTRA, NAN = nan, MEANBACK = meanback
<span class="comments">;+</span>
<span class="comments">; NAME:</span>
<span class="comments">;       SKY</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;       Determine the sky level in an image </span>
<span class="comments">; EXPLANATION:</span>
<span class="comments">;       Approximately 10000 uniformly spaced pixels are selected for the</span>
<span class="comments">;       computation.  Adapted from the DAOPHOT routine of the same name.</span>
<span class="comments">;</span>
<span class="comments">;       The sky is computed either by using the procedure mmm.pro (default) </span>
<span class="comments">;       or by sigma clipping (if /MEANBACK is set) </span>
<span class="comments">;</span>
<span class="comments">; CALLING SEQUENCE:</span>
<span class="comments">;       SKY, image, [ skymode, skysig ,/SILENT, /MEANBACK, /NAN, CIRCLERAD= ]</span>
<span class="comments">;     </span>
<span class="comments">;         Keywords available  when MEANBACK is not set (passed to mmm.pro): </span>
<span class="comments">;                   /DEBUG, HIGHBAD=, /INTEGER, MAXITER=. READNOISE=</span>
<span class="comments">;         Keywords available when /MEANBACK is set: </span>
<span class="comments">;                   CLIPSIG=, /DOUBLE, CONVERGE_NUM=, MAXITER=, /VERBOSE </span>
<span class="comments">; INPUTS:</span>
<span class="comments">;       IMAGE - One or two dimensional array</span>
<span class="comments">;</span>
<span class="comments">; OPTIONAL OUTPUT ARRAYS:</span>
<span class="comments">;       SKYMODE - Scalar, giving the mode of the sky pixel values of the </span>
<span class="comments">;               array IMAGE, as determined by the procedures MMM or MEANCLIP</span>
<span class="comments">;       SKYSIG -  Scalar, giving standard deviation of sky brightness.   If it</span>
<span class="comments">;               was not possible to derive a mode then SKYSIG is set to -1</span>
<span class="comments">;</span>
<span class="comments">; INPUT KEYWORD PARAMETERS:</span>
<span class="comments">;	CIRCLERAD - Use this keyword to have SKY only select pixels within</span>
<span class="comments">;		specified pixel radius of the center of the image.  If </span>
<span class="comments">;		CIRCLERAD =1, then the radius is set equal to half the image</span>
<span class="comments">;		width.   Can only be used with square images.</span>
<span class="comments">;       /MEANBACK - if set, then the background is computed using the 3 sigma </span>
<span class="comments">;             clipped mean (using meanclip.pro) rather than using the mode </span>
<span class="comments">;             computed with mmm.pro.    This keyword is useful for the Poisson </span>
<span class="comments">;             count regime or where contamination is known  to be minimal.</span>
<span class="comments">;       /NAN - This keyword must be set to  ignore NaN values when computing </span>
<span class="comments">;              the sky.</span>
<span class="comments">;       /SILENT - If this keyword is supplied and non-zero, then SKY will not</span>
<span class="comments">;               display the sky value and sigma at the terminal</span>
<span class="comments">;</span>
<span class="comments">;      The _EXTRA facility can is used to pass optional keywords to the programs</span>
<span class="comments">;             that actually perform the sky computation: either mmm.pro </span>
<span class="comments">;             (default) or meanclip.pro (if /MEANBACK) is set.    The following</span>
<span class="comments">;             keywords are available with the mmm.pro (default) setting </span>

<span class="comments">;       HIGHBAD - scalar value of the (lowest) "bad" pixel level (e.g. cosmic </span>
<span class="comments">;                rays or saturated pixels) If not supplied, then there is </span>
<span class="comments">;                assumed to be no high bad pixels.</span>
<span class="comments">;       READNOISE - Scalar giving the read noise (or minimum noise for any </span>
<span class="comments">;                pixel).     Normally, MMM determines the (robust) median by </span>
<span class="comments">;                averaging the central 20% of the sky values.     In some cases</span>
<span class="comments">;                where the noise is low, and pixel values are quantized a</span>
<span class="comments">;                larger fraction may be needed.    By supplying the optional</span>
<span class="comments">;                read noise parameter, MMM is better able to adjust the</span>
<span class="comments">;                fraction of pixels used to determine the median. </span>
<span class="comments">;       /INTEGER - Set this keyword if the  input SKY image only contains</span>
<span class="comments">;                discrete integer values.    This keyword is only needed if the</span>
<span class="comments">;                SKY image is of type float or double precision, but contains </span>
<span class="comments">;                only discrete integer values.     </span>
<span class="comments">;</span>
<span class="comments">;     If the /MEANBACK keyword is set then the following keywords are available</span>
<span class="comments">;</span>
<span class="comments">;       CLIPSIG:  Number of sigma at which to clip.  Default=3</span>
<span class="comments">;	MAXITER:  Ceiling on number of clipping iterations.  Default=5</span>
<span class="comments">;       CONVERGE_NUM:  If the proportion of rejected pixels is less</span>
<span class="comments">;           than this fraction, the iterations stop.  Default=0.02, i.e.,</span>
<span class="comments">;           iteration stops if fewer than 2% of pixels excluded.</span>
<span class="comments">;       /DOUBLE - if set then perform all computations in double precision.</span>
<span class="comments">;                 Otherwise double precision is used only if the input</span>
<span class="comments">;                 data is double</span>
<span class="comments">;</span>
<span class="comments">; PROCEDURE:</span>
<span class="comments">;       A grid of points, not exceeding 10000 in number, is extracted</span>
<span class="comments">;       from the srray.  The mode of these pixel values is determined</span>
<span class="comments">;       by the procedure mmm.pro or meanclip.pro.   In a 2-d array the grid is </span>
<span class="comments">;       staggered in each row to avoid emphasizing possible bad columns</span>
<span class="comments">;</span>
<span class="comments">; PROCEDURE CALLS:</span>
<span class="comments">;       MEANCLIP, MMM, DIST_CIRCLE</span>
<span class="comments">; REVISION HISTORY:</span>
<span class="comments">;       Written, W. Landsman   STX Co.            September, 1987     </span>
<span class="comments">;       Changed INDGEN to LINDGEN                 January, 1994</span>
<span class="comments">;       Fixed display of # of points used         March, 1994</span>
<span class="comments">;       Stagger beginning pixel in each row, added NSKY, READNOISE, HIGHBAD</span>
<span class="comments">;          W. Landsman        June 2004</span>
<span class="comments">;      Adjustments for unbiased sampling  W. Landsman June 2004</span>
<span class="comments">;      Added /NAN keyword, put back CIRCLERAD keyword W. Landsman July 2004</span>
<span class="comments">;      Added MEANBACK keyword, _EXTRA kewyord ,preserve data type in </span>
<span class="comments">;             calculations       W. Landsman November 2005</span>
<span class="comments">;      Fix problem for very large images by requiring at least 2 pixels to</span>
<span class="comments">;       be sampled per row.    March 2007    W. Landsman</span>
<span class="comments">;      Avoid possible out of bounds if /NAN set   W. Landsman   Jan 2008</span>
<span class="comments">;      Use  TOTAL(/INTEGER)      June 2009</span>
<span class="comments">;-</span>
  On_error,2              <span class="comments">;Return to caller</span>
  compile_opt idl2

 if N_params() eq 0 then begin
        print,'Syntax - sky, image, [ skymode, skysig , HIGHBAD= '
        print, '                    READNOISE = , /NAN, CIRCLERAD = , /SILENT ]'
        return
 endif

 checkbad = (N_elements(highbad) GT 0) or keyword_set(circlerad) or $
              keyword_set(nan)                          
 s = size(image)      
 nrow = s[1]
 if s[0] EQ 1 then ncol = 1 else begin                      
    if s[0] NE 2 then message, $
          'ERROR - Input array (first parameter) must be 1 or 2 dimensional'
    ncol = s[2]
 endelse
 if keyword_set(circlerad) then if ncol ne nrow then message, $
       'ERROR - The CIRCLERAD keyword only applies to a 2-d square array'
        
 if checkbad then begin 
          mask = replicate(1b, nrow, ncol)
          if N_elements(highbad) GT 0 then mask = mask and (image LT highbad)
          if keyword_set(nan) then mask = mask and finite(image)
          if keyword_set(circlerad) then begin
                  if circlerad EQ 1 then rad = nrow/2 else rad = long(circlerad)
                  dist_circle,drad, nrow
                  mask = mask and (temporary(drad) LT rad)
           endif
          npts = total(mask,/integer)  
 endif else  npts = N_elements(image)
 
<span class="comments">;  Use 10000 data points or  at least 2 points per row</span>
 maxsky = 2*npts/(nrow-1) > 10000          <span class="comments">;Maximum # of pixels to be used in sky calculation</span>
<span class="comments">; Maintain the same data type as the input image Nov 2005</span>
    istep = npts/maxsky +1
 skyvec = make_array(maxsky+100,type=size(image,/type))
     nstep = (nrow/istep)
 
    jj = 0
    index0 = istep*lindgen(nstep) 
    if nstep GT 1 then begin 
          i0 = (nrow-1 - max(index0)  - istep)/2 > 0  <span class="comments">;Adjust margin for symmetry</span>
          index0  = index0 + i0
    endif

<span class="comments">; The beginning index in each row is staggered to avoid emphasizing possible</span>
<span class="comments">; bad columns</span>

    for i=0, Ncol-1 do begin
        index  = index0 + (i mod istep)  
        row = image[*,i]
        if checkbad then begin         
            g = where(mask[*,i],ng)
            case ng of 
            0: goto, Done
            Nrow: 
            else: row = row[g]
            endcase
          endif else ng = nrow
   	      imax = value_locate( index, ng-1) > 0
	       ix = index[0:imax] &lt<span class="comments">; (ng-1)</span>
	       skyvec[jj] = row[ix]
          jj = jj + imax + 1
 DONE:

  endfor    
  skyvec = skyvec[0:jj-1] 

 
  if keyword_set(meanback) then begin 
   meanclip, skyvec, skymode, skysig,sub=sub, _EXTRA = _extra
   nsky = N_elements(sub)
 endif else $ 
 MMM, skyvec, skymode, skysig, _EXTRA = _extra, nsky = nsky

 skymode = float(skymode)  &  skysig = float(skysig)
 if ~keyword_set(SILENT) then begin
        print,'Number of points used to find sky = ',nsky
        print,'Approximate sky value for this frame = ',skymode
        print,'Standard deviation of sky brightness = ',skysig
 endif

 return
 end
</code>
    </div>
  </body>
</html>