<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:58:18 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>cgps2raster.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="cgps2raster.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">; docformat = 'rst'</span>
<span class="comments">;</span>
<span class="comments">; NAME:</span>
<span class="comments">;   cgPS2Raster</span>
<span class="comments">;</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;    The purpose of this program is to convert a PostScript file to a high</span>
<span class="comments">;    resolution raster file, using the ImageMagick convert command to do the</span>
<span class="comments">;    conversion.</span>
<span class="comments">;******************************************************************************************;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  Copyright (c) 2011, by Fanning Software Consulting, Inc. All rights reserved.           ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  Redistribution and use in source and binary forms, with or without                      ;</span>
<span class="comments">;  modification, are permitted provided that the following conditions are met:             ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;      * Redistributions of source code must retain the above copyright                    ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer.                     ;</span>
<span class="comments">;      * Redistributions in binary form must reproduce the above copyright                 ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer in the               ;</span>
<span class="comments">;        documentation and/or other materials provided with the distribution.              ;</span>
<span class="comments">;      * Neither the name of Fanning Software Consulting, Inc. nor the names of its        ;</span>
<span class="comments">;        contributors may be used to endorse or promote products derived from this         ;</span>
<span class="comments">;        software without specific prior written permission.                               ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  THIS SOFTWARE IS PROVIDED BY FANNING SOFTWARE CONSULTING, INC. ''AS IS'' AND ANY        ;</span>
<span class="comments">;  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES    ;</span>
<span class="comments">;  OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT     ;</span>
<span class="comments">;  SHALL FANNING SOFTWARE CONSULTING, INC. BE LIABLE FOR ANY DIRECT, INDIRECT,             ;</span>
<span class="comments">;  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED    ;</span>
<span class="comments">;  TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;         ;</span>
<span class="comments">;  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND             ;</span>
<span class="comments">;  ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT              ;</span>
<span class="comments">;  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS           ;</span>
<span class="comments">;  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.                            ;</span>
<span class="comments">;******************************************************************************************;</span>
<span class="comments">;</span>
<span class="comments">;+</span>
<span class="comments">; The purpose of this program is to convert a PostScript file to a high</span>
<span class="comments">; resolution raster file, using the ImageMagick convert command to do the</span>
<span class="comments">; conversion. `ImageMagick  &lt;http://www.imagemagick.org/script/index.php>` must </span>
<span class="comments">; be installed on your computer.</span>
<span class="comments">; </span>
<span class="comments">; Note that one restriction the ImageMagick convert command imposes is that it</span>
<span class="comments">; cannot convert encapsulated PostScript files that are in landscape mode to</span>
<span class="comments">; raster files. These raster files will be clipped at one end of the file. If you</span>
<span class="comments">; wish to do the conversion properly, make sure encapsulated landscape plots are</span>
<span class="comments">; in portrait mode.</span>
<span class="comments">; </span>
<span class="comments">; The program requires the `Coyote Library &lt;http://www.idlcoyote.com/documents/programs.php>`</span>
<span class="comments">; to be installed on your machine.</span>
<span class="comments">; </span>
<span class="comments">; :Categories:</span>
<span class="comments">;    Utilities, Graphics</span>
<span class="comments">;    </span>
<span class="comments">; :Params:</span>
<span class="comments">;     ps_filename: in, required, type=string</span>
<span class="comments">;         The name of the input PostScript file that is being converted to a raster file.</span>
<span class="comments">;         If not provided, the user will be asked to select a file.</span>
<span class="comments">;     raster_filename: in, required, type=string</span>
<span class="comments">;         The name of the output raster file that is being converted from the PostScript file.</span>
<span class="comments">;         If not provided, the output filename is created from the input PostScript file name.</span>
<span class="comments">;         Note, this is the preferred way to create the output filename, since the OUTPUTNAME</span>
<span class="comments">;         keyword has been depreciated as an input keyword.</span>
<span class="comments">;         </span>
<span class="comments">; :Keywords:</span>
<span class="comments">;     allow_transparent: in, optional, type=boolean, default=0</span>
<span class="comments">;         To make the background of some image files white, rather than transparent,</span>
<span class="comments">;         you have to set the "-alpha off" string in the ImageMagick call. This</span>
<span class="comments">;         string is automatically added to the ImageMagick call unless this keyword</span>
<span class="comments">;         is set, in which case the string is not added and the image background will</span>
<span class="comments">;         be transparent.  </span>
<span class="comments">;     bmp: in, optional, type=boolean, default=0                 </span>
<span class="comments">;        Set this keyword to convert the PostScript output file to a BMP image. Requires ImageMagick.</span>
<span class="comments">;     delete_ps: in, optional, type=boolean, default=0            </span>
<span class="comments">;        Setting this keyword will delete the PostScript file that is used as the intermediate</span>
<span class="comments">;        file in the conversion to other file types.</span>
<span class="comments">;     density: in, optional, type=integer, default=300</span>
<span class="comments">;        The horizontal and vertical density (in dots per inch, DPI) of the image when the PostScript file</span>
<span class="comments">;        is converted to a raster format by ImageMagick. </span>
<span class="comments">;     filetype: in, optional, type='string', default=""</span>
<span class="comments">;        This keyword provides a generic way of setting the `BMP`, `GIF`, `JPEG`, `PNG`, and `TIFF` </span>
<span class="comments">;        keywords. Set this keyword to the type of file output desired, and the correct "output"</span>
<span class="comments">;        keyword will be set.</span>
<span class="comments">;     gif: in, optional, type=boolean, default=0                 </span>
<span class="comments">;        Set this keyword to convert the PostScript output file to a GIF image. Requires ImageMagick.</span>
<span class="comments">;     im_options: in, optional, type=string, default=""</span>
<span class="comments">;        A string of ImageMagick "convert" options that can be passed to the ImageMagick convert </span>
<span class="comments">;        command. No error checking occurs with this string.</span>
<span class="comments">;     jpeg: in, optional, type=boolean, default=0  </span>
<span class="comments">;        Set this keyword to convert the PostScript output file to a JPEG image. Requires ImageMagick.</span>
<span class="comments">;     outfilename: out, optional, type=string</span>
<span class="comments">;        On exit, the name of the output file that was created.</span>
<span class="comments">;     pdf: in, optional, type=boolean, default=0                 </span>
<span class="comments">;        Set this keyword to convert the PostScript output file to a PDF file. Requires Ghostscript.</span>
<span class="comments">;     png: in, optional, type=boolean, default=0                 </span>
<span class="comments">;        Set this keyword to convert the PostScript output file to a PNG image. Requires ImageMagick.</span>
<span class="comments">;     portrait: in, optional, type=boolean, default=0</span>
<span class="comments">;        Set this keyword to indicate the PostScript file is in portrait mode. Otherwise, landscape</span>
<span class="comments">;        mode is assumed.    </span>
<span class="comments">;     resize: in, optional, type=integer, default=25</span>
<span class="comments">;        If an image is being created from the PostScript file, it is often resized by some </span>
<span class="comments">;        amount. You can use this keyword to change the value (e.g, RESIZE=100).</span>
<span class="comments">;        The value is passed on to resize argument as a percentage in the ImageMagick call.</span>
<span class="comments">;     showcmd: in, optional, type=boolean, default=0</span>
<span class="comments">;        Set this command to show the command used to do any PostScript coversions.</span>
<span class="comments">;     silent: in, optional, type=boolean, default=0</span>
<span class="comments">;        Set this keyword to suppress output from the file. Is this keyword is set, be</span>
<span class="comments">;        sure to check the `Success` keyword on exit.</span>
<span class="comments">;     success: out, optional, type=boolean</span>
<span class="comments">;         On exit, this keyword is set to 1 if the program successfully managed to create a </span>
<span class="comments">;         raster file. It will be set to 0 otherwise.</span>
<span class="comments">;     tiff: in, optional, type=boolean, default=0                 </span>
<span class="comments">;        Set this keyword to convert the PostScript output file to a TIFF image. Requires ImageMagick.</span>
<span class="comments">;     width: in, optional, type=integer</span>
<span class="comments">;        Set this keyword to set the resulting width of the raster file. The height of the</span>
<span class="comments">;        raster will be such as to preserve the aspect ratio of the starting image.</span>
<span class="comments">;          </span>
<span class="comments">; :Examples:</span>
<span class="comments">;    To create a line plot in a PostScript file named lineplot.ps and</span>
<span class="comments">;    also create a PNG file named lineplot.png for display in a browser,</span>
<span class="comments">;    type these commands::</span>
<span class="comments">;</span>
<span class="comments">;        PS_Start, FILENAME='lineplot.ps'</span>
<span class="comments">;        cgPlot, Findgen(11), COLOR='navy', /NODATA, XTITLE='Time', YTITLE='Signal'</span>
<span class="comments">;        cgPlot, Findgen(11), COLOR='indian red', /OVERPLOT</span>
<span class="comments">;        cgPlot, Findgen(11), COLOR='olive', PSYM=2, /OVERPLOT</span>
<span class="comments">;        PS_End, /PNG</span>
<span class="comments">;       </span>
<span class="comments">; :Author:</span>
<span class="comments">;       FANNING SOFTWARE CONSULTING::</span>
<span class="comments">;           David W. Fanning </span>
<span class="comments">;           1645 Sheely Drive</span>
<span class="comments">;           Fort Collins, CO 80526 USA</span>
<span class="comments">;           Phone: 970-221-0438</span>
<span class="comments">;           E-mail: david@idlcoyote.com</span>
<span class="comments">;           Coyote's Guide to IDL Programming: http://www.idlcoyote.com</span>
<span class="comments">;</span>
<span class="comments">; :History:</span>
<span class="comments">;     Change History::</span>
<span class="comments">;       Written by: David W. Fanning, 12 December 2011</span>
<span class="comments">;       Added the ability to check to see if 8-bit or 24-bit PNG files should be created. 3 April 2012. DWF.</span>
<span class="comments">;       Modified the ImageMagick commands that resizes the image to a particular width. Necessary</span>
<span class="comments">;          to accommodate PNG8 file output. Using ImageMagick 6.7.2-9. 4 April 2012. DWF.</span>
<span class="comments">;       Added FILETYPE keyword. 13 October 2012. DWF.</span>
<span class="comments">;       Apparently Macs can't handle the version number, so I have removed the version number</span>
<span class="comments">;           check for Macs. 13 October 2012. DWF.</span>
<span class="comments">;</span>
<span class="comments">; :Copyright:</span>
<span class="comments">;     Copyright (c) 2011, Fanning Software Consulting, Inc.</span>
<span class="comments">;-</span>
PRO cgPS2Raster, ps_filename, raster_filename, $
    ALLOW_TRANSPARENT=allow_transparent, $
    BMP=bmp, $
    DELETE_PS=delete_ps, $
    DENSITY=density, $
    IM_OPTIONS=im_options, $
    FILETYPE=filetype, $
    GIF=gif, $
    JPEG=jpeg, $
    OUTFILENAME=outfilename, $
    PDF=pdf, $
    PNG=png, $
    PORTRAIT=portrait, $
    RESIZE=resize, $
    SHOWCMD=showcmd, $
    SILENT=silent, $
    SUCCESS=success, $
    TIFF=tiff, $
    WIDTH=width

   Compile_Opt idl2
   
   <span class="comments">; Error handling.</span>
   Catch, theError
   IF theError NE 0 THEN BEGIN
      Catch, /CANCEL
      IF ~Keyword_Set(silent) THEN void = Error_Message()
      success = 0
      RETURN
   ENDIF

   <span class="comments">; Assume failure. Sigh...</span>
   success = 0
   
   <span class="comments">; Need a file?</span>
   IF N_Elements(ps_filename) EQ 0 THEN BEGIN
      ps_filename = cgPickfile(Filter=['*.ps','*.eps'], Title='Select a PostScript file.')
      IF ps_filename EQ "" THEN RETURN
   ENDIF

   <span class="comments">; ImageMagick parameters. Assume we will convert to PNG file, unless told otherwise</span>
   IF N_Elements(filetype) EQ 0 THEN filetype = ""
   CASE StrUpCase(filetype) OF
       'BMP': bmp = 1
       'GIF': gif = 1
       'PDF': pdf = 1
       'PNG': png = 1
       'JPEG': jpeg = 1
       'JPG': jpeg = 1
       'TIFF': tiff = 1
       'TIF': tiff = 1
       "": 
       ELSE: BEGIN
           void = Dialog_Message('File type ' + StrUpCase(filetype) + ' invalid. No raster created.')
           success = 0
           RETURN
           END
   ENDCASE
   IF Keyword_Set(bmp) THEN filetype = 'BMP'
   IF Keyword_Set(gif) THEN filetype = 'GIF'
   IF Keyword_Set(png) THEN filetype = 'PNG'
   IF Keyword_Set(jpeg) THEN filetype = 'JPEG'
   IF Keyword_Set(tiff) THEN filetype = 'TIFF'
   SetDefaultValue, allow_transparent, 0, /BOOLEAN
   SetDefaultValue, density, 300
   SetDefaultValue, portrait, 0, /BOOLEAN
   SetDefaultValue, resize, 25
   SetDefaultValue, showcmd, 0, /BOOLEAN
   SetDefaultValue, silent, 0, /BOOLEAN
   SetDefaultValue, width, 0
   IF portrait THEN BEGIN
      xsize = 11
      ysize = 8.5
   ENDIF ELSE BEGIN
      xsize = 8.5
      ysize = 11
   ENDELSE
   
   <span class="comments">; Construct an output filename, if needed. First, look to see if the raster_filename</span>
   <span class="comments">; positional parameter is being used to specify the output filename.</span>
   IF (N_Elements(raster_filename) NE 0) && (N_Elements(outfilename) EQ 0) THEN BEGIN
       outfilename = raster_filename
   ENDIF
   basename = cgRootName(ps_filename, DIRECTORY=theDir, EXTENSION=theExtension)
   IF theDir EQ "" THEN CD, CURRENT=theDir
   IF N_Elements(outfilename) EQ 0 THEN BEGIN
       CASE 1 OF
          filetype EQ 'BMP':  outfilename = Filepath(ROOT_DIR=theDir, basename + '.bmp')
          filetype EQ 'GIF':  outfilename = Filepath(ROOT_DIR=theDir, basename + '.gif')
          filetype EQ 'JPEG': outfilename = Filepath(ROOT_DIR=theDir, basename + '.jpg')
          filetype EQ 'PNG':  outfilename = Filepath(ROOT_DIR=theDir, basename + '.png')
          filetype EQ 'TIFF': outfilename = Filepath(ROOT_DIR=theDir, basename + '.tif')
       ENDCASE
   ENDIF
   
   <span class="comments">; Make sure the outfilename is an absolute file path.</span>
   IF File_BaseName(outfilename) EQ outfilename THEN outfilename = Filepath(ROOT_DIR=theDir, outfilename)
   
   <span class="comments">; If you have an output filename, then do it.</span>
   IF N_Elements(outfilename) NE "" THEN BEGIN
        
      <span class="comments">; ImageMagick is required for this section of the code.</span>
      IF StrUpCase(!Version.OS) EQ 'DARWIN' THEN BEGIN
          available = cgHasImageMagick()
          doVersionTest = 0
      ENDIF ELSE BEGIN
          available = cgHasImageMagick(Version=version)
          doVersionTest = 1
      ENDELSE
      IF available THEN BEGIN
            
          <span class="comments">; Some functionality depends on the ImageMagick version. Check the version here.</span>
          IF doVersionTest THEN BEGIN
             vp = StrSplit(version, '.', /EXTRACT)
             vp[2] = StrMid(vp[2],0,1)
             version_number = Fix(vp[0]) * 100 + Fix(vp[1])*10 + vp[2]
             IF version_number GT 634 THEN allowAlphaCmd = 1 ELSE allowAlphaCmd = 0
          ENDIF ELSE allowAlphaCmd = 1
            
          <span class="comments">; Set up for various ImageMagick convert options.</span>
          IF allowAlphaCmd THEN alpha_cmd =  allow_transparent ? '' : ' -alpha off' 
          density_cmd = ' -density ' + StrTrim(density,2)
          
          <span class="comments">; Normally, we just resize by a precentage, unless a specific width</span>
          <span class="comments">; has been specified.</span>
          IF (N_Elements(width) EQ 0) || (width LE 0) THEN BEGIN
               resize_cmd =  ' -resize '+ StrCompress(resize, /REMOVE_ALL)+'%'
           ENDIF ELSE BEGIN
                
           <span class="comments">; Getting the width correct has to be done in an extremely non-intuitive way.</span>
           <span class="comments">; I wonder if this will be changed in different versions of ImageMagick?</span>
           height = Ceil(width*ysize/Float(xsize))
           IF ~portrait THEN BEGIN
                resize_cmd = ' -resize ' + StrCompress(height, /REMOVE_ALL) + 'x' + StrCompress(width, /REMOVE_ALL)                   
           ENDIF ELSE BEGIN
                resize_cmd = ' -resize ' + StrCompress(width, /REMOVE_ALL) + 'x' + StrCompress(height, /REMOVE_ALL)
                     ENDELSE
           ENDELSE
                
          <span class="comments">; Start ImageMagick convert command.</span>
          cmd = 'convert'
                
          <span class="comments">; Add various command options.</span>
          IF N_Elements(alpha_cmd) NE 0 THEN cmd = cmd + alpha_cmd
          IF N_Elements(density_cmd) NE 0 THEN cmd = cmd + density_cmd
                
          <span class="comments">; Add the input filename.</span>
          cmd = cmd +  ' "' + ps_filename + '"' 
                
          IF N_Elements(resize_cmd) NE 0 THEN cmd = cmd + resize_cmd
          cmd = cmd +  ' -flatten '
          IF N_Elements(im_options) NE 0 THEN BEGIN
              IF StrMid(im_options, 0, 1) NE " " THEN im_options = " " + im_options
              cmd = cmd + im_options
          ENDIF
                
          <span class="comments">; If in landscape mode, rotate by 90 to allow the </span>
          <span class="comments">; resulting file to be in landscape mode.</span>
          IF (1-portrait) THEN cmd = cmd + ' -rotate 90'
                
                <span class="comments">; Add the output filename and check for PNG output.</span>
                IF Keyword_Set(png) THEN BEGIN
                
                    <span class="comments">; Check to see whether 8-bit or 24-bit PNG files should be created.</span>
                    cgWindow_GetDefs, IM_PNG8=png8
                    IF png8 THEN BEGIN
                       cmd = cmd + ' "' + 'PNG8:' +outfilename + '"' 
                    ENDIF ELSE BEGIN
                       cmd = cmd + ' "' + 'PNG24:' +outfilename + '"' 
                    ENDELSE
                ENDIF ELSE cmd = cmd + ' "' + outfilename + '"'
          IF ~silent THEN BEGIN
              IF showcmd THEN Print, 'ImageMagick CONVERT command: ',  cmd
          ENDIF
          SPAWN, cmd, result, err_result
                
          IF ~silent THEN BEGIN
              IF err_result[0] NE "" THEN BEGIN
                  FOR k=0,N_Elements(err_result)-1 DO Print, err_result[k]
              ENDIF ELSE Print, 'Output file located here: ' + outfilename
          ENDIF
                
          <span class="comments">; Have you been asked to delete the PostScript file?</span>
          IF Keyword_Set(delete_ps) THEN BEGIN
              IF outfilename NE ps_filename THEN File_Delete, ps_filename
          ENDIF
      ENDIF ELSE Message, 'ImageMagick cannot be found on this machine.'
      
   ENDIF
        
END
</code>
    </div>
  </body>
</html>