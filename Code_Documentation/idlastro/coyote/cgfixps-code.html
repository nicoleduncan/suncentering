<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:58:17 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>cgfixps.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="cgfixps.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">; docformat = 'rst'</span>
<span class="comments">;</span>
<span class="comments">; NAME:</span>
<span class="comments">;   cgFixPS</span>
<span class="comments">;</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;   This program modifies an IDL-produced PostScript landscape mode file so that the output</span>
<span class="comments">;   is right side up rather than upside down. In other words, it turns a so-called seascape</span>
<span class="comments">;   file into an actual landscape file.</span>
<span class="comments">;</span>
<span class="comments">;******************************************************************************************;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  Copyright (c) 2011, by Fanning Software Consulting, Inc. All rights reserved.           ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  Redistribution and use in source and binary forms, with or without                      ;</span>
<span class="comments">;  modification, are permitted provided that the following conditions are met:             ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;      * Redistributions of source code must retain the above copyright                    ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer.                     ;</span>
<span class="comments">;      * Redistributions in binary form must reproduce the above copyright                 ;</span>
<span class="comments">;        notice, this list of conditions and the following disclaimer in the               ;</span>
<span class="comments">;        documentation and/or other materials provided with the distribution.              ;</span>
<span class="comments">;      * Neither the name of Fanning Software Consulting, Inc. nor the names of its        ;</span>
<span class="comments">;        contributors may be used to endorse or promote products derived from this         ;</span>
<span class="comments">;        software without specific prior written permission.                               ;</span>
<span class="comments">;                                                                                          ;</span>
<span class="comments">;  THIS SOFTWARE IS PROVIDED BY FANNING SOFTWARE CONSULTING, INC. ''AS IS'' AND ANY        ;</span>
<span class="comments">;  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES    ;</span>
<span class="comments">;  OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT     ;</span>
<span class="comments">;  SHALL FANNING SOFTWARE CONSULTING, INC. BE LIABLE FOR ANY DIRECT, INDIRECT,             ;</span>
<span class="comments">;  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED    ;</span>
<span class="comments">;  TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;         ;</span>
<span class="comments">;  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND             ;</span>
<span class="comments">;  ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT              ;</span>
<span class="comments">;  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS           ;</span>
<span class="comments">;  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.                            ;</span>
<span class="comments">;******************************************************************************************;</span>
<span class="comments">;</span>
<span class="comments">;+</span>
<span class="comments">; This program modifies an IDL-produced PostScript landscape mode file so that the output</span>
<span class="comments">; is right side up rather than upside down. In other words, it turns a so-called seascape</span>
<span class="comments">; file into an actual landscape file. Files that are not currently in landscape mode will </span>
<span class="comments">; be ignored. Tested with single and multiple page PostScript output from IDL 7.0.1 and 7.1.</span>
<span class="comments">; </span>
<span class="comments">; The program requires the `Coyote Library &lt;http://www.idlcoyote.com/documents/programs.php>`</span>
<span class="comments">; to be installed on your machine.</span>
<span class="comments">;</span>
<span class="comments">; :Categories:</span>
<span class="comments">;    Graphics, Utilities</span>
<span class="comments">;    </span>
<span class="comments">; :Params:</span>
<span class="comments">;     in_filename: in, required, type=string</span>
<span class="comments">;        The name of an IDL-produced PostScript file in landscape mode.</span>
<span class="comments">;     out_filename: in, optional, type=string</span>
<span class="comments">;        The name of the fixed output PostScript file. If not provided, the input</span>
<span class="comments">;        file is overwritten. Overwritting assumes proper read/write permission in </span>
<span class="comments">;        TEMP directory and in the directory where the input file is located.</span>
<span class="comments">;</span>
<span class="comments">; :Keywords:</span>
<span class="comments">;     a4: in, optional, type=boolean, default=0</span>
<span class="comments">;        Set this keyword if the PostScript file is using a A4 Europeran sized page.</span>
<span class="comments">;     ledger: in, optional, type=boolean, default=0</span>
<span class="comments">;        Set this keyword if the PostScript file is using a US ledger size (11 x 17 inch) page.</span>
<span class="comments">;     legal: in, optional, type=boolean, default=0</span>
<span class="comments">;        Set this keyword if the PostScript file is using a US legal size (8.5 x 14 inch) page.</span>
<span class="comments">;     letter: in, optional, type=boolean, default=0</span>
<span class="comments">;        Set this keyword if the PostScript file is using a US letter size (8.5 x 11 inch) page.</span>
<span class="comments">;     pagetype: in, optional, type=string, default="Letter"</span>
<span class="comments">;        A generic way to set the page size. A string of "LETTER", "LEDGER", "LEGAL", or "A4".</span>
<span class="comments">;     quiet: in, optional, type=boolean, default=0</span>
<span class="comments">;        Set this keyword to suppress error messages from the program.</span>
<span class="comments">;     success: out, optional, type=boolean</span>
<span class="comments">;        If this keyword is set to a named variable, then on output the variable will</span>
<span class="comments">;        return a 1 if the operation was successful, and a 0 otherwise. Using this</span>
<span class="comments">;        keyword also supresses the program's ability to "throw" an error. Informational</span>
<span class="comments">;        messages are issued about program developments, but this program will allow the</span>
<span class="comments">;        program caller to decide what to do with unsuccessful program completion.</span>
<span class="comments">;</span>
<span class="comments">; :Author:</span>
<span class="comments">;    FANNING SOFTWARE CONSULTING::</span>
<span class="comments">;       David W. Fanning </span>
<span class="comments">;       1645 Sheely Drive</span>
<span class="comments">;       Fort Collins, CO 80526 USA</span>
<span class="comments">;       Phone: 970-221-0438</span>
<span class="comments">;       E-mail: david@idlcoyote.com</span>
<span class="comments">;       Coyote's Guide to IDL Programming: http://www.idlcoyote.com</span>
<span class="comments">;</span>
<span class="comments">; :History:</span>
<span class="comments">;     Change History::</span>
<span class="comments">;       Written by: David W. Fanning, 6 August 2009.</span>
<span class="comments">;       Change to overwrite input file if output filename is not provided. 6 August 2009. DWF.</span>
<span class="comments">;       Incorporated checks for non-landscape mode files and files that have already been fixed. 6 August 2009. DWF.</span>
<span class="comments">;       Modified to fix multiple-page PostScript files and to work seamlessly with PS_START output. 8 August 2009. DWF.</span>
<span class="comments">;       Ran into a problem in which the PostScript file is stored in the directory pointed</span>
<span class="comments">;          to by the IDL_TMPDIR environment variable. Now check to see if the input filename</span>
<span class="comments">;          is the same as the output filename and make a change, if necessary. 22 July 2010. DWF.</span>
<span class="comments">;        Retreated to standard error handling with ERROR_MESSAGE as there are inevitable errors. 2 August 2010. DWF.</span>
<span class="comments">;        Output file was created, even if not used. Now deleting file and issuing messages to</span>
<span class="comments">;           explain why output file was not created. 1 November 2010. DWF.</span>
<span class="comments">;        Added SUCCESS and QUIET keywords. 15 Novemember 2010. DWF.</span>
<span class="comments">;        PostScript file structure changed in IDL 8. Made adjustment to find the </span>
<span class="comments">;            PageBoundingBox line. 19 Dec 2010. DWF.</span>
<span class="comments">;            </span>
<span class="comments">; :Copyright:</span>
<span class="comments">;     Copyright (c) 2009-2012, Fanning Software Consulting, Inc.</span>
<span class="comments">;-</span>
PRO cgFIXPS, in_filename, out_filename, $
    A4=A4, $
    LEDGER=ledger, $
    LEGAL=legal, $
    LETTER=letter, $
    PAGETYPE=pagetype, $
    QUIET=quiet, $
    SUCCESS=success

  Compile_Opt idl2
  
  <span class="comments">; Error handling.</span>
  IF Arg_Present(success) THEN BEGIN
      Catch, theError
      IF theError NE 0 THEN BEGIN
          Catch, /CANCEL
          success = 0
          IF N_Elements(out_lun) NE 0 THEN Free_Lun, out_lun
          IF N_Elements(in_lun) NE 0 THEN Free_Lun, in_lun
          IF ~Keyword_Set(quiet) THEN Print, !Error_State.MSG
          RETURN
      ENDIF
  ENDIF ELSE BEGIN
      Catch, theError
      IF theError NE 0 THEN BEGIN
          Catch, /CANCEL
          IF ~Keyword_Set(quiet) THEN ok = Error_Message()
          success = 0
          IF N_Elements(out_lun) NE 0 THEN Free_Lun, out_lun
          IF N_Elements(in_lun) NE 0 THEN Free_Lun, in_lun
          RETURN
      ENDIF
  ENDELSE
  
  <span class="comments">; Assume success</span>
  success = 1
  
  <span class="comments">; Is there an input filename?</span>
  IF N_Elements(in_filename) EQ 0 THEN BEGIN
      in_filename = Dialog_Pickfile(FILTER='*.ps', TITLE='Select PostScript file to repair.')
      IF in_filename EQ "" THEN RETURN
  ENDIF
  
  <span class="comments">; Is there an output filename?</span>
  IF N_Elements(out_filename) EQ 0 THEN BEGIN
        root_name = cgRootName(in_filename, EXTENSION=ext)
        out_filename = Filepath(ROOT_DIR=GetEnv('IDL_TMPDIR'), root_name + '_tmp.' + ext)
        print_out = 1
        no_output_filename = 1
  ENDIF ELSE no_output_filename = 0
  
  <span class="comments">; The out_filename can be the same as the in_filename in some cases.</span>
  IF out_filename EQ in_filename THEN BEGIN
     rootname = cgRootName(out_filename, DIRECTORY=outDir, EXTENSION=ext)
     out_filename = FilePath(ROOT_DIR=outDir, rootname + '_tmp.' + ext)
  ENDIF
  
  <span class="comments">; Open the output filename.</span>
  OpenW, out_lun, out_filename, /GET_LUN
  
  <span class="comments">; What kind of page is this?</span>
  IF N_Elements(pagetype) EQ 0 THEN BEGIN
     IF Keyword_Set(A4) THEN pageType = 'A4'
     IF Keyword_Set(legal) THEN pageType = 'LEGAL'
     IF Keyword_Set(ledger) THEN pageType = 'LEDGER'
     IF Keyword_Set(letter) THEN pageType = 'LETTER'
     IF N_Elements(pageType) EQ 0 THEN pageType = 'LETTER' 
  ENDIF ELSE pageType = StrUpCase(pageType)
  
  <span class="comments">; Set the rotate/translate command appropriately. </span>
  CASE pageType OF
        'LETTER': rtcmd = '180 rotate -612 -792 translate'
        'A4':     rtcmd = '180 rotate -595.28 -841.89 translate'
        'LEGAL':  rtcmd = '180 rotate -612 -1008 translate'
        'LEDGER': rtcmd = '180 rotate -792 -1224 translate'
        ELSE: Message, 'Unknown PageType: ' + pageType
  ENDCASE
  
  <span class="comments">; Move along in the file until the end of the Prolog.</span>
  line = ""
  count = 0
  target = "void"
  buffer = StrArr(100)
  
  OpenR, in_lun, in_filename, /GET_LUN
  WHILE target NE '%%EndProlog' DO BEGIN
      ReadF, in_lun, line
      buffer[count] = line
      target = StrMid(line, 0, 11)
      count = count + 1
      IF count MOD 100 EQ 0 THEN buffer = [buffer, StrArr(100)]
  ENDWHILE
  
  <span class="comments">; Read the next 10 lines all at once. If you have already processed</span>
  <span class="comments">; this file, exit. But if you haven't write the buffer to the output file.</span>
  in_lines = StrArr(10)
  ReadF, in_lun, in_lines
  
  <span class="comments">; Is this a landscape file? If not, out of here.</span>
  index = Where(in_lines EQ '%%PageOrientation: Landscape', landscape_cnt)
  IF landscape_cnt EQ 0 THEN BEGIN
        Free_Lun, in_lun
        Free_Lun, out_lun
        File_Delete, out_filename
        Message, 'File not a landscape file. Exiting...', /Informational
        RETURN
  ENDIF
  
  <span class="comments">; Has this file already been mucked with? If so, out of here. If not, write</span>
  <span class="comments">; the buffer to the output file.</span>
  IF StrMid(in_lines[1], 0, 10) EQ '180 rotate' THEN BEGIN
        Free_Lun, in_lun
        Free_Lun, out_lun
        File_Delete, out_filename
        Message, 'File is in the proper rotation. Exiting...', /Informational
        RETURN
  ENDIF ELSE BEGIN
        FOR j=0,count-1 DO PrintF, out_lun, buffer[j]
  ENDELSE
  
  count = count + 10
  
  <span class="comments">; We are going to add an extra line in the output file.</span>
  out_lines = StrArr(11)
  out_lines[0] = in_lines[0]
  out_lines[2:10] = in_lines[1:9]
  out_lines[1] = rtcmd
  
  <span class="comments">; Calculate the new bounding box boundaries.</span>
  bbox_line_num = Where(StrMid(in_lines, 0, 17) EQ '%%PageBoundingBox', bbox_count)
  IF bbox_count EQ 0 THEN Message, 'Cannot find PageBoundingBox line in file.'
  bbox = StrMid(in_lines[bbox_line_num[0]], 18)
  x0 = 0
  x1 = 0
  y0 = 0
  y1 = 0
  ReadS, bbox, x0, y0, x1, y1
  CASE pageType OF
        'LETTER': BEGIN
            lx = String(612 - x1, FORMAT='(I5)')
            ly = String(792 - y1, FORMAT='(I5)')
            ux = String(612 - lx, FORMAT='(I5)')
            uy = String(792 - ly, FORMAT='(I5)')
            END
        'A4': BEGIN
            lx = String(595.28 - x1, FORMAT='(I5)')
            ly = String(841.89 - y1, FORMAT='(I5)')
            ux = String(595.28 - lx, FORMAT='(I5)')
            uy = String(841.89 - ly, FORMAT='(I5)')
            END
        'LEGAL': BEGIN
            lx = String(612 - x1, FORMAT='(I5)')
            ly = String(1008 - y1, FORMAT='(I5)')
            ux = String(612 - lx, FORMAT='(I5)')
            uy = String(1008 - ly, FORMAT='(I5)')
            END
        'LEDGER': BEGIN
            lx = String(792 - x1, FORMAT='(I5)')
            ly = String(1224 - y1, FORMAT='(I5)')
            ux = String(792 - lx, FORMAT='(I5)')
            uy = String(1224 - ly, FORMAT='(I5)')
            END
  ENDCASE
  
  <span class="comments">; Output the new boundaries.</span>
  out_lines[5] = '%%PageBoundingBox: ' + lx + ly + ux + uy
  FOR j=0,10 DO PrintF, out_lun, out_lines[j]
  
  <span class="comments">; Output the rest of the file, looking for another "%%Page:" marker.</span>
  WHILE ~EOF(in_lun) DO BEGIN
     ReadF, in_lun, line
     PrintF, out_lun, line
     IF StrMid(line, 0, 7) EQ '%%Page:' THEN BEGIN
          IF Keyword_Set(A4) THEN BEGIN
              PrintF, out_lun, rtcmd
          ENDIF ELSE BEGIN
              PrintF, out_lun, rtcmd
          ENDELSE
     ENDIF
  ENDWHILE

  <span class="comments">; Clean up.</span>
  Free_lun, in_lun
  Free_lun, out_lun
  
  <span class="comments">; If there was no output filename given, then we are going</span>
  <span class="comments">; to replace the input file with the temporary output file.</span>
  IF no_output_filename THEN BEGIN
    inputDir = File_Dirname(in_filename)
    root_name = File_BaseName(in_filename)
    
    <span class="comments">; Can you write into the input directory?</span>
    IF File_Test(in_filename, /WRITE) EQ 0 THEN Message, 'Cannot write TEMPORARY file into input file directory.'
    
    <span class="comments">; Replace the input file with the temporary output file.</span>
    File_Delete, in_filename
    File_Move, out_filename, in_filename
  ENDIF 
  
END
</code>
    </div>
  </body>
</html>