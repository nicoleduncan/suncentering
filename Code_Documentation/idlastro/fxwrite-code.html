<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:57:37 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>fxwrite.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="fxwrite.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source">	PRO FXWRITE, FILENAME, HEADER, DATA, NANVALUE=NANVALUE,		$
		NOUPDATE=NOUPDATE, ERRMSG=ERRMSG, APPEND=APPEND
<span class="comments">;+</span>
<span class="comments">; NAME: </span>
<span class="comments">;	FXWRITE</span>
<span class="comments">; Purpose     : </span>
<span class="comments">;	Write a disk FITS file.</span>
<span class="comments">; Explanation : </span>
<span class="comments">;       Creates or appends to a disk FITS file and writes a FITS</span>
<span class="comments">;       header, and optionally an image data array.</span>
<span class="comments">; Use         : </span>
<span class="comments">;	FXWRITE, FILENAME, HEADER [, DATA ]</span>
<span class="comments">; Inputs      : </span>
<span class="comments">;	FILENAME = String containing the name of the file to be written.</span>
<span class="comments">;	HEADER	 = String array containing the header for the FITS file.</span>
<span class="comments">; Opt. Inputs : </span>
<span class="comments">;	DATA	 = IDL data array to be written to the file.  If not passed,</span>
<span class="comments">;		   then it is assumed that extensions will be added to the</span>
<span class="comments">;		   file.</span>
<span class="comments">; Outputs     : </span>
<span class="comments">;	None.</span>
<span class="comments">; Opt. Outputs: </span>
<span class="comments">;	None.</span>
<span class="comments">; Keywords    : </span>
<span class="comments">;	NANVALUE = Value signalling data dropout.  All points corresponding to</span>
<span class="comments">;		   this value are set to be IEEE NaN (not-a-number).  Ignored</span>
<span class="comments">;		   unless DATA is of type float, double-precision or complex.</span>
<span class="comments">;	NOUPDATE = If set, then the optional BSCALE and BZERO keywords in the</span>
<span class="comments">;		   HEADER array will not be changed.  The default is to reset</span>
<span class="comments">;		   these keywords to BSCALE=1, BZERO=0.</span>
<span class="comments">;       APPEND = If set, then an existing file will be appended to.</span>
<span class="comments">;                Appending to a non-existent file will create it.  If</span>
<span class="comments">;                a primary HDU already exists then it will be modified</span>
<span class="comments">;                to have EXTEND = T.</span>
<span class="comments">;	ERRMSG	 = If defined and passed, then any error messages will be</span>
<span class="comments">;		   returned to the user in this parameter rather than</span>
<span class="comments">;		   depending on the MESSAGE routine in IDL.  If no errors are</span>
<span class="comments">;		   encountered, then a null string is returned.  In order to</span>
<span class="comments">;		   use this feature, ERRMSG must be defined first, e.g.</span>
<span class="comments">;</span>
<span class="comments">;			ERRMSG = ''</span>
<span class="comments">;			FXWRITE, ERRMSG=ERRMSG, ...</span>
<span class="comments">;			IF ERRMSG NE '' THEN ...</span>
<span class="comments">;</span>
<span class="comments">; Calls       : </span>
<span class="comments">;	CHECK_FITS, GET_DATE, HOST_TO_IEEE, FXADDPAR, FXPAR</span>
<span class="comments">; Common      : </span>
<span class="comments">;	None.</span>
<span class="comments">; Restrictions: </span>
<span class="comments">;	If DATA is passed, then HEADER must be consistent with it.  If no data</span>
<span class="comments">;	array is being written to the file, then HEADER must also be consistent</span>
<span class="comments">;	with that.  The routine FXHMAKE can be used to create a FITS header.</span>
<span class="comments">;</span>
<span class="comments">;	If found, then the optional keywords BSCALE and BZERO in the HEADER</span>
<span class="comments">;	array is changed so that BSCALE=1 and BZERO=0.  This is so that these</span>
<span class="comments">;	scaling parameters are not applied to the data a second time by another</span>
<span class="comments">;	routine.  Also, history records are added storing the original values</span>
<span class="comments">;	of these constants.  (Other values of BZERO are used for unsigned</span>
<span class="comments">;	integers.)</span>
<span class="comments">;</span>
<span class="comments">;	If the /NOUPDATE keyword is set, however, then the BSCALE and BZERO</span>
<span class="comments">;	keywords are not changed.  The user should then be aware that FITS</span>
<span class="comments">;	readers will apply these numbers to the data, even if the data is</span>
<span class="comments">;	already converted to floating point form.</span>
<span class="comments">;</span>
<span class="comments">;	Groups are not supported.</span>
<span class="comments">;</span>
<span class="comments">; Side effects: </span>
<span class="comments">;	HEADER may be modified.  One way it may be modified is describe</span>
<span class="comments">;       above under NOUPDATE.  The first header card may also be</span>
<span class="comments">;       modified to conform to the FITS standard if it does not</span>
<span class="comments">;       already agree (i.e. use of either the SIMPLE or XTENSION</span>
<span class="comments">;       keyword depending on whether the image is the primary HDU or</span>
<span class="comments">;       not).</span>
<span class="comments">; Category    : </span>
<span class="comments">;	Data Handling, I/O, FITS, Generic.</span>
<span class="comments">; Prev. Hist. : </span>
<span class="comments">;	W. Thompson, Jan 1992, from WRITEFITS by J. Woffard and W. Landsman.</span>
<span class="comments">;	Differences include:</span>
<span class="comments">;</span>
<span class="comments">;		* Made DATA array optional, and HEADER array mandatory.</span>
<span class="comments">;		* Changed order of HEADER and DATA parameters.</span>
<span class="comments">;		* No attempt made to fix HEADER array.</span>
<span class="comments">;</span>
<span class="comments">;	W. Thompson, May 1992, changed open statement to force 2880 byte fixed</span>
<span class="comments">;			       length records (VMS).  The software here does not</span>
<span class="comments">;			       depend on this file configuration, but other</span>
<span class="comments">;			       FITS readers might.</span>
<span class="comments">;	W. Thompson, Aug 1992, added code to reset BSCALE and BZERO records,</span>
<span class="comments">;			       and added the NOUPDATE keyword.</span>
<span class="comments">; Written     : </span>
<span class="comments">;	William Thompson, GSFC, January 1992.</span>
<span class="comments">; Modified    : </span>
<span class="comments">;	Version 1, William Thompson, GSFC, 12 April 1993.</span>
<span class="comments">;		Incorporated into CDS library.</span>
<span class="comments">;	Version 2, William Thompson, GSFC, 31 May 1994</span>
<span class="comments">;		Added ERRMSG keyword.</span>
<span class="comments">;	Version 3, William Thompson, GSFC, 23 June 1994</span>
<span class="comments">;		Modified so that ERRMSG is not touched if not defined.</span>
<span class="comments">;	Version 4, William Thompson, GSFC, 12 August 1999</span>
<span class="comments">;		Catch error if unable to open file.</span>
<span class="comments">;       Version 4.1 Wayne Landsman, GSFC, 02 May 2000</span>
<span class="comments">;               Remove !ERR in call to CHECK_FITS, Use ARG_PRESENT()</span>
<span class="comments">;       Version 5, William Thompson, GSFC, 22 September 2004</span>
<span class="comments">;               Recognize unsigned integer types</span>
<span class="comments">;       Version 5.1 W. Landsman 14 November 204 </span>
<span class="comments">;               Allow for need for 64bit number of bytes</span>
<span class="comments">;       Version 6, Craig Markwardt, GSFC, 30 May 2005</span>
<span class="comments">;               Ability to append to existing files</span>
<span class="comments">; Version     : </span>
<span class="comments">;	Version 6, 30 May 2005</span>
<span class="comments">;-</span>
<span class="comments">;</span>
	ON_ERROR, 2
<span class="comments">;</span>
<span class="comments">;  Check the number of parameters.</span>
<span class="comments">;   </span>
	IF N_PARAMS() LT 2 THEN BEGIN
	    MESSAGE = 'Syntax:  FXWRITE, FILENAME, HEADER  [, DATA ]'
	    GOTO, HANDLE_ERROR
	ENDIF
<span class="comments">;</span>
<span class="comments">;  Check the header against the data being written to the file.  If the data</span>
<span class="comments">;  array is not passed, then NAXIS should be set to zero, and EXTEND should be</span>
<span class="comments">;  true.</span>
<span class="comments">;</span>
	IF N_PARAMS() EQ 2 THEN BEGIN
	    IF (FXPAR(HEADER,'NAXIS') NE 0) THEN BEGIN
		MESSAGE = 'NAXIS should be zero for no primary data array'
		GOTO, HANDLE_ERROR
	    END ELSE IF (NOT FXPAR(HEADER,'EXTEND')) THEN BEGIN
		MESSAGE = 'EXTEND should be true for no primary data array'
		GOTO, HANDLE_ERROR
	    ENDIF
	END ELSE BEGIN
	    CHECK_FITS, DATA, HEADER, /FITS, ERRMSG = MESSAGE
	    IF MESSAGE NE '' THEN GOTO, HANDLE_ERROR
	ENDELSE
<span class="comments">;</span>
<span class="comments">;  Set the BSCALE and BZERO keywords to their default values.</span>
<span class="comments">;</span>
        SZ = SIZE(DATA)
        TYPE = SZ[SZ[0]+1]
        IF N_PARAMS() EQ 3 THEN NEWDATA = DATA
	IF NOT KEYWORD_SET(NOUPDATE) THEN BEGIN
	    BZERO  = FXPAR(HEADER,'BZERO')
	    BSCALE = FXPAR(HEADER,'BSCALE')
	    GET_DATE,DTE
	    IF (BSCALE NE 0) AND (BSCALE NE 1) THEN BEGIN
		FXADDPAR,HEADER,'BSCALE',1.
		FXADDPAR,HEADER,'HISTORY',DTE+' reset BSCALE, was '+ $
			STRTRIM(BSCALE,2)
            ENDIF
<span class="comments">;</span>
<span class="comments">;  If an unsigned data type then redefine BZERO to allow all the data to be</span>
<span class="comments">;  stored in the file.</span>
<span class="comments">;</span>
            BZERO0 = 0
            IF (TYPE EQ 12) AND (NOT KEYWORD_SET(NOUPDATE)) THEN BEGIN
                BZERO0 = '8000'X
                NEWDATA = FIX(TEMPORARY(NEWDATA) - BZERO)
            ENDIF
            IF (TYPE EQ 13) AND (NOT KEYWORD_SET(NOUPDATE)) THEN BEGIN
                BZERO0 = '80000000'X
                NEWDATA = LONG(TEMPORARY(NEWDATA) - BZERO)
            ENDIF
	    IF BZERO NE BZERO0 THEN BEGIN
		FXADDPAR,HEADER,'BZERO',BZERO0
		FXADDPAR,HEADER,'HISTORY',DTE+' reset BZERO, was '+ $
			STRTRIM(BZERO,2)
	    ENDIF
	ENDIF
<span class="comments">;</span>
<span class="comments">;  Get the UNIT number, and open the file.</span>
<span class="comments">;</span>
       	GET_LUN, UNIT      
       	OPENW, UNIT, FILENAME, 2880, /BLOCK, ERROR=ERR, APPEND=APPEND
        VERB = 'creating'
        IF KEYWORD_SET(APPEND) THEN VERB = 'appending to'
	IF ERR NE 0 THEN BEGIN
	    MESSAGE = 'Error '+VERB+' file '+FILENAME
	    GOTO, HANDLE_ERROR
        ENDIF

<span class="comments">;</span>
<span class="comments">;  Special processing is required when we are appending to </span>
<span class="comments">;  the file, to ensure that the FITS standards are met.</span>
<span class="comments">;  (i.e. primary HDU must have EXTEND = T, and the header</span>
<span class="comments">;  to be written must have XTENSION = 'IMAGE').</span>
<span class="comments">;  </span>

        POINT_LUN, -UNIT, POS
        IF POS GT 0 THEN BEGIN
            <span class="comments">;; Release the file and call FXHMODIFY to edit the</span>
            <span class="comments">;; header of the primary HDU.  It is required to have</span>
            <span class="comments">;; EXTEND=T.  FXHMODIFY calls FXADDPAR, which</span>
            <span class="comments">;; automatically places the EXTEND keyword in the</span>
            <span class="comments">;; required position.</span>
            FREE_LUN, UNIT
            FXHMODIFY, FILENAME, ERRMSG=MESSAGE, $ <span class="comments">; (EXTENSION=0 implied)</span>
              'EXTEND', 'T', ' FITS dataset may contain extensions'
            IF MESSAGE NE '' THEN GOTO, HANDLE_ERROR
            
            <span class="comments">;; Re-open the file</span>
            GET_LUN, UNIT      
            OPENW, UNIT, FILENAME, 2880, /BLOCK, ERROR=ERR, APPEND=APPEND
            IF ERR NE 0 THEN BEGIN
                MESSAGE = 'Error re-opening file '+FILENAME
                GOTO, HANDLE_ERROR
            ENDIF
            
            <span class="comments">;; Revise the header so that it begins with an</span>
            <span class="comments">;; XTENSION keyword... if it doesn't already</span>
            IF STRMID(HEADER[0], 0, 9) EQ 'SIMPLE  =' THEN BEGIN
                <span class="comments">;; Extra work to preserve the comment</span>
                DUMMY = FXPAR(HEADER, 'SIMPLE', COMMENT=COMMENT) 
                FXADDPAR, DUMMYHEADER, 'XTENSION', 'IMAGE', COMMENT
                HEADER[0] = DUMMYHEADER[0]
            ENDIF

            <span class="comments">;; Find last NAXIS* keyword, since PCOUNT/GCOUNT follow them</span>
            NAXIS = FXPAR(HEADER, 'NAXIS', COUNT=COUNT_NAXIS)
            IF NAXIS[0] GT 0 THEN PCOUNT_AFTER='NAXIS'+strtrim(NAXIS[0],2)
            <span class="comments">;; Required PCOUNT/GCOUNT keywords for following extensions</span>
            FXADDPAR, HEADER, 'PCOUNT', 0, ' number of random group parameters', $
              AFTER=PCOUNT_AFTER
            FXADDPAR, HEADER, 'GCOUNT', 1, ' number of random groups', $
              AFTER='PCOUNT'
            
        ENDIF ELSE BEGIN
            <span class="comments">;; In the off chance that this header was used before to</span>
            <span class="comments">;; write a header with XTENSION, make sure this *new* file</span>
            <span class="comments">;; has SIMPLE = T</span>
            
            IF STRMID(HEADER[0], 0, 9) EQ 'XTENSION=' THEN BEGIN
                <span class="comments">;; Extra work to preserve the comment</span>
                DUMMY = FXPAR(HEADER, 'XTENSION', COMMENT=COMMENT) 
                FXADDPAR, DUMMYHEADER, 'SIMPLE', 'T', COMMENT
                HEADER[0] = DUMMYHEADER[0]
            ENDIF

        ENDELSE


<span class="comments">;</span>
<span class="comments">;  Determine if an END line occurs, and add one if necessary</span>
<span class="comments">;</span>
	ENDLINE = WHERE( STRMID(HEADER,0,8) EQ 'END     ', NEND)
	ENDLINE = ENDLINE[0]
	IF NEND EQ 0 THEN BEGIN
	    MESSAGE, 'WARNING - An END statement has been appended ' + $
		'to the FITS header', /INFORMATIONAL
	    HEADER = [HEADER, 'END' + STRING(REPLICATE(32B,77))]
	    ENDLINE = N_ELEMENTS(HEADER) - 1 
	ENDIF
	NMAX = ENDLINE + 1		<span class="comments">;Number of 80 byte records</span>
	NHEAD = FIX((NMAX+35)/36)	<span class="comments">;Number of 2880 byte records</span>
<span class="comments">;</span>
<span class="comments">;  Convert to byte and force into 80 character lines</span>
<span class="comments">;</span>
	BHDR = REPLICATE(32B, 80, 36*NHEAD)
	FOR N = 0,ENDLINE DO BHDR[0,N] = BYTE( STRMID(HEADER[N],0,80) )
	WRITEU, UNIT, BHDR
<span class="comments">;</span>
<span class="comments">;  If passed, then write the data array.</span>
<span class="comments">;</span>
	IF N_PARAMS() EQ 3 THEN BEGIN
<span class="comments">;</span>
<span class="comments">;  If necessary, then byte-swap the data before writing it out.  Also, replace</span>
<span class="comments">;  any values corresponding data dropout with IEEE NaN.</span>
<span class="comments">;</span>
	    IF (N_ELEMENTS(NANVALUE) EQ 1) AND (TYPE GE 4) AND	$
		    (TYPE LE 6) THEN BEGIN
		W = WHERE(DATA EQ NANVALUE, COUNT)
		CASE TYPE OF
		    4:  NAN = FLOAT(  REPLICATE('FF'XB,4),0,1)
		    5:  NAN = DOUBLE( REPLICATE('FF'XB,8),0,1)
		    6:  NAN = COMPLEX(REPLICATE('FF'XB,8),0,1)
		    9:  NAN = DCOMPLEX(REPLICATE('FF'XB,16),0,1)
		ENDCASE
	    END ELSE COUNT = 0
<span class="comments">;</span>
	    HOST_TO_IEEE, NEWDATA
	    IF COUNT GT 0 THEN NEWDATA[W] = NAN
<span class="comments">;</span>
	    WRITEU,UNIT,NEWDATA
<span class="comments">;</span>
<span class="comments">;  If necessary, then pad out to an integral multiple of 2880 bytes.</span>
<span class="comments">;</span>
	    BITPIX = FXPAR( HEADER, 'BITPIX' )
	    NBYTES = LONG64(N_ELEMENTS(DATA)) * (ABS(BITPIX) / 8 )
	    NPAD = NBYTES MOD 2880
	    IF NPAD NE 0 THEN BEGIN
		NPAD = 2880 - NPAD
		WRITEU,UNIT,BYTARR(NPAD)
	    ENDIF
	ENDIF
<span class="comments">;</span>
<span class="comments">;  Close the file and return.</span>
<span class="comments">;</span>
	FREE_LUN, UNIT
	IF ARG_PRESENT(ERRMSG)  THEN ERRMSG = ''
	RETURN
<span class="comments">;</span>
HANDLE_ERROR:
	IF N_ELEMENTS(UNIT) EQ 1 THEN FREE_LUN, UNIT
	IF ARG_PRESENT(ERRMSG) THEN ERRMSG = 'FXWRITE: ' + MESSAGE	$
		ELSE MESSAGE, MESSAGE
<span class="comments">;</span>
	END
</code>
    </div>
  </body>
</html>