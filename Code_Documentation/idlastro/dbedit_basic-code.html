<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:57:25 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>dbedit_basic.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="dbedit_basic.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><a id="dbedit_basic:source"></a>pro dbedit_basic,list,items
<span class="comments">;+</span>
<span class="comments">; NAME:</span>
<span class="comments">;       DBEDIT_BASIC</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;       Subroutine of DBEDIT_BASIC to edit a database on a dumb terminal.</span>
<span class="comments">; EXPLANATION:</span>
<span class="comments">;       Interactively edit specified fields in a database.  The</span>
<span class="comments">;       value of each field is displayed, and the user has the option</span>
<span class="comments">;       of changing or keeping the value.</span>
<span class="comments">;</span>
<span class="comments">; CALLING SEQUENCE:</span>
<span class="comments">;       dbedit_basic, list, [ items ]</span>
<span class="comments">;</span>
<span class="comments">; INPUTS:</span>
<span class="comments">;       list - scalar or vector of database entry numbers.  Set LIST=0</span>
<span class="comments">;               to interactively add a new entry to a database.</span>
<span class="comments">;</span>
<span class="comments">; OPTIONAL INPUTS</span>
<span class="comments">;       items - list of items to be edited.  If not supplied, then the</span>
<span class="comments">;               value of every field will be displayed.</span>
<span class="comments">;</span>
<span class="comments">; NOTES:</span>
<span class="comments">;       (1) Database must be opened for update (dbopen,&lt;dbname>,1) before</span>
<span class="comments">;       calling DBEDIT_BASIC.  User must have write privileges on the database</span>
<span class="comments">;       files.</span>
<span class="comments">;       (2) User gets a second chance to look at edited values, before</span>
<span class="comments">;       they are actually written to the database</span>
<span class="comments">;</span>
<span class="comments">; PROMPTS:</span>
<span class="comments">;       The item values for each entry to be edited are first displayed</span>
<span class="comments">;       User is the asked "EDIT VALUES IN THIS ENTRY (Y(es), N(o), or Q(uit))?</span>
<span class="comments">;       If user answers 'Y' or hits RETURN, then each item is displayed</span>
<span class="comments">;       with its current value, which the user can update.  If user answered</span>
<span class="comments">;       'N' then DBEDIT_BASIC skips to the next  entry.   If user answers 'Q'</span>
<span class="comments">;       then DBEDIT will exit, saving all previous changes.</span>
<span class="comments">;</span>
<span class="comments">; EXAMPLE:</span>
<span class="comments">;       Suppose V magnitudes (V_MAG) in a database STARS with unknown values </span>
<span class="comments">;       were assigned a value of 99.9.  Once the true values become known, the</span>
<span class="comments">;       database can be edited</span>
<span class="comments">;</span>
<span class="comments">;       IDL> !PRIV=2 & dbopen,'STARS',1         ;Open database for update</span>
<span class="comments">;       IDL> list =  dbfind('V_MAG=99.9')       ;Get list of bad V_MAG values</span>
<span class="comments">;       IDL> dbedit,list,'V_MAG'       ;Interactively insert good V_MAG values</span>
<span class="comments">;</span>
<span class="comments">; REVISION HISTORY:</span>
<span class="comments">;       Written  W. Landsman     STX        April, 1989</span>
<span class="comments">;       Rename DBEDIT_BASIC from DBEDIT            July, 1993</span>
<span class="comments">;       Converted to IDL V5.0   W. Landsman   September 1997</span>
<span class="comments">;       Change DATATYPE() to size(/TNAME)  W. Landsman   November 2001</span>
<span class="comments">;-</span>
 On_error,2

 zparcheck, 'DBEDIT_BASIC', list, 1, [1,2,3], [0,1], 'Database entry numbers'

 dbname = db_info( 'NAME', 0 )                <span class="comments">;Database name</span>
 if not db_info( 'UPDATE' ) then $
     message, 'Database ' + dbname + ' must be opened for update

 if ( N_params() LT 2 ) then begin         <span class="comments">;Did user specify items string?</span>
     nitems = db_info( 'ITEMS', 0 ) -1     <span class="comments">;If not then use every item but ENTRY</span>
     items = indgen(nitems) + 1
 endif 

 nlist = N_elements(list)

 if ( list[0] EQ -1 ) then begin            <span class="comments">;Edit all entries?</span>
    nlist = db_info( 'ENTRIES', 0 )         <span class="comments">;Get number of entries</span>
    list = lindgen(nlist) + 1
 endif

 db_item, items, itnum, ivalnum, dtype, sbyte, numvals, nbytes

 nitems = N_elements(itnum)                <span class="comments">;Number of items to be edited</span>
 names = db_item_info( 'NAME', itnum )     <span class="comments">;Get names of each item</span>
 newflag = bytarr(nlist,nitems)        <span class="comments">;Keeps track of fields actually updated</span>
 yesno = ''

for i = 0, nlist-1 do begin            <span class="comments">;Loop over each entry to be edited</span>
    ll = list[i]

    if ll GT 0 then begin             <span class="comments">;Existing entry?</span>
      dbprint,ll,'*',TEXT = 1
      read,'Edit values in this entry (Y(es),N(o),Q(uit), def=Y)? ',yesno
      yesno = strupcase(strmid(yesno,0,1))
      if yesno eq 'Q' then goto, UPDATE $
        else if yesno EQ 'N' then goto, ENTRY_DONE   
    endif else message,'Adding new entry to database '+dbname,/inform

    print,'Hit [RETURN] to leave values unaltered'
    READVAL:  dbrd,ll,entry
    for j = 0,nitems - 1 do begin
        val = ''
        name = strtrim(names[j],2)
        curval = dbxval( entry, dtype[j], numvals[j], sbyte[j], nbytes[j] )
<span class="comments">;       Convert byte to integer to avoid string conversion problems</span>
        if (dtype[j] EQ 1) and ( N_elements(curval) EQ 1 ) then $ 
            curval = fix(curval)       
        if ( numvals[j] EQ 1 ) then oldval = strtrim(curval,2) else $
                                oldval = strtrim(curval[0],2) + '...'
        read,name+' New Value (' + oldval + '): ',val
        TESTVAL: 
           if ( val NE '' ) then begin
           oldval = make_array( size = [1,numvals[j],dtype[j],numvals[j]] )
           On_IOerror, BADVAL 
           oldval[0] = val
           On_IOerror, NULL 
           newflag[i,j] = 1
           dbxput, oldval, entry, dtype[j], sbyte[j], nbytes[j]
        endif    
    endfor

    if ( total(newflag[i,*]) GT 0 ) then begin
    print,'' & print,'Updated Values' & print,''

    for j = 0,nitems-1 do begin
         name = strtrim(names[j],2)
         print,name,': ',dbxval( entry,dtype[j],numvals[j],sbyte[j],nbytes[j] )
    endfor
         print,''
         yesno = ''
         read,' Are these values correct [Y]? ', yesno
         if ( strupcase(yesno) NE 'N' ) then begin
            if ( ll EQ 0 ) then begin 
                dbwrt,entry,0,1 
                ll = db_info('entries',0) + 1
            endif else dbwrt,entry
            print,'' & print,'Entry ',strtrim(ll,2), ' now updated   
         endif else begin 
            newflag[i,*] = 0
            goto, READVAL
         endelse
    endif else print,'No values updated for entry',ll
    ENTRY_DONE:     
endfor

UPDATE: 
 newitem = total(newflag, 1)
 indexnum = where(newitem, nindex)

 if ( nindex GT 0 ) then begin                          <span class="comments">;Any mods made?</span>
      indexnum = itnum[indexnum]
      indextype = db_item_info('INDEX',indexnum)  <span class="comments">;Index type of modified fields </span>
      good = where(indextype GE 1, ngood)         <span class="comments">;Which fields are indexed?</span>
      if ngood GT 0 then dbindex,indexnum[good]
      dbopen,dbname,1
      dbprint,list,[0,itnum],TEXT=1
 endif
 return
BADVAL:  
  print,'Item '+name+ ' must be of type '+ size(oldval[0],/TNAME)
         val = ''
         j = j-1
         goto, TESTVAL      

 end
</code>
    </div>
  </body>
</html>