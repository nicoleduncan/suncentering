<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:58:06 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>tab_read.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="tab_read.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><a id="tab_read:source"></a>pro tab_read,name,tcb,table,header
<span class="comments">;+</span>
<span class="comments">; NAME:</span>
<span class="comments">;   TAB_READ   </span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;   Procedure to read an SDAS table file</span>
<span class="comments">; CALLING SEQUENCE:</span>
<span class="comments">;	tab_read,name,tcb,table,header</span>
<span class="comments">; INPUTS:</span>
<span class="comments">;	name - name of the table file</span>
<span class="comments">; OUTPUTS:</span>
<span class="comments">;	tcb - table control block </span>
<span class="comments">;		Longword array of size 16 x maxcols+2</span>
<span class="comments">;		where maxcols is the maximum number of columns</span>
<span class="comments">;		allocated for the table.</span>
<span class="comments">;		tcb(*,0) contains:</span>
<span class="comments">;		   word	0	SPARE</span>
<span class="comments">;			1	number of user parameters</span>
<span class="comments">;			2	max. number of user par. allowed</span>
<span class="comments">;			3	number of rows in the table</span>
<span class="comments">;			4	number of allocated rows (for col. ordered tab)</span>
<span class="comments">;			5	number of columns defined</span>
<span class="comments">;			6	max number of columns</span>
<span class="comments">;			7	length of row used (in units of 2-bytes)</span>
<span class="comments">;			8	max row length (in units of 2-bytes)</span>
<span class="comments">;					relevant only for row ordered tables.</span>
<span class="comments">;			9	table type (11 for row order, 12 for col. order)</span>
<span class="comments">;			15	update flag (0-readonly, 1-update)</span>
<span class="comments">;		tcb(*,i) contains description of column i</span>
<span class="comments">;		   word 0	column number</span>
<span class="comments">;			1	offset for start of row in units of 2-bytes</span>
<span class="comments">;			2	width or column in 2-byte units</span>
<span class="comments">;			3	data type</span>
<span class="comments">;					6 = real*4</span>
<span class="comments">;					7 = real*8</span>
<span class="comments">;					4 = integer*4</span>
<span class="comments">;					1 = boolean*4</span>
<span class="comments">;					2 = character string</span>
<span class="comments">;			4-8	ascii column name up to 19 characters</span>
<span class="comments">;			9-13	column units (up to 19 characters)</span>
<span class="comments">;			14-15	format string</span>
<span class="comments">;		tcb(*,max number of columns+1)= file name</span>
<span class="comments">;</span>
<span class="comments">;	table - table array, Byte array row length (bytes) x nrows</span>
<span class="comments">;</span>
<span class="comments">; 	header - header parameters in form usable by sxpar, sxaddhist,</span>
<span class="comments">;		sxaddpar, ect.</span>
<span class="comments">; HISTORY:</span>
<span class="comments">;	Version 1  D. Lindler  Jan 88</span>
<span class="comments">;	Converted to NEW IDL  April 90  D. Lindler</span>
<span class="comments">;	Converted to IDL V5.0   W. Landsman   September 1997</span>
<span class="comments">;-</span>
<span class="comments">;------------------------------------------------------------------------</span>
if n_params(0) lt 2 then begin
	print,'TAB_READ -- output table control block not supplied'
	retall
endif
<span class="comments">;</span>
<span class="comments">; open file</span>
<span class="comments">;</span>
fdecomp,name,disk,dir,root,ext
if ext eq '' then ext = 'tab'
fname=disk+dir+root+'.'+ext
!err=0
openr,unit,fname,/get_lun,error=err
if err lt 0 then begin
	free_lun,unit
	message,'Error opening file '+fname,/CON
	print,!ERROR_STATE.MSG
	retall
end
<span class="comments">;</span>
<span class="comments">; read header record</span>
<span class="comments">;</span>
lrec=assoc(unit,lonarr(12),0)
h=lrec[0]
maxpar=h[1]
maxcol=h[5]
type=h[8]
<span class="comments">;</span>
<span class="comments">; create table control block</span>
<span class="comments">;</span>
tcb=lonarr(16,maxcol+2)
tcb[0]=[unit,h,0,0,0]
sbyte=12*4+h[1]*80L			<span class="comments">;starting byte of column descriptions</span>
lrec = assoc(unit,lonarr(16,maxcol),sbyte)
tcb[0,1]=lrec[0]			<span class="comments">;read col. descriptions</span>
byte_name=replicate(32b,64)
byte_name[0]=byte(fname)
tcb[0,maxcol+1]=long(byte_name,0,16)	<span class="comments">;place filename into tcb</span>
<span class="comments">;</span>
<span class="comments">; read data</span>
<span class="comments">;</span>
rowlen=MAX([tcb[7,0],tcb[8,0]])*2
nrows=MAX([tcb[4,0],tcb[3,0]])
offset=12*4+tcb[2,0]*80+tcb[6,0]*16*4	<span class="comments">;offset of data in the file</span>

brec=assoc(unit,bytarr(1))		<span class="comments">; we will read into a byte array</span>

if type eq 11 then begin	<span class="comments">; row ordered</span>
	brec = assoc(unit,bytarr(rowlen,nrows,/nozero),offset)
	table=brec[0]		<span class="comments">;read table</span>
   end else begin		<span class="comments">; column ordered table</span>
	table=bytarr(rowlen,nrows)
	ncols=tcb[5,0]
	if ncols gt 0 then begin
		for i=1,ncols do begin
			tab_col,tcb,i,position,width,datatype
			brec = assoc(unit,bytarr(width,nrows,/nozero),offset)
			column=brec[0]			 <span class="comments">; read column</span>
			offset=offset+nrows*width	<span class="comments">;offset to next col</span>
			table[position,0]=column	<span class="comments">;insert into table</span>
		endfor
	endif
endelse
<span class="comments">;</span>
<span class="comments">; read header</span>
<span class="comments">;</span>
if n_params(0) gt 3 then begin	<span class="comments">;read only if output parameter supplied</span>
	npar=tcb[1,0]
	header=strarr(npar+1)
	header[0]='END'+string(replicate(32b,77))
	if npar gt 0 then begin
	    brec = assoc(unit,bytarr(80,npar,/nozero),12*4)
	    htab=string(brec[0])		<span class="comments">;read table header</span>
	    for i=0,npar-1 do begin		<span class="comments">;convert to FITS header</span>
		line=htab[i]
		keyword=strmid(line,0,8)
		type=strmid(line,8,1)
		value=nulltrim(strmid(line,9,71))
		if strtrim(keyword ne '') then begin
		  case type of			<span class="comments">;convert value to correct type</span>
			't':
			'b': if value eq '0' then value='F' else value='T'
			'i': value=long(strtrim(value))
			'r': value=float(strtrim(value))
			'd': value=double(strtrim(value))
		  endcase
		  sxaddpar,header,keyword,value
		end
	    endfor
	endif
endif
close,unit
free_lun,unit
return
end
</code>
    </div>
  </body>
</html>