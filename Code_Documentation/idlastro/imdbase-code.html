<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Mon Sep 30 16:57:42 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>imdbase.pro (Documentation for ./)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="imdbase.pro (Documentation for ./)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><a id="imdbase:source"></a>pro imdbase,hdr,catalogue,list,XPOS=xpos,YPOS=ypos, SILENT=silent, $
                XRANGE=xrange,YRANGE=yrange, SUBLIST = sublist, ALT = alt
<span class="comments">;+</span>
<span class="comments">; NAME:</span>
<span class="comments">;     IMDBASE</span>
<span class="comments">; PURPOSE:</span>
<span class="comments">;     Find the sources in an IDL database that are located on a given image.</span>
<span class="comments">;</span>
<span class="comments">; CALLING SEQUENCE:</span>
<span class="comments">;    imdbase, hdr, [catalogue, list, ALT=, XPOS= ,YPOS=, XRANGE= ,YRANGE= , </span>
<span class="comments">;                       SUBLIST =, /SILENT ]  </span>
<span class="comments">;</span>
<span class="comments">; INPUTS:</span>
<span class="comments">;    hdr - FITS image header containing astrometry, and the NAXIS1,</span>
<span class="comments">;               NAXIS2 keywords giving the image size</span>
<span class="comments">;    catalogue - string giving name of catalogue in database.   If not supplied</span>
<span class="comments">;              then the currently open database is used.   The database must </span>
<span class="comments">;              contain the (preferably indexed) fields RA (in hours) and DEC.  </span>
<span class="comments">;              Type DBHELP for a list of the names of available catalogues.</span>
<span class="comments">;</span>
<span class="comments">; OPTIONAL OUTPUT PARAMETER:</span>
<span class="comments">;    LIST - A longwprd vector containing the entry numbers of sources found</span>
<span class="comments">;           within the image.   This vector can then be used with other</span>
<span class="comments">;           database procedures, e.g. to print specified fields (DBPRINT)</span>
<span class="comments">;           or subselect with further criteria (DBFIND)</span>
<span class="comments">;</span>
<span class="comments">; OPTIONAL OUTPUT KEYWORD PARAMETER:</span>
<span class="comments">;     XPOS - REAL*4 vector giving X positions of catalogue sources found </span>
<span class="comments">;            within the image</span>
<span class="comments">;     YPOS - REAL*4 vector giving Y positions of catalogue sources found </span>
<span class="comments">;            within the image</span>
<span class="comments">;</span>
<span class="comments">; OPTIONAL INPUT KEYWORD PARAMETERS</span>
<span class="comments">;       ALT -  single character 'A' through 'Z' or ' ' specifying an alternate </span>
<span class="comments">;              astrometry system present in the FITS header.    The default is</span>
<span class="comments">;              to use the primary astrometry or ALT = ' '.   If /ALT is set, </span>
<span class="comments">;              then this is equivalent to ALT = 'A'.   See Section 3.3 of </span>
<span class="comments">;              Greisen & Calabretta (2002, A&A, 395, 1061) for information about</span>
<span class="comments">;              alternate astrometry keywords.</span>
<span class="comments">;     SILENT - If set, then informational messages are suppressed</span>
<span class="comments">;     SUBLIST - vector giving entries in the database to consider in the</span>
<span class="comments">;               search.  If not supplied, or set equal to -1, then all entries</span>
<span class="comments">;               are considered.</span>
<span class="comments">;     XRANGE - 2 element vector giving the X range of the image to consider.</span>
<span class="comments">;              The default is to search for catalogue sources within the entire</span>
<span class="comments">;             image</span>
<span class="comments">;     YRANGE - 2 element vector giving the Y range of the image to consider.</span>
<span class="comments">;</span>
<span class="comments">; NOTES:</span>
<span class="comments">;     If an output list vector is not supplied, then the found objects are</span>
<span class="comments">;     diplayed at the terminal.</span>
<span class="comments">;</span>
<span class="comments">; EXAMPLE:</span>
<span class="comments">;      Find all existing IUE observations within the field of the FITS </span>
<span class="comments">;      file fuv0435fc.fits.  Subselect those taken with the SWP camera</span>
<span class="comments">;</span>
<span class="comments">;      H = HEADFITS('fuv0435f.fits')             ;Read FITS header </span>
<span class="comments">;      IMDBASE,H,'IUE',list              ;Find IUE obs. within image </span>
<span class="comments">;      list2 = DBFIND('CAM_NO=3',list)   ;Subselect on SWP images</span>
<span class="comments">;</span>
<span class="comments">; SIDE EFFECTS:</span>
<span class="comments">;      The IDL database is left open upon exiting IMDBASE.</span>
<span class="comments">; NOTES:</span>
<span class="comments">;      IMDBASE checks the description of the RA item in the database for the</span>
<span class="comments">;      string '1950'.    If found, the database RA and Dec are assumed to be </span>
<span class="comments">;      in equinox B1950.   Otherwise they are assumed to be in ICRS or J2000. </span>
<span class="comments">;</span>
<span class="comments">; SYSTEM VARIABLES:                                                </span>
<span class="comments">;      The non-standard system variable !TEXTOUT is required for use with the</span>
<span class="comments">;      database procedures.   </span>
<span class="comments">;</span>
<span class="comments">; PROCEDURES USED:</span>
<span class="comments">;      AD2XY, DBEXT, DB_ITEM, DB_ITEM_INFO(), DBOPEN, DBFIND(), EXTAST, </span>
<span class="comments">;      GET_EQUINOX(), GSSSADXY, GSSSXYAD, HPRECESS, SXPAR(), XY2AD </span>
<span class="comments">; REVISION HISTORY:</span>
<span class="comments">;      Written W. Landsman            September, 1988</span>
<span class="comments">;      Added SUBLIST keyword          September, 1991</span>
<span class="comments">;      Updated to use ASTROMETRY structures    J.D. Offenberg, HSTX, Jan 1993</span>
<span class="comments">;      Conversion for precession fixed.   R.Hill, HSTX, 22-Apr-93</span>
<span class="comments">;      Check RA description for equinox   W. Landsman  Aug 96</span>
<span class="comments">;      Call HPRECESS if header equinox does not match DB  W. Landsman Oct. 1998</span>
<span class="comments">;      Assume Equinox J2000 if not explicitly B1950 W. Landsman Jan. 2005</span>
<span class="comments">;      Added ALT keyword W. Landsman  April 2005</span>
<span class="comments">;      Use open database, if no catalogue name given  W.L  April 2008</span>
<span class="comments">;      Added /SILENT keyword W.L. Mar 2009</span>
<span class="comments">;-</span>
 On_error,2                                  <span class="comments">;Return to caller</span>
 compile_opt idl2

 if N_params() LT 2 then begin               <span class="comments">;Sufficient parameters?</span>
     print,'Syntax - imdbase, hdr, catalogue, [ list, ALT =, SUBLIST = '
     print,'              XPOS = , YPOS = , XRANGE =, YRANGE =, /SILENT  ]'
     print,'Type DBHELP for available catalogues'
     return
 endif              

<span class="comments">; Check if catalogue has preselected output fields</span>

 if N_elements(catalogue) EQ 0 then catalogue = db_info('name',0)
 catname = strupcase(strtrim(catalogue,2)) 

 dbopen,catalogue,unavail=unavail       <span class="comments">;Was database found?</span>
 if unavail EQ 1 then message,'Database ' + catalogue + ' is unavailable'
                
 db_item,'ra',itnum
 descrip = db_item_info('description',itnum[0])
 if strpos(descrip,'1950') GE 0 then cat_year = 1950. else cat_year = 2000.

<span class="comments">; Get X and Y of 4 corners of the image</span>

 if N_elements(xrange) NE 2 then begin    
      xmin = 0          & xmax =  sxpar(hdr,'NAXIS1') - 1
 ENDIF ELSE BEGIN
      xmin = xrange[0]  & xmax = xrange[1]
 ENDELSE

 if N_elements(yrange) NE 2 then BEGIN
        ymin=0          & ymax = sxpar(hdr,'NAXIS2') - 1
 ENDIF ELSE BEGIN
     ymin = yrange[0]   & ymax = yrange[1]
 ENDELSE

 x = [xmin,xmax,xmax,xmin]
 y = [ymin,ymin,ymax,ymax]

<span class="comments">; Make sure header has astrometry and convert X,Y to Ra, Dec</span>

 extast, hdr, ASTR, noparams, ALT = alt
 if noparams LT 0 then message,'Image header does not contain astrometry'

<span class="comments">; Compare equinox of image with that of database and precess if necessary</span>

 im_year = GET_EQUINOX(hdr,code)
 if ( code EQ -1 ) then begin 
        message,/inf,'EQUINOX keyword not found in header, assumed to be J2000'
        im_year = 2000.    <span class="comments">;Assume image in 2000 Equinox as default</span>
 endif
 if ( im_year NE cat_year ) then begin      <span class="comments">;Need to precess header?</span>
      hdr1 = hdr
      hprecess,hdr1,cat_year
      extast,hdr1, ASTR, noparams, ALT = alt
 endif 

 proj = strmid(astr.ctype[0],5,3)           <span class="comments">;Astrometric projection type</span>

 case proj of
         'GSS': gsssxyad, astr, x, y, ra,dec
         else: xy2ad, x, y, ASTR, ra, dec
 endcase

 ra = ra/15.                            <span class="comments">;Convert from degrees to hours</span>
 ramin = min(ra)  & ramax = max(ra)     <span class="comments">;Get max and min RA values</span>
 decmin = min(dec) & decmax = max(dec)  <span class="comments">;Get max and min Dec values</span>
 if (ramax - ramin) GT 12 then begin    <span class="comments">;Does the RA cross 24 hours?</span>
     newmax = ramin
     ramin = ramax
     ramax = 24.
     redo = 1
endif else redo = 0
if not keyword_set(SUBLIST) then sublist = -1


 search = strtrim(ramin,2)  + ' &lt; ra &lt; ' + strtrim(ramax,2) + ', ' + $
         strtrim(decmin,2) + ' &lt; dec &lt; ' + strtrim(decmax,2)
if not keyword_set(SILENT) then begin 
 print,'IMDBASE: Now searching ',catname,' catalogue - be patient'
 print,search
endif
 list = dbfind(search,sublist,/SILENT, Count = nstar)        <span class="comments">;Search for stars in field</span>
 if redo then begin
     search = '0 &lt; ra &lt; ' + strtrim(newmax,2) + ', ' + $
               strtrim(decmin,2) + '&lt; dec &lt;' + strtrim(decmax,2)
     if not keyword_set(SILENT) then print,search
     newlist = dbfind(search,sublist,/SILENT, Count = count)
     if count GT 0 then list = [list,newlist]
     nstar = nstar + count
 endif
 if not keyword_set(SILENT) then print,''

 if nstar GT 0 then begin                     <span class="comments">;Any stars found?</span>
   dbext,list,'ra,dec',ra,dec                <span class="comments">;Extract RA,DEC of stars found</span>
   ra = ra*15. 

   case proj of
           'GSS': gsssadxy, astr,ra,dec,x,y
            else: ad2xy,ra,dec,astr,x,y
   endcase 

   good = where( (x GT xmin) and ( x LT xmax ) $     <span class="comments">;Select stars within field</span>
             and (y GT ymin) and ( y LT ymax), ngood)
   if ngood GT 0 then begin 
       list = list[good]
       xpos = x[good] & ypos = y[good]
      if not keyword_set(SILENT) then $
      message,strtrim(ngood,2)+' '+ catname +' sources found within image',/INF
       if ( N_params() LT 3 ) then dbprint,list,textout=1   <span class="comments">;List stars found</span>
   endif else GOTO,NO_MATCH
 endif else GOTO,NO_MATCH
return

NO_MATCH: message,'No '+ catname + ' sources found within supplied image',/CON
return

end
</code>
    </div>
  </body>
</html>