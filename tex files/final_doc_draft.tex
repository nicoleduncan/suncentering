\documentclass[10pt]{scrartcl}
% \documentclass[10pt]{article}
\usepackage[T1]{fontenc}
\usepackage{amsmath,amsfonts,amssymb}
\usepackage{mathtools}
\usepackage{color,soul}
\usepackage{fullpage}
\usepackage{enumerate}
\usepackage{graphicx}
\usepackage[colorlinks=true,urlcolor=blue]{hyperref}
% \usepackage[justification=center]{caption}
\usepackage{subcaption}
\usepackage{deluxetable}
\usepackage{verbatim}
\usepackage{fancyvrb}
\usepackage{listings}


\definecolor{Light}{gray}{.90}
\sethlcolor{Light}


\lstset{%
language=IDL,                   % choose the language of the code
basicstyle=\footnotesize\sffamily,%\ttfamily\footnotesize,       % the size of the fonts that are used for the code
numbers=left,                   % where to put the line-numbers
numberstyle=\footnotesize,      % the size of the fonts that are used for the line-numbers
stepnumber=1,                   % the step between two line-numbers. If it is 1 each line will be numbered
numbersep=5pt,                  % how far the line-numbers are from the code
showspaces=false,               % show spaces adding particular underscores
showstringspaces=false,         % underline spaces within strings
showtabs=false,                 % show tabs within strings adding particular underscores
% frame=single,                   % adds a frame around the code
backgroundcolor=\color{Light},
columns=flexible,
tabsize=2,                      % sets default tabsize to 2 spaces
captionpos=b,                   % sets the caption-position to bottom
breaklines=true,                % sets automatic line breaking
breakatwhitespace=false,        % sets if automatic breaks should only happen at whitespace
escapeinside={\%*}{*)}          % if you want to add a comment within your code
}

\title{Final Documentation Draft}
\author{Jeren Suzuki}
\date{Last Edited \today}

\begin{document}

\maketitle
\pagenumbering{Roman}
\tableofcontents
\clearpage
\pagenumbering{arabic}

\section{Introduction} % (fold)
\label{sec:introduction}
Starting with an image of at most three suns on a fiducial grid, we find the centers of the suns and their relative position to the fiducials (which provide a physical distance calibration). The program deems suns too close to the edge or suns partially cut off as unfit for centering. 
% section introduction (end)

\section{Introduction cont.} % (fold)
\label{sec:intro_cont}
% This outline of steps aims to lay out the basic form we Not sure how in-depth to make the list so I'll just mark it for later.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{enumerate}
    \item Load Image
    \item Read parameters from pblock.txt
    \item Sort image and cut off top .1\% of pixels (top 1\% was actually too much)
    \item Smooth, take deriv, smooth again, take deriv again of sorted array, find peaks that correspond to difference solar regions and their thresholds
    \item Mask image above thresholds to find centers of every shape, regardless of partial or not
    \item If center of shape is within a certain distance to edge of image, mark as partial and cease further analysis
    \item Crop remaining whole suns
    \item Extract 5 strips centered around cropped solar center for both X and Y direction
    \item Extract a pair of limb strips for each long strip
    \item Applt linear fit to limb profile
    \item Mark position where fit crosses threshold 
    \item Use new threshold-crossing position to calculate chord lengths
    \item Average midpoints of chords to find limb-fitted centers
    % \item Recrop image and calculate row/column sums 
    % \item Subtract smoothed sums from original sum array to return fiducial row/column positions
    \item Analyze the cropped image for fiducials
    \item Using the fiducial positions, we compare the solar positions we calculated to a position defined by the physical setup.
\end{enumerate}


\begin{figure}[!ht]
    \centering
    \includegraphics[width=.9\textwidth]{../plots_tables_images/new_alphaflowchart.eps}    
    \caption{}
    \label{flowchart}
\end{figure}


\begin{deluxetable}{cllllllll}
    \tablecaption{Final data structure of solar region}
    \tablecolumns{4}
    \tabletypesize{\scriptsize}
    \tablewidth{0pt}
    \tablehead{ 
      \colhead{Name} %
    & \colhead{Type} %
    & \colhead{Value} %
    & \colhead{Notes}
    }
    \startdata
    \hline
    XPOS
    & FLOAT
    & 210.522
    & Rough calculation using a simple masking method\\
    %
    YPOS
    & FLOAT
    & 166.702
    & ''\\
    %
    REG
    & INT
    & 1
    & Region ID \#: 1 is 100\%, 2 is 50\%, 3 is 25\%\\
    %
    THRESH
    & FLOAT
    & 106.000
    & Threshold calculated from sorting array and taking derivatives.\\ & & & Used in both finding rough X-Y center as well as the\\ & & & threshold for limb-fitting.\\
    %
    PARTIAL
    & FLOAT
    & 0.
    & Flag that determines if the solar region is cut off on the edge or not.\\ & & & 0 means that it is not cut off \\
    %
    XSTRIPS
    & STRUCTURE
    & -> WHOLEXSTRIPS Array[5]
    & Strucutre containing the strips of whole solar data\\ & & & bound by a cropped region chosen by XPOS and YPOS\\
    %
    YSTRIPS
    & STRUCTURE
    & -> WHOLEYSTRIPS Array[5]
    & ''\\
    %
    LIMBXSTRIPS
    & STRUCTURE
    & -> LIMBXSTRIPS Array[5]
    & LIMBSTRIPS contains a pair of arrays, ENDPOINTS and \\ & & & STARTPOINTS that mark the limbs of each strip of data from \\ & & & X/YSTRIPS\\
    %
    LIMBYSTRIPS
    & STRUCTURE
    & -> LIMBYSTRIPS Array[5]
    & ''\\
    %
    LIMBXPOS
    & FLOAT
    & 210.710
    & Center calculated from LIMBXSTRIPS\\
    %
    LIMBYPOS
    & FLOAT
    & 167.172
    & ''\\
    %
    NPIX
    & FLOAT
    & 26680.0
    & Number of pixels above threshold
    \enddata
\label{structtable}
\end{deluxetable}

This is the form of the fiducial structure containing the positions and sub-pixel positions of fiducials for each solar region.
\begin{lstlisting}
>> help,*(bbb[0])
** Structure <260a348>, 2 tags, length=180, data length=178, refs=1:
   REG             INT              1
   FIDARR          STRUCT    -> FIDPOS Array[11]
>> help,(*(bbb[0])).fidarr,/str
** Structure FIDPOS, 4 tags, length=16, data length=16:
   X               FLOAT           50.0000
   Y               FLOAT           132.000
   SUBX            FLOAT           50.8438
   SUBY            FLOAT           133.291
\end{lstlisting}

% section intro_cont (end)

\section{Setting Up Parameters} % (fold)
\label{sec:setting_up_parameters}
Before we analyze the solar image, we load a parameter table and assign values. 

\begin{lstlisting}
scan_width 10               ; Distance to next chord when picking chords to limb-fit
sundiam 70                  ; Approx Solar diameter, deprecated
nstrips 5                   ; Number of pairs of solar chords to limb-fit per direction
ministrip_length 4          ; Length of limb profile to linear fit
crop_box 120                ; Half-width of box used to find fiducials in
elim_perc 1                 ; Percentage of highest pixels to eliminate when finding threshold
n_smooth 900                ; Elements to smooth by when finding threshold 
soldiskr 60                 ; Deprecated
border_pad 50               ; If solar center is within this value of border, marked as a partial sun
triangle_size .25           ; Percentage of image height to use for triangle sides for making clipped-bottom-corner mask
fid_smooth_thresh -150      ; Threshold to determine row/column positions of fiducials
onedsumthresh 80            ; Once looking at fiducial candidates, look at 1D sum of smaller fiducial crop and threshold difference of smoothed array - original array by this
disk_brightness 15          ; Arbitrary pixel brightness to eliminate bright fiducial candidates which are on the solar disk but are not on a fiducial
fid_crop_box 15             ; Half-width of box used to analyze fiducials
fid_smooth_candidates 15    ; Smoothing paramater for 1D sums of fiducial candidates 
\end{lstlisting}

In Figure \ref{sortedarray} we dynamically set thresholds for our image. Using these thresholds, we mask our image and identify solar regions by their brightness. We can't simply order them by brightness because we may have a 100\% and 50\% brightness sun in the same image and in order to determine the difference between a 100\%/50\% sun combo and a 50\%/25\% sun combo we must look at the actual threshold values.

\begin{figure}[!ht]
    \centering
    \includegraphics[width=.9\textwidth]{../plots_tables_images/sortedarray.eps}    
    \caption{We look at the second deriv because it consistently quantifies the thresholds to identify each solar region by. Unfortunately (or for better), we repeat this process per image we analyze. In terms of total time spent from starting the program to returning limb-fitted centers and fiducials, setting thresholds takes up about 25\%.}
    \label{sortedarray}
\end{figure}

\subsection{Possibility for Error} % (fold)
\label{sub:possibility_for_error}
Herein lies the problem of determining solar regions based on brightness and threshold values. We don't have a clear way of determining whether or not a sun is being obscured pre-imaging and in result, becoming dimmer. If this happens, an image with a 100\% and 50\% sun may appear to be a 50\% and 25\% sun. We could do something with the time of day and make sure if the sun is obscured by anything we can predict, we account for it in our code. 
% subsection possibility_for_error (end)

% section setting_up_parameters (end)

\section{Prepare Image for Limb Fitting} % (fold)
\label{sec:prepare_image_for_limb_fitting}
After we set our threshold and parameters, we iteratively find and crop suns in our image. To determine if the sun is partially cut off, we create a zone around the edge of our (usable) part of the image that if the center is within, it is counted as a fiducial. I emphasize \emph{usable} because the image has two triangles cut out of the bottom corners, reducing the usable part of the image. Figure \ref{cuttingcorners} gives and example of what our mask might look like. The gradient is unimportant, it's purpose is only to emphasize the shape of the mask.

\begin{figure}[!ht]
    \centering
    \hspace{-1.0in}
    \begin{subfigure}[b]{.45\linewidth}
        \centering
        \includegraphics[width=1.3\textwidth]{../plots_tables_images/cutcorner.eps}
        \caption{What our mask should look like - side of black triangle is 1/4 of image width}
        \label{noborder}
    \end{subfigure}
    \hspace{.5in}
    \begin{subfigure}[b]{.45\linewidth}
        \centering
        \includegraphics[width=1.3\textwidth]{../plots_tables_images/cutcornerwborder.eps}
        \caption{A proposed mask that looks within a certain distance form the border.}
        \label{aborder}
    \end{subfigure}
    \caption{The bottom corners will never see any data; the border mask must take into account the distance from the hypotenuse of the bottom corners still.}
    \label{cuttingcorners}
\end{figure}

% section prepare_image_for_limb_fitting (end)

\section{Fitting Limb Strips} % (fold)
\label{sec:fitting_limb_strips}

% section fitting_limb_strips (end)

\section{Finding Fiducials} % (fold)
\label{sec:finding_fiducials}

\begin{figure}[!ht]
    \begin{subfigure}[b]{.5\linewidth}
        \centering
        \includegraphics[width=\linewidth]{../plots_tables_images/smooth_expl.eps}
        \caption{This is the 1D sum of a solar image. Small dips are seen in the profile corresponding to fiducials. The line in red is the sum smoothed by 10 pixels.}
    \end{subfigure}
    \begin{subfigure}[b]{.5\linewidth}
        \centering
        \includegraphics[width=\linewidth]{../plots_tables_images/smoothcomp.eps}
        \caption{We subtract the smoothed profile from the raw data to emphasize dips. Comparisons of the smooth amount change the width and number of the dips, although not really the depth.}
        \label{threshed}
    \end{subfigure}
    \caption{}
    \label{smoothed}
\end{figure}


For each position below a certain threshold (see Figure \ref{threshed}) a row/column  is returned. Once we have an array of possible fiducial row and column positions, they are matched against each other using a method that iteratively checks to see if a pair of coordinates is a fiducial. Figure \ref{lotsofcrop} is what each fiducial candidate looks like for a certain sun. The position of plots in Figure \ref{lotsofplot} corresponds to the same regions in Figure \ref{lotsofcrop}. 

\begin{figure}[!ht]
    \vspace{-0.5in}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.2\linewidth]{../plots_tables_images/1d1dcrop_0_0.eps}
        % \caption{}
    \end{subfigure}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.2\linewidth]{../plots_tables_images/1d1dcrop_0_1.eps}
        % \caption{}
    \end{subfigure}
    % \hspace{-1.0in}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.2\linewidth]{../plots_tables_images/1d1dcrop_0_4.eps}
        % \caption{}
    \end{subfigure}

    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.2\linewidth]{../plots_tables_images/1d1dcrop_0_8.eps}
        % \caption{}
    \end{subfigure}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.2\linewidth]{../plots_tables_images/1d1dcrop_0_9.eps}
        % \caption{}
    \end{subfigure}
    % \hspace{-1.0in}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.2\linewidth]{../plots_tables_images/1d1dcrop_1_0.eps}
        % \caption{}
    \end{subfigure}


    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.2\linewidth]{../plots_tables_images/1d1dcrop_1_1.eps}
        % \caption{}
    \end{subfigure}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.2\linewidth]{../plots_tables_images/1d1dcrop_1_9.eps}
        % \caption{}
    \end{subfigure}
    % \hspace{-1.0in}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.2\linewidth]{../plots_tables_images/1d1dcrop_2_0.eps}
        % \caption{}
    \end{subfigure}


    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.2\linewidth]{../plots_tables_images/1d1dcrop_2_5.eps}
        % \caption{}
    \end{subfigure}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.2\linewidth]{../plots_tables_images/1d1dcrop_2_9.eps}
        % \caption{}
    \end{subfigure}
    % \hspace{-1.0in}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.2\linewidth]{../plots_tables_images/1d1dcrop_3_0.eps}
        % \caption{}
    \end{subfigure}


    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.2\linewidth]{../plots_tables_images/1d1dcrop_3_2.eps}
        % \caption{}
    \end{subfigure}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.2\linewidth]{../plots_tables_images/1d1dcrop_4_0.eps}
        % \caption{}
    \end{subfigure}
    % \hspace{-1.0in}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.2\linewidth]{../plots_tables_images/1d1dcrop_4_9.eps}
        % \caption{}
    \end{subfigure}


    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.2\linewidth]{../plots_tables_images/1d1dcrop_5_0.eps}
        % \caption{}
    \end{subfigure}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.2\linewidth]{../plots_tables_images/1d1dcrop_5_6.eps}
        % \caption{}
    \end{subfigure}
    % \hspace{-1.0in}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.2\linewidth]{../plots_tables_images/1d1dcrop_5_9.eps}
        % \caption{}
    \end{subfigure}


    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.2\linewidth]{../plots_tables_images/1d1dcrop_6_0.eps}
        % \caption{}
    \end{subfigure}
    % \hspace{-1.0in}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.2\linewidth]{../plots_tables_images/1d1dcrop_6_3.eps}
        % \caption{}
    \end{subfigure}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.2\linewidth]{../plots_tables_images/1d1dcrop_6_9.eps}
        % \caption{}
    \end{subfigure}
    \caption{Each possible fiducial candidate}
    \label{lotsofcrop}
\end{figure}


\begin{figure}[!ht]
    \vspace{-0.5in}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.0\linewidth]{../plots_tables_images/1d1dsums_0_0.eps}
        % \caption{}
    \end{subfigure}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.0\linewidth]{../plots_tables_images/1d1dsums_0_1.eps}
        % \caption{}
    \end{subfigure}
    % \hspace{-1.0in}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.0\linewidth]{../plots_tables_images/1d1dsums_0_4.eps}
        % \caption{}
    \end{subfigure}
\vspace{0.2in}

    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.0\linewidth]{../plots_tables_images/1d1dsums_0_8.eps}
        % \caption{}
    \end{subfigure}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.0\linewidth]{../plots_tables_images/1d1dsums_0_9.eps}
        % \caption{}
    \end{subfigure}
    % \hspace{-1.0in}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.0\linewidth]{../plots_tables_images/1d1dsums_1_0.eps}
        % \caption{}
    \end{subfigure}
\vspace{0.2in}

    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.0\linewidth]{../plots_tables_images/1d1dsums_1_1.eps}
        % \caption{}
    \end{subfigure}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.0\linewidth]{../plots_tables_images/1d1dsums_1_9.eps}
        % \caption{}
    \end{subfigure}
    % \hspace{-1.0in}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.0\linewidth]{../plots_tables_images/1d1dsums_2_0.eps}
        % \caption{}
    \end{subfigure}
\vspace{0.2in}

    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.0\linewidth]{../plots_tables_images/1d1dsums_2_5.eps}
        % \caption{}
    \end{subfigure}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.0\linewidth]{../plots_tables_images/1d1dsums_2_9.eps}
        % \caption{}
    \end{subfigure}
    % \hspace{-1.0in}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.0\linewidth]{../plots_tables_images/1d1dsums_3_0.eps}
        % \caption{}
    \end{subfigure}
\vspace{0.2in}

    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.0\linewidth]{../plots_tables_images/1d1dsums_3_2.eps}
        % \caption{}
    \end{subfigure}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.0\linewidth]{../plots_tables_images/1d1dsums_4_0.eps}
        % \caption{}
    \end{subfigure}
    % \hspace{-1.0in}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.0\linewidth]{../plots_tables_images/1d1dsums_4_9.eps}
        % \caption{}
    \end{subfigure}
\vspace{0.2in}

    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.0\linewidth]{../plots_tables_images/1d1dsums_5_0.eps}
        % \caption{}
    \end{subfigure}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.0\linewidth]{../plots_tables_images/1d1dsums_5_6.eps}
        % \caption{}
    \end{subfigure}
    % \hspace{-1.0in}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.0\linewidth]{../plots_tables_images/1d1dsums_5_9.eps}
        % \caption{}
    \end{subfigure}
\vspace{0.2in}

    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.0\linewidth]{../plots_tables_images/1d1dsums_6_0.eps}
        % \caption{}
    \end{subfigure}
    % \hspace{-1.0in}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.0\linewidth]{../plots_tables_images/1d1dsums_6_3.eps}
        % \caption{}
    \end{subfigure}
    \begin{subfigure}[b]{.3\linewidth}
        \centering
        \includegraphics[width=1.0\linewidth]{../plots_tables_images/1d1dsums_6_9.eps}
        % \caption{}
    \end{subfigure}
    \caption{The horizontal line is at 100; if there are any elements of the array above 100 for both a column 1D sum and a row 1D sum, then the cropped area is identified to have a fiducial in it. A parabolic fit is applied to 3 consecutive pixels with the center pixel at the peak of the array.}
    \label{lotsofplot}
\end{figure}




% section finding_fiducials (end)


\end{document}










