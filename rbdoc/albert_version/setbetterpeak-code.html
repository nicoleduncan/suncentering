<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Tue Jun 11 15:09:28 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>setbetterpeak.pro (Documentation for /Users/jerensuzuki/Documents/suncentering/)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="setbetterpeak.pro (Documentation for /Users/jerensuzuki/Documents/suncentering/)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source">FUNCTION setbetterpeak, input, nsuns
<span class="comments">;+</span>
<span class="comments">;   :Description:</span>
<span class="comments">;       Returns peaks of 2nd deriv of sorted array to set thresholds for image</span>
<span class="comments">;</span>
<span class="comments">;   :Params:</span>
<span class="comments">;       input: in, required</span>
<span class="comments">;           Starting input image</span>
<span class="comments">;</span>
<span class="comments">;       nsuns: in, required</span>
<span class="comments">;           Number of suns</span>
<span class="comments">;</span>
<span class="comments">;-</span>

<span class="comments">; instead of sorting the entire image, let's try getting away with sorting a whole lot less</span>

trimmed = input[where(input gt 1)]
peakarr = FLTARR(nsuns)
beensorted = SORT(trimmed)
sorted = trimmed[beensorted]
sorted = sorted[0:(1-!param.elim_perc/1000)*(N_ELEMENTS(sorted)-1)]
<span class="comments">; .03 to run to here</span>
 <span class="comments">; Now takes .0075</span>

a = DERIV(SMOOTH(FLOAT(sorted), !param.n_smooth, /edge_truncate))
arr = DERIV(SMOOTH(a, !param.n_smooth, /edge_truncate))
<span class="comments">; .05 to run to here</span>
<span class="comments">; Now takes .0075</span>


<span class="comments">; This isn't much faster</span>
<span class="comments">; tic</span>
<span class="comments">; a = SMOOTH(FLOAT(sorted), !param.n_smooth, /edge_truncate)</span>
<span class="comments">; a=[0,a,0]</span>
<span class="comments">; da = a-shift(a,1)</span>
<span class="comments">; da = da[1:n_elements(da)-2]</span>
<span class="comments">; b = SMOOTH(da, !param.n_smooth, /edge_truncate)</span>
<span class="comments">; b=[0,b,0]</span>
<span class="comments">; db = b-shift(b,1)</span>
<span class="comments">; db = db[1:n_elements(db)-2]</span>
<span class="comments">; toc</span>

arr = arr[0:-10000]

if nsuns gt 1 then begin
    for i = 0,nsuns-1 do begin
        peakarr[i] = MEAN(WHERE(arr eq MAX(arr)))
        <span class="comments">; so that the next peak is the real peak</span>
        arr=[arr,fltarr(13000)]
        arr[peakarr[i]-13000:peakarr[i]+13000]=0
        arr=arr[0:-13000]
    endfor
endif else begin
    peakarr = MEAN(WHERE(a[0:-10000] eq MAX(a[0:-10000])))
endelse
<span class="comments">; .06 to run to here</span>

<span class="comments">; plot,sorted</span>
<span class="comments">; vline,peakarr</span>
<span class="comments">; stop</span>


<span class="comments">; ; We actually don't care about this xpos ypos thing. Let's comment it out for later.</span>
<span class="comments">; peakarr = FLTARR(nsuns)</span>
<span class="comments">; beensorted = SORT(input)</span>
<span class="comments">; sorted = input[beensorted]</span>
<span class="comments">; sorted = sorted[0:(1-!param.elim_perc/1000)*(N_ELEMENTS(sorted)-1)]</span>

<span class="comments">; s = SIZE(input,/dim)</span>
<span class="comments">; n_col = s[0]</span>
<span class="comments">; n_row = s[1]</span>

<span class="comments">; xarr = fan(FINDGEN(n_col),n_row)</span>
<span class="comments">; ; yarr = TRANSPOSE(fan(FINDGEN(n_row),n_col))</span>
<span class="comments">; ; slightly faster to rotate than transpose</span>
<span class="comments">; yarr = ROTATE(fan(FINDGEN(n_row),n_col),1)</span>

<span class="comments">; xsort = xarr[beensorted]</span>
<span class="comments">; xsort = xsort[0:(1- !param.elim_perc/1000)*(N_ELEMENTS(sorted)-1)]</span>
<span class="comments">; ysort = yarr[beensorted]</span>
<span class="comments">; ysort = ysort[0:(1- !param.elim_perc/1000)*(N_ELEMENTS(sorted)-1)]</span>

<span class="comments">; ; Originally, used ts_smooth but a simple float() fixed smoothing. Jesus Christ.</span>
<span class="comments">; ; smooth = TS_SMOOTH(sorted, !param.n_smooth, order = !param.smoothorder-1)</span>
<span class="comments">; ; arr = DERIV(TS_SMOOTH(DERIV(smooth), !param.n_smooth, order = !param.smoothorder-1))</span>
<span class="comments">; stop</span>
<span class="comments">; a = DERIV(SMOOTH(FLOAT(sorted), !param.n_smooth, /edge_truncate))</span>
<span class="comments">; arr = DERIV(SMOOTH(a, !param.n_smooth, /edge_truncate))</span>

<span class="comments">; ; have to drop the last 10,000 indices since I'm smoothing by 1500</span>
<span class="comments">; arr=arr[0:1240000]</span>

<span class="comments">; ; The thresholds are letting too many of the region-1 pixels in</span>
<span class="comments">; ; stop</span>
<span class="comments">; ; plot,arr</span>
<span class="comments">; ; vline, 1222214</span>
<span class="comments">; ; vline, 1193643</span>
<span class="comments">; ; vline,1158722</span>
<span class="comments">; ; stop</span>
<span class="comments">; if nsuns gt 1 then begin</span>
<span class="comments">;     for i = 0,nsuns-1 do begin</span>
<span class="comments">;         peakarr[i] = MEAN(WHERE(arr eq MAX(arr)))</span>
<span class="comments">;         ; so that the next peak is the real peak</span>
<span class="comments">;         arr=[arr,fltarr(10000)]</span>
<span class="comments">;         arr[peakarr[i]-10000:peakarr[i]+10000]=0</span>
<span class="comments">;         arr=arr[0:-10000]</span>
        
<span class="comments">;     endfor</span>
<span class="comments">; endif else begin</span>
<span class="comments">;     peakarr = MEAN(WHERE(a eq MAX(a)))</span>
<span class="comments">; endelse</span>

RETURN,{peakarr:peakarr,sorted:sorted}<span class="comments">;xsort:xsort,ysort:ysort}</span>
end
</code>
    </div>
  </body>
</html>